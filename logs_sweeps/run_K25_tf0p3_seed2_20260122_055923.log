################################################################################################################
### RUN: K=25 test_fraction=0.3 seed=2                                                                       ###
### npz_in=/workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz ###
################################################################################################################

#####################
### 1) PREPROCESS ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_delan_dataset.py --qdd True --col_format wide --trajectory_amount 25 --test_fraction 0.3 --seed 2 --raw_csv /workspace/shared/data/raw/delan_UR3_Load0_combined_26.csv --out_npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Saved: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz
Trajectories: train=17 test=8
Exists: True

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=0                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz -t structured -s 0 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x75645ed4c1f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz
   dt ≈ 0.026853339250055355
  dof = 6
  Train trajectories = 17
  Test trajectories  = 8
  Train samples = 7524
  Test samples  = 1515
################################################

2026-01-22 05:22:58.552390: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150 | type=structured | dof=6
################################################
2026-01-22 05:23:01.721578: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:01.721617: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:01.721623: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:01.721650: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:01.721655: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:01.721670: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:01.721706: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:01.721711: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:01.721726: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:01.721731: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.1s, Loss=4.85e+01, Inv=4.85e+01, For=2.07e+02, Power=7.91e+00
2026-01-22 05:23:06.732769: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  [eval] test_mse=2.222e+01  (n=1515)
Epoch 00050: Time=   7.3s, Loss=2.77e+00, Inv=2.77e+00, For=3.54e+01, Power=2.46e+00
Epoch 00100: Time=   8.3s, Loss=2.50e+00, Inv=2.50e+00, For=4.33e+01, Power=2.27e+00
Epoch 00150: Time=   9.3s, Loss=2.35e+00, Inv=2.35e+00, For=4.80e+01, Power=2.09e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
Torque MSE  = 2.826e+00
Torque RMSE = 1.681e+00
Per-joint MSE : 6.970e+00 6.544e+00 1.946e-01 4.907e-01 1.877e+00 8.811e-01
Per-joint RMSE: 2.640e+00 2.558e+00 4.411e-01 7.005e-01 1.370e+00 9.387e-01
Comp Time per Sample = 2.214e-07s / 4515863.6Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
Detected n_dof=6 (seed=0)
2026-01-22 05:23:13.051289: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 17 trajectories
2026-01-22 05:23:14.377880: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:14.377894: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:15.883278: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:15.883291: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:23:17.444468: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 17/17

Exporting split=test: 8 trajectories
  done 8/8

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (7284, 25, 24)  Y_train: (7284, 6)
X_test : (1428, 25, 24)  Y_test : (1428, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:23:19.490737: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:23:19.514953: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (7284, 25, 24), Y_train = (7284, 6)
  X_test  = (1428, 25, 24),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:23:20.458691: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:20.463336: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:20.464242: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:20.465914: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:20.466725: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:20.467489: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:20.548105: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:20.548982: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:20.549846: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:20.550613: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:23:21.433679: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 61ms/step - loss: 0.2610 - val_loss: 1.9923
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1351 - val_loss: 1.8714
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1080 - val_loss: 1.8755
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.0923 - val_loss: 1.9136
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.0839 - val_loss: 1.9109
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0781 - val_loss: 1.9161
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0755 - val_loss: 1.9229
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0731 - val_loss: 1.9175
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0712 - val_loss: 1.9095
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0694 - val_loss: 1.9196
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0681 - val_loss: 1.9176
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0667 - val_loss: 1.9025
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6337
Per-joint RMSE: 2.6007 2.3301 0.3715 0.7415 1.4396 1.0299
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:23:24.079479: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:23:24.104131: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:23:24.941871: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:24.946795: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:24.947590: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:24.949451: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:24.950240: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:24.950981: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:25.033827: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:25.034739: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:25.035478: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:25.036207: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:23:25.331710: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.960946e+00  RMSE=1.720740e+00
  per-joint RMSE: 2.7147 2.5993 0.4470 0.7207 1.4101 0.9656
Residual LSTM:  MSE=2.668964e+00      RMSE=1.633696e+00
  per-joint RMSE: 2.6007 2.3301 0.3715 0.7415 1.4396 1.0299
Combined torque MSE=2.668964e+00     RMSE=1.633696e+00
  per-joint RMSE: 2.6007 2.3301 0.3715 0.7415 1.4396 1.0299
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (7284, 25, 6)  Y_train: (7284, 6)
X_test : (1428, 25, 6)  Y_test : (1428, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:23:27.130819: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:23:27.155003: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (7284, 25, 6), Y_train = (7284, 6)
  X_test  = (1428, 25, 6),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:23:28.078753: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:28.083309: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:28.084187: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:28.085889: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:28.086675: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:28.087405: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:28.167090: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:28.167921: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:28.168677: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:28.169464: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:23:29.082300: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.4333 - val_loss: 2.4749
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.3263 - val_loss: 2.5431
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.2654 - val_loss: 2.6163
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.2307 - val_loss: 2.6153
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.2039 - val_loss: 2.5975
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.1837 - val_loss: 2.6629
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.1690 - val_loss: 2.6260
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.1532 - val_loss: 2.5859
Epoch 9/30
23/23 - 0s - 4ms/step - loss: 0.1349 - val_loss: 2.6372
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.1138 - val_loss: 2.8127
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0988 - val_loss: 2.7732
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.7132
Per-joint RMSE: 2.8149 2.4032 0.4525 0.7507 1.4850 0.9688
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:23:31.591577: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:23:31.617970: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:23:32.459883: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:32.464619: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:32.465402: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:32.467001: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:32.467787: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:32.468519: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:32.548271: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:32.549100: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:32.549918: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:32.550649: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:23:32.844509: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.960946e+00  RMSE=1.720740e+00
  per-joint RMSE: 2.7147 2.5993 0.4470 0.7207 1.4101 0.9656
Residual LSTM:  MSE=2.935126e+00      RMSE=1.713221e+00
  per-joint RMSE: 2.8149 2.4032 0.4525 0.7507 1.4850 0.9688
Combined torque MSE=2.935126e+00     RMSE=1.713221e+00
  per-joint RMSE: 2.8149 2.4032 0.4525 0.7507 1.4850 0.9688
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:23:34.634262: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:23:34.658031: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:23:35.605417: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:35.610137: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:35.610928: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:35.612433: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:35.613288: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:35.614025: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:35.685974: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:35.686820: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:35.687560: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:35.688291: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:23:36.603558: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 61ms/step - loss: 0.2961 - val_loss: 2.0373
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1485 - val_loss: 1.8652
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1276 - val_loss: 1.8281
Epoch 4/30
23/23 - 0s - 4ms/step - loss: 0.1152 - val_loss: 1.8419
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.1056 - val_loss: 1.8546
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0977 - val_loss: 1.8502
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0895 - val_loss: 1.8710
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0843 - val_loss: 1.8824
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0802 - val_loss: 1.8564
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0797 - val_loss: 1.8829
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0760 - val_loss: 1.9104
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0742 - val_loss: 1.9087
Epoch 13/30
23/23 - 0s - 3ms/step - loss: 0.0748 - val_loss: 1.9046
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6745
Per-joint RMSE: 2.6625 2.4836 0.3207 0.7326 1.3971 0.9878
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:23:39.292050: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:23:39.316749: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:23:40.177106: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:40.181782: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:40.182651: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:40.184315: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:40.185101: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:40.185832: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:40.264795: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:40.265627: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:40.266369: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:40.267100: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:23:40.563983: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.960946e+00  RMSE=1.720740e+00
  per-joint RMSE: 2.7147 2.5993 0.4470 0.7207 1.4101 0.9656
Residual LSTM:  MSE=2.803976e+00      RMSE=1.674508e+00
  per-joint RMSE: 2.6625 2.4836 0.3207 0.7326 1.3971 0.9878
Combined torque MSE=2.803976e+00     RMSE=1.674508e+00
  per-joint RMSE: 2.6625 2.4836 0.3207 0.7326 1.3971 0.9878
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:23:42.362020: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:23:42.386210: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:23:43.333647: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:43.338412: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:43.339202: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:43.340868: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:43.341645: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:43.342372: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:43.417548: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:43.418379: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:43.419117: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:43.419849: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:23:44.339211: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2827 - val_loss: 1.9803
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1392 - val_loss: 1.8520
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1105 - val_loss: 1.8731
Epoch 4/30
23/23 - 0s - 4ms/step - loss: 0.0983 - val_loss: 1.8572
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.0904 - val_loss: 1.8717
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0829 - val_loss: 1.8884
Epoch 7/30
23/23 - 0s - 4ms/step - loss: 0.0789 - val_loss: 1.9074
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0754 - val_loss: 1.9350
Epoch 9/30
23/23 - 0s - 4ms/step - loss: 0.0726 - val_loss: 1.9490
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0709 - val_loss: 1.9696
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0691 - val_loss: 1.9664
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0688 - val_loss: 1.9594
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6634
Per-joint RMSE: 2.6821 2.4080 0.3961 0.7333 1.3840 0.9993
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:23:46.960663: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:23:46.985256: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:23:47.847466: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:47.852392: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:47.853194: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:47.855108: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:47.855912: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:47.856652: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:47.940182: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:47.941023: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:47.941782: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:47.942517: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:23:48.241980: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.960946e+00  RMSE=1.720740e+00
  per-joint RMSE: 2.7147 2.5993 0.4470 0.7207 1.4101 0.9656
Residual LSTM:  MSE=2.766755e+00      RMSE=1.663357e+00
  per-joint RMSE: 2.6821 2.4080 0.3961 0.7333 1.3840 0.9993
Combined torque MSE=2.766755e+00     RMSE=1.663357e+00
  per-joint RMSE: 2.6821 2.4080 0.3961 0.7333 1.3840 0.9993
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (7059, 50, 24)  Y_train: (7059, 6)
X_test : (1353, 50, 24)  Y_test : (1353, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:23:50.048391: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:23:50.072840: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (7059, 50, 24), Y_train = (7059, 6)
  X_test  = (1353, 50, 24),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:23:51.050198: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:51.054829: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:51.055677: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:51.057438: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:51.058224: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:51.058957: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:51.139975: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:51.140797: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:51.141529: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:51.142250: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:23:52.046834: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2660 - val_loss: 2.0892
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1380 - val_loss: 2.0148
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1130 - val_loss: 2.0413
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.0979 - val_loss: 2.0440
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0896 - val_loss: 2.0221
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0851 - val_loss: 2.0033
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0801 - val_loss: 1.9677
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0778 - val_loss: 1.9634
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0757 - val_loss: 1.9616
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0735 - val_loss: 1.9708
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0721 - val_loss: 1.9525
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0709 - val_loss: 1.9519
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0697 - val_loss: 1.9590
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0682 - val_loss: 1.9527
Epoch 15/30
23/23 - 0s - 5ms/step - loss: 0.0676 - val_loss: 1.9489
Epoch 16/30
23/23 - 0s - 5ms/step - loss: 0.0669 - val_loss: 1.9418
Epoch 17/30
23/23 - 0s - 5ms/step - loss: 0.0671 - val_loss: 1.9394
Epoch 18/30
23/23 - 0s - 5ms/step - loss: 0.0662 - val_loss: 1.9455
Epoch 19/30
23/23 - 0s - 5ms/step - loss: 0.0658 - val_loss: 1.9471
Epoch 20/30
23/23 - 0s - 5ms/step - loss: 0.0644 - val_loss: 1.9496
Epoch 21/30
23/23 - 0s - 5ms/step - loss: 0.0632 - val_loss: 1.9638
Epoch 22/30
23/23 - 0s - 5ms/step - loss: 0.0632 - val_loss: 1.9486
Epoch 23/30
23/23 - 0s - 5ms/step - loss: 0.0632 - val_loss: 1.9698
Epoch 24/30
23/23 - 0s - 5ms/step - loss: 0.0627 - val_loss: 1.9528
Epoch 25/30
23/23 - 0s - 5ms/step - loss: 0.0614 - val_loss: 1.9527
Epoch 26/30
23/23 - 0s - 5ms/step - loss: 0.0612 - val_loss: 1.9578
Epoch 27/30
23/23 - 0s - 5ms/step - loss: 0.0625 - val_loss: 1.9549
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.5858
Per-joint RMSE: 2.5893 2.2150 0.3629 0.7147 1.3860 0.9563
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:23:56.763877: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:23:56.788686: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:23:57.631263: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:57.636124: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:57.639176: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:57.641410: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:57.642209: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:57.642952: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:57.722196: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:57.723031: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:57.723774: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:23:57.724504: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8945 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:23:58.023881: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.837135e+00  RMSE=1.684380e+00
  per-joint RMSE: 2.6819 2.5020 0.4478 0.7207 1.3907 0.9571
Residual LSTM:  MSE=2.514842e+00      RMSE=1.585825e+00
  per-joint RMSE: 2.5893 2.2150 0.3629 0.7147 1.3860 0.9563
Combined torque MSE=2.514842e+00     RMSE=1.585825e+00
  per-joint RMSE: 2.5893 2.2150 0.3629 0.7147 1.3860 0.9563
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (7059, 50, 6)  Y_train: (7059, 6)
X_test : (1353, 50, 6)  Y_test : (1353, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:23:59.788710: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:23:59.813360: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (7059, 50, 6), Y_train = (7059, 6)
  X_test  = (1353, 50, 6),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:24:00.741963: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:00.746602: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:00.747400: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:00.748922: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:00.749713: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:00.750444: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:00.830058: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:00.830887: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:00.831719: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:00.832449: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:24:01.714396: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.3975 - val_loss: 2.7476
Epoch 2/30
23/23 - 0s - 5ms/step - loss: 0.2795 - val_loss: 2.7718
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.2284 - val_loss: 2.8204
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.2038 - val_loss: 2.8690
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.1611 - val_loss: 2.8702
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.1443 - val_loss: 2.8353
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.1223 - val_loss: 2.8663
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.1087 - val_loss: 2.9098
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.1051 - val_loss: 2.8997
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0987 - val_loss: 2.8789
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0902 - val_loss: 2.8718
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6496
Per-joint RMSE: 2.6754 2.3013 0.4342 0.7126 1.5181 0.9342
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:24:04.575338: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:24:04.599819: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:24:05.443116: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:05.447728: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:05.448612: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:05.450326: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:05.451115: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:05.451925: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:05.531101: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:05.531934: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:05.532675: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:05.533403: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8945 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:24:05.827835: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.837135e+00  RMSE=1.684380e+00
  per-joint RMSE: 2.6819 2.5020 0.4478 0.7207 1.3907 0.9571
Residual LSTM:  MSE=2.721173e+00      RMSE=1.649598e+00
  per-joint RMSE: 2.6754 2.3013 0.4342 0.7126 1.5181 0.9342
Combined torque MSE=2.721173e+00     RMSE=1.649598e+00
  per-joint RMSE: 2.6754 2.3013 0.4342 0.7126 1.5181 0.9342
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:24:07.628236: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:24:07.652545: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:24:08.627138: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:08.631725: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:08.632508: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:08.634051: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:08.634835: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:08.635568: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:08.709482: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:08.710317: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:08.711136: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:08.711872: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:24:09.629153: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2821 - val_loss: 1.9858
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1513 - val_loss: 1.8425
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1313 - val_loss: 1.8568
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1205 - val_loss: 1.8424
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.1057 - val_loss: 1.8324
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0945 - val_loss: 1.8348
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0925 - val_loss: 1.8111
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0865 - val_loss: 1.8317
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0823 - val_loss: 1.8322
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0784 - val_loss: 1.8439
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0775 - val_loss: 1.8309
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0760 - val_loss: 1.8171
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0760 - val_loss: 1.8622
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0728 - val_loss: 1.8699
Epoch 15/30
23/23 - 0s - 5ms/step - loss: 0.0719 - val_loss: 1.8938
Epoch 16/30
23/23 - 0s - 5ms/step - loss: 0.0728 - val_loss: 1.8716
Epoch 17/30
23/23 - 0s - 5ms/step - loss: 0.0693 - val_loss: 1.8583
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6571
Per-joint RMSE: 2.6314 2.4604 0.3158 0.7054 1.3981 0.9728
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:24:13.175411: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:24:13.199830: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:24:14.053705: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:14.058417: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:14.059294: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:14.061019: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:14.061809: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:14.062539: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:14.136769: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:14.137744: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:14.138543: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:14.139279: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:24:14.434887: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.837135e+00  RMSE=1.684380e+00
  per-joint RMSE: 2.6819 2.5020 0.4478 0.7207 1.3907 0.9571
Residual LSTM:  MSE=2.746032e+00      RMSE=1.657116e+00
  per-joint RMSE: 2.6314 2.4604 0.3158 0.7054 1.3981 0.9728
Combined torque MSE=2.746032e+00     RMSE=1.657116e+00
  per-joint RMSE: 2.6314 2.4604 0.3158 0.7054 1.3981 0.9728
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:24:16.235195: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:24:16.259551: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:24:17.223229: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:17.227883: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:17.228835: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:17.230408: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:17.231195: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:17.232011: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:17.309148: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:17.309977: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:17.310711: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:17.311434: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:24:18.197397: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2631 - val_loss: 1.9317
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1395 - val_loss: 1.8260
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1185 - val_loss: 1.8508
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1042 - val_loss: 1.8583
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0927 - val_loss: 1.8710
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0872 - val_loss: 1.8830
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0834 - val_loss: 1.8888
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0808 - val_loss: 1.9141
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0772 - val_loss: 1.9283
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0740 - val_loss: 1.9261
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0731 - val_loss: 1.9422
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0716 - val_loss: 1.9417
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6042
Per-joint RMSE: 2.6266 2.2255 0.3840 0.7394 1.3852 0.9881
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:24:21.192865: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:24:21.217711: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:24:22.067705: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:22.072496: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:22.073289: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:22.074920: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:22.075711: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:22.076456: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:22.154709: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:22.155547: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:22.156387: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:22.157108: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:24:22.454359: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.837135e+00  RMSE=1.684380e+00
  per-joint RMSE: 2.6819 2.5020 0.4478 0.7207 1.3907 0.9571
Residual LSTM:  MSE=2.573553e+00      RMSE=1.604230e+00
  per-joint RMSE: 2.6266 2.2255 0.3840 0.7394 1.3852 0.9881
Combined torque MSE=2.573553e+00     RMSE=1.604230e+00
  per-joint RMSE: 2.6266 2.2255 0.3840 0.7394 1.3852 0.9881
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=1                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz -t structured -s 1 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x70caa73501f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz
   dt ≈ 0.026853339250055355
  dof = 6
  Train trajectories = 17
  Test trajectories  = 8
  Train samples = 7524
  Test samples  = 1515
################################################

2026-01-22 05:24:26.606442: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150 | type=structured | dof=6
################################################
2026-01-22 05:24:29.757107: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:29.757145: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:29.757152: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:29.757181: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:29.757187: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:29.757202: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:29.757241: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:29.757247: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:29.757263: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:29.757268: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.1s, Loss=6.21e+01, Inv=6.21e+01, For=2.93e+02, Power=9.47e+00
2026-01-22 05:24:34.727759: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  [eval] test_mse=1.064e+01  (n=1515)
Epoch 00050: Time=   7.5s, Loss=2.89e+00, Inv=2.89e+00, For=4.28e+01, Power=2.69e+00
Epoch 00100: Time=   8.5s, Loss=2.51e+00, Inv=2.51e+00, For=5.44e+01, Power=2.44e+00
Epoch 00150: Time=   9.7s, Loss=2.38e+00, Inv=2.38e+00, For=6.18e+01, Power=2.23e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
Torque MSE  = 7.311e-01
Torque RMSE = 8.550e-01
Per-joint MSE : 7.982e-01 1.588e+00 5.225e-01 3.328e-01 6.959e-01 4.488e-01
Per-joint RMSE: 8.934e-01 1.260e+00 7.228e-01 5.769e-01 8.342e-01 6.699e-01
Comp Time per Sample = 2.236e-07s / 4473064.2Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
Detected n_dof=6 (seed=1)
2026-01-22 05:24:41.498411: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 17 trajectories
2026-01-22 05:24:42.789371: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:42.789387: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:44.274779: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:44.274791: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:24:45.792115: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 17/17

Exporting split=test: 8 trajectories
  done 8/8

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (7284, 25, 24)  Y_train: (7284, 6)
X_test : (1428, 25, 24)  Y_test : (1428, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:24:47.780374: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:24:47.805949: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (7284, 25, 24), Y_train = (7284, 6)
  X_test  = (1428, 25, 24),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:24:48.770807: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:48.775455: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:48.776266: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:48.777848: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:48.778654: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:48.779409: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:48.857973: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:48.858918: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:48.859759: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:48.860562: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8948 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:24:49.762425: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2975 - val_loss: 2.0999
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1386 - val_loss: 2.0158
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1092 - val_loss: 2.0246
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.0932 - val_loss: 2.0522
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.0844 - val_loss: 2.0766
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0774 - val_loss: 2.1031
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0743 - val_loss: 2.1002
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0728 - val_loss: 2.1194
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0710 - val_loss: 2.1081
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0699 - val_loss: 2.1366
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0688 - val_loss: 2.1348
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0674 - val_loss: 2.1625
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.7999
Per-joint RMSE: 0.8166 1.1974 0.6221 0.5405 0.7967 0.6519
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:24:52.376988: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:24:52.403199: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:24:53.253131: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:53.257839: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:53.258629: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:53.260253: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:53.261039: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:53.261778: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:53.340511: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:53.341341: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:53.342077: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:53.342803: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8945 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:24:53.644769: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.521639e-01  RMSE=8.672739e-01
  per-joint RMSE: 0.9159 1.2620 0.7360 0.5891 0.8498 0.6860
Residual LSTM:  MSE=6.398952e-01      RMSE=7.999345e-01
  per-joint RMSE: 0.8166 1.1974 0.6221 0.5405 0.7967 0.6519
Combined torque MSE=6.398952e-01     RMSE=7.999345e-01
  per-joint RMSE: 0.8166 1.1974 0.6221 0.5405 0.7967 0.6519
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (7284, 25, 6)  Y_train: (7284, 6)
X_test : (1428, 25, 6)  Y_test : (1428, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:24:55.420971: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:24:55.445182: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (7284, 25, 6), Y_train = (7284, 6)
  X_test  = (1428, 25, 6),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:24:56.378255: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:56.382852: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:56.383643: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:56.385343: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:56.386205: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:56.386939: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:56.462023: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:56.463022: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:56.463760: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:24:56.464485: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:24:57.336917: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 61ms/step - loss: 0.4240 - val_loss: 2.5577
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.3216 - val_loss: 2.7931
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.2645 - val_loss: 2.8746
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.2321 - val_loss: 3.0370
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.2059 - val_loss: 2.9158
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.1856 - val_loss: 2.9071
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.1679 - val_loss: 2.8396
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.1505 - val_loss: 2.8098
Epoch 9/30
23/23 - 0s - 4ms/step - loss: 0.1206 - val_loss: 2.8962
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.1014 - val_loss: 2.9090
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0982 - val_loss: 2.7756
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8533
Per-joint RMSE: 0.8789 1.1669 0.6371 0.5906 0.9986 0.6947
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:24:59.868435: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:24:59.893125: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:25:00.741530: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:00.746213: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:00.747011: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:00.748705: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:00.749587: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:00.750315: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:00.827752: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:00.828665: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:00.829407: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:00.830138: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:25:01.124195: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.521639e-01  RMSE=8.672739e-01
  per-joint RMSE: 0.9159 1.2620 0.7360 0.5891 0.8498 0.6860
Residual LSTM:  MSE=7.281102e-01      RMSE=8.532937e-01
  per-joint RMSE: 0.8789 1.1669 0.6371 0.5906 0.9986 0.6947
Combined torque MSE=7.281102e-01     RMSE=8.532937e-01
  per-joint RMSE: 0.8789 1.1669 0.6371 0.5906 0.9986 0.6947
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:02.910264: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:02.934271: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:25:03.881823: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:03.886737: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:03.887524: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:03.889256: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:03.890033: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:03.890760: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:03.964146: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:03.964978: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:03.965715: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:03.966438: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:25:04.868798: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2794 - val_loss: 1.9243
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1501 - val_loss: 1.9085
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1281 - val_loss: 1.9416
Epoch 4/30
23/23 - 0s - 4ms/step - loss: 0.1144 - val_loss: 1.9976
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.1059 - val_loss: 2.0482
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0957 - val_loss: 2.0786
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0862 - val_loss: 2.1047
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0814 - val_loss: 2.1285
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0817 - val_loss: 2.0950
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0771 - val_loss: 2.1018
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0754 - val_loss: 2.1091
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0732 - val_loss: 2.0594
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8378
Per-joint RMSE: 0.8560 1.2139 0.6660 0.5999 0.8319 0.7137
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:07.485066: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:07.509856: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:25:08.371177: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:08.375847: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:08.376772: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:08.378594: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:08.379434: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:08.380231: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:08.460507: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:08.461586: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:08.462436: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:08.463209: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8945 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:25:08.761517: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.521639e-01  RMSE=8.672739e-01
  per-joint RMSE: 0.9159 1.2620 0.7360 0.5891 0.8498 0.6860
Residual LSTM:  MSE=7.018574e-01      RMSE=8.377693e-01
  per-joint RMSE: 0.8560 1.2139 0.6660 0.5999 0.8319 0.7137
Combined torque MSE=7.018574e-01     RMSE=8.377693e-01
  per-joint RMSE: 0.8560 1.2139 0.6660 0.5999 0.8319 0.7137
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:10.531885: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:10.556591: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:25:11.505730: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:11.510835: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:11.511630: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:11.513176: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:11.513960: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:11.514693: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:11.590979: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:11.591812: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:11.592548: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:11.593373: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:25:12.481752: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 61ms/step - loss: 0.2615 - val_loss: 2.0881
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1383 - val_loss: 1.8934
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1124 - val_loss: 1.8816
Epoch 4/30
23/23 - 0s - 4ms/step - loss: 0.0966 - val_loss: 1.8974
Epoch 5/30
23/23 - 0s - 4ms/step - loss: 0.0872 - val_loss: 1.9321
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0819 - val_loss: 1.9647
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0777 - val_loss: 1.9769
Epoch 8/30
23/23 - 0s - 4ms/step - loss: 0.0749 - val_loss: 2.0233
Epoch 9/30
23/23 - 0s - 4ms/step - loss: 0.0717 - val_loss: 2.0575
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0702 - val_loss: 2.0788
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0688 - val_loss: 2.0977
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0680 - val_loss: 2.0871
Epoch 13/30
23/23 - 0s - 3ms/step - loss: 0.0673 - val_loss: 2.1094
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8241
Per-joint RMSE: 0.8289 1.1915 0.6973 0.5365 0.8772 0.6515
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:15.196904: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:15.221873: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:25:16.061508: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:16.066194: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:16.066979: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:16.068591: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:16.069374: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:16.070107: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:16.155662: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:16.156497: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:16.157235: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:16.157965: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:25:16.456207: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.521639e-01  RMSE=8.672739e-01
  per-joint RMSE: 0.9159 1.2620 0.7360 0.5891 0.8498 0.6860
Residual LSTM:  MSE=6.791075e-01      RMSE=8.240798e-01
  per-joint RMSE: 0.8289 1.1915 0.6973 0.5365 0.8772 0.6515
Combined torque MSE=6.791075e-01     RMSE=8.240798e-01
  per-joint RMSE: 0.8289 1.1915 0.6973 0.5365 0.8772 0.6515
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (7059, 50, 24)  Y_train: (7059, 6)
X_test : (1353, 50, 24)  Y_test : (1353, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:18.259148: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:18.283755: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (7059, 50, 24), Y_train = (7059, 6)
  X_test  = (1353, 50, 24),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:25:19.256215: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:19.261298: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:19.262123: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:19.263643: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:19.264433: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:19.265261: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:19.346959: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:19.347877: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:19.348720: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:19.349547: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:25:20.297297: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2816 - val_loss: 2.0270
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1477 - val_loss: 1.9060
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1161 - val_loss: 1.8924
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1002 - val_loss: 1.9020
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0905 - val_loss: 1.8944
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0856 - val_loss: 1.8780
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0818 - val_loss: 1.8917
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0787 - val_loss: 1.8966
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0752 - val_loss: 1.8987
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0731 - val_loss: 1.8836
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0717 - val_loss: 1.8919
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0702 - val_loss: 1.8938
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0700 - val_loss: 1.8844
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0689 - val_loss: 1.8835
Epoch 15/30
23/23 - 0s - 5ms/step - loss: 0.0681 - val_loss: 1.8903
Epoch 16/30
23/23 - 0s - 5ms/step - loss: 0.0668 - val_loss: 1.8871
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.7630
Per-joint RMSE: 0.7374 1.0094 0.6687 0.5817 0.8226 0.6840
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:23.731807: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:23.756471: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:25:24.610281: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:24.615241: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:24.616046: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:24.617724: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:24.618517: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:24.619257: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:24.693734: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:24.694577: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:24.695401: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:24.696133: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:25:24.997626: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.168153e-01  RMSE=8.466495e-01
  per-joint RMSE: 0.9271 1.2006 0.7238 0.5919 0.8338 0.6562
Residual LSTM:  MSE=5.821177e-01      RMSE=7.629664e-01
  per-joint RMSE: 0.7374 1.0094 0.6687 0.5817 0.8226 0.6840
Combined torque MSE=5.821177e-01     RMSE=7.629664e-01
  per-joint RMSE: 0.7374 1.0094 0.6687 0.5817 0.8226 0.6840
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (7059, 50, 6)  Y_train: (7059, 6)
X_test : (1353, 50, 6)  Y_test : (1353, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:26.789417: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:26.813552: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (7059, 50, 6), Y_train = (7059, 6)
  X_test  = (1353, 50, 6),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:25:27.760613: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:27.765417: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:27.766372: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:27.768036: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:27.768815: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:27.769546: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:27.850137: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:27.851193: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:27.851929: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:27.852660: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:25:28.734186: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.4110 - val_loss: 2.8026
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.2885 - val_loss: 2.7138
Epoch 3/30
23/23 - 0s - 6ms/step - loss: 0.2409 - val_loss: 2.6962
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.2050 - val_loss: 2.7849
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.1742 - val_loss: 2.7874
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.1427 - val_loss: 2.8693
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.1231 - val_loss: 3.0131
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.1146 - val_loss: 2.8258
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.1005 - val_loss: 2.9293
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0940 - val_loss: 2.9497
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0848 - val_loss: 2.9775
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0831 - val_loss: 2.9653
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0813 - val_loss: 2.9086
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8361
Per-joint RMSE: 0.9023 1.0846 0.6524 0.6024 0.9925 0.6557
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:31.822583: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:31.847757: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:25:32.697256: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:32.702120: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:32.702900: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:32.704565: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:32.705354: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:32.706090: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:32.788550: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:32.789457: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:32.790282: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:32.791005: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:25:33.085717: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.168153e-01  RMSE=8.466495e-01
  per-joint RMSE: 0.9271 1.2006 0.7238 0.5919 0.8338 0.6562
Residual LSTM:  MSE=6.990343e-01      RMSE=8.360828e-01
  per-joint RMSE: 0.9023 1.0846 0.6524 0.6024 0.9925 0.6557
Combined torque MSE=6.990343e-01     RMSE=8.360828e-01
  per-joint RMSE: 0.9023 1.0846 0.6524 0.6024 0.9925 0.6557
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:34.875432: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:34.899133: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:25:35.868840: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:35.873619: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:35.874450: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:35.876168: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:35.876990: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:35.877771: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:35.951549: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:35.952514: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:35.953299: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:35.954063: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:25:36.882482: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2861 - val_loss: 1.8077
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1500 - val_loss: 1.7742
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1321 - val_loss: 1.7838
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1201 - val_loss: 1.8015
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.1090 - val_loss: 1.8332
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.1050 - val_loss: 1.8235
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0928 - val_loss: 1.8062
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0853 - val_loss: 1.7692
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0829 - val_loss: 1.7506
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0812 - val_loss: 1.7589
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0788 - val_loss: 1.7448
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0759 - val_loss: 1.7387
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0741 - val_loss: 1.7387
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0715 - val_loss: 1.7433
Epoch 15/30
23/23 - 0s - 5ms/step - loss: 0.0722 - val_loss: 1.7355
Epoch 16/30
23/23 - 0s - 5ms/step - loss: 0.0705 - val_loss: 1.7460
Epoch 17/30
23/23 - 0s - 5ms/step - loss: 0.0693 - val_loss: 1.7084
Epoch 18/30
23/23 - 0s - 5ms/step - loss: 0.0693 - val_loss: 1.7604
Epoch 19/30
23/23 - 0s - 5ms/step - loss: 0.0686 - val_loss: 1.7340
Epoch 20/30
23/23 - 0s - 5ms/step - loss: 0.0670 - val_loss: 1.7125
Epoch 21/30
23/23 - 0s - 5ms/step - loss: 0.0674 - val_loss: 1.7093
Epoch 22/30
23/23 - 0s - 5ms/step - loss: 0.0672 - val_loss: 1.7435
Epoch 23/30
23/23 - 0s - 5ms/step - loss: 0.0655 - val_loss: 1.7211
Epoch 24/30
23/23 - 0s - 5ms/step - loss: 0.0660 - val_loss: 1.7238
Epoch 25/30
23/23 - 0s - 5ms/step - loss: 0.0650 - val_loss: 1.7186
Epoch 26/30
23/23 - 0s - 5ms/step - loss: 0.0637 - val_loss: 1.7148
Epoch 27/30
23/23 - 0s - 5ms/step - loss: 0.0638 - val_loss: 1.7270
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.7868
Per-joint RMSE: 0.8181 1.0568 0.6548 0.5964 0.8197 0.6869
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:41.566553: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:41.591620: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:25:42.438610: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:42.443482: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:42.444278: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:42.445980: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:42.446768: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:42.447497: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:42.525147: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:42.526058: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:42.526795: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:42.527528: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:25:42.821088: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.168153e-01  RMSE=8.466495e-01
  per-joint RMSE: 0.9271 1.2006 0.7238 0.5919 0.8338 0.6562
Residual LSTM:  MSE=6.190128e-01      RMSE=7.867736e-01
  per-joint RMSE: 0.8181 1.0568 0.6548 0.5964 0.8197 0.6869
Combined torque MSE=6.190128e-01     RMSE=7.867737e-01
  per-joint RMSE: 0.8181 1.0568 0.6548 0.5964 0.8197 0.6869
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:44.597526: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:44.621360: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:25:45.588802: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:45.593352: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:45.594152: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:45.595879: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:45.596670: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:45.597406: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:45.666526: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:45.667365: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:45.668108: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:45.668838: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:25:46.575408: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2650 - val_loss: 1.9112
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1445 - val_loss: 1.8800
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1188 - val_loss: 1.9373
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1043 - val_loss: 1.9873
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0936 - val_loss: 2.0341
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0862 - val_loss: 2.0220
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0816 - val_loss: 2.0138
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0791 - val_loss: 2.0134
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0763 - val_loss: 2.0178
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0734 - val_loss: 2.0295
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0726 - val_loss: 2.0313
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0708 - val_loss: 2.0105
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.7748
Per-joint RMSE: 0.7829 1.0291 0.6489 0.5774 0.8505 0.6722
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:25:49.551104: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:25:49.575366: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:25:50.408752: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:50.413363: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:50.414152: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:50.415847: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:50.416700: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:50.417478: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:50.491317: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:50.492234: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:50.492970: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:25:50.493695: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8944 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:25:50.790206: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.168153e-01  RMSE=8.466495e-01
  per-joint RMSE: 0.9271 1.2006 0.7238 0.5919 0.8338 0.6562
Residual LSTM:  MSE=6.002945e-01      RMSE=7.747867e-01
  per-joint RMSE: 0.7829 1.0291 0.6489 0.5774 0.8505 0.6722
Combined torque MSE=6.002945e-01     RMSE=7.747867e-01
  per-joint RMSE: 0.7829 1.0291 0.6489 0.5774 0.8505 0.6722
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=2                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz -t structured -s 2 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x78e75433c1f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz
   dt ≈ 0.026853339250055355
  dof = 6
  Train trajectories = 17
  Test trajectories  = 8
  Train samples = 7524
  Test samples  = 1515
################################################

2026-01-22 05:25:54.921903: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150 | type=structured | dof=6
################################################
2026-01-22 05:25:58.069902: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:25:58.069938: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:25:58.069944: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:25:58.069971: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:25:58.069977: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:25:58.069991: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:25:58.070026: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:25:58.070032: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:25:58.070047: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:25:58.070052: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   4.9s, Loss=3.39e+01, Inv=3.39e+01, For=1.91e+02, Power=1.21e+01
2026-01-22 05:26:02.907562: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  [eval] test_mse=1.007e+01  (n=1515)
Epoch 00050: Time=   7.3s, Loss=2.70e+00, Inv=2.70e+00, For=2.84e+01, Power=2.57e+00
Epoch 00100: Time=   8.3s, Loss=2.43e+00, Inv=2.43e+00, For=3.56e+01, Power=2.30e+00
Epoch 00150: Time=   9.3s, Loss=2.32e+00, Inv=2.32e+00, For=4.57e+01, Power=2.05e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
Torque MSE  = 1.523e+00
Torque RMSE = 1.234e+00
Per-joint MSE : 4.662e+00 1.193e+00 1.164e+00 5.976e-01 3.528e-01 1.165e+00
Per-joint RMSE: 2.159e+00 1.092e+00 1.079e+00 7.730e-01 5.940e-01 1.080e+00
Comp Time per Sample = 2.080e-07s / 4808424.7Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed2_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
Detected n_dof=6 (seed=2)
2026-01-22 05:26:09.410740: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 17 trajectories
2026-01-22 05:26:10.713268: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:26:10.713281: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:26:12.191363: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:26:12.191376: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:26:13.777504: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 17/17

Exporting split=test: 8 trajectories
  done 8/8

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (7284, 25, 24)  Y_train: (7284, 6)
X_test : (1428, 25, 24)  Y_test : (1428, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:26:15.792594: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:26:15.817006: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (7284, 25, 24), Y_train = (7284, 6)
  X_test  = (1428, 25, 24),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:26:16.753713: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:16.758301: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:16.759126: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:16.760729: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:16.761548: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:16.762312: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:16.839906: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:16.840863: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:16.841737: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:16.842497: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:26:17.735370: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2816 - val_loss: 2.0157
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1380 - val_loss: 1.9914
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1081 - val_loss: 1.9710
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.0937 - val_loss: 2.0116
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.0840 - val_loss: 2.0011
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0801 - val_loss: 1.9998
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0767 - val_loss: 1.9832
Epoch 8/30
23/23 - 0s - 4ms/step - loss: 0.0738 - val_loss: 1.9774
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0723 - val_loss: 1.9917
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0711 - val_loss: 1.9765
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0712 - val_loss: 1.9800
Epoch 12/30
23/23 - 0s - 4ms/step - loss: 0.0699 - val_loss: 1.9606
Epoch 13/30
23/23 - 0s - 3ms/step - loss: 0.0678 - val_loss: 1.9677
Epoch 14/30
23/23 - 0s - 3ms/step - loss: 0.0672 - val_loss: 1.9833
Epoch 15/30
23/23 - 0s - 3ms/step - loss: 0.0661 - val_loss: 1.9845
Epoch 16/30
23/23 - 0s - 3ms/step - loss: 0.0655 - val_loss: 1.9763
Epoch 17/30
23/23 - 0s - 3ms/step - loss: 0.0655 - val_loss: 1.9679
Epoch 18/30
23/23 - 0s - 3ms/step - loss: 0.0652 - val_loss: 1.9867
Epoch 19/30
23/23 - 0s - 3ms/step - loss: 0.0638 - val_loss: 1.9710
Epoch 20/30
23/23 - 0s - 3ms/step - loss: 0.0631 - val_loss: 1.9804
Epoch 21/30
23/23 - 0s - 3ms/step - loss: 0.0623 - val_loss: 1.9935
Epoch 22/30
23/23 - 0s - 3ms/step - loss: 0.0628 - val_loss: 2.0065
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2071
Per-joint RMSE: 2.1747 0.8754 1.0763 0.7620 0.6103 1.0656
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:26:21.225326: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:26:21.249955: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:26:22.086400: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:22.091112: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:22.091912: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:22.093548: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:22.094419: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:22.095153: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:22.171784: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:22.172626: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:22.173454: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:22.174267: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:26:22.469453: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.586266e+00  RMSE=1.259471e+00
  per-joint RMSE: 2.2202 1.0931 1.1076 0.7684 0.6099 1.0973
Residual LSTM:  MSE=1.457116e+00      RMSE=1.207111e+00
  per-joint RMSE: 2.1747 0.8754 1.0763 0.7620 0.6103 1.0656
Combined torque MSE=1.457116e+00     RMSE=1.207111e+00
  per-joint RMSE: 2.1747 0.8754 1.0763 0.7620 0.6103 1.0656
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (7284, 25, 6)  Y_train: (7284, 6)
X_test : (1428, 25, 6)  Y_test : (1428, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:26:24.204886: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:26:24.229303: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (7284, 25, 6), Y_train = (7284, 6)
  X_test  = (1428, 25, 6),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:26:25.179780: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:25.184447: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:25.185536: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:25.187306: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:25.188090: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:25.188823: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:25.269357: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:25.270270: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:25.271018: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:25.271842: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8945 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:26:26.159036: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 61ms/step - loss: 0.4210 - val_loss: 2.6112
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.3104 - val_loss: 2.7780
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.2584 - val_loss: 2.8243
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.2318 - val_loss: 2.7899
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.2086 - val_loss: 2.7090
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.1903 - val_loss: 2.7045
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.1751 - val_loss: 2.6872
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.1532 - val_loss: 2.6895
Epoch 9/30
23/23 - 0s - 4ms/step - loss: 0.1377 - val_loss: 2.6385
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.1074 - val_loss: 2.7190
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0950 - val_loss: 2.6639
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2410
Per-joint RMSE: 2.2875 0.8908 1.0296 0.7745 0.6042 1.0908
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:26:28.651798: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:26:28.676611: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:26:29.524678: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:29.529258: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:29.530058: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:29.531751: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:29.532545: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:29.533281: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:29.609740: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:29.610582: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:29.611316: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:29.612720: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:26:29.906098: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.586266e+00  RMSE=1.259471e+00
  per-joint RMSE: 2.2202 1.0931 1.1076 0.7684 0.6099 1.0973
Residual LSTM:  MSE=1.540156e+00      RMSE=1.241030e+00
  per-joint RMSE: 2.2875 0.8908 1.0296 0.7745 0.6042 1.0908
Combined torque MSE=1.540156e+00     RMSE=1.241030e+00
  per-joint RMSE: 2.2875 0.8908 1.0296 0.7745 0.6042 1.0908
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:26:31.676745: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:26:31.701103: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:26:32.632708: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:32.637458: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:32.638249: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:32.639900: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:32.640745: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:32.641527: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:32.713057: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:32.713901: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:32.714648: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:32.715385: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:26:33.611242: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2919 - val_loss: 1.9356
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1491 - val_loss: 1.9824
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1286 - val_loss: 2.0062
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.1151 - val_loss: 2.0343
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.1034 - val_loss: 2.0285
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0949 - val_loss: 2.0507
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0872 - val_loss: 2.0821
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0849 - val_loss: 2.0693
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0806 - val_loss: 2.0859
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0775 - val_loss: 2.0878
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0788 - val_loss: 2.0978
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2314
Per-joint RMSE: 2.1786 1.0156 1.0776 0.8052 0.5632 1.0925
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:26:36.102923: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:26:36.127793: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:26:36.967901: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:36.972699: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:36.973492: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:36.975214: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:36.976010: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:36.976753: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:37.051127: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:37.051957: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:37.052701: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:37.053432: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:26:37.352638: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.586266e+00  RMSE=1.259471e+00
  per-joint RMSE: 2.2202 1.0931 1.1076 0.7684 0.6099 1.0973
Residual LSTM:  MSE=1.516304e+00      RMSE=1.231383e+00
  per-joint RMSE: 2.1786 1.0156 1.0776 0.8052 0.5632 1.0925
Combined torque MSE=1.516304e+00     RMSE=1.231383e+00
  per-joint RMSE: 2.1786 1.0156 1.0776 0.8052 0.5632 1.0925
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:26:39.126823: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:26:39.150618: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:26:40.080425: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:40.085311: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:40.086099: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:40.087811: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:40.088598: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:40.089321: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:40.167856: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:40.168705: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:40.169450: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:40.170180: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:26:41.092869: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2586 - val_loss: 2.0335
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1346 - val_loss: 1.8921
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1082 - val_loss: 1.9686
Epoch 4/30
23/23 - 0s - 4ms/step - loss: 0.0949 - val_loss: 1.9921
Epoch 5/30
23/23 - 0s - 4ms/step - loss: 0.0874 - val_loss: 1.9915
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0827 - val_loss: 1.9985
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0781 - val_loss: 2.0016
Epoch 8/30
23/23 - 0s - 4ms/step - loss: 0.0758 - val_loss: 2.0154
Epoch 9/30
23/23 - 0s - 4ms/step - loss: 0.0737 - val_loss: 2.0026
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0723 - val_loss: 2.0142
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0714 - val_loss: 2.0290
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0693 - val_loss: 2.0246
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.1894
Per-joint RMSE: 2.1198 0.8628 1.0350 0.7783 0.6220 1.0892
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:26:43.684321: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:26:43.708795: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:26:44.558205: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:44.562933: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:44.563721: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:44.565416: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:44.566196: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:44.566942: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:44.646078: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:44.646918: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:44.647748: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:44.648476: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:26:44.945421: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.586266e+00  RMSE=1.259471e+00
  per-joint RMSE: 2.2202 1.0931 1.1076 0.7684 0.6099 1.0973
Residual LSTM:  MSE=1.414728e+00      RMSE=1.189423e+00
  per-joint RMSE: 2.1198 0.8628 1.0350 0.7783 0.6220 1.0892
Combined torque MSE=1.414728e+00     RMSE=1.189423e+00
  per-joint RMSE: 2.1198 0.8628 1.0350 0.7783 0.6220 1.0892
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (7059, 50, 24)  Y_train: (7059, 6)
X_test : (1353, 50, 24)  Y_test : (1353, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:26:46.771410: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:26:46.795428: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (7059, 50, 24), Y_train = (7059, 6)
  X_test  = (1353, 50, 24),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:26:47.767662: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:47.772281: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:47.773079: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:47.774769: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:47.775560: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:47.776293: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:47.851750: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:47.852593: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:47.853393: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:47.854204: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:26:48.774447: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2616 - val_loss: 2.0280
Epoch 2/30
23/23 - 0s - 5ms/step - loss: 0.1400 - val_loss: 2.0277
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1160 - val_loss: 2.0387
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1005 - val_loss: 2.0005
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0922 - val_loss: 2.0341
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0871 - val_loss: 2.0414
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0831 - val_loss: 1.9987
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0787 - val_loss: 2.0097
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0755 - val_loss: 1.9988
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0741 - val_loss: 1.9816
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0730 - val_loss: 1.9917
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0724 - val_loss: 2.0189
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0720 - val_loss: 1.9972
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0699 - val_loss: 1.9941
Epoch 15/30
23/23 - 0s - 5ms/step - loss: 0.0698 - val_loss: 1.9835
Epoch 16/30
23/23 - 0s - 5ms/step - loss: 0.0676 - val_loss: 1.9836
Epoch 17/30
23/23 - 0s - 5ms/step - loss: 0.0675 - val_loss: 1.9867
Epoch 18/30
23/23 - 0s - 5ms/step - loss: 0.0671 - val_loss: 2.0042
Epoch 19/30
23/23 - 0s - 5ms/step - loss: 0.0663 - val_loss: 1.9899
Epoch 20/30
23/23 - 0s - 5ms/step - loss: 0.0651 - val_loss: 2.0049
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.1550
Per-joint RMSE: 2.1086 0.7816 0.9833 0.7358 0.6140 1.0303
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:26:52.652340: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:26:52.676655: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:26:53.528637: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:53.533286: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:53.534171: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:53.536199: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:53.536984: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:53.537715: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:53.612456: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:53.613447: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:53.614269: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:53.615008: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:26:53.914611: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.541393e+00  RMSE=1.241529e+00
  per-joint RMSE: 2.1929 1.0679 1.0904 0.7567 0.6239 1.0716
Residual LSTM:  MSE=1.333983e+00      RMSE=1.154982e+00
  per-joint RMSE: 2.1086 0.7816 0.9833 0.7358 0.6140 1.0303
Combined torque MSE=1.333983e+00     RMSE=1.154982e+00
  per-joint RMSE: 2.1086 0.7816 0.9833 0.7358 0.6140 1.0303
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (7059, 50, 6)  Y_train: (7059, 6)
X_test : (1353, 50, 6)  Y_test : (1353, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:26:55.672197: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:26:55.695848: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (7059, 50, 6), Y_train = (7059, 6)
  X_test  = (1353, 50, 6),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:26:56.644171: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:56.649316: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:56.650104: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:56.651759: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:56.652542: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:56.653281: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:56.727357: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:56.728196: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:56.728938: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:26:56.729735: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:26:57.628559: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.3997 - val_loss: 2.6578
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.2840 - val_loss: 2.6227
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.2278 - val_loss: 2.6478
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1847 - val_loss: 2.5426
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.1528 - val_loss: 2.6594
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.1314 - val_loss: 2.7076
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.1226 - val_loss: 2.6279
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.1130 - val_loss: 2.6277
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0999 - val_loss: 2.6337
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0988 - val_loss: 2.7405
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0882 - val_loss: 2.7008
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0864 - val_loss: 2.6927
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0887 - val_loss: 2.6730
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0813 - val_loss: 2.6765
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.1977
Per-joint RMSE: 2.2343 0.8066 0.9956 0.7380 0.5830 1.0433
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:27:00.805130: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:27:00.829504: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:27:01.669483: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:01.674221: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:01.675085: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:01.676828: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:01.677612: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:01.678343: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:01.756592: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:01.757431: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:01.758170: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:01.758901: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:27:02.048970: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.541393e+00  RMSE=1.241529e+00
  per-joint RMSE: 2.1929 1.0679 1.0904 0.7567 0.6239 1.0716
Residual LSTM:  MSE=1.434435e+00      RMSE=1.197679e+00
  per-joint RMSE: 2.2343 0.8066 0.9956 0.7380 0.5830 1.0433
Combined torque MSE=1.434435e+00     RMSE=1.197679e+00
  per-joint RMSE: 2.2343 0.8066 0.9956 0.7380 0.5830 1.0433
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:27:03.865229: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:27:03.888866: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:27:04.850618: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:04.855516: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:04.856318: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:04.857861: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:04.858644: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:04.859382: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:04.936248: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:04.937164: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:04.937908: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:04.938640: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:27:05.835587: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2925 - val_loss: 1.9796
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1548 - val_loss: 1.9328
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1323 - val_loss: 1.9408
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1191 - val_loss: 1.9601
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.1071 - val_loss: 1.9968
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0983 - val_loss: 1.9536
Epoch 7/30
23/23 - 0s - 6ms/step - loss: 0.0936 - val_loss: 1.9226
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0887 - val_loss: 1.9421
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0838 - val_loss: 1.9228
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0794 - val_loss: 1.9633
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0788 - val_loss: 1.9425
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0766 - val_loss: 2.0050
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0757 - val_loss: 1.9779
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0740 - val_loss: 1.9957
Epoch 15/30
23/23 - 0s - 5ms/step - loss: 0.0717 - val_loss: 2.0080
Epoch 16/30
23/23 - 0s - 5ms/step - loss: 0.0710 - val_loss: 1.9895
Epoch 17/30
23/23 - 0s - 5ms/step - loss: 0.0717 - val_loss: 1.9829
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2392
Per-joint RMSE: 2.1718 1.0835 1.0857 0.7845 0.5981 1.0823
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:27:09.395482: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:27:09.419530: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:27:10.265960: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:10.270608: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:10.271398: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:10.273080: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:10.273878: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:10.274614: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:10.348254: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:10.349169: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:10.349909: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:10.350636: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:27:10.650865: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.541393e+00  RMSE=1.241529e+00
  per-joint RMSE: 2.1929 1.0679 1.0904 0.7567 0.6239 1.0716
Residual LSTM:  MSE=1.535661e+00      RMSE=1.239218e+00
  per-joint RMSE: 2.1718 1.0835 1.0857 0.7845 0.5981 1.0823
Combined torque MSE=1.535661e+00     RMSE=1.239218e+00
  per-joint RMSE: 2.1718 1.0835 1.0857 0.7845 0.5981 1.0823
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:27:12.443327: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:27:12.467310: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:27:13.442822: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:13.447525: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:13.448405: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:13.450113: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:13.450892: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:13.451626: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:13.521962: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:13.522789: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:13.523622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:13.524348: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:27:14.436975: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2855 - val_loss: 2.1333
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1463 - val_loss: 1.9206
Epoch 3/30
23/23 - 0s - 6ms/step - loss: 0.1219 - val_loss: 1.9182
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1075 - val_loss: 1.9286
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0976 - val_loss: 1.9168
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0900 - val_loss: 1.9029
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0850 - val_loss: 1.8920
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0818 - val_loss: 1.8813
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0787 - val_loss: 1.8915
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0765 - val_loss: 1.8734
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0746 - val_loss: 1.8989
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0736 - val_loss: 1.9003
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0727 - val_loss: 1.9031
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0711 - val_loss: 1.9145
Epoch 15/30
23/23 - 0s - 5ms/step - loss: 0.0700 - val_loss: 1.9112
Epoch 16/30
23/23 - 0s - 5ms/step - loss: 0.0700 - val_loss: 1.9313
Epoch 17/30
23/23 - 0s - 5ms/step - loss: 0.0685 - val_loss: 1.9290
Epoch 18/30
23/23 - 0s - 5ms/step - loss: 0.0677 - val_loss: 1.9133
Epoch 19/30
23/23 - 0s - 5ms/step - loss: 0.0662 - val_loss: 1.9258
Epoch 20/30
23/23 - 0s - 5ms/step - loss: 0.0661 - val_loss: 1.9158
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.1194
Per-joint RMSE: 1.9896 0.7685 0.9923 0.7294 0.6164 1.0360
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:27:18.364377: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:27:18.388622: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:27:19.248070: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:19.252776: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:19.253651: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:19.255405: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:19.256199: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:19.256932: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:19.335912: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:19.336745: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:19.337477: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:27:19.338288: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:27:19.640227: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.541393e+00  RMSE=1.241529e+00
  per-joint RMSE: 2.1929 1.0679 1.0904 0.7567 0.6239 1.0716
Residual LSTM:  MSE=1.253130e+00      RMSE=1.119433e+00
  per-joint RMSE: 1.9896 0.7685 0.9923 0.7294 0.6164 1.0360
Combined torque MSE=1.253130e+00     RMSE=1.119433e+00
  per-joint RMSE: 1.9896 0.7685 0.9923 0.7294 0.6164 1.0360
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

