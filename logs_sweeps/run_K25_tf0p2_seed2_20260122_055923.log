################################################################################################################
### RUN: K=25 test_fraction=0.2 seed=2                                                                       ###
### npz_in=/workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz ###
################################################################################################################

#####################
### 1) PREPROCESS ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_delan_dataset.py --qdd True --col_format wide --trajectory_amount 25 --test_fraction 0.2 --seed 2 --raw_csv /workspace/shared/data/raw/delan_UR3_Load0_combined_26.csv --out_npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Saved: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz
Trajectories: train=20 test=5
Exists: True

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=0                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz -t structured -s 0 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x7b35f7a2c1f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz
   dt ≈ 0.026853339250055355
  dof = 6
  Train trajectories = 20
  Test trajectories  = 5
  Train samples = 7533
  Test samples  = 1506
################################################

2026-01-22 05:09:25.884484: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150 | type=structured | dof=6
################################################
2026-01-22 05:09:29.079542: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:29.079581: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:29.079588: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:29.079615: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:29.079620: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:29.079635: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:29.079672: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:29.079678: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:29.079694: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:29.079699: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.1s, Loss=4.80e+01, Inv=4.80e+01, For=2.06e+02, Power=7.94e+00
2026-01-22 05:09:34.080217: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  [eval] test_mse=2.225e+01  (n=1506)
Epoch 00050: Time=   7.5s, Loss=2.80e+00, Inv=2.80e+00, For=3.55e+01, Power=2.47e+00
Epoch 00100: Time=   8.5s, Loss=2.43e+00, Inv=2.43e+00, For=4.29e+01, Power=2.25e+00
Epoch 00150: Time=   9.4s, Loss=2.32e+00, Inv=2.32e+00, For=4.66e+01, Power=2.08e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
Torque MSE  = 2.802e+00
Torque RMSE = 1.674e+00
Per-joint MSE : 6.756e+00 6.645e+00 1.976e-01 4.511e-01 1.933e+00 8.273e-01
Per-joint RMSE: 2.599e+00 2.578e+00 4.445e-01 6.717e-01 1.390e+00 9.096e-01
Comp Time per Sample = 2.223e-07s / 4497563.1Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
Detected n_dof=6 (seed=0)
2026-01-22 05:09:40.611839: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 20 trajectories
2026-01-22 05:09:41.897909: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:41.897922: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:43.434767: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:43.434781: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:09:44.989897: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 20/20

Exporting split=test: 5 trajectories
  done 5/5

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (7284, 25, 24)  Y_train: (7284, 6)
X_test : (1428, 25, 24)  Y_test : (1428, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:09:47.060130: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:09:47.084706: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (7284, 25, 24), Y_train = (7284, 6)
  X_test  = (1428, 25, 24),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:09:48.042988: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:48.047996: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:48.048905: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:48.050466: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:48.051269: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:48.052023: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:48.125228: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:48.126181: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:48.126957: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:48.127720: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8384 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:09:49.063328: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2714 - val_loss: 2.0615
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1361 - val_loss: 2.0403
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1071 - val_loss: 2.0510
Epoch 4/30
23/23 - 0s - 4ms/step - loss: 0.0929 - val_loss: 2.0786
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.0833 - val_loss: 2.0681
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0780 - val_loss: 2.0671
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0740 - val_loss: 2.0893
Epoch 8/30
23/23 - 0s - 4ms/step - loss: 0.0730 - val_loss: 2.0877
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0721 - val_loss: 2.0907
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0707 - val_loss: 2.0871
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0698 - val_loss: 2.1063
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0688 - val_loss: 2.0928
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6653
Per-joint RMSE: 2.6893 2.4351 0.3922 0.6786 1.4011 0.9488
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:09:51.664075: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:09:51.688919: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:09:52.541311: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:52.546115: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:52.546914: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:52.548554: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:52.549347: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:52.550089: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:52.624463: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:52.625310: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:52.626148: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:52.626874: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:09:52.923866: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.917824e+00  RMSE=1.708164e+00
  per-joint RMSE: 2.6650 2.6118 0.4494 0.6891 1.4270 0.9329
Residual LSTM:  MSE=2.773287e+00      RMSE=1.665319e+00
  per-joint RMSE: 2.6893 2.4351 0.3922 0.6786 1.4011 0.9488
Combined torque MSE=2.773287e+00     RMSE=1.665319e+00
  per-joint RMSE: 2.6893 2.4351 0.3922 0.6786 1.4011 0.9488
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (7284, 25, 6)  Y_train: (7284, 6)
X_test : (1428, 25, 6)  Y_test : (1428, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:09:54.683098: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:09:54.707769: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (7284, 25, 6), Y_train = (7284, 6)
  X_test  = (1428, 25, 6),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:09:55.647043: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:55.651954: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:55.652751: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:55.654472: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:55.655260: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:55.656002: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:55.736882: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:55.737718: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:55.738454: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:09:55.739279: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:09:56.653848: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.4216 - val_loss: 2.4508
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.3171 - val_loss: 2.6536
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.2605 - val_loss: 2.5788
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.2293 - val_loss: 2.4892
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.2045 - val_loss: 2.5291
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.1801 - val_loss: 2.5393
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.1620 - val_loss: 2.5573
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.1512 - val_loss: 2.5379
Epoch 9/30
23/23 - 0s - 4ms/step - loss: 0.1251 - val_loss: 2.5520
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.1132 - val_loss: 2.5179
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0987 - val_loss: 2.5627
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6749
Per-joint RMSE: 2.7423 2.3233 0.4842 0.7047 1.5256 0.9243
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:09:59.186575: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:09:59.211139: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:10:00.067670: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:00.072576: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:00.073417: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:00.075088: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:00.075932: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:00.076712: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:00.159691: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:00.160655: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:00.161452: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:00.162235: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:10:00.455512: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.917824e+00  RMSE=1.708164e+00
  per-joint RMSE: 2.6650 2.6118 0.4494 0.6891 1.4270 0.9329
Residual LSTM:  MSE=2.805140e+00      RMSE=1.674855e+00
  per-joint RMSE: 2.7423 2.3233 0.4842 0.7047 1.5256 0.9243
Combined torque MSE=2.805140e+00     RMSE=1.674855e+00
  per-joint RMSE: 2.7423 2.3233 0.4842 0.7047 1.5256 0.9243
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:02.246513: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:02.271299: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:10:03.216895: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:03.221617: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:03.222416: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:03.223960: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:03.224750: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:03.225492: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:03.299366: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:03.300204: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:03.300952: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:03.301743: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:10:04.184560: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 61ms/step - loss: 0.2770 - val_loss: 1.8489
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1497 - val_loss: 1.8105
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1293 - val_loss: 1.8125
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.1150 - val_loss: 1.8533
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.1039 - val_loss: 1.8258
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0940 - val_loss: 1.8257
Epoch 7/30
23/23 - 0s - 4ms/step - loss: 0.0886 - val_loss: 1.8070
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0842 - val_loss: 1.8214
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0853 - val_loss: 1.8165
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0775 - val_loss: 1.8227
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0729 - val_loss: 1.8401
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0730 - val_loss: 1.8680
Epoch 13/30
23/23 - 0s - 3ms/step - loss: 0.0723 - val_loss: 1.8484
Epoch 14/30
23/23 - 0s - 3ms/step - loss: 0.0742 - val_loss: 1.8480
Epoch 15/30
23/23 - 0s - 3ms/step - loss: 0.0720 - val_loss: 1.8863
Epoch 16/30
23/23 - 0s - 3ms/step - loss: 0.0684 - val_loss: 1.8881
Epoch 17/30
23/23 - 0s - 3ms/step - loss: 0.0680 - val_loss: 1.8771
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6735
Per-joint RMSE: 2.6210 2.5268 0.3287 0.6724 1.4459 0.9479
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:07.248784: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:07.273434: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:10:08.123132: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:08.128193: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:08.128990: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:08.130823: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:08.131611: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:08.132356: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:08.211555: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:08.212428: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:08.213174: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:08.213909: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:10:08.509345: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.917824e+00  RMSE=1.708164e+00
  per-joint RMSE: 2.6650 2.6118 0.4494 0.6891 1.4270 0.9329
Residual LSTM:  MSE=2.800655e+00      RMSE=1.673516e+00
  per-joint RMSE: 2.6210 2.5268 0.3287 0.6724 1.4459 0.9479
Combined torque MSE=2.800655e+00     RMSE=1.673516e+00
  per-joint RMSE: 2.6210 2.5268 0.3287 0.6724 1.4459 0.9479
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:10.331958: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:10.357057: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:10:11.319640: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:11.324514: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:11.325315: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:11.326965: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:11.327757: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:11.328489: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:11.399498: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:11.400328: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:11.401147: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:11.401884: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8377 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:10:12.294007: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2782 - val_loss: 1.9822
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1385 - val_loss: 1.9602
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1109 - val_loss: 2.0594
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.0979 - val_loss: 2.1028
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.0898 - val_loss: 2.1088
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0834 - val_loss: 2.1125
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0790 - val_loss: 2.1220
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0756 - val_loss: 2.1192
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0727 - val_loss: 2.1114
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0709 - val_loss: 2.1169
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0702 - val_loss: 2.1346
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0682 - val_loss: 2.1380
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6686
Per-joint RMSE: 2.6624 2.4134 0.4109 0.7017 1.4801 0.9695
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:14.925276: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:14.950404: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:10:15.810224: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:15.814993: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:15.815783: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:15.817476: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:15.818265: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:15.819010: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:15.901096: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:15.902009: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:15.902837: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:15.903566: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:10:16.195828: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.917824e+00  RMSE=1.708164e+00
  per-joint RMSE: 2.6650 2.6118 0.4494 0.6891 1.4270 0.9329
Residual LSTM:  MSE=2.784088e+00      RMSE=1.668559e+00
  per-joint RMSE: 2.6624 2.4134 0.4109 0.7017 1.4801 0.9695
Combined torque MSE=2.784087e+00     RMSE=1.668558e+00
  per-joint RMSE: 2.6624 2.4134 0.4109 0.7017 1.4801 0.9695
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (7059, 50, 24)  Y_train: (7059, 6)
X_test : (1353, 50, 24)  Y_test : (1353, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:18.015056: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:18.039479: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (7059, 50, 24), Y_train = (7059, 6)
  X_test  = (1353, 50, 24),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:10:19.037704: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:19.042496: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:19.043299: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:19.044852: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:19.045639: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:19.046367: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:19.122869: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:19.123838: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:19.124622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:19.125351: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:10:20.030732: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2641 - val_loss: 2.0676
Epoch 2/30
23/23 - 0s - 5ms/step - loss: 0.1411 - val_loss: 2.0942
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1147 - val_loss: 2.0991
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.0989 - val_loss: 2.0620
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0910 - val_loss: 2.0739
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0850 - val_loss: 2.0785
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0805 - val_loss: 2.0539
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0780 - val_loss: 2.0545
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0761 - val_loss: 2.0469
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0750 - val_loss: 2.0507
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0732 - val_loss: 2.0474
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0717 - val_loss: 2.0606
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0707 - val_loss: 2.0474
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0699 - val_loss: 2.0730
Epoch 15/30
23/23 - 0s - 5ms/step - loss: 0.0686 - val_loss: 2.0646
Epoch 16/30
23/23 - 0s - 5ms/step - loss: 0.0679 - val_loss: 2.0783
Epoch 17/30
23/23 - 0s - 5ms/step - loss: 0.0672 - val_loss: 2.0893
Epoch 18/30
23/23 - 0s - 5ms/step - loss: 0.0666 - val_loss: 2.0852
Epoch 19/30
23/23 - 0s - 5ms/step - loss: 0.0664 - val_loss: 2.0942
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6041
Per-joint RMSE: 2.6059 2.2410 0.3665 0.6836 1.4795 0.9142
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:23.809216: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:23.834162: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:10:24.685272: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:24.690146: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:24.690938: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:24.692627: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:24.693413: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:24.694143: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:24.779954: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:24.780783: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:24.781523: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:24.782252: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:10:25.075975: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.794116e+00  RMSE=1.671561e+00
  per-joint RMSE: 2.6333 2.5138 0.4500 0.6893 1.4061 0.9256
Residual LSTM:  MSE=2.573204e+00      RMSE=1.604121e+00
  per-joint RMSE: 2.6059 2.2410 0.3665 0.6836 1.4795 0.9142
Combined torque MSE=2.573204e+00     RMSE=1.604121e+00
  per-joint RMSE: 2.6059 2.2410 0.3665 0.6836 1.4795 0.9142
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (7059, 50, 6)  Y_train: (7059, 6)
X_test : (1353, 50, 6)  Y_test : (1353, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:26.927174: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:26.952006: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (7059, 50, 6), Y_train = (7059, 6)
  X_test  = (1353, 50, 6),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:10:27.909409: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:27.914136: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:27.914959: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:27.916555: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:27.917914: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:27.918745: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:27.997281: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:27.998152: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:27.998932: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:27.999700: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:10:28.914417: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.3923 - val_loss: 2.3983
Epoch 2/30
23/23 - 0s - 5ms/step - loss: 0.2855 - val_loss: 2.6861
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.2324 - val_loss: 2.5807
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1790 - val_loss: 2.5661
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.1449 - val_loss: 2.5345
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.1160 - val_loss: 2.6334
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.1029 - val_loss: 2.6302
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0977 - val_loss: 2.6285
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0910 - val_loss: 2.6528
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0857 - val_loss: 2.6447
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0817 - val_loss: 2.6662
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6610
Per-joint RMSE: 2.6920 2.3061 0.4329 0.7087 1.5534 0.9411
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:31.746590: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:31.771728: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:10:32.636276: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:32.644607: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:32.645397: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:32.647157: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:32.647965: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:32.648760: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:32.729240: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:32.730081: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:32.730837: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:32.731563: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:10:33.019238: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.794116e+00  RMSE=1.671561e+00
  per-joint RMSE: 2.6333 2.5138 0.4500 0.6893 1.4061 0.9256
Residual LSTM:  MSE=2.758894e+00      RMSE=1.660992e+00
  per-joint RMSE: 2.6920 2.3061 0.4329 0.7087 1.5534 0.9411
Combined torque MSE=2.758894e+00     RMSE=1.660992e+00
  per-joint RMSE: 2.6920 2.3061 0.4329 0.7087 1.5534 0.9411
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:34.820315: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:34.844592: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:10:35.820457: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:35.825405: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:35.826275: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:35.827824: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:35.828614: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:35.829336: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:35.907027: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:35.907867: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:35.908613: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:35.909396: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:10:36.828000: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.3011 - val_loss: 1.8594
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1549 - val_loss: 1.8359
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1334 - val_loss: 1.8660
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1200 - val_loss: 1.9214
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.1184 - val_loss: 1.9311
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.1031 - val_loss: 1.8834
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0915 - val_loss: 1.8889
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0891 - val_loss: 1.8792
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0827 - val_loss: 1.8675
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0823 - val_loss: 1.8855
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0800 - val_loss: 1.8830
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0784 - val_loss: 1.8514
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6544
Per-joint RMSE: 2.5741 2.5126 0.3292 0.6965 1.4024 0.9603
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:39.789596: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:39.813969: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:10:40.676849: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:40.681691: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:40.682794: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:40.684474: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:40.685294: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:40.686028: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:40.766371: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:40.767284: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:40.768030: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:40.768761: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8378 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:10:41.061958: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.794116e+00  RMSE=1.671561e+00
  per-joint RMSE: 2.6333 2.5138 0.4500 0.6893 1.4061 0.9256
Residual LSTM:  MSE=2.736939e+00      RMSE=1.654370e+00
  per-joint RMSE: 2.5741 2.5126 0.3292 0.6965 1.4024 0.9603
Combined torque MSE=2.736939e+00     RMSE=1.654370e+00
  per-joint RMSE: 2.5741 2.5126 0.3292 0.6965 1.4024 0.9603
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:42.840940: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:42.865272: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:10:43.836886: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:43.841585: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:43.842397: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:43.844008: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:43.844799: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:43.845533: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:43.925458: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:43.926297: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:43.927043: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:43.927771: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8519 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:10:44.832732: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2640 - val_loss: 1.8918
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1455 - val_loss: 1.7810
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1165 - val_loss: 1.7718
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.0983 - val_loss: 1.8030
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0901 - val_loss: 1.7987
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0841 - val_loss: 1.8371
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0812 - val_loss: 1.8607
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0803 - val_loss: 1.8681
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0786 - val_loss: 1.8581
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0744 - val_loss: 1.8981
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0735 - val_loss: 1.9249
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0716 - val_loss: 1.9401
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0706 - val_loss: 1.9566
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6255
Per-joint RMSE: 2.5933 2.3625 0.3952 0.6711 1.4332 0.9410
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:10:47.926107: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:10:47.951113: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:10:48.816629: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:48.821379: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:48.822167: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:48.823834: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:48.824619: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:48.825353: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:48.906121: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:48.906961: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:48.907703: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:10:48.908426: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:10:49.203893: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.794116e+00  RMSE=1.671561e+00
  per-joint RMSE: 2.6333 2.5138 0.4500 0.6893 1.4061 0.9256
Residual LSTM:  MSE=2.642128e+00      RMSE=1.625462e+00
  per-joint RMSE: 2.5933 2.3625 0.3952 0.6711 1.4332 0.9410
Combined torque MSE=2.642128e+00     RMSE=1.625462e+00
  per-joint RMSE: 2.5933 2.3625 0.3952 0.6711 1.4332 0.9410
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=1                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz -t structured -s 1 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x7a71f7bb81f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz
   dt ≈ 0.026853339250055355
  dof = 6
  Train trajectories = 20
  Test trajectories  = 5
  Train samples = 7533
  Test samples  = 1506
################################################

2026-01-22 05:10:53.413470: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150 | type=structured | dof=6
################################################
2026-01-22 05:10:56.589678: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:10:56.589715: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:10:56.589722: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:10:56.589750: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:10:56.589755: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:10:56.589770: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:10:56.589807: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:10:56.589813: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:10:56.589829: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:10:56.589833: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.1s, Loss=6.11e+01, Inv=6.11e+01, For=2.88e+02, Power=9.29e+00
2026-01-22 05:11:01.548459: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  [eval] test_mse=1.067e+01  (n=1506)
Epoch 00050: Time=   7.5s, Loss=2.91e+00, Inv=2.91e+00, For=4.43e+01, Power=2.68e+00
Epoch 00100: Time=   8.4s, Loss=2.52e+00, Inv=2.52e+00, For=5.53e+01, Power=2.45e+00
Epoch 00150: Time=   9.3s, Loss=2.38e+00, Inv=2.38e+00, For=6.17e+01, Power=2.25e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
Torque MSE  = 7.488e-01
Torque RMSE = 8.653e-01
Per-joint MSE : 8.270e-01 1.677e+00 5.387e-01 3.015e-01 7.120e-01 4.363e-01
Per-joint RMSE: 9.094e-01 1.295e+00 7.340e-01 5.491e-01 8.438e-01 6.606e-01
Comp Time per Sample = 2.109e-07s / 4742590.1Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
Detected n_dof=6 (seed=1)
2026-01-22 05:11:08.035867: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 20 trajectories
2026-01-22 05:11:09.337729: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:11:09.337741: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:11:10.938898: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:11:10.938912: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:11:12.448629: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 20/20

Exporting split=test: 5 trajectories
  done 5/5

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (7284, 25, 24)  Y_train: (7284, 6)
X_test : (1428, 25, 24)  Y_test : (1428, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:14.487044: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:14.510835: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (7284, 25, 24), Y_train = (7284, 6)
  X_test  = (1428, 25, 24),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:11:15.472602: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:15.477272: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:15.478174: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:15.479893: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:15.480708: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:15.481484: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:15.555668: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:15.556528: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:15.557299: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:15.558052: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8521 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:11:16.440864: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2692 - val_loss: 2.2510
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1364 - val_loss: 2.0763
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1077 - val_loss: 2.0846
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.0921 - val_loss: 2.1272
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.0838 - val_loss: 2.1676
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0783 - val_loss: 2.1711
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0744 - val_loss: 2.1824
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0735 - val_loss: 2.1776
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0721 - val_loss: 2.1835
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0699 - val_loss: 2.1801
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0691 - val_loss: 2.1854
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0676 - val_loss: 2.1746
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8265
Per-joint RMSE: 0.7877 1.1543 0.7379 0.5870 0.8658 0.7122
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:19.064557: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:19.089419: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:11:19.944396: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:19.949213: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:19.950010: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:19.951740: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:19.952522: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:19.953255: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:20.033452: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:20.034287: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:20.035023: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:20.035838: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:11:20.328185: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.658742e-01  RMSE=8.751424e-01
  per-joint RMSE: 0.9305 1.2933 0.7455 0.5589 0.8568 0.6743
Residual LSTM:  MSE=6.831660e-01      RMSE=8.265386e-01
  per-joint RMSE: 0.7877 1.1543 0.7379 0.5870 0.8658 0.7122
Combined torque MSE=6.831660e-01     RMSE=8.265386e-01
  per-joint RMSE: 0.7877 1.1543 0.7379 0.5870 0.8658 0.7122
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (7284, 25, 6)  Y_train: (7284, 6)
X_test : (1428, 25, 6)  Y_test : (1428, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:22.083865: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:22.108258: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (7284, 25, 6), Y_train = (7284, 6)
  X_test  = (1428, 25, 6),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:11:23.039470: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:23.044102: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:23.044888: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:23.046624: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:23.047405: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:23.048147: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:23.128414: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:23.129250: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:23.129990: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:23.130728: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:11:24.051563: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.4207 - val_loss: 2.4791
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.3268 - val_loss: 2.5898
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.2667 - val_loss: 2.6708
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.2332 - val_loss: 2.7877
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.2084 - val_loss: 2.8921
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.1887 - val_loss: 2.8489
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.1711 - val_loss: 2.8995
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.1465 - val_loss: 2.8965
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.1226 - val_loss: 3.0477
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.1012 - val_loss: 2.9474
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.1020 - val_loss: 2.9272
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8792
Per-joint RMSE: 0.8924 1.2281 0.6863 0.5743 1.0220 0.6987
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:26.550993: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:26.576508: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:11:27.442153: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:27.446939: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:27.447784: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:27.449501: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:27.450344: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:27.451760: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:27.531839: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:27.532734: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:27.533529: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:27.534499: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:11:27.826374: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.658742e-01  RMSE=8.751424e-01
  per-joint RMSE: 0.9305 1.2933 0.7455 0.5589 0.8568 0.6743
Residual LSTM:  MSE=7.730197e-01      RMSE=8.792154e-01
  per-joint RMSE: 0.8924 1.2281 0.6863 0.5743 1.0220 0.6987
Combined torque MSE=7.730197e-01     RMSE=8.792154e-01
  per-joint RMSE: 0.8924 1.2281 0.6863 0.5743 1.0220 0.6987
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:29.655653: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:29.680046: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:11:30.631263: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:30.635871: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:30.636834: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:30.642791: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:30.643587: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:30.644321: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:30.720734: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:30.721587: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:30.722390: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:30.723209: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:11:31.619219: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2803 - val_loss: 1.7691
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1509 - val_loss: 1.7707
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1275 - val_loss: 1.7585
Epoch 4/30
23/23 - 0s - 4ms/step - loss: 0.1148 - val_loss: 1.7849
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.1039 - val_loss: 1.8135
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0948 - val_loss: 1.8299
Epoch 7/30
23/23 - 0s - 4ms/step - loss: 0.0854 - val_loss: 1.8490
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0807 - val_loss: 1.8272
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0766 - val_loss: 1.8603
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0761 - val_loss: 1.8550
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0729 - val_loss: 1.8587
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0741 - val_loss: 1.8569
Epoch 13/30
23/23 - 0s - 3ms/step - loss: 0.0746 - val_loss: 1.8474
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8286
Per-joint RMSE: 0.8356 1.2149 0.6888 0.5658 0.8261 0.6845
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:34.320504: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:34.344754: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:11:35.217417: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:35.222227: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:35.223038: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:35.224721: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:35.225503: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:35.226225: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:35.305464: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:35.306303: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:35.307043: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:35.307768: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8518 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:11:35.601249: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.658742e-01  RMSE=8.751424e-01
  per-joint RMSE: 0.9305 1.2933 0.7455 0.5589 0.8568 0.6743
Residual LSTM:  MSE=6.865959e-01      RMSE=8.286108e-01
  per-joint RMSE: 0.8356 1.2149 0.6888 0.5658 0.8261 0.6845
Combined torque MSE=6.865959e-01     RMSE=8.286108e-01
  per-joint RMSE: 0.8356 1.2149 0.6888 0.5658 0.8261 0.6845
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:37.431952: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:37.456073: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:11:38.407775: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:38.412639: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:38.413431: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:38.414954: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:38.415740: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:38.416472: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:38.487087: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:38.487911: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:38.488653: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:38.489387: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8518 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:11:39.364425: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 61ms/step - loss: 0.2745 - val_loss: 1.9613
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1386 - val_loss: 1.8799
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1095 - val_loss: 1.9855
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.0947 - val_loss: 2.1048
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.0860 - val_loss: 2.1497
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0804 - val_loss: 2.1630
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0768 - val_loss: 2.1777
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0750 - val_loss: 2.1856
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0741 - val_loss: 2.1947
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0728 - val_loss: 2.1922
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0690 - val_loss: 2.2332
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0679 - val_loss: 2.2336
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8036
Per-joint RMSE: 0.8864 1.1333 0.6313 0.5378 0.8289 0.6558
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:41.970527: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:41.995162: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:11:42.862764: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:42.867556: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:42.868437: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:42.870233: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:42.871026: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:42.871765: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:42.952346: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:42.953176: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:42.953922: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:42.954644: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:11:43.246102: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.658742e-01  RMSE=8.751424e-01
  per-joint RMSE: 0.9305 1.2933 0.7455 0.5589 0.8568 0.6743
Residual LSTM:  MSE=6.458235e-01      RMSE=8.036314e-01
  per-joint RMSE: 0.8864 1.1333 0.6313 0.5378 0.8289 0.6558
Combined torque MSE=6.458235e-01     RMSE=8.036314e-01
  per-joint RMSE: 0.8864 1.1333 0.6313 0.5378 0.8289 0.6558
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (7059, 50, 24)  Y_train: (7059, 6)
X_test : (1353, 50, 24)  Y_test : (1353, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:45.046339: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:45.070771: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (7059, 50, 24), Y_train = (7059, 6)
  X_test  = (1353, 50, 24),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:11:46.060107: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:46.064794: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:46.065591: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:46.067342: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:46.068226: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:46.069014: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:46.150439: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:46.151358: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:46.152111: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:46.152925: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:11:47.090708: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2697 - val_loss: 1.9635
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1388 - val_loss: 1.9492
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1116 - val_loss: 1.9837
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.0967 - val_loss: 1.9894
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0895 - val_loss: 1.9839
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0838 - val_loss: 1.9924
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0798 - val_loss: 1.9753
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0769 - val_loss: 1.9713
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0754 - val_loss: 1.9770
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0746 - val_loss: 1.9610
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0720 - val_loss: 1.9821
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0704 - val_loss: 1.9825
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8062
Per-joint RMSE: 0.9139 1.1047 0.6626 0.5749 0.7965 0.6635
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:50.104657: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:50.129985: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:11:50.984631: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:50.989349: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:50.990146: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:50.991867: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:50.992657: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:50.993386: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:51.067060: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:51.067976: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:51.068720: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:51.069440: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8518 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:11:51.361322: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.296332e-01  RMSE=8.541856e-01
  per-joint RMSE: 0.9418 1.2307 0.7334 0.5619 0.8405 0.6450
Residual LSTM:  MSE=6.499341e-01      RMSE=8.061849e-01
  per-joint RMSE: 0.9139 1.1047 0.6626 0.5749 0.7965 0.6635
Combined torque MSE=6.499341e-01     RMSE=8.061849e-01
  per-joint RMSE: 0.9139 1.1047 0.6626 0.5749 0.7965 0.6635
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (7059, 50, 6)  Y_train: (7059, 6)
X_test : (1353, 50, 6)  Y_test : (1353, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:53.127060: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:53.151471: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (7059, 50, 6), Y_train = (7059, 6)
  X_test  = (1353, 50, 6),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:11:54.093179: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:54.097827: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:54.098616: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:54.100154: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:54.100944: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:54.101684: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:54.180131: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:54.180970: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:54.181717: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:54.182451: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:11:55.093529: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.4164 - val_loss: 2.6033
Epoch 2/30
23/23 - 0s - 5ms/step - loss: 0.2904 - val_loss: 2.6057
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.2462 - val_loss: 2.6318
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.2024 - val_loss: 2.6683
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.2016 - val_loss: 2.6742
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.1405 - val_loss: 2.6920
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.1168 - val_loss: 2.6949
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.1033 - val_loss: 2.5800
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0951 - val_loss: 2.6142
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0937 - val_loss: 2.6523
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0895 - val_loss: 2.6591
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0826 - val_loss: 2.6735
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0809 - val_loss: 2.6405
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0797 - val_loss: 2.6537
Epoch 15/30
23/23 - 0s - 5ms/step - loss: 0.0778 - val_loss: 2.6710
Epoch 16/30
23/23 - 0s - 5ms/step - loss: 0.0758 - val_loss: 2.6376
Epoch 17/30
23/23 - 0s - 5ms/step - loss: 0.0737 - val_loss: 2.6112
Epoch 18/30
23/23 - 0s - 5ms/step - loss: 0.0716 - val_loss: 2.6209
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8382
Per-joint RMSE: 0.9307 1.0665 0.7717 0.5643 0.9369 0.6481
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:11:58.712219: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:11:58.737114: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:11:59.601160: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:59.605828: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:59.606758: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:59.608491: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:59.609291: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:59.610091: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:59.684643: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:59.685486: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:59.686238: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:11:59.686963: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:11:59.976399: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.296332e-01  RMSE=8.541856e-01
  per-joint RMSE: 0.9418 1.2307 0.7334 0.5619 0.8405 0.6450
Residual LSTM:  MSE=7.025704e-01      RMSE=8.381947e-01
  per-joint RMSE: 0.9307 1.0665 0.7717 0.5643 0.9369 0.6481
Combined torque MSE=7.025704e-01     RMSE=8.381947e-01
  per-joint RMSE: 0.9307 1.0665 0.7717 0.5643 0.9369 0.6481
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:12:01.819851: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:12:01.844599: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:12:02.814545: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:02.819214: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:02.820004: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:02.821482: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:02.822264: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:02.823052: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:02.898867: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:02.899697: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:02.900433: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:02.901163: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:12:03.812995: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2848 - val_loss: 1.7585
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1550 - val_loss: 1.6974
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1331 - val_loss: 1.7382
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1195 - val_loss: 1.7344
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.1044 - val_loss: 1.7288
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0981 - val_loss: 1.7262
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0902 - val_loss: 1.7394
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0915 - val_loss: 1.7090
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0836 - val_loss: 1.7216
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0792 - val_loss: 1.7460
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0779 - val_loss: 1.7279
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0757 - val_loss: 1.7405
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8063
Per-joint RMSE: 0.8022 1.1592 0.6630 0.5940 0.8145 0.6767
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:12:06.783077: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:12:06.808253: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:12:07.674536: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:07.679213: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:07.680154: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:07.681813: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:07.682605: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:07.683329: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:07.765774: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:07.766622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:07.767356: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:07.768092: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8518 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:12:08.059416: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.296332e-01  RMSE=8.541856e-01
  per-joint RMSE: 0.9418 1.2307 0.7334 0.5619 0.8405 0.6450
Residual LSTM:  MSE=6.501693e-01      RMSE=8.063308e-01
  per-joint RMSE: 0.8022 1.1592 0.6630 0.5940 0.8145 0.6767
Combined torque MSE=6.501693e-01     RMSE=8.063308e-01
  per-joint RMSE: 0.8022 1.1592 0.6630 0.5940 0.8145 0.6767
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:12:09.852700: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:12:09.876748: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:12:10.852799: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:10.857492: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:10.858283: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:10.859923: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:10.860702: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:10.861436: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:10.938027: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:10.938942: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:10.939684: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:10.940412: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:12:11.846023: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2682 - val_loss: 1.9602
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1419 - val_loss: 1.8736
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1184 - val_loss: 1.9096
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1030 - val_loss: 1.9788
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0941 - val_loss: 2.0420
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0868 - val_loss: 2.0855
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0818 - val_loss: 2.1095
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0778 - val_loss: 2.1037
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0760 - val_loss: 2.1227
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0738 - val_loss: 2.1354
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0728 - val_loss: 2.1666
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0705 - val_loss: 2.1859
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8066
Per-joint RMSE: 0.9058 1.0732 0.7012 0.5576 0.8330 0.6593
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:12:14.816461: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:12:14.841621: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:12:15.691907: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:15.696488: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:15.697432: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:15.699083: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:15.699866: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:15.700602: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:15.783095: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:15.783925: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:15.784672: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:15.785388: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8515 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:12:16.076838: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.296332e-01  RMSE=8.541856e-01
  per-joint RMSE: 0.9418 1.2307 0.7334 0.5619 0.8405 0.6450
Residual LSTM:  MSE=6.505605e-01      RMSE=8.065733e-01
  per-joint RMSE: 0.9058 1.0732 0.7012 0.5576 0.8330 0.6593
Combined torque MSE=6.505605e-01     RMSE=8.065733e-01
  per-joint RMSE: 0.9058 1.0732 0.7012 0.5576 0.8330 0.6593
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=2                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz -t structured -s 2 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x7d0a450981f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz
   dt ≈ 0.026853339250055355
  dof = 6
  Train trajectories = 20
  Test trajectories  = 5
  Train samples = 7533
  Test samples  = 1506
################################################

2026-01-22 05:12:20.228259: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150 | type=structured | dof=6
################################################
2026-01-22 05:12:23.396486: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:23.396521: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:23.396527: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:23.396554: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:23.396559: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:23.396600: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:23.396644: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:23.396650: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:23.396672: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:23.396677: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.1s, Loss=3.20e+01, Inv=3.20e+01, For=1.84e+02, Power=1.16e+01
2026-01-22 05:12:28.423050: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  [eval] test_mse=9.883e+00  (n=1506)
Epoch 00050: Time=   7.4s, Loss=2.67e+00, Inv=2.67e+00, For=2.83e+01, Power=2.57e+00
Epoch 00100: Time=   8.3s, Loss=2.40e+00, Inv=2.40e+00, For=3.61e+01, Power=2.26e+00
Epoch 00150: Time=   9.4s, Loss=2.30e+00, Inv=2.30e+00, For=4.65e+01, Power=2.05e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
Torque MSE  = 1.520e+00
Torque RMSE = 1.233e+00
Per-joint MSE : 4.666e+00 1.251e+00 1.134e+00 6.077e-01 3.493e-01 1.112e+00
Per-joint RMSE: 2.160e+00 1.118e+00 1.065e+00 7.796e-01 5.910e-01 1.054e+00
Comp Time per Sample = 2.166e-07s / 4616403.2Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed2_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
Detected n_dof=6 (seed=2)
2026-01-22 05:12:34.891908: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 20 trajectories
2026-01-22 05:12:36.207756: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:36.207768: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:37.754124: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:37.754138: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:12:39.198854: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 20/20

Exporting split=test: 5 trajectories
  done 5/5

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (7284, 25, 24)  Y_train: (7284, 6)
X_test : (1428, 25, 24)  Y_test : (1428, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:12:41.242062: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:12:41.266390: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (7284, 25, 24), Y_train = (7284, 6)
  X_test  = (1428, 25, 24),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:12:42.221409: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:42.226264: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:42.227179: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:42.228857: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:42.229872: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:42.230734: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:42.314695: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:42.315578: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:42.316358: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:42.317134: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8952 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:12:43.236182: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2804 - val_loss: 2.0023
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1340 - val_loss: 1.9387
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1067 - val_loss: 1.9834
Epoch 4/30
23/23 - 0s - 4ms/step - loss: 0.0917 - val_loss: 2.0087
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.0834 - val_loss: 1.9979
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0795 - val_loss: 2.0015
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0773 - val_loss: 2.0081
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0737 - val_loss: 1.9968
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0718 - val_loss: 1.9915
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0711 - val_loss: 2.0185
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0696 - val_loss: 2.0167
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0678 - val_loss: 2.0117
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2173
Per-joint RMSE: 2.2019 0.9311 0.9993 0.8054 0.6121 1.0739
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:12:45.843980: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:12:45.868802: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:12:46.719748: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:46.724813: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:46.725605: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:46.727296: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:46.728235: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:46.728974: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:46.813460: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:46.814377: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:46.815127: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:46.815854: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8946 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:12:47.114266: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.574840e+00  RMSE=1.254926e+00
  per-joint RMSE: 2.2148 1.1167 1.0901 0.7749 0.6050 1.0686
Residual LSTM:  MSE=1.481763e+00      RMSE=1.217277e+00
  per-joint RMSE: 2.2019 0.9311 0.9993 0.8054 0.6121 1.0739
Combined torque MSE=1.481763e+00     RMSE=1.217277e+00
  per-joint RMSE: 2.2019 0.9311 0.9993 0.8054 0.6121 1.0739
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (7284, 25, 6)  Y_train: (7284, 6)
X_test : (1428, 25, 6)  Y_test : (1428, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:12:48.858831: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:12:48.882921: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (7284, 25, 6), Y_train = (7284, 6)
  X_test  = (1428, 25, 6),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:12:49.815617: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:49.820243: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:49.821034: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:49.822711: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:49.823501: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:49.824236: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:49.905958: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:49.906789: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:49.907534: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:49.908269: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8945 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:12:50.827962: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.4139 - val_loss: 2.6743
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.3085 - val_loss: 2.8753
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.2541 - val_loss: 2.8826
Epoch 4/30
23/23 - 0s - 3ms/step - loss: 0.2304 - val_loss: 3.0031
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.2099 - val_loss: 2.9952
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.1889 - val_loss: 2.8317
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.1652 - val_loss: 2.8116
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.1454 - val_loss: 2.8804
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.1214 - val_loss: 3.0111
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0996 - val_loss: 2.9503
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0948 - val_loss: 2.9080
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2418
Per-joint RMSE: 2.3158 0.8844 1.0015 0.7794 0.5849 1.0748
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:12:53.331659: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:12:53.356420: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:12:54.213935: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:54.218747: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:54.219590: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:54.221978: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:54.222827: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:54.223615: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:54.304385: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:54.305273: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:54.306068: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:54.306941: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8946 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:12:54.602960: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.574840e+00  RMSE=1.254926e+00
  per-joint RMSE: 2.2148 1.1167 1.0901 0.7749 0.6050 1.0686
Residual LSTM:  MSE=1.542149e+00      RMSE=1.241833e+00
  per-joint RMSE: 2.3158 0.8844 1.0015 0.7794 0.5849 1.0748
Combined torque MSE=1.542149e+00     RMSE=1.241833e+00
  per-joint RMSE: 2.3158 0.8844 1.0015 0.7794 0.5849 1.0748
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:12:56.391827: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:12:56.415826: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:12:57.361340: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:57.365912: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:57.366737: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:57.368255: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:57.369047: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:57.369785: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:57.444304: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:57.445143: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:57.445886: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:12:57.446620: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8946 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:12:58.355228: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 61ms/step - loss: 0.2687 - val_loss: 1.9734
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1463 - val_loss: 1.8616
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1282 - val_loss: 1.8603
Epoch 4/30
23/23 - 0s - 4ms/step - loss: 0.1169 - val_loss: 1.9056
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.1064 - val_loss: 1.8875
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0938 - val_loss: 1.9046
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0887 - val_loss: 1.9103
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0839 - val_loss: 1.9315
Epoch 9/30
23/23 - 0s - 3ms/step - loss: 0.0807 - val_loss: 1.9240
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0782 - val_loss: 1.9057
Epoch 11/30
23/23 - 0s - 4ms/step - loss: 0.0764 - val_loss: 1.9319
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0733 - val_loss: 1.9283
Epoch 13/30
23/23 - 0s - 3ms/step - loss: 0.0706 - val_loss: 1.9328
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2410
Per-joint RMSE: 2.1895 1.0953 1.0565 0.7921 0.5648 1.0885
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:13:01.027964: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:13:01.052461: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:13:01.893969: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:01.898782: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:01.899663: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:01.901438: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:01.902309: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:01.903046: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:01.987609: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:01.988523: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:01.989272: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:01.990101: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8946 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:13:02.286116: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.574840e+00  RMSE=1.254926e+00
  per-joint RMSE: 2.2148 1.1167 1.0901 0.7749 0.6050 1.0686
Residual LSTM:  MSE=1.540129e+00      RMSE=1.241019e+00
  per-joint RMSE: 2.1895 1.0953 1.0565 0.7921 0.5648 1.0885
Combined torque MSE=1.540129e+00     RMSE=1.241019e+00
  per-joint RMSE: 2.1895 1.0953 1.0565 0.7921 0.5648 1.0885
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (7284, 25, 18)  Y_train: (7284, 6)
X_test : (1428, 25, 18)  Y_test : (1428, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:13:04.047318: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:13:04.071356: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (7284, 25, 18), Y_train = (7284, 6)
  X_test  = (1428, 25, 18),  Y_test  = (1428, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:13:05.024808: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:05.030063: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:05.030868: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:05.032391: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:05.033181: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:05.033920: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:05.107329: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:05.108321: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:05.109066: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:05.109795: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8949 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:13:06.025588: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 61ms/step - loss: 0.2575 - val_loss: 2.0389
Epoch 2/30
23/23 - 0s - 4ms/step - loss: 0.1320 - val_loss: 2.0336
Epoch 3/30
23/23 - 0s - 4ms/step - loss: 0.1081 - val_loss: 2.1267
Epoch 4/30
23/23 - 0s - 4ms/step - loss: 0.0959 - val_loss: 2.1605
Epoch 5/30
23/23 - 0s - 3ms/step - loss: 0.0876 - val_loss: 2.1958
Epoch 6/30
23/23 - 0s - 3ms/step - loss: 0.0817 - val_loss: 2.1995
Epoch 7/30
23/23 - 0s - 3ms/step - loss: 0.0781 - val_loss: 2.2063
Epoch 8/30
23/23 - 0s - 3ms/step - loss: 0.0751 - val_loss: 2.1920
Epoch 9/30
23/23 - 0s - 4ms/step - loss: 0.0724 - val_loss: 2.1654
Epoch 10/30
23/23 - 0s - 3ms/step - loss: 0.0708 - val_loss: 2.1838
Epoch 11/30
23/23 - 0s - 3ms/step - loss: 0.0691 - val_loss: 2.1710
Epoch 12/30
23/23 - 0s - 3ms/step - loss: 0.0681 - val_loss: 2.1726
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2313
Per-joint RMSE: 2.2457 0.9629 1.0067 0.7862 0.6067 1.0614
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:13:08.601969: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:13:08.626775: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:13:09.480272: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:09.485045: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:09.485915: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:09.487645: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:09.488429: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:09.490069: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:09.565420: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:09.566415: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:09.567154: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:09.567885: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8946 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:13:09.861647: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.574840e+00  RMSE=1.254926e+00
  per-joint RMSE: 2.2148 1.1167 1.0901 0.7749 0.6050 1.0686
Residual LSTM:  MSE=1.516110e+00      RMSE=1.231304e+00
  per-joint RMSE: 2.2457 0.9629 1.0067 0.7862 0.6067 1.0614
Combined torque MSE=1.516110e+00     RMSE=1.231304e+00
  per-joint RMSE: 2.2457 0.9629 1.0067 0.7862 0.6067 1.0614
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (7059, 50, 24)  Y_train: (7059, 6)
X_test : (1353, 50, 24)  Y_test : (1353, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:13:11.657068: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:13:11.681434: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (7059, 50, 24), Y_train = (7059, 6)
  X_test  = (1353, 50, 24),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:13:12.655726: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:12.660277: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:12.661148: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:12.662747: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:12.663530: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:12.664272: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:12.746019: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:12.746929: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:12.747674: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:12.748401: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8946 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:13:13.674515: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 64ms/step - loss: 0.2688 - val_loss: 2.0097
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1430 - val_loss: 1.9663
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1178 - val_loss: 2.0049
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1033 - val_loss: 2.0097
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0930 - val_loss: 2.0264
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0871 - val_loss: 2.0194
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0832 - val_loss: 1.9966
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0781 - val_loss: 1.9887
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0764 - val_loss: 1.9671
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0746 - val_loss: 1.9612
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0740 - val_loss: 1.9521
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0741 - val_loss: 1.9376
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0704 - val_loss: 1.9403
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0690 - val_loss: 1.9330
Epoch 15/30
23/23 - 0s - 5ms/step - loss: 0.0683 - val_loss: 1.9340
Epoch 16/30
23/23 - 0s - 5ms/step - loss: 0.0671 - val_loss: 1.9278
Epoch 17/30
23/23 - 0s - 5ms/step - loss: 0.0667 - val_loss: 1.9232
Epoch 18/30
23/23 - 0s - 5ms/step - loss: 0.0656 - val_loss: 1.9204
Epoch 19/30
23/23 - 0s - 5ms/step - loss: 0.0664 - val_loss: 1.9185
Epoch 20/30
23/23 - 0s - 5ms/step - loss: 0.0647 - val_loss: 1.9026
Epoch 21/30
23/23 - 0s - 5ms/step - loss: 0.0655 - val_loss: 1.8927
Epoch 22/30
23/23 - 0s - 5ms/step - loss: 0.0640 - val_loss: 1.9023
Epoch 23/30
23/23 - 0s - 5ms/step - loss: 0.0638 - val_loss: 1.8965
Epoch 24/30
23/23 - 0s - 5ms/step - loss: 0.0633 - val_loss: 1.8870
Epoch 25/30
23/23 - 0s - 5ms/step - loss: 0.0624 - val_loss: 1.9056
Epoch 26/30
23/23 - 0s - 5ms/step - loss: 0.0627 - val_loss: 1.8925
Epoch 27/30
23/23 - 0s - 5ms/step - loss: 0.0621 - val_loss: 1.8878
Epoch 28/30
23/23 - 0s - 5ms/step - loss: 0.0613 - val_loss: 1.8763
Epoch 29/30
23/23 - 0s - 5ms/step - loss: 0.0620 - val_loss: 1.9057
Epoch 30/30
23/23 - 0s - 5ms/step - loss: 0.0615 - val_loss: 1.9092
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.1263
Per-joint RMSE: 2.0138 0.8160 0.9515 0.7688 0.5895 1.0228
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:13:18.750135: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:13:18.774663: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:13:19.639378: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:19.645892: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:19.646697: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:19.648341: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:19.649149: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:19.649892: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:19.731585: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:19.732507: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:19.733250: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:19.733970: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8946 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:13:20.030909: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.531759e+00  RMSE=1.237643e+00
  per-joint RMSE: 2.1883 1.0897 1.0734 0.7658 0.6189 1.0453
Residual LSTM:  MSE=1.268535e+00      RMSE=1.126293e+00
  per-joint RMSE: 2.0138 0.8160 0.9515 0.7688 0.5895 1.0228
Combined torque MSE=1.268535e+00     RMSE=1.126293e+00
  per-joint RMSE: 2.0138 0.8160 0.9515 0.7688 0.5895 1.0228
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (7059, 50, 6)  Y_train: (7059, 6)
X_test : (1353, 50, 6)  Y_test : (1353, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:13:21.830358: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:13:21.855361: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (7059, 50, 6), Y_train = (7059, 6)
  X_test  = (1353, 50, 6),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:13:22.810091: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:22.814762: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:22.815639: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:22.817195: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:22.817980: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:22.818720: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:22.900878: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:22.901789: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:22.902534: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:22.903271: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8946 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:13:23.797772: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.4005 - val_loss: 2.8103
Epoch 2/30
23/23 - 0s - 5ms/step - loss: 0.2773 - val_loss: 2.9004
Epoch 3/30
23/23 - 0s - 6ms/step - loss: 0.2138 - val_loss: 2.8061
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1775 - val_loss: 2.7576
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.1484 - val_loss: 2.7979
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.1324 - val_loss: 2.7976
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.1354 - val_loss: 2.8247
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.1130 - val_loss: 2.7987
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.1023 - val_loss: 2.9368
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0909 - val_loss: 2.8723
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0868 - val_loss: 2.8920
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0848 - val_loss: 2.8740
Epoch 13/30
23/23 - 0s - 5ms/step - loss: 0.0843 - val_loss: 2.8524
Epoch 14/30
23/23 - 0s - 5ms/step - loss: 0.0794 - val_loss: 2.8180
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.1799
Per-joint RMSE: 2.1800 0.8509 0.9411 0.7549 0.6097 1.0242
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:13:26.976563: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:13:27.001092: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:13:27.863625: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:27.868370: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:27.869165: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:27.870768: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:27.871558: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:27.872293: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:27.953680: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:27.954515: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:27.955258: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:27.955984: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8945 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:13:28.247751: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.531759e+00  RMSE=1.237643e+00
  per-joint RMSE: 2.1883 1.0897 1.0734 0.7658 0.6189 1.0453
Residual LSTM:  MSE=1.392165e+00      RMSE=1.179901e+00
  per-joint RMSE: 2.1800 0.8509 0.9411 0.7549 0.6097 1.0242
Combined torque MSE=1.392165e+00     RMSE=1.179901e+00
  per-joint RMSE: 2.1800 0.8509 0.9411 0.7549 0.6097 1.0242
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:13:30.026775: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:13:30.051229: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:13:31.017529: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:31.022156: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:31.023102: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:31.024651: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:31.025432: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:31.026155: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:31.094786: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:31.095615: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:31.096363: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:31.097098: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8945 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:13:32.014708: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 63ms/step - loss: 0.2731 - val_loss: 1.8736
Epoch 2/30
23/23 - 0s - 6ms/step - loss: 0.1533 - val_loss: 1.8638
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1316 - val_loss: 1.8919
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1177 - val_loss: 1.8720
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.1062 - val_loss: 1.8965
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0986 - val_loss: 1.8898
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0920 - val_loss: 1.9191
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0883 - val_loss: 1.8943
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0845 - val_loss: 1.9002
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0807 - val_loss: 1.9006
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0762 - val_loss: 1.9142
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0741 - val_loss: 1.9187
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2277
Per-joint RMSE: 2.1471 1.1010 1.0446 0.8109 0.5835 1.0642
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:13:34.988425: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:13:35.013254: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:13:35.876147: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:35.880837: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:35.881621: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:35.883252: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:35.884034: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:35.884761: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:35.961006: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:35.961919: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:35.962836: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:35.963569: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8945 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:13:36.259027: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.531759e+00  RMSE=1.237643e+00
  per-joint RMSE: 2.1883 1.0897 1.0734 0.7658 0.6189 1.0453
Residual LSTM:  MSE=1.507301e+00      RMSE=1.227722e+00
  per-joint RMSE: 2.1471 1.1010 1.0446 0.8109 0.5835 1.0642
Combined torque MSE=1.507301e+00     RMSE=1.227722e+00
  per-joint RMSE: 2.1471 1.1010 1.0446 0.8109 0.5835 1.0642
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (7059, 50, 18)  Y_train: (7059, 6)
X_test : (1353, 50, 18)  Y_test : (1353, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:13:38.032183: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:13:38.056166: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (7059, 50, 18), Y_train = (7059, 6)
  X_test  = (1353, 50, 18),  Y_test  = (1353, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:13:39.011812: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:39.016404: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:39.017273: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:39.018858: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:39.019646: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:39.020379: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:39.091768: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:39.092608: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:39.093348: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:39.094074: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8946 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:13:40.013068: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
23/23 - 1s - 62ms/step - loss: 0.2534 - val_loss: 1.8565
Epoch 2/30
23/23 - 0s - 5ms/step - loss: 0.1410 - val_loss: 1.8278
Epoch 3/30
23/23 - 0s - 5ms/step - loss: 0.1181 - val_loss: 1.8588
Epoch 4/30
23/23 - 0s - 5ms/step - loss: 0.1055 - val_loss: 1.8627
Epoch 5/30
23/23 - 0s - 5ms/step - loss: 0.0957 - val_loss: 1.8706
Epoch 6/30
23/23 - 0s - 5ms/step - loss: 0.0894 - val_loss: 1.8604
Epoch 7/30
23/23 - 0s - 5ms/step - loss: 0.0850 - val_loss: 1.8327
Epoch 8/30
23/23 - 0s - 5ms/step - loss: 0.0830 - val_loss: 1.8318
Epoch 9/30
23/23 - 0s - 5ms/step - loss: 0.0801 - val_loss: 1.8356
Epoch 10/30
23/23 - 0s - 5ms/step - loss: 0.0777 - val_loss: 1.8534
Epoch 11/30
23/23 - 0s - 5ms/step - loss: 0.0751 - val_loss: 1.8521
Epoch 12/30
23/23 - 0s - 5ms/step - loss: 0.0721 - val_loss: 1.8476
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2018
Per-joint RMSE: 2.1717 0.9362 1.0232 0.7670 0.6196 1.0269
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:13:42.973787: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:13:42.998892: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:13:43.850943: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:43.855635: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:43.856427: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:43.858160: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:43.858944: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:43.859744: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:43.935045: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:43.935878: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:43.936611: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:13:43.937337: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8946 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:13:44.231284: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 5/5

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.531759e+00  RMSE=1.237643e+00
  per-joint RMSE: 2.1883 1.0897 1.0734 0.7658 0.6189 1.0453
Residual LSTM:  MSE=1.444422e+00      RMSE=1.201841e+00
  per-joint RMSE: 2.1717 0.9362 1.0232 0.7670 0.6196 1.0269
Combined torque MSE=1.444422e+00     RMSE=1.201841e+00
  per-joint RMSE: 2.1717 0.9362 1.0232 0.7670 0.6196 1.0269
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s2_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

