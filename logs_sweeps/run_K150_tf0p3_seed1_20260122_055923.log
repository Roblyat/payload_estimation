#################################################################################################################
### RUN: K=150 test_fraction=0.3 seed=1                                                                       ###
### npz_in=/workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz ###
#################################################################################################################

#####################
### 1) PREPROCESS ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_delan_dataset.py --qdd True --col_format wide --trajectory_amount 150 --test_fraction 0.3 --seed 1 --raw_csv /workspace/shared/data/raw/delan_UR3_Load0_combined_26.csv --out_npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Saved: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz
Trajectories: train=105 test=45
Exists: True

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=0                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz                                ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz -t structured -s 0 -r 0 --hp_preset fast_debug --epochs 400 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 400, 'lagrangian_type': <function structured_lagrangian_fn at 0x7a8a8cff41f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz
   dt ≈ 0.027122289385805493
  dof = 6
  Train trajectories = 105
  Test trajectories  = 45
  Train samples = 51043
  Test samples  = 20078
################################################

2026-01-22 09:15:23.300128: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400 | type=structured | dof=6
################################################
2026-01-22 09:15:26.467213: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:15:26.467248: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:15:26.467254: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:15:26.467282: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:15:26.467287: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:15:26.467301: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:15:26.467338: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:15:26.467344: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:15:26.467359: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:15:26.467364: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.2s, Loss=1.06e+01, Inv=1.06e+01, For=1.59e+02, Power=2.49e+00
  [eval] test_mse=1.078e+00  (n=20078)
Epoch 00050: Time=  13.5s, Loss=2.60e+00, Inv=2.60e+00, For=8.29e+01, Power=1.21e+00
Epoch 00100: Time=  20.2s, Loss=2.32e+00, Inv=2.32e+00, For=1.01e+02, Power=1.07e+00
Epoch 00150: Time=  26.6s, Loss=2.18e+00, Inv=2.18e+00, For=1.17e+02, Power=1.03e+00
Epoch 00200: Time=  33.5s, Loss=2.11e+00, Inv=2.11e+00, For=1.23e+02, Power=1.00e+00
  [eval] test_mse=6.027e-01  (n=20078)
Epoch 00250: Time=  40.2s, Loss=2.05e+00, Inv=2.05e+00, For=1.31e+02, Power=9.88e-01
Epoch 00300: Time=  46.9s, Loss=2.03e+00, Inv=2.03e+00, For=1.40e+02, Power=9.88e-01
Epoch 00350: Time=  54.0s, Loss=1.99e+00, Inv=1.99e+00, For=1.49e+02, Power=9.81e-01
Epoch 00400: Time=  60.7s, Loss=1.97e+00, Inv=1.97e+00, For=1.52e+02, Power=9.73e-01
  [eval] test_mse=6.311e-01  (n=20078)
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400
Torque MSE  = 1.052e-01
Torque RMSE = 3.243e-01
Per-joint MSE : 1.702e-01 2.637e-01 1.011e-01 3.563e-02 2.472e-02 3.580e-02
Per-joint RMSE: 4.125e-01 5.135e-01 3.179e-01 1.888e-01 1.572e-01 1.892e-01
Comp Time per Sample = 1.905e-08s / 52502758.5Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz' ===
===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax
Detected n_dof=6 (seed=0)
2026-01-22 09:16:29.283552: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 105 trajectories
2026-01-22 09:16:30.584206: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:16:30.584218: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:16:32.191916: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:16:32.191930: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:16:33.638765: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:16:33.638799: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:16:33.638804: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:16:35.225266: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 25/105
2026-01-22 09:16:36.411834: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 50/105
  done 75/105
2026-01-22 09:16:37.647618: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 100/105
  done 105/105

Exporting split=test: 45 trajectories
  done 25/45
  done 45/45

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.npz --H 25 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.json
H=25, n_dof=6, feature_dim=24
X_train: (49575, 25, 24)  Y_train: (49575, 6)
X_test : (19544, 25, 24)  Y_test : (19544, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:16:40.058119: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:16:40.082876: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (49575, 25, 24), Y_train = (49575, 6)
  X_test  = (19544, 25, 24),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:16:41.268204: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:41.273386: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:41.274330: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:41.276769: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:41.277892: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:41.278643: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:41.376938: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:41.377831: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:41.378625: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:41.379414: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8975 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:16:42.370594: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.2921 - val_loss: 0.3947
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.1766 - val_loss: 0.3661
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.1531 - val_loss: 0.3619
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.1418 - val_loss: 0.3453
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.1338 - val_loss: 0.3540
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.1266 - val_loss: 0.3330
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.1198 - val_loss: 0.3383
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1130 - val_loss: 0.3647
Epoch 9/100
155/155 - 0s - 3ms/step - loss: 0.1105 - val_loss: 0.3550
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1041 - val_loss: 0.3725
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1035 - val_loss: 0.3432
Epoch 12/100
155/155 - 0s - 3ms/step - loss: 0.0993 - val_loss: 0.3778
Epoch 13/100
155/155 - 0s - 3ms/step - loss: 0.0971 - val_loss: 0.3624
Epoch 14/100
155/155 - 0s - 3ms/step - loss: 0.0977 - val_loss: 0.3619
Epoch 15/100
155/155 - 0s - 3ms/step - loss: 0.0953 - val_loss: 0.3516
Epoch 16/100
155/155 - 0s - 3ms/step - loss: 0.0934 - val_loss: 0.3544
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1786
Per-joint RMSE: 0.2877 0.2144 0.1668 0.0998 0.0966 0.1249
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:16:50.582887: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:16:50.607631: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 09:16:51.474492: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:51.479141: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:51.479933: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:51.481615: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:51.482408: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:51.483149: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:51.561588: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:51.562419: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:51.563159: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:51.563889: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:16:51.860262: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.040761e-01  RMSE=3.226082e-01
  per-joint RMSE: 0.4126 0.5093 0.3143 0.1878 0.1566 0.1901
Residual LSTM:  MSE=3.190927e-02      RMSE=1.786317e-01
  per-joint RMSE: 0.2877 0.2144 0.1668 0.0998 0.0966 0.1249
Combined torque MSE=3.190927e-02     RMSE=1.786317e-01
  per-joint RMSE: 0.2877 0.2144 0.1668 0.0998 0.0966 0.1249
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.npz --H 25 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.json
H=25, n_dof=6, feature_dim=6
X_train: (49575, 25, 6)  Y_train: (49575, 6)
X_test : (19544, 25, 6)  Y_test : (19544, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:16:54.195882: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:16:54.223582: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (49575, 25, 6), Y_train = (49575, 6)
  X_test  = (19544, 25, 6),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:16:55.248819: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:55.253605: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:55.254437: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:55.256007: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:55.256824: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:55.257585: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:55.337417: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:55.338310: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:55.339088: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:16:55.339931: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:16:56.257731: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.6146 - val_loss: 1.0924
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.4093 - val_loss: 0.9191
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.3379 - val_loss: 0.9721
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.2883 - val_loss: 0.9801
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.2533 - val_loss: 1.0488
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.2214 - val_loss: 1.0186
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.2144 - val_loss: 1.1785
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1752 - val_loss: 1.1072
Epoch 9/100
155/155 - 0s - 3ms/step - loss: 0.1590 - val_loss: 1.1703
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1595 - val_loss: 1.1188
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1586 - val_loss: 1.0544
Epoch 12/100
155/155 - 0s - 3ms/step - loss: 0.1434 - val_loss: 1.1363
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2332
Per-joint RMSE: 0.3287 0.2890 0.2597 0.1576 0.1316 0.1582
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:17:02.774891: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:17:02.800161: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 09:17:03.675740: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:03.680440: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:03.681314: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:03.683146: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:03.683937: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:03.684674: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:03.765388: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:03.766392: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:03.767229: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:03.767951: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:17:04.062296: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.040761e-01  RMSE=3.226082e-01
  per-joint RMSE: 0.4126 0.5093 0.3143 0.1878 0.1566 0.1901
Residual LSTM:  MSE=5.436311e-02      RMSE=2.331590e-01
  per-joint RMSE: 0.3287 0.2890 0.2597 0.1576 0.1316 0.1582
Combined torque MSE=5.436311e-02     RMSE=2.331590e-01
  per-joint RMSE: 0.3287 0.2890 0.2597 0.1576 0.1316 0.1582
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.npz --H 25 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (49575, 25, 18)  Y_train: (49575, 6)
X_test : (19544, 25, 18)  Y_test : (19544, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:17:06.519516: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:17:06.544389: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (49575, 25, 18), Y_train = (49575, 6)
  X_test  = (19544, 25, 18),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:17:07.702467: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:07.707194: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:07.708091: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:07.709986: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:07.710972: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:07.711717: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:07.804148: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:07.805041: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:07.805846: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:07.806630: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:17:08.785763: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.3278 - val_loss: 0.5242
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.2104 - val_loss: 0.5125
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.1779 - val_loss: 0.4967
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.1595 - val_loss: 0.5015
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.1485 - val_loss: 0.5083
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.1397 - val_loss: 0.5225
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.1327 - val_loss: 0.5719
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1276 - val_loss: 0.5090
Epoch 9/100
155/155 - 0s - 3ms/step - loss: 0.1214 - val_loss: 0.5092
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1165 - val_loss: 0.5236
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1139 - val_loss: 0.4887
Epoch 12/100
155/155 - 0s - 3ms/step - loss: 0.1118 - val_loss: 0.5225
Epoch 13/100
155/155 - 0s - 3ms/step - loss: 0.1094 - val_loss: 0.5548
Epoch 14/100
155/155 - 0s - 3ms/step - loss: 0.1056 - val_loss: 0.5207
Epoch 15/100
155/155 - 0s - 3ms/step - loss: 0.1038 - val_loss: 0.5157
Epoch 16/100
155/155 - 0s - 3ms/step - loss: 0.1024 - val_loss: 0.5355
Epoch 17/100
155/155 - 0s - 3ms/step - loss: 0.1027 - val_loss: 0.5132
Epoch 18/100
155/155 - 0s - 3ms/step - loss: 0.0995 - val_loss: 0.4924
Epoch 19/100
155/155 - 0s - 3ms/step - loss: 0.0995 - val_loss: 0.4843
Epoch 20/100
155/155 - 0s - 3ms/step - loss: 0.0975 - val_loss: 0.5004
Epoch 21/100
155/155 - 0s - 3ms/step - loss: 0.0969 - val_loss: 0.5375
Epoch 22/100
155/155 - 0s - 3ms/step - loss: 0.0948 - val_loss: 0.5005
Epoch 23/100
155/155 - 0s - 3ms/step - loss: 0.0934 - val_loss: 0.5282
Epoch 24/100
155/155 - 0s - 3ms/step - loss: 0.0931 - val_loss: 0.5534
Epoch 25/100
155/155 - 0s - 3ms/step - loss: 0.0923 - val_loss: 0.5363
Epoch 26/100
155/155 - 0s - 3ms/step - loss: 0.0914 - val_loss: 0.5418
Epoch 27/100
155/155 - 0s - 3ms/step - loss: 0.0906 - val_loss: 0.5192
Epoch 28/100
155/155 - 0s - 3ms/step - loss: 0.0890 - val_loss: 0.5370
Epoch 29/100
155/155 - 0s - 3ms/step - loss: 0.0891 - val_loss: 0.5415
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1850
Per-joint RMSE: 0.2946 0.2239 0.1741 0.0934 0.0977 0.1407
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:17:22.336415: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:17:22.361158: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:17:23.228211: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:23.232875: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:23.233668: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:23.235311: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:23.236101: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:23.236912: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:23.321087: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:23.322022: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:23.322770: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:23.323499: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:17:23.619860: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.040761e-01  RMSE=3.226082e-01
  per-joint RMSE: 0.4126 0.5093 0.3143 0.1878 0.1566 0.1901
Residual LSTM:  MSE=3.421465e-02      RMSE=1.849720e-01
  per-joint RMSE: 0.2946 0.2239 0.1741 0.0934 0.0977 0.1407
Combined torque MSE=3.421465e-02     RMSE=1.849720e-01
  per-joint RMSE: 0.2946 0.2239 0.1741 0.0934 0.0977 0.1407
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.npz --H 25 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (49575, 25, 18)  Y_train: (49575, 6)
X_test : (19544, 25, 18)  Y_test : (19544, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:17:26.089901: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:17:26.113814: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (49575, 25, 18), Y_train = (49575, 6)
  X_test  = (19544, 25, 18),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:17:27.249582: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:27.254394: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:27.255330: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:27.257086: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:27.257998: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:27.258856: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:27.343020: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:27.343903: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:27.344773: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:27.345602: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:17:28.284823: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.2960 - val_loss: 0.3766
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.1782 - val_loss: 0.3446
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.1543 - val_loss: 0.3185
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.1420 - val_loss: 0.3182
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.1315 - val_loss: 0.3114
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.1245 - val_loss: 0.3205
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.1173 - val_loss: 0.3218
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1137 - val_loss: 0.3212
Epoch 9/100
155/155 - 0s - 2ms/step - loss: 0.1091 - val_loss: 0.3182
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1060 - val_loss: 0.3191
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1032 - val_loss: 0.3244
Epoch 12/100
155/155 - 0s - 3ms/step - loss: 0.1017 - val_loss: 0.3180
Epoch 13/100
155/155 - 0s - 3ms/step - loss: 0.0988 - val_loss: 0.3254
Epoch 14/100
155/155 - 0s - 3ms/step - loss: 0.0974 - val_loss: 0.3035
Epoch 15/100
155/155 - 0s - 2ms/step - loss: 0.0963 - val_loss: 0.3263
Epoch 16/100
155/155 - 0s - 3ms/step - loss: 0.0941 - val_loss: 0.3227
Epoch 17/100
155/155 - 0s - 3ms/step - loss: 0.0922 - val_loss: 0.3240
Epoch 18/100
155/155 - 0s - 3ms/step - loss: 0.0915 - val_loss: 0.3157
Epoch 19/100
155/155 - 0s - 3ms/step - loss: 0.0896 - val_loss: 0.3226
Epoch 20/100
155/155 - 0s - 3ms/step - loss: 0.0887 - val_loss: 0.3103
Epoch 21/100
155/155 - 0s - 3ms/step - loss: 0.0873 - val_loss: 0.3208
Epoch 22/100
155/155 - 0s - 3ms/step - loss: 0.0866 - val_loss: 0.3016
Epoch 23/100
155/155 - 0s - 3ms/step - loss: 0.0855 - val_loss: 0.3084
Epoch 24/100
155/155 - 0s - 2ms/step - loss: 0.0837 - val_loss: 0.3189
Epoch 25/100
155/155 - 0s - 3ms/step - loss: 0.0835 - val_loss: 0.3169
Epoch 26/100
155/155 - 0s - 3ms/step - loss: 0.0822 - val_loss: 0.3259
Epoch 27/100
155/155 - 0s - 2ms/step - loss: 0.0810 - val_loss: 0.3174
Epoch 28/100
155/155 - 0s - 3ms/step - loss: 0.0800 - val_loss: 0.3284
Epoch 29/100
155/155 - 0s - 3ms/step - loss: 0.0792 - val_loss: 0.3240
Epoch 30/100
155/155 - 0s - 3ms/step - loss: 0.0791 - val_loss: 0.3287
Epoch 31/100
155/155 - 0s - 3ms/step - loss: 0.0788 - val_loss: 0.3214
Epoch 32/100
155/155 - 0s - 3ms/step - loss: 0.0771 - val_loss: 0.3245
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1695
Per-joint RMSE: 0.2620 0.2122 0.1554 0.0916 0.1011 0.1264
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:17:42.719932: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:17:42.745565: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:17:43.595312: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:43.600137: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:43.600986: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:43.602855: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:43.603698: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:43.604492: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:43.722005: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:43.722891: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:43.723781: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:43.724585: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:17:44.025545: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.040761e-01  RMSE=3.226082e-01
  per-joint RMSE: 0.4126 0.5093 0.3143 0.1878 0.1566 0.1901
Residual LSTM:  MSE=2.873596e-02      RMSE=1.695168e-01
  per-joint RMSE: 0.2620 0.2122 0.1554 0.0916 0.1011 0.1264
Combined torque MSE=2.873596e-02     RMSE=1.695168e-01
  per-joint RMSE: 0.2620 0.2122 0.1554 0.0916 0.1011 0.1264
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.npz --H 50 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.json
H=50, n_dof=6, feature_dim=24
X_train: (48200, 50, 24)  Y_train: (48200, 6)
X_test : (19069, 50, 24)  Y_test : (19069, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:17:46.708372: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:17:46.732167: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (48200, 50, 24), Y_train = (48200, 6)
  X_test  = (19069, 50, 24),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:17:48.216115: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:48.222190: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:48.223151: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:48.225392: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:48.226299: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:48.227210: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:48.315944: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:48.316916: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:48.317714: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:17:48.318510: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:17:49.401341: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.2898 - val_loss: 0.4361
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.1767 - val_loss: 0.4276
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.1553 - val_loss: 0.4139
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.1424 - val_loss: 0.4361
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.1338 - val_loss: 0.4077
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1280 - val_loss: 0.3724
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1199 - val_loss: 0.3737
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1168 - val_loss: 0.3410
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1135 - val_loss: 0.3449
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1080 - val_loss: 0.4074
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1042 - val_loss: 0.3847
Epoch 12/100
151/151 - 1s - 4ms/step - loss: 0.1029 - val_loss: 0.3517
Epoch 13/100
151/151 - 1s - 4ms/step - loss: 0.0994 - val_loss: 0.3742
Epoch 14/100
151/151 - 1s - 4ms/step - loss: 0.0973 - val_loss: 0.3522
Epoch 15/100
151/151 - 1s - 4ms/step - loss: 0.0968 - val_loss: 0.3676
Epoch 16/100
151/151 - 1s - 4ms/step - loss: 0.0944 - val_loss: 0.3621
Epoch 17/100
151/151 - 1s - 4ms/step - loss: 0.0925 - val_loss: 0.3676
Epoch 18/100
151/151 - 1s - 4ms/step - loss: 0.0917 - val_loss: 0.3803
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1746
Per-joint RMSE: 0.2825 0.2037 0.1605 0.0956 0.0943 0.1337
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:18:02.020146: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:18:02.046837: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 09:18:02.892059: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:02.896966: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:02.897771: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:02.899394: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:02.900192: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:02.900939: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:02.977355: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:02.978192: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:02.978946: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:02.979744: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:18:03.276042: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.037460e-01  RMSE=3.220962e-01
  per-joint RMSE: 0.4110 0.5106 0.3132 0.1854 0.1555 0.1901
Residual LSTM:  MSE=3.049299e-02      RMSE=1.746224e-01
  per-joint RMSE: 0.2825 0.2037 0.1605 0.0956 0.0943 0.1337
Combined torque MSE=3.049299e-02     RMSE=1.746224e-01
  per-joint RMSE: 0.2825 0.2037 0.1605 0.0956 0.0943 0.1337
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.npz --H 50 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.json
H=50, n_dof=6, feature_dim=6
X_train: (48200, 50, 6)  Y_train: (48200, 6)
X_test : (19069, 50, 6)  Y_test : (19069, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:18:05.738168: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:18:05.762695: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (48200, 50, 6), Y_train = (48200, 6)
  X_test  = (19069, 50, 6),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:18:06.888035: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:06.892717: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:06.893603: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:06.895228: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:06.896038: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:06.896835: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:06.976526: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:06.977422: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:06.978227: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:06.979028: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:18:07.922318: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.5877 - val_loss: 1.0439
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.3531 - val_loss: 1.0688
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.2775 - val_loss: 1.0798
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.2827 - val_loss: 1.1186
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.2185 - val_loss: 1.0941
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1789 - val_loss: 1.2255
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1664 - val_loss: 1.0649
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1585 - val_loss: 1.2068
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1504 - val_loss: 1.1734
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1491 - val_loss: 1.1806
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1428 - val_loss: 1.2046
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2525
Per-joint RMSE: 0.3510 0.3480 0.2521 0.1634 0.1264 0.1786
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:18:16.126607: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:18:16.151325: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 09:18:17.013031: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:17.017749: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:17.018548: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:17.020190: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:17.020993: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:17.021737: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:17.103997: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:17.104842: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:17.105597: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:17.106325: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:18:17.402459: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.037460e-01  RMSE=3.220962e-01
  per-joint RMSE: 0.4110 0.5106 0.3132 0.1854 0.1555 0.1901
Residual LSTM:  MSE=6.373897e-02      RMSE=2.524658e-01
  per-joint RMSE: 0.3510 0.3480 0.2521 0.1634 0.1264 0.1786
Combined torque MSE=6.373897e-02     RMSE=2.524658e-01
  per-joint RMSE: 0.3510 0.3480 0.2521 0.1634 0.1264 0.1786
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.npz --H 50 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (48200, 50, 18)  Y_train: (48200, 6)
X_test : (19069, 50, 18)  Y_test : (19069, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:18:20.040095: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:18:20.064722: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (48200, 50, 18), Y_train = (48200, 6)
  X_test  = (19069, 50, 18),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:18:21.379716: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:21.384740: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:21.385544: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:21.387370: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:21.388284: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:21.389145: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:21.482553: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:21.483524: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:21.484319: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:21.485105: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:18:22.500878: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.3396 - val_loss: 0.5296
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.2095 - val_loss: 0.5706
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.1817 - val_loss: 0.5038
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.1617 - val_loss: 0.5016
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.1507 - val_loss: 0.5000
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1436 - val_loss: 0.4946
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1364 - val_loss: 0.4646
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1278 - val_loss: 0.4532
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1252 - val_loss: 0.5201
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1191 - val_loss: 0.4761
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1150 - val_loss: 0.4427
Epoch 12/100
151/151 - 1s - 4ms/step - loss: 0.1136 - val_loss: 0.4357
Epoch 13/100
151/151 - 1s - 4ms/step - loss: 0.1108 - val_loss: 0.4381
Epoch 14/100
151/151 - 1s - 4ms/step - loss: 0.1090 - val_loss: 0.4225
Epoch 15/100
151/151 - 1s - 4ms/step - loss: 0.1072 - val_loss: 0.4154
Epoch 16/100
151/151 - 1s - 4ms/step - loss: 0.1047 - val_loss: 0.4245
Epoch 17/100
151/151 - 1s - 4ms/step - loss: 0.1035 - val_loss: 0.4379
Epoch 18/100
151/151 - 1s - 4ms/step - loss: 0.1014 - val_loss: 0.4372
Epoch 19/100
151/151 - 1s - 4ms/step - loss: 0.1008 - val_loss: 0.4061
Epoch 20/100
151/151 - 1s - 4ms/step - loss: 0.1001 - val_loss: 0.4141
Epoch 21/100
151/151 - 1s - 4ms/step - loss: 0.0979 - val_loss: 0.4234
Epoch 22/100
151/151 - 1s - 4ms/step - loss: 0.0959 - val_loss: 0.4222
Epoch 23/100
151/151 - 1s - 4ms/step - loss: 0.0965 - val_loss: 0.4203
Epoch 24/100
151/151 - 1s - 4ms/step - loss: 0.0940 - val_loss: 0.4209
Epoch 25/100
151/151 - 1s - 4ms/step - loss: 0.0936 - val_loss: 0.4257
Epoch 26/100
151/151 - 1s - 4ms/step - loss: 0.0922 - val_loss: 0.4159
Epoch 27/100
151/151 - 1s - 4ms/step - loss: 0.0931 - val_loss: 0.4074
Epoch 28/100
151/151 - 1s - 4ms/step - loss: 0.0908 - val_loss: 0.4233
Epoch 29/100
151/151 - 1s - 4ms/step - loss: 0.0905 - val_loss: 0.4005
Epoch 30/100
151/151 - 1s - 4ms/step - loss: 0.0899 - val_loss: 0.4395
Epoch 31/100
151/151 - 1s - 4ms/step - loss: 0.0890 - val_loss: 0.4217
Epoch 32/100
151/151 - 1s - 4ms/step - loss: 0.0889 - val_loss: 0.4248
Epoch 33/100
151/151 - 1s - 4ms/step - loss: 0.0881 - val_loss: 0.4320
Epoch 34/100
151/151 - 1s - 4ms/step - loss: 0.0867 - val_loss: 0.4142
Epoch 35/100
151/151 - 1s - 4ms/step - loss: 0.0860 - val_loss: 0.4153
Epoch 36/100
151/151 - 1s - 4ms/step - loss: 0.0847 - val_loss: 0.4233
Epoch 37/100
151/151 - 1s - 4ms/step - loss: 0.0854 - val_loss: 0.4136
Epoch 38/100
151/151 - 1s - 4ms/step - loss: 0.0849 - val_loss: 0.4118
Epoch 39/100
151/151 - 1s - 4ms/step - loss: 0.0853 - val_loss: 0.4118
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1850
Per-joint RMSE: 0.2978 0.2141 0.1803 0.0923 0.0983 0.1416
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:18:47.610559: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:18:47.635499: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:18:48.492044: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:48.496765: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:48.497558: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:48.499255: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:48.500052: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:48.500791: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:48.581874: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:48.582779: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:48.583576: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:48.584318: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:18:48.881393: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.037460e-01  RMSE=3.220962e-01
  per-joint RMSE: 0.4110 0.5106 0.3132 0.1854 0.1555 0.1901
Residual LSTM:  MSE=3.421102e-02      RMSE=1.849622e-01
  per-joint RMSE: 0.2978 0.2141 0.1803 0.0923 0.0983 0.1416
Combined torque MSE=3.421102e-02     RMSE=1.849622e-01
  per-joint RMSE: 0.2978 0.2141 0.1803 0.0923 0.0983 0.1416
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.npz --H 50 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (48200, 50, 18)  Y_train: (48200, 6)
X_test : (19069, 50, 18)  Y_test : (19069, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:18:51.504097: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:18:51.528279: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (48200, 50, 18), Y_train = (48200, 6)
  X_test  = (19069, 50, 18),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:18:52.849670: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:52.854510: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:52.855530: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:52.857236: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:52.858147: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:52.858903: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:52.958946: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:52.959924: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:52.960729: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:18:52.961514: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:18:53.979086: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.2954 - val_loss: 0.3956
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.1804 - val_loss: 0.4161
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.1579 - val_loss: 0.4247
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.1441 - val_loss: 0.4227
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.1353 - val_loss: 0.4219
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1269 - val_loss: 0.4250
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1215 - val_loss: 0.3675
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1144 - val_loss: 0.3758
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1120 - val_loss: 0.3560
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1085 - val_loss: 0.3689
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1059 - val_loss: 0.3657
Epoch 12/100
151/151 - 1s - 4ms/step - loss: 0.1026 - val_loss: 0.3540
Epoch 13/100
151/151 - 1s - 4ms/step - loss: 0.1002 - val_loss: 0.3512
Epoch 14/100
151/151 - 1s - 4ms/step - loss: 0.0990 - val_loss: 0.3737
Epoch 15/100
151/151 - 1s - 4ms/step - loss: 0.0978 - val_loss: 0.3653
Epoch 16/100
151/151 - 1s - 4ms/step - loss: 0.0955 - val_loss: 0.3879
Epoch 17/100
151/151 - 1s - 4ms/step - loss: 0.0941 - val_loss: 0.3905
Epoch 18/100
151/151 - 1s - 4ms/step - loss: 0.0931 - val_loss: 0.3881
Epoch 19/100
151/151 - 1s - 4ms/step - loss: 0.0914 - val_loss: 0.3983
Epoch 20/100
151/151 - 1s - 4ms/step - loss: 0.0900 - val_loss: 0.3900
Epoch 21/100
151/151 - 1s - 4ms/step - loss: 0.0896 - val_loss: 0.3646
Epoch 22/100
151/151 - 1s - 4ms/step - loss: 0.0880 - val_loss: 0.4822
Epoch 23/100
151/151 - 1s - 4ms/step - loss: 0.0873 - val_loss: 0.4418
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1718
Per-joint RMSE: 0.2734 0.2087 0.1602 0.0922 0.0973 0.1232
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:19:09.497078: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:19:09.522392: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:19:10.391442: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:19:10.396270: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:19:10.397191: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:19:10.399122: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:19:10.400032: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:19:10.400894: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:19:10.488422: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:19:10.489315: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:19:10.490200: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:19:10.490983: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:19:10.788420: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.037460e-01  RMSE=3.220962e-01
  per-joint RMSE: 0.4110 0.5106 0.3132 0.1854 0.1555 0.1901
Residual LSTM:  MSE=2.950986e-02      RMSE=1.717844e-01
  per-joint RMSE: 0.2734 0.2087 0.1602 0.0922 0.0973 0.1232
Combined torque MSE=2.950986e-02     RMSE=1.717844e-01
  per-joint RMSE: 0.2734 0.2087 0.1602 0.0922 0.0973 0.1232
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=1                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz                                ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz -t structured -s 1 -r 0 --hp_preset fast_debug --epochs 400 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 400, 'lagrangian_type': <function structured_lagrangian_fn at 0x7c4f5464c1f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz
   dt ≈ 0.027122289385805493
  dof = 6
  Train trajectories = 105
  Test trajectories  = 45
  Train samples = 51043
  Test samples  = 20078
################################################

2026-01-22 09:19:15.510179: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400 | type=structured | dof=6
################################################
2026-01-22 09:19:18.604023: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:19:18.604058: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:19:18.604064: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:19:18.604091: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:19:18.604096: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:19:18.604110: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:19:18.604147: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:19:18.604152: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:19:18.604168: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:19:18.604173: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.2s, Loss=1.18e+01, Inv=1.18e+01, For=1.40e+02, Power=2.56e+00
  [eval] test_mse=1.153e+00  (n=20078)
Epoch 00050: Time=  13.1s, Loss=2.70e+00, Inv=2.70e+00, For=7.71e+01, Power=1.25e+00
Epoch 00100: Time=  19.7s, Loss=2.37e+00, Inv=2.37e+00, For=8.21e+01, Power=1.12e+00
Epoch 00150: Time=  25.9s, Loss=2.21e+00, Inv=2.21e+00, For=1.02e+02, Power=1.04e+00
Epoch 00200: Time=  32.8s, Loss=2.12e+00, Inv=2.12e+00, For=1.24e+02, Power=1.01e+00
  [eval] test_mse=6.300e-01  (n=20078)
Epoch 00250: Time=  39.6s, Loss=2.07e+00, Inv=2.07e+00, For=1.41e+02, Power=9.97e-01
Epoch 00300: Time=  46.5s, Loss=2.03e+00, Inv=2.03e+00, For=1.58e+02, Power=9.85e-01
Epoch 00350: Time=  52.8s, Loss=2.00e+00, Inv=2.00e+00, For=1.68e+02, Power=9.79e-01
Epoch 00400: Time=  59.4s, Loss=1.98e+00, Inv=1.98e+00, For=1.81e+02, Power=9.78e-01
  [eval] test_mse=6.817e-01  (n=20078)
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400
Torque MSE  = 1.136e-01
Torque RMSE = 3.371e-01
Per-joint MSE : 1.613e-01 3.123e-01 1.057e-01 4.861e-02 2.462e-02 2.923e-02
Per-joint RMSE: 4.016e-01 5.588e-01 3.251e-01 2.205e-01 1.569e-01 1.710e-01
Comp Time per Sample = 1.640e-08s / 60986945.3Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz' ===
===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax
Detected n_dof=6 (seed=1)
2026-01-22 09:20:20.207805: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 105 trajectories
2026-01-22 09:20:21.516145: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:20:21.516158: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:20:23.127476: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:20:23.127490: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:20:24.631677: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:20:24.631712: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:20:24.631718: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:20:26.150853: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 25/105
2026-01-22 09:20:27.381718: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 50/105
  done 75/105
2026-01-22 09:20:28.601722: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 100/105
  done 105/105

Exporting split=test: 45 trajectories
  done 25/45
  done 45/45

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.npz --H 25 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.json
H=25, n_dof=6, feature_dim=24
X_train: (49575, 25, 24)  Y_train: (49575, 6)
X_test : (19544, 25, 24)  Y_test : (19544, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:20:30.995682: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:20:31.020639: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (49575, 25, 24), Y_train = (49575, 6)
  X_test  = (19544, 25, 24),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:20:32.204048: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:32.208925: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:32.209854: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:32.211852: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:32.212767: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:32.213647: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:32.300552: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:32.301436: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:32.302261: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:32.303042: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8975 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:20:33.310897: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.2877 - val_loss: 0.3558
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.1727 - val_loss: 0.3238
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.1503 - val_loss: 0.3470
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.1379 - val_loss: 0.3402
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.1299 - val_loss: 0.3304
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.1238 - val_loss: 0.3280
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.1181 - val_loss: 0.3106
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1128 - val_loss: 0.3129
Epoch 9/100
155/155 - 0s - 3ms/step - loss: 0.1073 - val_loss: 0.3336
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1044 - val_loss: 0.3199
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1041 - val_loss: 0.3023
Epoch 12/100
155/155 - 0s - 3ms/step - loss: 0.0982 - val_loss: 0.3132
Epoch 13/100
155/155 - 0s - 3ms/step - loss: 0.0957 - val_loss: 0.3223
Epoch 14/100
155/155 - 0s - 3ms/step - loss: 0.0942 - val_loss: 0.3236
Epoch 15/100
155/155 - 0s - 3ms/step - loss: 0.0921 - val_loss: 0.3278
Epoch 16/100
155/155 - 0s - 3ms/step - loss: 0.0894 - val_loss: 0.3311
Epoch 17/100
155/155 - 0s - 3ms/step - loss: 0.0896 - val_loss: 0.3229
Epoch 18/100
155/155 - 0s - 3ms/step - loss: 0.0882 - val_loss: 0.3305
Epoch 19/100
155/155 - 0s - 3ms/step - loss: 0.0871 - val_loss: 0.3259
Epoch 20/100
155/155 - 0s - 3ms/step - loss: 0.0850 - val_loss: 0.3380
Epoch 21/100
155/155 - 0s - 3ms/step - loss: 0.0856 - val_loss: 0.3337
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1807
Per-joint RMSE: 0.2349 0.2716 0.1661 0.1349 0.1046 0.1008
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:20:43.560701: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:20:43.585640: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 09:20:44.443737: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:44.448312: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:44.449210: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:44.451036: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:44.451830: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:44.452576: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:44.535517: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:44.536360: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:44.537100: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:44.537918: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:20:44.833769: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.128760e-01  RMSE=3.359702e-01
  per-joint RMSE: 0.4015 0.5562 0.3228 0.2207 0.1564 0.1713
Residual LSTM:  MSE=3.264073e-02      RMSE=1.806675e-01
  per-joint RMSE: 0.2349 0.2716 0.1661 0.1349 0.1046 0.1008
Combined torque MSE=3.264073e-02     RMSE=1.806675e-01
  per-joint RMSE: 0.2349 0.2716 0.1661 0.1349 0.1046 0.1008
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.npz --H 25 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.json
H=25, n_dof=6, feature_dim=6
X_train: (49575, 25, 6)  Y_train: (49575, 6)
X_test : (19544, 25, 6)  Y_test : (19544, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:20:47.185516: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:20:47.209626: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (49575, 25, 6), Y_train = (49575, 6)
  X_test  = (19544, 25, 6),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:20:48.232157: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:48.236620: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:48.237408: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:48.238988: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:48.239769: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:48.240504: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:48.324650: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:48.325486: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:48.326238: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:48.326978: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:20:49.256782: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.6216 - val_loss: 0.9305
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.3877 - val_loss: 0.9507
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.3022 - val_loss: 1.2666
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.2454 - val_loss: 1.1015
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.2106 - val_loss: 1.1221
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.1807 - val_loss: 1.1257
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.1715 - val_loss: 1.1076
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1607 - val_loss: 1.0619
Epoch 9/100
155/155 - 0s - 3ms/step - loss: 0.1560 - val_loss: 1.0915
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1501 - val_loss: 1.1056
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1403 - val_loss: 1.0302
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2626
Per-joint RMSE: 0.3335 0.3758 0.2805 0.1847 0.1440 0.1664
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:20:55.406321: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:20:55.430770: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 09:20:56.285631: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:56.290182: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:56.290975: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:56.292816: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:56.293610: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:56.294348: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:56.376583: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:56.377420: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:56.378162: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:20:56.378889: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:20:56.669471: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.128760e-01  RMSE=3.359702e-01
  per-joint RMSE: 0.4015 0.5562 0.3228 0.2207 0.1564 0.1713
Residual LSTM:  MSE=6.894933e-02      RMSE=2.625821e-01
  per-joint RMSE: 0.3335 0.3758 0.2805 0.1847 0.1440 0.1664
Combined torque MSE=6.894933e-02     RMSE=2.625821e-01
  per-joint RMSE: 0.3335 0.3758 0.2805 0.1847 0.1440 0.1664
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.npz --H 25 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (49575, 25, 18)  Y_train: (49575, 6)
X_test : (19544, 25, 18)  Y_test : (19544, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:20:59.130679: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:20:59.155037: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (49575, 25, 18), Y_train = (49575, 6)
  X_test  = (19544, 25, 18),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:21:00.278801: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:00.283266: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:00.284123: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:00.285965: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:00.286752: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:00.287483: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:00.371736: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:00.372787: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:00.373719: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:00.374507: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:21:01.346920: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.3302 - val_loss: 0.5194
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.2079 - val_loss: 0.5153
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.1792 - val_loss: 0.5991
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.1627 - val_loss: 0.6204
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.1500 - val_loss: 0.6463
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.1404 - val_loss: 0.6586
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.1325 - val_loss: 0.6597
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1245 - val_loss: 0.6143
Epoch 9/100
155/155 - 0s - 3ms/step - loss: 0.1218 - val_loss: 0.6357
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1181 - val_loss: 0.6419
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1148 - val_loss: 0.6086
Epoch 12/100
155/155 - 0s - 3ms/step - loss: 0.1100 - val_loss: 0.6301
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2238
Per-joint RMSE: 0.2913 0.3572 0.1912 0.1544 0.1113 0.1230
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:21:07.922566: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:21:07.947484: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:21:08.812743: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:08.817425: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:08.818293: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:08.819907: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:08.820753: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:08.821533: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:08.899317: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:08.900243: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:08.900989: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:08.901808: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:21:09.196522: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.128760e-01  RMSE=3.359702e-01
  per-joint RMSE: 0.4015 0.5562 0.3228 0.2207 0.1564 0.1713
Residual LSTM:  MSE=5.006506e-02      RMSE=2.237522e-01
  per-joint RMSE: 0.2913 0.3572 0.1912 0.1544 0.1113 0.1230
Combined torque MSE=5.006506e-02     RMSE=2.237522e-01
  per-joint RMSE: 0.2913 0.3572 0.1912 0.1544 0.1113 0.1230
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.npz --H 25 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (49575, 25, 18)  Y_train: (49575, 6)
X_test : (19544, 25, 18)  Y_test : (19544, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:21:11.665289: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:21:11.689437: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (49575, 25, 18), Y_train = (49575, 6)
  X_test  = (19544, 25, 18),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:21:12.808318: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:12.813443: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:12.814236: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:12.816080: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:12.816866: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:12.817600: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:12.900822: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:12.901658: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:12.902401: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:12.903135: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:21:13.843299: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.2970 - val_loss: 0.3333
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.1770 - val_loss: 0.3160
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.1549 - val_loss: 0.2796
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.1423 - val_loss: 0.2734
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.1328 - val_loss: 0.2713
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.1250 - val_loss: 0.2759
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.1180 - val_loss: 0.2912
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1123 - val_loss: 0.2863
Epoch 9/100
155/155 - 0s - 3ms/step - loss: 0.1085 - val_loss: 0.2900
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1051 - val_loss: 0.2896
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1015 - val_loss: 0.2849
Epoch 12/100
155/155 - 0s - 3ms/step - loss: 0.0993 - val_loss: 0.2874
Epoch 13/100
155/155 - 0s - 3ms/step - loss: 0.0979 - val_loss: 0.2826
Epoch 14/100
155/155 - 0s - 3ms/step - loss: 0.0959 - val_loss: 0.2795
Epoch 15/100
155/155 - 0s - 3ms/step - loss: 0.0942 - val_loss: 0.2933
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1849
Per-joint RMSE: 0.2390 0.2819 0.1650 0.1436 0.1018 0.1014
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:21:21.622786: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:21:21.647555: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:21:22.508525: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:22.513216: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:22.514011: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:22.515822: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:22.516618: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:22.517351: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:22.594116: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:22.594948: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:22.595684: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:22.596416: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:21:22.886404: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.128760e-01  RMSE=3.359702e-01
  per-joint RMSE: 0.4015 0.5562 0.3228 0.2207 0.1564 0.1713
Residual LSTM:  MSE=3.418031e-02      RMSE=1.848792e-01
  per-joint RMSE: 0.2390 0.2819 0.1650 0.1436 0.1018 0.1014
Combined torque MSE=3.418031e-02     RMSE=1.848792e-01
  per-joint RMSE: 0.2390 0.2819 0.1650 0.1436 0.1018 0.1014
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.npz --H 50 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.json
H=50, n_dof=6, feature_dim=24
X_train: (48200, 50, 24)  Y_train: (48200, 6)
X_test : (19069, 50, 24)  Y_test : (19069, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:21:25.562529: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:21:25.587014: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (48200, 50, 24), Y_train = (48200, 6)
  X_test  = (19069, 50, 24),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:21:26.971895: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:26.976822: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:26.977739: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:26.979411: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:26.980305: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:26.981163: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:27.067615: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:27.068536: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:27.069396: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:27.070165: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:21:28.129715: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.2907 - val_loss: 0.3483
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.1738 - val_loss: 0.3399
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.1530 - val_loss: 0.3434
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.1401 - val_loss: 0.3524
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.1318 - val_loss: 0.3278
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1242 - val_loss: 0.3440
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1179 - val_loss: 0.3510
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1123 - val_loss: 0.3611
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1074 - val_loss: 0.3614
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1040 - val_loss: 0.3815
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1018 - val_loss: 0.4023
Epoch 12/100
151/151 - 1s - 4ms/step - loss: 0.1000 - val_loss: 0.4132
Epoch 13/100
151/151 - 1s - 4ms/step - loss: 0.0979 - val_loss: 0.3533
Epoch 14/100
151/151 - 1s - 4ms/step - loss: 0.0944 - val_loss: 0.4036
Epoch 15/100
151/151 - 1s - 4ms/step - loss: 0.0925 - val_loss: 0.4043
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1885
Per-joint RMSE: 0.2418 0.2859 0.1798 0.1389 0.1014 0.1056
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:21:38.908184: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:21:38.932981: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 09:21:39.785994: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:39.790547: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:39.791422: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:39.793202: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:39.793995: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:39.794737: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:39.871093: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:39.871930: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:39.872677: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:39.873401: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:21:40.174304: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.130883e-01  RMSE=3.362861e-01
  per-joint RMSE: 0.4005 0.5586 0.3235 0.2195 0.1557 0.1703
Residual LSTM:  MSE=3.553891e-02      RMSE=1.885177e-01
  per-joint RMSE: 0.2418 0.2859 0.1798 0.1389 0.1014 0.1056
Combined torque MSE=3.553891e-02     RMSE=1.885177e-01
  per-joint RMSE: 0.2418 0.2859 0.1798 0.1389 0.1014 0.1056
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.npz --H 50 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.json
H=50, n_dof=6, feature_dim=6
X_train: (48200, 50, 6)  Y_train: (48200, 6)
X_test : (19069, 50, 6)  Y_test : (19069, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:21:42.595163: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:21:42.619373: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (48200, 50, 6), Y_train = (48200, 6)
  X_test  = (19069, 50, 6),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:21:43.744895: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:43.749555: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:43.750354: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:43.752103: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:43.752890: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:43.753628: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:43.828836: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:43.829679: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:43.830429: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:43.831163: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8972 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:21:44.777035: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.5890 - val_loss: 1.1222
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.3276 - val_loss: 1.2043
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.2509 - val_loss: 1.2725
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.2126 - val_loss: 1.2399
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.1831 - val_loss: 1.2647
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1987 - val_loss: 1.2070
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1801 - val_loss: 1.3212
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1573 - val_loss: 1.5714
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1491 - val_loss: 1.4879
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1446 - val_loss: 1.5332
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1392 - val_loss: 1.6968
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2534
Per-joint RMSE: 0.3318 0.3514 0.2747 0.1783 0.1405 0.1571
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:21:52.968985: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:21:52.994195: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 09:21:53.850515: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:53.855151: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:53.857323: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:53.859212: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:53.860025: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:53.860759: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:53.937264: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:53.938183: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:53.938923: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:53.939657: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:21:54.232898: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.130883e-01  RMSE=3.362861e-01
  per-joint RMSE: 0.4005 0.5586 0.3235 0.2195 0.1557 0.1703
Residual LSTM:  MSE=6.420390e-02      RMSE=2.533849e-01
  per-joint RMSE: 0.3318 0.3514 0.2747 0.1783 0.1405 0.1571
Combined torque MSE=6.420390e-02     RMSE=2.533849e-01
  per-joint RMSE: 0.3318 0.3514 0.2747 0.1783 0.1405 0.1571
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.npz --H 50 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (48200, 50, 18)  Y_train: (48200, 6)
X_test : (19069, 50, 18)  Y_test : (19069, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:21:56.823610: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:21:56.848040: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (48200, 50, 18), Y_train = (48200, 6)
  X_test  = (19069, 50, 18),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:21:58.161136: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:58.165924: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:58.166831: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:58.168435: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:58.169337: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:58.170200: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:58.258024: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:58.258911: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:58.259714: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:21:58.260499: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:21:59.284228: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.3315 - val_loss: 0.4119
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.2094 - val_loss: 0.4073
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.1807 - val_loss: 0.4726
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.1628 - val_loss: 0.4987
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.1529 - val_loss: 0.4672
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1451 - val_loss: 0.4173
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1367 - val_loss: 0.3856
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1316 - val_loss: 0.4218
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1247 - val_loss: 0.4137
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1203 - val_loss: 0.4199
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1151 - val_loss: 0.4120
Epoch 12/100
151/151 - 1s - 4ms/step - loss: 0.1142 - val_loss: 0.4420
Epoch 13/100
151/151 - 1s - 4ms/step - loss: 0.1100 - val_loss: 0.4462
Epoch 14/100
151/151 - 1s - 4ms/step - loss: 0.1094 - val_loss: 0.4574
Epoch 15/100
151/151 - 1s - 4ms/step - loss: 0.1067 - val_loss: 0.4750
Epoch 16/100
151/151 - 1s - 4ms/step - loss: 0.1050 - val_loss: 0.4414
Epoch 17/100
151/151 - 1s - 4ms/step - loss: 0.1021 - val_loss: 0.4752
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2227
Per-joint RMSE: 0.2954 0.3547 0.1941 0.1501 0.1048 0.1148
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:22:11.234690: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:22:11.260381: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:22:12.130576: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:12.135231: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:12.136110: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:12.137754: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:12.138553: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:12.139301: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:12.218691: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:12.219532: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:12.220283: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:12.221014: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:22:12.516371: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.130883e-01  RMSE=3.362861e-01
  per-joint RMSE: 0.4005 0.5586 0.3235 0.2195 0.1557 0.1703
Residual LSTM:  MSE=4.957388e-02      RMSE=2.226519e-01
  per-joint RMSE: 0.2954 0.3547 0.1941 0.1501 0.1048 0.1148
Combined torque MSE=4.957388e-02     RMSE=2.226519e-01
  per-joint RMSE: 0.2954 0.3547 0.1941 0.1501 0.1048 0.1148
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.npz --H 50 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (48200, 50, 18)  Y_train: (48200, 6)
X_test : (19069, 50, 18)  Y_test : (19069, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:22:15.154299: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:22:15.179023: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (48200, 50, 18), Y_train = (48200, 6)
  X_test  = (19069, 50, 18),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:22:16.500858: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:16.505601: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:16.506610: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:16.508172: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:16.509077: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:16.509934: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:16.591738: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:16.592625: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:16.593413: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:16.594195: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:22:17.593166: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.2906 - val_loss: 0.3858
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.1794 - val_loss: 0.3352
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.1562 - val_loss: 0.3660
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.1431 - val_loss: 0.3353
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.1317 - val_loss: 0.3617
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1239 - val_loss: 0.3546
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1183 - val_loss: 0.3415
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1149 - val_loss: 0.3508
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1111 - val_loss: 0.3402
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1067 - val_loss: 0.3423
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1041 - val_loss: 0.3428
Epoch 12/100
151/151 - 1s - 4ms/step - loss: 0.1025 - val_loss: 0.3555
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2059
Per-joint RMSE: 0.2674 0.3248 0.1763 0.1548 0.0990 0.1123
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:22:26.530709: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:22:26.555601: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:22:27.413911: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:27.418607: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:27.419474: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:27.421153: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:27.421946: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:27.422686: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:27.506684: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:27.507524: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:27.508269: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:22:27.508997: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:22:27.809263: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.130883e-01  RMSE=3.362861e-01
  per-joint RMSE: 0.4005 0.5586 0.3235 0.2195 0.1557 0.1703
Residual LSTM:  MSE=4.241384e-02      RMSE=2.059462e-01
  per-joint RMSE: 0.2674 0.3248 0.1763 0.1548 0.0990 0.1123
Combined torque MSE=4.241384e-02     RMSE=2.059462e-01
  per-joint RMSE: 0.2674 0.3248 0.1763 0.1548 0.0990 0.1123
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=2                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz                                ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz -t structured -s 2 -r 0 --hp_preset fast_debug --epochs 400 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 400, 'lagrangian_type': <function structured_lagrangian_fn at 0x764980d481f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz
   dt ≈ 0.027122289385805493
  dof = 6
  Train trajectories = 105
  Test trajectories  = 45
  Train samples = 51043
  Test samples  = 20078
################################################

2026-01-22 09:22:32.486844: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400 | type=structured | dof=6
################################################
2026-01-22 09:22:35.630881: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:22:35.630917: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:22:35.630923: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:22:35.630951: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:22:35.630957: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:22:35.630972: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:22:35.631009: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:22:35.631015: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:22:35.631030: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:22:35.631035: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.1s, Loss=9.71e+00, Inv=9.71e+00, For=1.07e+02, Power=2.53e+00
  [eval] test_mse=1.052e+00  (n=20078)
Epoch 00050: Time=  13.4s, Loss=2.64e+00, Inv=2.64e+00, For=7.65e+01, Power=1.26e+00
Epoch 00100: Time=  20.1s, Loss=2.34e+00, Inv=2.34e+00, For=1.01e+02, Power=1.12e+00
Epoch 00150: Time=  27.0s, Loss=2.20e+00, Inv=2.20e+00, For=1.17e+02, Power=1.06e+00
Epoch 00200: Time=  33.9s, Loss=2.12e+00, Inv=2.12e+00, For=1.27e+02, Power=1.01e+00
  [eval] test_mse=6.415e-01  (n=20078)
Epoch 00250: Time=  40.6s, Loss=2.06e+00, Inv=2.06e+00, For=1.38e+02, Power=1.00e+00
Epoch 00300: Time=  47.2s, Loss=2.02e+00, Inv=2.02e+00, For=1.52e+02, Power=9.87e-01
Epoch 00350: Time=  53.8s, Loss=1.99e+00, Inv=1.99e+00, For=1.71e+02, Power=9.80e-01
Epoch 00400: Time=  60.2s, Loss=1.97e+00, Inv=1.97e+00, For=1.93e+02, Power=9.69e-01
  [eval] test_mse=7.011e-01  (n=20078)
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400
Torque MSE  = 1.168e-01
Torque RMSE = 3.418e-01
Per-joint MSE : 1.206e-01 3.586e-01 1.043e-01 3.674e-02 5.203e-02 2.882e-02
Per-joint RMSE: 3.472e-01 5.988e-01 3.230e-01 1.917e-01 2.281e-01 1.698e-01
Comp Time per Sample = 1.681e-08s / 59501124.7Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz' ===
===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p3_seed1_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax
Detected n_dof=6 (seed=2)
2026-01-22 09:23:37.976084: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 105 trajectories
2026-01-22 09:23:39.283486: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:23:39.283498: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:23:40.874986: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:23:40.875000: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:23:42.368392: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:23:42.368427: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:23:42.368432: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 09:23:43.856502: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 25/105
2026-01-22 09:23:44.985680: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 50/105
  done 75/105
2026-01-22 09:23:46.228687: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 100/105
  done 105/105

Exporting split=test: 45 trajectories
  done 25/45
  done 45/45

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.npz --H 25 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.json
H=25, n_dof=6, feature_dim=24
X_train: (49575, 25, 24)  Y_train: (49575, 6)
X_test : (19544, 25, 24)  Y_test : (19544, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:23:48.624511: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:23:48.648760: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (49575, 25, 24), Y_train = (49575, 6)
  X_test  = (19544, 25, 24),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:23:49.824596: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:23:49.830166: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:23:49.831130: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:23:49.833058: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:23:49.833994: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:23:49.834870: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:23:49.924695: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:23:49.925603: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:23:49.926469: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:23:49.927347: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8975 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:23:50.930279: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.2912 - val_loss: 0.3792
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.1766 - val_loss: 0.3687
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.1542 - val_loss: 0.3775
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.1413 - val_loss: 0.3899
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.1330 - val_loss: 0.3585
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.1270 - val_loss: 0.3555
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.1202 - val_loss: 0.3537
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1157 - val_loss: 0.3334
Epoch 9/100
155/155 - 0s - 3ms/step - loss: 0.1094 - val_loss: 0.3460
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1089 - val_loss: 0.3287
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1067 - val_loss: 0.3314
Epoch 12/100
155/155 - 0s - 3ms/step - loss: 0.1008 - val_loss: 0.3411
Epoch 13/100
155/155 - 0s - 3ms/step - loss: 0.1008 - val_loss: 0.3368
Epoch 14/100
155/155 - 0s - 3ms/step - loss: 0.0954 - val_loss: 0.3465
Epoch 15/100
155/155 - 0s - 3ms/step - loss: 0.0954 - val_loss: 0.3479
Epoch 16/100
155/155 - 0s - 3ms/step - loss: 0.0932 - val_loss: 0.3374
Epoch 17/100
155/155 - 0s - 3ms/step - loss: 0.0909 - val_loss: 0.3389
Epoch 18/100
155/155 - 0s - 3ms/step - loss: 0.0925 - val_loss: 0.3335
Epoch 19/100
155/155 - 0s - 3ms/step - loss: 0.0877 - val_loss: 0.3191
Epoch 20/100
155/155 - 0s - 3ms/step - loss: 0.0871 - val_loss: 0.3145
Epoch 21/100
155/155 - 0s - 3ms/step - loss: 0.0879 - val_loss: 0.3248
Epoch 22/100
155/155 - 0s - 3ms/step - loss: 0.0854 - val_loss: 0.3215
Epoch 23/100
155/155 - 0s - 3ms/step - loss: 0.0856 - val_loss: 0.3321
Epoch 24/100
155/155 - 0s - 3ms/step - loss: 0.0836 - val_loss: 0.3233
Epoch 25/100
155/155 - 0s - 3ms/step - loss: 0.0822 - val_loss: 0.3347
Epoch 26/100
155/155 - 0s - 3ms/step - loss: 0.0814 - val_loss: 0.3218
Epoch 27/100
155/155 - 0s - 3ms/step - loss: 0.0807 - val_loss: 0.3252
Epoch 28/100
155/155 - 0s - 3ms/step - loss: 0.0801 - val_loss: 0.3364
Epoch 29/100
155/155 - 0s - 3ms/step - loss: 0.0790 - val_loss: 0.3366
Epoch 30/100
155/155 - 0s - 3ms/step - loss: 0.0778 - val_loss: 0.3336
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1950
Per-joint RMSE: 0.1742 0.3284 0.1838 0.1080 0.1772 0.1144
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:24:04.862080: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:24:04.887086: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 09:24:05.741688: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:05.746407: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:05.747284: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:05.749026: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:05.749820: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:05.750556: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:05.827367: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:05.828205: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:05.828959: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:05.829752: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:24:06.124603: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.162637e-01  RMSE=3.409746e-01
  per-joint RMSE: 0.3457 0.5976 0.3205 0.1911 0.2293 0.1704
Residual LSTM:  MSE=3.803079e-02      RMSE=1.950148e-01
  per-joint RMSE: 0.1742 0.3284 0.1838 0.1080 0.1772 0.1144
Combined torque MSE=3.803079e-02     RMSE=1.950148e-01
  per-joint RMSE: 0.1742 0.3284 0.1838 0.1080 0.1772 0.1144
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.npz --H 25 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.json
H=25, n_dof=6, feature_dim=6
X_train: (49575, 25, 6)  Y_train: (49575, 6)
X_test : (19544, 25, 6)  Y_test : (19544, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:24:08.454200: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:24:08.478511: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (49575, 25, 6), Y_train = (49575, 6)
  X_test  = (19544, 25, 6),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:24:09.500118: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:09.504883: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:09.505745: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:09.507294: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:09.508159: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:09.508890: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:09.582604: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:09.583436: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:09.584182: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:09.584921: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:24:10.504284: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.6186 - val_loss: 1.0149
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.4090 - val_loss: 0.9909
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.3397 - val_loss: 0.9294
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.2906 - val_loss: 1.0060
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.2516 - val_loss: 1.0656
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.2234 - val_loss: 0.9294
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.1849 - val_loss: 1.0610
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1835 - val_loss: 1.1312
Epoch 9/100
155/155 - 0s - 3ms/step - loss: 0.1671 - val_loss: 1.0511
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1521 - val_loss: 1.1242
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1473 - val_loss: 1.0749
Epoch 12/100
155/155 - 0s - 3ms/step - loss: 0.1647 - val_loss: 0.9537
Epoch 13/100
155/155 - 0s - 3ms/step - loss: 0.1581 - val_loss: 1.0417
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2658
Per-joint RMSE: 0.2679 0.4394 0.2557 0.1816 0.2000 0.1437
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:24:17.395316: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:24:17.419835: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 09:24:18.277375: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:18.282123: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:18.282924: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:18.284548: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:18.285350: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:18.286084: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:18.371001: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:18.371833: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:18.372633: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:18.373404: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:24:18.664350: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.162637e-01  RMSE=3.409746e-01
  per-joint RMSE: 0.3457 0.5976 0.3205 0.1911 0.2293 0.1704
Residual LSTM:  MSE=7.063889e-02      RMSE=2.657798e-01
  per-joint RMSE: 0.2679 0.4394 0.2557 0.1816 0.2000 0.1437
Combined torque MSE=7.063889e-02     RMSE=2.657798e-01
  per-joint RMSE: 0.2679 0.4394 0.2557 0.1816 0.2000 0.1437
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.npz --H 25 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (49575, 25, 18)  Y_train: (49575, 6)
X_test : (19544, 25, 18)  Y_test : (19544, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:24:21.106515: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:24:21.130406: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (49575, 25, 18), Y_train = (49575, 6)
  X_test  = (19544, 25, 18),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:24:22.246113: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:22.250704: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:22.251689: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:22.253509: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:22.254408: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:22.255264: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:22.347976: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:22.348866: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:22.349644: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:22.350428: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:24:23.316478: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.3340 - val_loss: 0.4815
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.2093 - val_loss: 0.4978
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.1783 - val_loss: 0.4789
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.1602 - val_loss: 0.4974
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.1486 - val_loss: 0.4846
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.1403 - val_loss: 0.5170
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.1317 - val_loss: 0.5103
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1270 - val_loss: 0.5502
Epoch 9/100
155/155 - 0s - 3ms/step - loss: 0.1223 - val_loss: 0.5340
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1179 - val_loss: 0.5358
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1157 - val_loss: 0.5447
Epoch 12/100
155/155 - 0s - 3ms/step - loss: 0.1131 - val_loss: 0.5169
Epoch 13/100
155/155 - 0s - 3ms/step - loss: 0.1094 - val_loss: 0.5412
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2302
Per-joint RMSE: 0.2130 0.4111 0.1867 0.1139 0.2028 0.1203
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:24:30.245957: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:24:30.270532: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:24:31.121717: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:31.126390: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:31.127180: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:31.128801: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:31.129601: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:31.130332: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:31.209484: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:31.210397: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:31.211143: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:31.211868: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:24:31.507925: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.162637e-01  RMSE=3.409746e-01
  per-joint RMSE: 0.3457 0.5976 0.3205 0.1911 0.2293 0.1704
Residual LSTM:  MSE=5.297541e-02      RMSE=2.301639e-01
  per-joint RMSE: 0.2130 0.4111 0.1867 0.1139 0.2028 0.1203
Combined torque MSE=5.297541e-02     RMSE=2.301639e-01
  per-joint RMSE: 0.2130 0.4111 0.1867 0.1139 0.2028 0.1203
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.npz --H 25 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (49575, 25, 18)  Y_train: (49575, 6)
X_test : (19544, 25, 18)  Y_test : (19544, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:24:33.940512: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:24:33.964238: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (49575, 25, 18), Y_train = (49575, 6)
  X_test  = (19544, 25, 18),  Y_test  = (19544, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:24:35.118565: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:35.123613: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:35.124617: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:35.126338: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:35.127248: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:35.128093: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:35.215639: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:35.216528: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:35.217328: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:35.218109: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:24:36.174363: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
155/155 - 2s - 11ms/step - loss: 0.2923 - val_loss: 0.3772
Epoch 2/100
155/155 - 0s - 3ms/step - loss: 0.1802 - val_loss: 0.3430
Epoch 3/100
155/155 - 0s - 3ms/step - loss: 0.1568 - val_loss: 0.3188
Epoch 4/100
155/155 - 0s - 3ms/step - loss: 0.1438 - val_loss: 0.2882
Epoch 5/100
155/155 - 0s - 3ms/step - loss: 0.1326 - val_loss: 0.3026
Epoch 6/100
155/155 - 0s - 3ms/step - loss: 0.1243 - val_loss: 0.2999
Epoch 7/100
155/155 - 0s - 3ms/step - loss: 0.1176 - val_loss: 0.3071
Epoch 8/100
155/155 - 0s - 3ms/step - loss: 0.1137 - val_loss: 0.3109
Epoch 9/100
155/155 - 0s - 3ms/step - loss: 0.1092 - val_loss: 0.3100
Epoch 10/100
155/155 - 0s - 3ms/step - loss: 0.1064 - val_loss: 0.3209
Epoch 11/100
155/155 - 0s - 3ms/step - loss: 0.1033 - val_loss: 0.3188
Epoch 12/100
155/155 - 0s - 3ms/step - loss: 0.1015 - val_loss: 0.3063
Epoch 13/100
155/155 - 0s - 3ms/step - loss: 0.0992 - val_loss: 0.3050
Epoch 14/100
155/155 - 0s - 3ms/step - loss: 0.0974 - val_loss: 0.3124
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2046
Per-joint RMSE: 0.1892 0.3648 0.1683 0.1016 0.1772 0.1108
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:24:43.590702: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:24:43.615345: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:24:44.469423: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:44.474325: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:44.475122: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:44.476791: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:44.477594: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:44.478328: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:44.562328: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:44.563160: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:44.563899: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:44.564624: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:24:44.859786: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.162637e-01  RMSE=3.409746e-01
  per-joint RMSE: 0.3457 0.5976 0.3205 0.1911 0.2293 0.1704
Residual LSTM:  MSE=4.186835e-02      RMSE=2.046176e-01
  per-joint RMSE: 0.1892 0.3648 0.1683 0.1016 0.1772 0.1108
Combined torque MSE=4.186835e-02     RMSE=2.046176e-01
  per-joint RMSE: 0.1892 0.3648 0.1683 0.1016 0.1772 0.1108
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.npz --H 50 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.json
H=50, n_dof=6, feature_dim=24
X_train: (48200, 50, 24)  Y_train: (48200, 6)
X_test : (19069, 50, 24)  Y_test : (19069, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:24:47.505268: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:24:47.529219: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (48200, 50, 24), Y_train = (48200, 6)
  X_test  = (19069, 50, 24),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:24:48.931939: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:48.936651: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:48.937568: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:48.939339: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:48.940252: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:48.941208: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:49.023180: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:49.024162: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:49.024955: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:49.025738: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:24:50.052101: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.2962 - val_loss: 0.3623
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.1761 - val_loss: 0.4129
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.1555 - val_loss: 0.3964
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.1416 - val_loss: 0.4395
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.1327 - val_loss: 0.4218
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1266 - val_loss: 0.3883
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1212 - val_loss: 0.4004
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1165 - val_loss: 0.3835
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1132 - val_loss: 0.4151
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1125 - val_loss: 0.3677
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1083 - val_loss: 0.4023
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2124
Per-joint RMSE: 0.1903 0.3762 0.1731 0.1069 0.1957 0.1155
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:24:58.336068: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:24:58.360721: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 09:24:59.213780: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:59.218423: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:59.219280: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:59.220926: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:59.221715: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:59.222456: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:59.308050: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:59.308962: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:59.309698: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:24:59.310422: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:24:59.604857: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.164604e-01  RMSE=3.412629e-01
  per-joint RMSE: 0.3418 0.6017 0.3199 0.1896 0.2299 0.1697
Residual LSTM:  MSE=4.512244e-02      RMSE=2.124204e-01
  per-joint RMSE: 0.1903 0.3762 0.1731 0.1069 0.1957 0.1155
Combined torque MSE=4.512244e-02     RMSE=2.124204e-01
  per-joint RMSE: 0.1903 0.3762 0.1731 0.1069 0.1957 0.1155
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.npz --H 50 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.json
H=50, n_dof=6, feature_dim=6
X_train: (48200, 50, 6)  Y_train: (48200, 6)
X_test : (19069, 50, 6)  Y_test : (19069, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:25:02.047369: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:25:02.071369: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (48200, 50, 6), Y_train = (48200, 6)
  X_test  = (19069, 50, 6),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:25:03.180060: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:03.184883: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:03.185841: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:03.187611: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:03.188402: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:03.189142: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:03.263306: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:03.264202: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:03.265003: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:03.265785: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:25:04.207250: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.5744 - val_loss: 1.0242
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.3379 - val_loss: 1.1810
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.2633 - val_loss: 1.1355
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.2324 - val_loss: 1.2051
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.1809 - val_loss: 1.1737
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1608 - val_loss: 1.3395
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1768 - val_loss: 1.2051
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1497 - val_loss: 1.1691
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1409 - val_loss: 1.1483
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1388 - val_loss: 1.1231
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1331 - val_loss: 1.1798
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2768
Per-joint RMSE: 0.2812 0.4634 0.2685 0.1608 0.2140 0.1492
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:25:12.356918: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:25:12.381926: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 09:25:13.237968: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:13.242711: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:13.243517: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:13.245332: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:13.246215: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:13.246957: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:13.330888: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:13.331712: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:13.332450: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:13.333276: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:25:13.628726: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.164604e-01  RMSE=3.412629e-01
  per-joint RMSE: 0.3418 0.6017 0.3199 0.1896 0.2299 0.1697
Residual LSTM:  MSE=7.663145e-02      RMSE=2.768238e-01
  per-joint RMSE: 0.2812 0.4634 0.2685 0.1608 0.2140 0.1492
Combined torque MSE=7.663147e-02     RMSE=2.768239e-01
  per-joint RMSE: 0.2812 0.4634 0.2685 0.1608 0.2140 0.1492
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.npz --H 50 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (48200, 50, 18)  Y_train: (48200, 6)
X_test : (19069, 50, 18)  Y_test : (19069, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:25:16.280079: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:25:16.303928: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (48200, 50, 18), Y_train = (48200, 6)
  X_test  = (19069, 50, 18),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:25:17.616782: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:17.621692: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:17.622620: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:17.624413: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:17.625310: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:17.626059: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:17.714621: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:17.715513: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:17.716406: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:17.717180: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:25:18.721002: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.3324 - val_loss: 0.5435
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.2096 - val_loss: 0.5792
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.1805 - val_loss: 0.6256
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.1636 - val_loss: 0.5455
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.1533 - val_loss: 0.5274
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1435 - val_loss: 0.5847
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1358 - val_loss: 0.5250
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1280 - val_loss: 0.4982
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1227 - val_loss: 0.5816
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1203 - val_loss: 0.4910
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1171 - val_loss: 0.4999
Epoch 12/100
151/151 - 1s - 4ms/step - loss: 0.1143 - val_loss: 0.4922
Epoch 13/100
151/151 - 1s - 4ms/step - loss: 0.1113 - val_loss: 0.5129
Epoch 14/100
151/151 - 1s - 4ms/step - loss: 0.1093 - val_loss: 0.5148
Epoch 15/100
151/151 - 1s - 4ms/step - loss: 0.1064 - val_loss: 0.5205
Epoch 16/100
151/151 - 1s - 4ms/step - loss: 0.1044 - val_loss: 0.5381
Epoch 17/100
151/151 - 1s - 4ms/step - loss: 0.1029 - val_loss: 0.5207
Epoch 18/100
151/151 - 1s - 4ms/step - loss: 0.1017 - val_loss: 0.5124
Epoch 19/100
151/151 - 1s - 4ms/step - loss: 0.1003 - val_loss: 0.5339
Epoch 20/100
151/151 - 1s - 4ms/step - loss: 0.1011 - val_loss: 0.5444
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2247
Per-joint RMSE: 0.2005 0.4034 0.1897 0.1038 0.2007 0.1137
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:25:32.235999: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:25:32.260540: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:25:33.115051: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:33.119781: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:33.120729: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:33.122494: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:33.123285: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:33.124028: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:33.204483: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:33.205314: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:33.206144: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:33.206878: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:25:33.507725: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.164604e-01  RMSE=3.412629e-01
  per-joint RMSE: 0.3418 0.6017 0.3199 0.1896 0.2299 0.1697
Residual LSTM:  MSE=5.047321e-02      RMSE=2.246624e-01
  per-joint RMSE: 0.2005 0.4034 0.1897 0.1038 0.2007 0.1137
Combined torque MSE=5.047321e-02     RMSE=2.246624e-01
  per-joint RMSE: 0.2005 0.4034 0.1897 0.1038 0.2007 0.1137
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.npz --H 50 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (48200, 50, 18)  Y_train: (48200, 6)
X_test : (19069, 50, 18)  Y_test : (19069, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:25:36.134743: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:25:36.158887: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (48200, 50, 18), Y_train = (48200, 6)
  X_test  = (19069, 50, 18),  Y_test  = (19069, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 09:25:37.471870: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:37.476835: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:37.477746: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:37.479729: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:37.480640: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:37.481490: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:37.569226: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:37.570195: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:37.570990: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:37.571775: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 09:25:38.614791: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
151/151 - 2s - 13ms/step - loss: 0.2933 - val_loss: 0.3439
Epoch 2/100
151/151 - 1s - 4ms/step - loss: 0.1797 - val_loss: 0.3480
Epoch 3/100
151/151 - 1s - 4ms/step - loss: 0.1565 - val_loss: 0.3443
Epoch 4/100
151/151 - 1s - 4ms/step - loss: 0.1424 - val_loss: 0.3492
Epoch 5/100
151/151 - 1s - 4ms/step - loss: 0.1304 - val_loss: 0.3034
Epoch 6/100
151/151 - 1s - 4ms/step - loss: 0.1238 - val_loss: 0.3439
Epoch 7/100
151/151 - 1s - 4ms/step - loss: 0.1168 - val_loss: 0.3327
Epoch 8/100
151/151 - 1s - 4ms/step - loss: 0.1126 - val_loss: 0.3009
Epoch 9/100
151/151 - 1s - 4ms/step - loss: 0.1092 - val_loss: 0.3081
Epoch 10/100
151/151 - 1s - 4ms/step - loss: 0.1065 - val_loss: 0.3179
Epoch 11/100
151/151 - 1s - 4ms/step - loss: 0.1030 - val_loss: 0.2963
Epoch 12/100
151/151 - 1s - 4ms/step - loss: 0.1023 - val_loss: 0.2925
Epoch 13/100
151/151 - 1s - 4ms/step - loss: 0.1000 - val_loss: 0.2936
Epoch 14/100
151/151 - 1s - 4ms/step - loss: 0.0974 - val_loss: 0.3038
Epoch 15/100
151/151 - 1s - 4ms/step - loss: 0.0952 - val_loss: 0.2958
Epoch 16/100
151/151 - 1s - 4ms/step - loss: 0.0963 - val_loss: 0.3058
Epoch 17/100
151/151 - 1s - 4ms/step - loss: 0.0931 - val_loss: 0.2994
Epoch 18/100
151/151 - 1s - 4ms/step - loss: 0.0915 - val_loss: 0.2961
Epoch 19/100
151/151 - 1s - 4ms/step - loss: 0.0907 - val_loss: 0.2937
Epoch 20/100
151/151 - 1s - 4ms/step - loss: 0.0897 - val_loss: 0.2879
Epoch 21/100
151/151 - 1s - 4ms/step - loss: 0.0884 - val_loss: 0.2967
Epoch 22/100
151/151 - 1s - 4ms/step - loss: 0.0878 - val_loss: 0.3142
Epoch 23/100
151/151 - 1s - 4ms/step - loss: 0.0861 - val_loss: 0.3071
Epoch 24/100
151/151 - 1s - 4ms/step - loss: 0.0846 - val_loss: 0.3030
Epoch 25/100
151/151 - 1s - 4ms/step - loss: 0.0846 - val_loss: 0.3057
Epoch 26/100
151/151 - 1s - 4ms/step - loss: 0.0837 - val_loss: 0.3185
Epoch 27/100
151/151 - 1s - 4ms/step - loss: 0.0827 - val_loss: 0.3111
Epoch 28/100
151/151 - 1s - 4ms/step - loss: 0.0825 - val_loss: 0.3006
Epoch 29/100
151/151 - 1s - 4ms/step - loss: 0.0807 - val_loss: 0.3029
Epoch 30/100
151/151 - 1s - 4ms/step - loss: 0.0803 - val_loss: 0.3069
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1978
Per-joint RMSE: 0.1805 0.3469 0.1653 0.0978 0.1802 0.1120
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 09:25:58.277659: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 09:25:58.302480: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p3__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 45
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 09:25:59.160258: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:59.165223: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:59.166092: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:59.167940: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:59.168732: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:59.169468: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:59.245712: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:59.246628: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:59.247367: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 09:25:59.248092: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8970 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 09:25:59.543917: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/45
  done 45/45

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.164604e-01  RMSE=3.412629e-01
  per-joint RMSE: 0.3418 0.6017 0.3199 0.1896 0.2299 0.1697
Residual LSTM:  MSE=3.913730e-02      RMSE=1.978315e-01
  per-joint RMSE: 0.1805 0.3469 0.1653 0.0978 0.1802 0.1120
Combined torque MSE=3.913730e-02     RMSE=1.978315e-01
  per-joint RMSE: 0.1805 0.3469 0.1653 0.0978 0.1802 0.1120
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p3__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

