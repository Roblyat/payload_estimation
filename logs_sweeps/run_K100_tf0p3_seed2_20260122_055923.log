#################################################################################################################
### RUN: K=100 test_fraction=0.3 seed=2                                                                       ###
### npz_in=/workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz ###
#################################################################################################################

#####################
### 1) PREPROCESS ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_delan_dataset.py --qdd True --col_format wide --trajectory_amount 100 --test_fraction 0.3 --seed 2 --raw_csv /workspace/shared/data/raw/delan_UR3_Load0_combined_26.csv --out_npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Saved: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz
Trajectories: train=70 test=30
Exists: True

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=0                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz                                ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz -t structured -s 0 -r 0 --hp_preset fast_debug --epochs 300 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300.jax' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 300, 'lagrangian_type': <function structured_lagrangian_fn at 0x73aa8ef281f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz
   dt ≈ 0.025265617146188975
  dof = 6
  Train trajectories = 70
  Test trajectories  = 30
  Train samples = 35298
  Test samples  = 14539
################################################

2026-01-22 07:51:26.009988: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300 | type=structured | dof=6
################################################
2026-01-22 07:51:29.098268: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:51:29.098304: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:51:29.098310: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:51:29.098341: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:51:29.098347: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:51:29.098362: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:51:29.098400: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:51:29.098406: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:51:29.098421: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:51:29.098426: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.1s, Loss=1.47e+01, Inv=1.47e+01, For=1.57e+02, Power=4.17e+00
  [eval] test_mse=2.504e+00  (n=14539)
Epoch 00050: Time=  10.8s, Loss=2.67e+00, Inv=2.67e+00, For=6.25e+01, Power=1.94e+00
Epoch 00100: Time=  15.2s, Loss=2.39e+00, Inv=2.39e+00, For=6.05e+01, Power=1.72e+00
Epoch 00150: Time=  19.5s, Loss=2.26e+00, Inv=2.26e+00, For=7.15e+01, Power=1.64e+00
Epoch 00200: Time=  23.9s, Loss=2.18e+00, Inv=2.18e+00, For=8.56e+01, Power=1.61e+00
  [eval] test_mse=1.028e+00  (n=14539)
Epoch 00250: Time=  28.8s, Loss=2.13e+00, Inv=2.13e+00, For=1.01e+02, Power=1.59e+00
Epoch 00300: Time=  33.3s, Loss=2.09e+00, Inv=2.09e+00, For=1.19e+02, Power=1.56e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300
Torque MSE  = 2.021e-01
Torque RMSE = 4.495e-01
Per-joint MSE : 2.358e-01 4.835e-01 1.884e-01 1.360e-01 8.948e-02 7.923e-02
Per-joint RMSE: 4.856e-01 6.953e-01 4.340e-01 3.687e-01 2.991e-01 2.815e-01
Comp Time per Sample = 2.251e-08s / 44417085.1Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz' ===
===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep300.jax
Detected n_dof=6 (seed=0)
2026-01-22 07:52:04.582940: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 70 trajectories
2026-01-22 07:52:05.855332: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:52:05.855345: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:52:07.515143: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:52:07.515159: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:52:09.035646: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 25/70
2026-01-22 07:52:10.254444: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:52:11.464486: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:52:11.464521: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:52:11.464527: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 50/70
  done 70/70

Exporting split=test: 30 trajectories
  done 25/30
  done 30/30

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep300.npz --H 25 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep300.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep300.json
H=25, n_dof=6, feature_dim=24
X_train: (34332, 25, 24)  Y_train: (34332, 6)
X_test : (14092, 25, 24)  Y_test : (14092, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:52:14.019393: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:52:14.043711: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep300.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (34332, 25, 24), Y_train = (34332, 6)
  X_test  = (14092, 25, 24),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:52:15.150961: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:15.155814: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:15.156630: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:15.158510: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:15.159433: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:15.160313: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:15.254227: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:15.255116: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:15.255913: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:15.256692: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8962 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:52:16.225814: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.2664 - val_loss: 0.7582
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.1476 - val_loss: 0.7326
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.1261 - val_loss: 0.7386
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1157 - val_loss: 0.7194
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1090 - val_loss: 0.7276
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1038 - val_loss: 0.7314
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.0996 - val_loss: 0.7377
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.0964 - val_loss: 0.7374
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.0937 - val_loss: 0.7368
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.0918 - val_loss: 0.7374
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.0894 - val_loss: 0.7401
Epoch 12/80
108/108 - 0s - 3ms/step - loss: 0.0878 - val_loss: 0.7434
Epoch 13/80
108/108 - 0s - 3ms/step - loss: 0.0855 - val_loss: 0.7413
Epoch 14/80
108/108 - 0s - 3ms/step - loss: 0.0845 - val_loss: 0.7472
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3118
Per-joint RMSE: 0.3480 0.4164 0.3214 0.2927 0.2253 0.2215
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:52:22.012590: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:52:22.037110: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 07:52:22.880319: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:22.884984: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:22.885944: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:22.887822: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:22.888633: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:22.889378: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:22.969165: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:22.970007: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:22.970755: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:22.971491: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:52:23.267947: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.037401e-01  RMSE=4.513758e-01
  per-joint RMSE: 0.4873 0.6992 0.4342 0.3702 0.3003 0.2835
Residual LSTM:  MSE=9.720470e-02      RMSE=3.117767e-01
  per-joint RMSE: 0.3480 0.4164 0.3214 0.2927 0.2253 0.2215
Combined torque MSE=9.720470e-02     RMSE=3.117767e-01
  per-joint RMSE: 0.3480 0.4164 0.3214 0.2927 0.2253 0.2215
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep300.npz --H 25 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep300.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep300.json
H=25, n_dof=6, feature_dim=6
X_train: (34332, 25, 6)  Y_train: (34332, 6)
X_test : (14092, 25, 6)  Y_test : (14092, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:52:25.526582: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:52:25.550420: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep300.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (34332, 25, 6), Y_train = (34332, 6)
  X_test  = (14092, 25, 6),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:52:26.547706: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:26.552286: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:26.553170: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:26.554831: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:26.555635: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:26.556375: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:26.631281: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:26.632275: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:26.633018: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:26.633836: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:52:27.539633: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.5414 - val_loss: 1.4799
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.2837 - val_loss: 1.5148
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.2154 - val_loss: 1.4808
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1803 - val_loss: 1.4875
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1623 - val_loss: 1.8502
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1522 - val_loss: 1.7045
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.1439 - val_loss: 1.6445
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.1343 - val_loss: 1.6614
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.1282 - val_loss: 1.6932
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.1228 - val_loss: 1.5867
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.1355 - val_loss: 1.6116
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3865
Per-joint RMSE: 0.4353 0.5489 0.3779 0.3220 0.2829 0.2810
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:52:32.349255: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:52:32.374041: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 07:52:33.230719: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:33.235308: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:33.236099: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:33.237937: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:33.238725: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:33.239462: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:33.323494: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:33.324327: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:33.325161: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:33.325892: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:52:33.618698: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.037401e-01  RMSE=4.513758e-01
  per-joint RMSE: 0.4873 0.6992 0.4342 0.3702 0.3003 0.2835
Residual LSTM:  MSE=1.493811e-01      RMSE=3.864985e-01
  per-joint RMSE: 0.4353 0.5489 0.3779 0.3220 0.2829 0.2810
Combined torque MSE=1.493811e-01     RMSE=3.864985e-01
  per-joint RMSE: 0.4353 0.5489 0.3779 0.3220 0.2829 0.2810
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep300.npz --H 25 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep300.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep300.json
H=25, n_dof=6, feature_dim=18
X_train: (34332, 25, 18)  Y_train: (34332, 6)
X_test : (14092, 25, 18)  Y_test : (14092, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:52:35.873675: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:52:35.897793: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep300.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (34332, 25, 18), Y_train = (34332, 6)
  X_test  = (14092, 25, 18),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:52:36.957625: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:36.962375: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:36.963167: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:36.964861: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:36.965641: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:36.966381: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:37.044801: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:37.045642: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:37.046379: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:37.047205: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:52:37.976780: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.3195 - val_loss: 0.7054
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.1975 - val_loss: 0.7201
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.1734 - val_loss: 0.7105
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1605 - val_loss: 0.6832
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1510 - val_loss: 0.6462
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1437 - val_loss: 0.6354
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.1374 - val_loss: 0.6698
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.1349 - val_loss: 0.6586
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.1300 - val_loss: 0.6592
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.1271 - val_loss: 0.6602
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.1244 - val_loss: 0.6488
Epoch 12/80
108/108 - 0s - 3ms/step - loss: 0.1206 - val_loss: 0.6435
Epoch 13/80
108/108 - 0s - 3ms/step - loss: 0.1200 - val_loss: 0.6641
Epoch 14/80
108/108 - 0s - 3ms/step - loss: 0.1169 - val_loss: 0.6646
Epoch 15/80
108/108 - 0s - 3ms/step - loss: 0.1169 - val_loss: 0.6633
Epoch 16/80
108/108 - 0s - 3ms/step - loss: 0.1140 - val_loss: 0.6672
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3501
Per-joint RMSE: 0.4045 0.4598 0.3216 0.3453 0.2673 0.2570
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:52:44.207331: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:52:44.232827: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 07:52:45.104203: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:45.109090: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:45.109890: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:45.111545: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:45.112333: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:45.113071: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:45.198553: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:45.199387: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:45.200124: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:45.200858: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:52:45.496622: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.037401e-01  RMSE=4.513758e-01
  per-joint RMSE: 0.4873 0.6992 0.4342 0.3702 0.3003 0.2835
Residual LSTM:  MSE=1.225446e-01      RMSE=3.500637e-01
  per-joint RMSE: 0.4045 0.4598 0.3216 0.3453 0.2673 0.2570
Combined torque MSE=1.225446e-01     RMSE=3.500637e-01
  per-joint RMSE: 0.4045 0.4598 0.3216 0.3453 0.2673 0.2570
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep300.npz --H 25 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep300.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep300.json
H=25, n_dof=6, feature_dim=18
X_train: (34332, 25, 18)  Y_train: (34332, 6)
X_test : (14092, 25, 18)  Y_test : (14092, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:52:47.866851: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:52:47.890999: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep300.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (34332, 25, 18), Y_train = (34332, 6)
  X_test  = (14092, 25, 18),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:52:48.971884: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:48.976632: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:48.977502: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:48.979141: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:48.979919: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:48.980651: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:49.057859: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:49.058996: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:49.059735: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:49.060467: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:52:49.989367: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.2691 - val_loss: 0.7031
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.1493 - val_loss: 0.7014
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.1276 - val_loss: 0.7156
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1168 - val_loss: 0.7028
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1107 - val_loss: 0.6993
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1049 - val_loss: 0.6978
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.1005 - val_loss: 0.6964
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.0968 - val_loss: 0.6914
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.0945 - val_loss: 0.7138
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.0923 - val_loss: 0.7041
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.0898 - val_loss: 0.7057
Epoch 12/80
108/108 - 0s - 3ms/step - loss: 0.0882 - val_loss: 0.7039
Epoch 13/80
108/108 - 0s - 3ms/step - loss: 0.0864 - val_loss: 0.7003
Epoch 14/80
108/108 - 0s - 3ms/step - loss: 0.0850 - val_loss: 0.6949
Epoch 15/80
108/108 - 0s - 3ms/step - loss: 0.0833 - val_loss: 0.7076
Epoch 16/80
108/108 - 0s - 3ms/step - loss: 0.0822 - val_loss: 0.6981
Epoch 17/80
108/108 - 0s - 3ms/step - loss: 0.0803 - val_loss: 0.7035
Epoch 18/80
108/108 - 0s - 3ms/step - loss: 0.0790 - val_loss: 0.6930
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3153
Per-joint RMSE: 0.3269 0.4598 0.3251 0.2795 0.2192 0.2153
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:52:56.881576: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:52:56.906332: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 07:52:57.770204: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:57.774943: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:57.775730: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:57.777515: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:57.778421: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:57.779217: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:57.861617: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:57.862523: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:57.863262: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:52:57.863990: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:52:58.160986: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.037401e-01  RMSE=4.513758e-01
  per-joint RMSE: 0.4873 0.6992 0.4342 0.3702 0.3003 0.2835
Residual LSTM:  MSE=9.942445e-02      RMSE=3.153164e-01
  per-joint RMSE: 0.3269 0.4598 0.3251 0.2795 0.2192 0.2153
Combined torque MSE=9.942444e-02     RMSE=3.153164e-01
  per-joint RMSE: 0.3269 0.4598 0.3251 0.2795 0.2192 0.2153
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep300.npz --H 50 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep300.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep300.json
H=50, n_dof=6, feature_dim=24
X_train: (33432, 50, 24)  Y_train: (33432, 6)
X_test : (13667, 50, 24)  Y_test : (13667, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:53:00.595245: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:53:00.618996: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep300.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (33432, 50, 24), Y_train = (33432, 6)
  X_test  = (13667, 50, 24),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:53:01.873714: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:01.878491: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:01.879401: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:01.881370: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:01.882400: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:01.883260: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:01.976868: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:01.977864: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:01.978668: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:01.979463: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:53:02.998081: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.2651 - val_loss: 0.8526
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.1451 - val_loss: 0.8654
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.1279 - val_loss: 0.8440
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1178 - val_loss: 0.8389
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1115 - val_loss: 0.8204
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1072 - val_loss: 0.8044
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1034 - val_loss: 0.7835
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.0997 - val_loss: 0.7870
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.0965 - val_loss: 0.7787
Epoch 10/80
105/105 - 1s - 5ms/step - loss: 0.0945 - val_loss: 0.7663
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.0920 - val_loss: 0.7440
Epoch 12/80
105/105 - 0s - 4ms/step - loss: 0.0899 - val_loss: 0.7497
Epoch 13/80
105/105 - 0s - 4ms/step - loss: 0.0883 - val_loss: 0.7306
Epoch 14/80
105/105 - 0s - 4ms/step - loss: 0.0864 - val_loss: 0.7278
Epoch 15/80
105/105 - 0s - 4ms/step - loss: 0.0850 - val_loss: 0.7116
Epoch 16/80
105/105 - 0s - 4ms/step - loss: 0.0840 - val_loss: 0.7004
Epoch 17/80
105/105 - 0s - 4ms/step - loss: 0.0823 - val_loss: 0.6955
Epoch 18/80
105/105 - 0s - 4ms/step - loss: 0.0811 - val_loss: 0.6929
Epoch 19/80
105/105 - 0s - 4ms/step - loss: 0.0803 - val_loss: 0.6934
Epoch 20/80
105/105 - 0s - 4ms/step - loss: 0.0788 - val_loss: 0.6908
Epoch 21/80
105/105 - 0s - 4ms/step - loss: 0.0782 - val_loss: 0.6862
Epoch 22/80
105/105 - 0s - 4ms/step - loss: 0.0771 - val_loss: 0.6952
Epoch 23/80
105/105 - 0s - 4ms/step - loss: 0.0765 - val_loss: 0.6851
Epoch 24/80
105/105 - 0s - 4ms/step - loss: 0.0756 - val_loss: 0.6803
Epoch 25/80
105/105 - 0s - 4ms/step - loss: 0.0751 - val_loss: 0.6866
Epoch 26/80
105/105 - 0s - 4ms/step - loss: 0.0736 - val_loss: 0.6712
Epoch 27/80
105/105 - 0s - 4ms/step - loss: 0.0732 - val_loss: 0.6908
Epoch 28/80
105/105 - 0s - 4ms/step - loss: 0.0728 - val_loss: 0.6713
Epoch 29/80
105/105 - 0s - 4ms/step - loss: 0.0724 - val_loss: 0.6710
Epoch 30/80
105/105 - 0s - 4ms/step - loss: 0.0714 - val_loss: 0.6880
Epoch 31/80
105/105 - 0s - 4ms/step - loss: 0.0711 - val_loss: 0.6832
Epoch 32/80
105/105 - 0s - 4ms/step - loss: 0.0705 - val_loss: 0.6794
Epoch 33/80
105/105 - 0s - 4ms/step - loss: 0.0699 - val_loss: 0.6726
Epoch 34/80
105/105 - 0s - 4ms/step - loss: 0.0695 - val_loss: 0.6707
Epoch 35/80
105/105 - 0s - 4ms/step - loss: 0.0690 - val_loss: 0.6611
Epoch 36/80
105/105 - 0s - 4ms/step - loss: 0.0684 - val_loss: 0.6691
Epoch 37/80
105/105 - 0s - 4ms/step - loss: 0.0683 - val_loss: 0.6628
Epoch 38/80
105/105 - 0s - 4ms/step - loss: 0.0677 - val_loss: 0.6795
Epoch 39/80
105/105 - 0s - 4ms/step - loss: 0.0679 - val_loss: 0.6788
Epoch 40/80
105/105 - 0s - 4ms/step - loss: 0.0678 - val_loss: 0.6524
Epoch 41/80
105/105 - 0s - 4ms/step - loss: 0.0668 - val_loss: 0.6676
Epoch 42/80
105/105 - 0s - 4ms/step - loss: 0.0662 - val_loss: 0.6720
Epoch 43/80
105/105 - 0s - 4ms/step - loss: 0.0662 - val_loss: 0.6796
Epoch 44/80
105/105 - 0s - 4ms/step - loss: 0.0658 - val_loss: 0.6614
Epoch 45/80
105/105 - 0s - 4ms/step - loss: 0.0651 - val_loss: 0.6596
Epoch 46/80
105/105 - 0s - 4ms/step - loss: 0.0651 - val_loss: 0.6702
Epoch 47/80
105/105 - 0s - 4ms/step - loss: 0.0652 - val_loss: 0.6593
Epoch 48/80
105/105 - 0s - 4ms/step - loss: 0.0644 - val_loss: 0.6556
Epoch 49/80
105/105 - 0s - 4ms/step - loss: 0.0640 - val_loss: 0.6586
Epoch 50/80
105/105 - 0s - 4ms/step - loss: 0.0637 - val_loss: 0.6666
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3069
Per-joint RMSE: 0.3173 0.4269 0.3118 0.2960 0.2245 0.2168
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:53:26.188647: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:53:26.213793: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 07:53:27.070248: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:27.074902: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:27.075700: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:27.077354: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:27.078148: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:27.078883: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:27.167699: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:27.168622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:27.169372: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:27.170103: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:53:27.468883: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.059532e-01  RMSE=4.538206e-01
  per-joint RMSE: 0.4890 0.7058 0.4322 0.3727 0.3027 0.2846
Residual LSTM:  MSE=9.419551e-02      RMSE=3.069129e-01
  per-joint RMSE: 0.3173 0.4269 0.3118 0.2960 0.2245 0.2168
Combined torque MSE=9.419551e-02     RMSE=3.069129e-01
  per-joint RMSE: 0.3173 0.4269 0.3118 0.2960 0.2245 0.2168
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep300.npz --H 50 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep300.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep300.json
H=50, n_dof=6, feature_dim=6
X_train: (33432, 50, 6)  Y_train: (33432, 6)
X_test : (13667, 50, 6)  Y_test : (13667, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:53:29.772509: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:53:29.796283: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep300.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (33432, 50, 6), Y_train = (33432, 6)
  X_test  = (13667, 50, 6),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:53:30.854049: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:30.858927: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:30.859736: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:30.861320: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:30.862120: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:30.862871: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:30.941984: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:30.942830: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:30.943592: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:30.944332: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:53:31.866129: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.4779 - val_loss: 1.7013
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.2760 - val_loss: 1.7580
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.2215 - val_loss: 1.8860
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1689 - val_loss: 1.9072
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1509 - val_loss: 1.9778
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1376 - val_loss: 1.9010
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1286 - val_loss: 2.0900
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.1259 - val_loss: 1.9982
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.1282 - val_loss: 1.9163
Epoch 10/80
105/105 - 0s - 5ms/step - loss: 0.1227 - val_loss: 1.8695
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.1130 - val_loss: 1.9627
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.4060
Per-joint RMSE: 0.4730 0.5514 0.3683 0.3616 0.3073 0.3166
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:53:38.117877: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:53:38.142755: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 07:53:38.996109: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:39.000773: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:39.001560: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:39.003232: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:39.004025: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:39.004761: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:39.081120: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:39.081953: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:39.082701: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:39.083435: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:53:39.382492: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.059532e-01  RMSE=4.538206e-01
  per-joint RMSE: 0.4890 0.7058 0.4322 0.3727 0.3027 0.2846
Residual LSTM:  MSE=1.648095e-01      RMSE=4.059673e-01
  per-joint RMSE: 0.4730 0.5514 0.3683 0.3616 0.3073 0.3166
Combined torque MSE=1.648095e-01     RMSE=4.059673e-01
  per-joint RMSE: 0.4730 0.5514 0.3683 0.3616 0.3073 0.3166
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep300.npz --H 50 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep300.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep300.json
H=50, n_dof=6, feature_dim=18
X_train: (33432, 50, 18)  Y_train: (33432, 6)
X_test : (13667, 50, 18)  Y_test : (13667, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:53:41.838237: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:53:41.862416: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep300.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (33432, 50, 18), Y_train = (33432, 6)
  X_test  = (13667, 50, 18),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:53:43.060344: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:43.065746: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:43.066659: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:43.068372: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:43.069284: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:43.070140: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:43.162061: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:43.162962: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:43.163856: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:43.164650: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:53:44.159946: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.3178 - val_loss: 0.8454
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.1948 - val_loss: 0.8362
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.1769 - val_loss: 0.8252
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1642 - val_loss: 0.8229
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1539 - val_loss: 0.7863
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1458 - val_loss: 0.7557
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1418 - val_loss: 0.7830
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.1375 - val_loss: 0.7372
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.1334 - val_loss: 0.7377
Epoch 10/80
105/105 - 1s - 5ms/step - loss: 0.1303 - val_loss: 0.7348
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.1282 - val_loss: 0.6776
Epoch 12/80
105/105 - 0s - 4ms/step - loss: 0.1270 - val_loss: 0.7449
Epoch 13/80
105/105 - 0s - 4ms/step - loss: 0.1251 - val_loss: 0.7158
Epoch 14/80
105/105 - 0s - 4ms/step - loss: 0.1213 - val_loss: 0.6917
Epoch 15/80
105/105 - 0s - 4ms/step - loss: 0.1222 - val_loss: 0.7138
Epoch 16/80
105/105 - 0s - 4ms/step - loss: 0.1198 - val_loss: 0.7358
Epoch 17/80
105/105 - 0s - 4ms/step - loss: 0.1159 - val_loss: 0.7222
Epoch 18/80
105/105 - 0s - 4ms/step - loss: 0.1146 - val_loss: 0.7218
Epoch 19/80
105/105 - 0s - 4ms/step - loss: 0.1140 - val_loss: 0.7106
Epoch 20/80
105/105 - 0s - 4ms/step - loss: 0.1134 - val_loss: 0.7178
Epoch 21/80
105/105 - 0s - 4ms/step - loss: 0.1127 - val_loss: 0.6836
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3591
Per-joint RMSE: 0.4042 0.4862 0.3356 0.3456 0.2722 0.2610
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:53:54.889105: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:53:54.914062: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 07:53:55.770309: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:55.774917: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:55.775724: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:55.777487: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:55.778356: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:55.779090: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:55.856212: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:55.857129: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:55.857876: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:55.858607: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8824 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:53:56.151910: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.059532e-01  RMSE=4.538206e-01
  per-joint RMSE: 0.4890 0.7058 0.4322 0.3727 0.3027 0.2846
Residual LSTM:  MSE=1.289862e-01      RMSE=3.591464e-01
  per-joint RMSE: 0.4042 0.4862 0.3356 0.3456 0.2722 0.2610
Combined torque MSE=1.289862e-01     RMSE=3.591464e-01
  per-joint RMSE: 0.4042 0.4862 0.3356 0.3456 0.2722 0.2610
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep300.npz --H 50 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep300.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep300.json
H=50, n_dof=6, feature_dim=18
X_train: (33432, 50, 18)  Y_train: (33432, 6)
X_test : (13667, 50, 18)  Y_test : (13667, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:53:58.579188: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:53:58.603229: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep300.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (33432, 50, 18), Y_train = (33432, 6)
  X_test  = (13667, 50, 18),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:53:59.806422: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:59.811463: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:59.812355: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:59.814186: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:59.815098: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:59.815957: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:59.902936: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:59.903929: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:59.904719: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:53:59.905500: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:54:00.849848: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.2681 - val_loss: 0.8529
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.1488 - val_loss: 0.8665
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.1295 - val_loss: 0.8649
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1204 - val_loss: 0.8542
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1133 - val_loss: 0.8323
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1081 - val_loss: 0.8230
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1036 - val_loss: 0.8200
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.1007 - val_loss: 0.8050
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.0971 - val_loss: 0.7906
Epoch 10/80
105/105 - 0s - 5ms/step - loss: 0.0939 - val_loss: 0.7845
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.0919 - val_loss: 0.7628
Epoch 12/80
105/105 - 0s - 4ms/step - loss: 0.0898 - val_loss: 0.7677
Epoch 13/80
105/105 - 0s - 4ms/step - loss: 0.0876 - val_loss: 0.7510
Epoch 14/80
105/105 - 0s - 4ms/step - loss: 0.0863 - val_loss: 0.7508
Epoch 15/80
105/105 - 0s - 4ms/step - loss: 0.0846 - val_loss: 0.7385
Epoch 16/80
105/105 - 0s - 4ms/step - loss: 0.0826 - val_loss: 0.7349
Epoch 17/80
105/105 - 0s - 4ms/step - loss: 0.0822 - val_loss: 0.7398
Epoch 18/80
105/105 - 0s - 4ms/step - loss: 0.0800 - val_loss: 0.7376
Epoch 19/80
105/105 - 0s - 4ms/step - loss: 0.0793 - val_loss: 0.7269
Epoch 20/80
105/105 - 0s - 4ms/step - loss: 0.0781 - val_loss: 0.7280
Epoch 21/80
105/105 - 0s - 4ms/step - loss: 0.0778 - val_loss: 0.7244
Epoch 22/80
105/105 - 0s - 4ms/step - loss: 0.0767 - val_loss: 0.7220
Epoch 23/80
105/105 - 0s - 4ms/step - loss: 0.0753 - val_loss: 0.7295
Epoch 24/80
105/105 - 0s - 4ms/step - loss: 0.0749 - val_loss: 0.7235
Epoch 25/80
105/105 - 0s - 4ms/step - loss: 0.0735 - val_loss: 0.7216
Epoch 26/80
105/105 - 0s - 4ms/step - loss: 0.0731 - val_loss: 0.7104
Epoch 27/80
105/105 - 0s - 4ms/step - loss: 0.0728 - val_loss: 0.7202
Epoch 28/80
105/105 - 0s - 4ms/step - loss: 0.0720 - val_loss: 0.7130
Epoch 29/80
105/105 - 0s - 4ms/step - loss: 0.0721 - val_loss: 0.7101
Epoch 30/80
105/105 - 0s - 4ms/step - loss: 0.0710 - val_loss: 0.7141
Epoch 31/80
105/105 - 0s - 4ms/step - loss: 0.0700 - val_loss: 0.7049
Epoch 32/80
105/105 - 0s - 4ms/step - loss: 0.0698 - val_loss: 0.7094
Epoch 33/80
105/105 - 0s - 4ms/step - loss: 0.0691 - val_loss: 0.7107
Epoch 34/80
105/105 - 0s - 4ms/step - loss: 0.0692 - val_loss: 0.7129
Epoch 35/80
105/105 - 0s - 4ms/step - loss: 0.0688 - val_loss: 0.7102
Epoch 36/80
105/105 - 0s - 4ms/step - loss: 0.0685 - val_loss: 0.6998
Epoch 37/80
105/105 - 0s - 4ms/step - loss: 0.0674 - val_loss: 0.6925
Epoch 38/80
105/105 - 0s - 4ms/step - loss: 0.0671 - val_loss: 0.6981
Epoch 39/80
105/105 - 0s - 4ms/step - loss: 0.0664 - val_loss: 0.7178
Epoch 40/80
105/105 - 0s - 4ms/step - loss: 0.0661 - val_loss: 0.7098
Epoch 41/80
105/105 - 0s - 4ms/step - loss: 0.0657 - val_loss: 0.6920
Epoch 42/80
105/105 - 0s - 4ms/step - loss: 0.0654 - val_loss: 0.6976
Epoch 43/80
105/105 - 0s - 4ms/step - loss: 0.0657 - val_loss: 0.6925
Epoch 44/80
105/105 - 0s - 4ms/step - loss: 0.0645 - val_loss: 0.6942
Epoch 45/80
105/105 - 0s - 4ms/step - loss: 0.0649 - val_loss: 0.6928
Epoch 46/80
105/105 - 0s - 4ms/step - loss: 0.0642 - val_loss: 0.6933
Epoch 47/80
105/105 - 0s - 4ms/step - loss: 0.0639 - val_loss: 0.6952
Epoch 48/80
105/105 - 0s - 4ms/step - loss: 0.0631 - val_loss: 0.6993
Epoch 49/80
105/105 - 0s - 4ms/step - loss: 0.0626 - val_loss: 0.7073
Epoch 50/80
105/105 - 0s - 4ms/step - loss: 0.0625 - val_loss: 0.7063
Epoch 51/80
105/105 - 0s - 4ms/step - loss: 0.0628 - val_loss: 0.7155
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3127
Per-joint RMSE: 0.3115 0.4403 0.3291 0.2951 0.2315 0.2168
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:54:24.082929: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:54:24.107478: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s0_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 07:54:24.966756: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:54:24.971481: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:54:24.972326: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:54:24.974246: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:54:24.975174: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:54:24.975963: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:54:25.055742: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:54:25.056624: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:54:25.057413: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:54:25.058189: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:54:25.356144: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.059532e-01  RMSE=4.538206e-01
  per-joint RMSE: 0.4890 0.7058 0.4322 0.3727 0.3027 0.2846
Residual LSTM:  MSE=9.780572e-02      RMSE=3.127390e-01
  per-joint RMSE: 0.3115 0.4403 0.3291 0.2951 0.2315 0.2168
Combined torque MSE=9.780572e-02     RMSE=3.127390e-01
  per-joint RMSE: 0.3115 0.4403 0.3291 0.2951 0.2315 0.2168
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s0_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=1                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz                                ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz -t structured -s 1 -r 0 --hp_preset fast_debug --epochs 300 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300.jax' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 300, 'lagrangian_type': <function structured_lagrangian_fn at 0x76f4efb481f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz
   dt ≈ 0.025265617146188975
  dof = 6
  Train trajectories = 70
  Test trajectories  = 30
  Train samples = 35298
  Test samples  = 14539
################################################

2026-01-22 07:54:29.982509: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300 | type=structured | dof=6
################################################
2026-01-22 07:54:33.152938: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:54:33.152974: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:54:33.152979: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:54:33.153015: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:54:33.153022: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:54:33.153040: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:54:33.153084: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:54:33.153090: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:54:33.153109: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:54:33.153116: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.1s, Loss=1.80e+01, Inv=1.80e+01, For=1.47e+02, Power=3.93e+00
  [eval] test_mse=1.979e+00  (n=14539)
Epoch 00050: Time=  11.0s, Loss=2.79e+00, Inv=2.79e+00, For=4.37e+01, Power=1.99e+00
Epoch 00100: Time=  15.5s, Loss=2.44e+00, Inv=2.44e+00, For=4.99e+01, Power=1.76e+00
Epoch 00150: Time=  20.0s, Loss=2.29e+00, Inv=2.29e+00, For=6.25e+01, Power=1.66e+00
Epoch 00200: Time=  24.3s, Loss=2.18e+00, Inv=2.18e+00, For=7.96e+01, Power=1.60e+00
  [eval] test_mse=1.118e+00  (n=14539)
Epoch 00250: Time=  28.7s, Loss=2.13e+00, Inv=2.13e+00, For=9.41e+01, Power=1.58e+00
Epoch 00300: Time=  33.1s, Loss=2.10e+00, Inv=2.10e+00, For=1.08e+02, Power=1.57e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300
Torque MSE  = 2.106e-01
Torque RMSE = 4.590e-01
Per-joint MSE : 2.450e-01 5.316e-01 1.691e-01 1.067e-01 1.065e-01 1.051e-01
Per-joint RMSE: 4.949e-01 7.291e-01 4.112e-01 3.267e-01 3.263e-01 3.241e-01
Comp Time per Sample = 2.115e-08s / 47272076.5Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz' ===
===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep300.jax
Detected n_dof=6 (seed=1)
2026-01-22 07:55:08.410808: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 70 trajectories
2026-01-22 07:55:09.711669: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:55:09.711681: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:55:11.254698: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:55:11.254712: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:55:12.672763: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 25/70
2026-01-22 07:55:13.881425: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:55:15.081935: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:55:15.081970: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:55:15.081975: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 50/70
  done 70/70

Exporting split=test: 30 trajectories
  done 25/30
  done 30/30

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep300.npz --H 25 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep300.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep300.json
H=25, n_dof=6, feature_dim=24
X_train: (34332, 25, 24)  Y_train: (34332, 6)
X_test : (14092, 25, 24)  Y_test : (14092, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:55:17.578555: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:55:17.602855: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep300.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (34332, 25, 24), Y_train = (34332, 6)
  X_test  = (14092, 25, 24),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:55:18.707617: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:18.712651: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:18.713668: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:18.715364: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:18.716282: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:18.717160: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:18.811470: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:18.812359: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:18.813150: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:18.813930: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8827 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:55:19.770560: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.2629 - val_loss: 0.7879
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.1466 - val_loss: 0.7733
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.1264 - val_loss: 0.7600
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1163 - val_loss: 0.7630
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1099 - val_loss: 0.7602
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1034 - val_loss: 0.7578
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.1000 - val_loss: 0.7667
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.0974 - val_loss: 0.7656
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.0951 - val_loss: 0.7521
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.0924 - val_loss: 0.7584
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.0916 - val_loss: 0.7584
Epoch 12/80
108/108 - 0s - 3ms/step - loss: 0.0890 - val_loss: 0.7609
Epoch 13/80
108/108 - 0s - 3ms/step - loss: 0.0871 - val_loss: 0.7387
Epoch 14/80
108/108 - 0s - 3ms/step - loss: 0.0857 - val_loss: 0.7366
Epoch 15/80
108/108 - 0s - 3ms/step - loss: 0.0839 - val_loss: 0.7408
Epoch 16/80
108/108 - 0s - 3ms/step - loss: 0.0831 - val_loss: 0.7456
Epoch 17/80
108/108 - 0s - 3ms/step - loss: 0.0818 - val_loss: 0.7414
Epoch 18/80
108/108 - 0s - 3ms/step - loss: 0.0798 - val_loss: 0.7347
Epoch 19/80
108/108 - 0s - 3ms/step - loss: 0.0791 - val_loss: 0.7327
Epoch 20/80
108/108 - 0s - 3ms/step - loss: 0.0783 - val_loss: 0.7240
Epoch 21/80
108/108 - 0s - 3ms/step - loss: 0.0773 - val_loss: 0.7182
Epoch 22/80
108/108 - 0s - 3ms/step - loss: 0.0763 - val_loss: 0.7158
Epoch 23/80
108/108 - 0s - 3ms/step - loss: 0.0753 - val_loss: 0.7261
Epoch 24/80
108/108 - 0s - 3ms/step - loss: 0.0748 - val_loss: 0.7055
Epoch 25/80
108/108 - 0s - 3ms/step - loss: 0.0733 - val_loss: 0.7168
Epoch 26/80
108/108 - 0s - 3ms/step - loss: 0.0739 - val_loss: 0.7140
Epoch 27/80
108/108 - 0s - 3ms/step - loss: 0.0723 - val_loss: 0.7172
Epoch 28/80
108/108 - 0s - 3ms/step - loss: 0.0719 - val_loss: 0.7080
Epoch 29/80
108/108 - 0s - 3ms/step - loss: 0.0716 - val_loss: 0.7022
Epoch 30/80
108/108 - 0s - 3ms/step - loss: 0.0708 - val_loss: 0.7054
Epoch 31/80
108/108 - 0s - 3ms/step - loss: 0.0701 - val_loss: 0.7151
Epoch 32/80
108/108 - 0s - 3ms/step - loss: 0.0695 - val_loss: 0.6998
Epoch 33/80
108/108 - 0s - 3ms/step - loss: 0.0696 - val_loss: 0.7166
Epoch 34/80
108/108 - 0s - 3ms/step - loss: 0.0683 - val_loss: 0.7089
Epoch 35/80
108/108 - 0s - 3ms/step - loss: 0.0677 - val_loss: 0.7076
Epoch 36/80
108/108 - 0s - 3ms/step - loss: 0.0676 - val_loss: 0.6949
Epoch 37/80
108/108 - 0s - 3ms/step - loss: 0.0677 - val_loss: 0.7055
Epoch 38/80
108/108 - 0s - 3ms/step - loss: 0.0666 - val_loss: 0.7181
Epoch 39/80
108/108 - 0s - 3ms/step - loss: 0.0660 - val_loss: 0.7138
Epoch 40/80
108/108 - 0s - 3ms/step - loss: 0.0657 - val_loss: 0.7116
Epoch 41/80
108/108 - 0s - 3ms/step - loss: 0.0665 - val_loss: 0.7124
Epoch 42/80
108/108 - 0s - 3ms/step - loss: 0.0647 - val_loss: 0.7260
Epoch 43/80
108/108 - 0s - 3ms/step - loss: 0.0645 - val_loss: 0.7115
Epoch 44/80
108/108 - 0s - 3ms/step - loss: 0.0643 - val_loss: 0.7153
Epoch 45/80
108/108 - 0s - 3ms/step - loss: 0.0641 - val_loss: 0.7207
Epoch 46/80
108/108 - 0s - 3ms/step - loss: 0.0634 - val_loss: 0.7171
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3256
Per-joint RMSE: 0.3544 0.4810 0.2845 0.2583 0.2582 0.2545
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:55:34.704642: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:55:34.729242: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 07:55:35.580340: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:35.584952: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:35.585743: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:35.587378: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:35.588164: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:35.588896: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:35.667655: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:35.668487: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:35.669316: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:35.670123: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:55:35.964922: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.117203e-01  RMSE=4.601308e-01
  per-joint RMSE: 0.4954 0.7315 0.4120 0.3248 0.3284 0.3268
Residual LSTM:  MSE=1.060115e-01      RMSE=3.255941e-01
  per-joint RMSE: 0.3544 0.4810 0.2845 0.2583 0.2582 0.2545
Combined torque MSE=1.060115e-01     RMSE=3.255941e-01
  per-joint RMSE: 0.3544 0.4810 0.2845 0.2583 0.2582 0.2545
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep300.npz --H 25 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep300.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep300.json
H=25, n_dof=6, feature_dim=6
X_train: (34332, 25, 6)  Y_train: (34332, 6)
X_test : (14092, 25, 6)  Y_test : (14092, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:55:38.194724: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:55:38.218598: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep300.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (34332, 25, 6), Y_train = (34332, 6)
  X_test  = (14092, 25, 6),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:55:39.194954: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:39.199606: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:39.200393: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:39.201945: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:39.202725: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:39.203462: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:39.285598: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:39.286435: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:39.287188: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:39.287918: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:55:40.185101: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.5378 - val_loss: 1.4085
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.2805 - val_loss: 1.4000
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.2138 - val_loss: 1.3622
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1837 - val_loss: 1.3565
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1674 - val_loss: 1.4194
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1535 - val_loss: 1.3671
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.1418 - val_loss: 1.3574
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.1362 - val_loss: 1.3914
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.1290 - val_loss: 1.4098
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.1188 - val_loss: 1.4581
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.1230 - val_loss: 1.4844
Epoch 12/80
108/108 - 0s - 3ms/step - loss: 0.1183 - val_loss: 1.4184
Epoch 13/80
108/108 - 0s - 3ms/step - loss: 0.1126 - val_loss: 1.6096
Epoch 14/80
108/108 - 0s - 3ms/step - loss: 0.1073 - val_loss: 1.5096
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.4019
Per-joint RMSE: 0.4664 0.5888 0.3556 0.2906 0.3041 0.3189
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:55:45.870001: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:55:45.894315: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 07:55:46.755295: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:46.760087: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:46.760941: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:46.762753: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:46.763618: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:46.764406: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:46.841940: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:46.842834: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:46.843728: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:46.844519: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:55:47.140157: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.117203e-01  RMSE=4.601308e-01
  per-joint RMSE: 0.4954 0.7315 0.4120 0.3248 0.3284 0.3268
Residual LSTM:  MSE=1.615590e-01      RMSE=4.019440e-01
  per-joint RMSE: 0.4664 0.5888 0.3556 0.2906 0.3041 0.3189
Combined torque MSE=1.615590e-01     RMSE=4.019440e-01
  per-joint RMSE: 0.4664 0.5888 0.3556 0.2906 0.3041 0.3189
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep300.npz --H 25 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep300.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep300.json
H=25, n_dof=6, feature_dim=18
X_train: (34332, 25, 18)  Y_train: (34332, 6)
X_test : (14092, 25, 18)  Y_test : (14092, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:55:49.445089: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:55:49.469087: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep300.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (34332, 25, 18), Y_train = (34332, 6)
  X_test  = (14092, 25, 18),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:55:50.523303: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:50.527981: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:50.528932: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:50.530701: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:50.531489: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:50.532223: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:50.606685: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:50.607523: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:50.608367: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:50.609102: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:55:51.577800: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.3142 - val_loss: 0.6593
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.1944 - val_loss: 0.7351
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.1712 - val_loss: 0.7814
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1590 - val_loss: 0.7715
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1501 - val_loss: 0.8012
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1457 - val_loss: 0.8161
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.1354 - val_loss: 0.7551
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.1360 - val_loss: 0.8074
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.1367 - val_loss: 0.7185
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.1307 - val_loss: 0.7194
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.1276 - val_loss: 0.7100
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3687
Per-joint RMSE: 0.4228 0.5145 0.3095 0.2933 0.3043 0.3124
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:55:56.416494: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:55:56.441489: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 07:55:57.301054: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:57.305749: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:57.306632: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:57.308318: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:57.309107: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:57.310002: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:57.393898: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:57.394742: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:57.395485: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:55:57.396226: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:55:57.693279: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.117203e-01  RMSE=4.601308e-01
  per-joint RMSE: 0.4954 0.7315 0.4120 0.3248 0.3284 0.3268
Residual LSTM:  MSE=1.359183e-01      RMSE=3.686711e-01
  per-joint RMSE: 0.4228 0.5145 0.3095 0.2933 0.3043 0.3124
Combined torque MSE=1.359183e-01     RMSE=3.686711e-01
  per-joint RMSE: 0.4228 0.5145 0.3095 0.2933 0.3043 0.3124
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep300.npz --H 25 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep300.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep300.json
H=25, n_dof=6, feature_dim=18
X_train: (34332, 25, 18)  Y_train: (34332, 6)
X_test : (14092, 25, 18)  Y_test : (14092, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:55:59.998548: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:56:00.023037: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep300.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (34332, 25, 18), Y_train = (34332, 6)
  X_test  = (14092, 25, 18),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:56:01.082755: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:01.087316: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:01.088183: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:01.089713: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:01.090504: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:01.091244: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:01.166472: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:01.167318: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:01.168126: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:01.168854: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:56:02.112929: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.2632 - val_loss: 0.7078
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.1485 - val_loss: 0.7375
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.1262 - val_loss: 0.7216
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1161 - val_loss: 0.7182
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1097 - val_loss: 0.7102
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1043 - val_loss: 0.7121
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.1004 - val_loss: 0.6928
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.0973 - val_loss: 0.6798
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.0951 - val_loss: 0.6848
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.0924 - val_loss: 0.6829
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.0907 - val_loss: 0.6732
Epoch 12/80
108/108 - 0s - 3ms/step - loss: 0.0884 - val_loss: 0.6602
Epoch 13/80
108/108 - 0s - 3ms/step - loss: 0.0867 - val_loss: 0.6623
Epoch 14/80
108/108 - 0s - 3ms/step - loss: 0.0851 - val_loss: 0.6538
Epoch 15/80
108/108 - 0s - 3ms/step - loss: 0.0837 - val_loss: 0.6533
Epoch 16/80
108/108 - 0s - 3ms/step - loss: 0.0828 - val_loss: 0.6576
Epoch 17/80
108/108 - 0s - 3ms/step - loss: 0.0812 - val_loss: 0.6550
Epoch 18/80
108/108 - 0s - 3ms/step - loss: 0.0800 - val_loss: 0.6511
Epoch 19/80
108/108 - 0s - 3ms/step - loss: 0.0794 - val_loss: 0.6444
Epoch 20/80
108/108 - 0s - 3ms/step - loss: 0.0781 - val_loss: 0.6480
Epoch 21/80
108/108 - 0s - 3ms/step - loss: 0.0768 - val_loss: 0.6548
Epoch 22/80
108/108 - 0s - 3ms/step - loss: 0.0766 - val_loss: 0.6484
Epoch 23/80
108/108 - 0s - 3ms/step - loss: 0.0756 - val_loss: 0.6514
Epoch 24/80
108/108 - 0s - 3ms/step - loss: 0.0746 - val_loss: 0.6509
Epoch 25/80
108/108 - 0s - 3ms/step - loss: 0.0737 - val_loss: 0.6521
Epoch 26/80
108/108 - 0s - 3ms/step - loss: 0.0735 - val_loss: 0.6361
Epoch 27/80
108/108 - 0s - 3ms/step - loss: 0.0728 - val_loss: 0.6516
Epoch 28/80
108/108 - 0s - 3ms/step - loss: 0.0718 - val_loss: 0.6567
Epoch 29/80
108/108 - 0s - 3ms/step - loss: 0.0713 - val_loss: 0.6613
Epoch 30/80
108/108 - 0s - 3ms/step - loss: 0.0709 - val_loss: 0.6515
Epoch 31/80
108/108 - 0s - 3ms/step - loss: 0.0697 - val_loss: 0.6568
Epoch 32/80
108/108 - 0s - 3ms/step - loss: 0.0697 - val_loss: 0.6521
Epoch 33/80
108/108 - 0s - 3ms/step - loss: 0.0696 - val_loss: 0.6510
Epoch 34/80
108/108 - 0s - 3ms/step - loss: 0.0685 - val_loss: 0.6534
Epoch 35/80
108/108 - 0s - 3ms/step - loss: 0.0680 - val_loss: 0.6573
Epoch 36/80
108/108 - 0s - 3ms/step - loss: 0.0678 - val_loss: 0.6527
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3259
Per-joint RMSE: 0.3595 0.4895 0.2799 0.2392 0.2535 0.2620
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:56:14.281595: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:56:14.306433: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 07:56:15.155380: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:15.159986: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:15.160792: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:15.162715: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:15.163512: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:15.164257: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:15.244072: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:15.244912: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:15.245669: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:15.246398: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:56:15.541268: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.117203e-01  RMSE=4.601308e-01
  per-joint RMSE: 0.4954 0.7315 0.4120 0.3248 0.3284 0.3268
Residual LSTM:  MSE=1.062210e-01      RMSE=3.259157e-01
  per-joint RMSE: 0.3595 0.4895 0.2799 0.2392 0.2535 0.2620
Combined torque MSE=1.062210e-01     RMSE=3.259157e-01
  per-joint RMSE: 0.3595 0.4895 0.2799 0.2392 0.2535 0.2620
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep300.npz --H 50 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep300.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep300.json
H=50, n_dof=6, feature_dim=24
X_train: (33432, 50, 24)  Y_train: (33432, 6)
X_test : (13667, 50, 24)  Y_test : (13667, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:56:18.058131: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:56:18.081855: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep300.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (33432, 50, 24), Y_train = (33432, 6)
  X_test  = (13667, 50, 24),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:56:19.328131: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:19.333072: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:19.333985: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:19.335707: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:19.336618: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:19.337348: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:19.430228: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:19.431115: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:19.431918: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:19.432702: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:56:20.449767: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.2619 - val_loss: 0.8695
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.1451 - val_loss: 0.8803
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.1287 - val_loss: 0.8626
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1199 - val_loss: 0.8558
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1127 - val_loss: 0.8434
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1085 - val_loss: 0.8255
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1041 - val_loss: 0.8389
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.0996 - val_loss: 0.8362
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.0970 - val_loss: 0.8224
Epoch 10/80
105/105 - 1s - 5ms/step - loss: 0.0943 - val_loss: 0.8021
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.0916 - val_loss: 0.7963
Epoch 12/80
105/105 - 0s - 4ms/step - loss: 0.0898 - val_loss: 0.7700
Epoch 13/80
105/105 - 0s - 4ms/step - loss: 0.0877 - val_loss: 0.7777
Epoch 14/80
105/105 - 0s - 4ms/step - loss: 0.0860 - val_loss: 0.7638
Epoch 15/80
105/105 - 0s - 4ms/step - loss: 0.0842 - val_loss: 0.7662
Epoch 16/80
105/105 - 0s - 4ms/step - loss: 0.0833 - val_loss: 0.7577
Epoch 17/80
105/105 - 0s - 4ms/step - loss: 0.0815 - val_loss: 0.7491
Epoch 18/80
105/105 - 0s - 4ms/step - loss: 0.0805 - val_loss: 0.7501
Epoch 19/80
105/105 - 0s - 4ms/step - loss: 0.0793 - val_loss: 0.7640
Epoch 20/80
105/105 - 0s - 4ms/step - loss: 0.0785 - val_loss: 0.7526
Epoch 21/80
105/105 - 0s - 4ms/step - loss: 0.0770 - val_loss: 0.7591
Epoch 22/80
105/105 - 0s - 4ms/step - loss: 0.0765 - val_loss: 0.7529
Epoch 23/80
105/105 - 0s - 4ms/step - loss: 0.0758 - val_loss: 0.7427
Epoch 24/80
105/105 - 0s - 4ms/step - loss: 0.0743 - val_loss: 0.7466
Epoch 25/80
105/105 - 0s - 4ms/step - loss: 0.0742 - val_loss: 0.7621
Epoch 26/80
105/105 - 0s - 4ms/step - loss: 0.0736 - val_loss: 0.7360
Epoch 27/80
105/105 - 0s - 4ms/step - loss: 0.0726 - val_loss: 0.7534
Epoch 28/80
105/105 - 0s - 4ms/step - loss: 0.0723 - val_loss: 0.7584
Epoch 29/80
105/105 - 0s - 4ms/step - loss: 0.0711 - val_loss: 0.7495
Epoch 30/80
105/105 - 0s - 4ms/step - loss: 0.0706 - val_loss: 0.7619
Epoch 31/80
105/105 - 0s - 4ms/step - loss: 0.0704 - val_loss: 0.7465
Epoch 32/80
105/105 - 0s - 4ms/step - loss: 0.0698 - val_loss: 0.7451
Epoch 33/80
105/105 - 0s - 4ms/step - loss: 0.0692 - val_loss: 0.7593
Epoch 34/80
105/105 - 0s - 4ms/step - loss: 0.0687 - val_loss: 0.7581
Epoch 35/80
105/105 - 0s - 4ms/step - loss: 0.0679 - val_loss: 0.7367
Epoch 36/80
105/105 - 0s - 4ms/step - loss: 0.0676 - val_loss: 0.7386
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3204
Per-joint RMSE: 0.3536 0.4652 0.2804 0.2526 0.2597 0.2540
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:56:37.465264: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:56:37.489671: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 07:56:38.342525: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:38.347177: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:38.348057: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:38.350182: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:38.350975: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:38.351706: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:38.432876: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:38.433726: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:38.434614: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:38.435346: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8824 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:56:38.734986: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.140995e-01  RMSE=4.627089e-01
  per-joint RMSE: 0.4965 0.7384 0.4128 0.3260 0.3306 0.3270
Residual LSTM:  MSE=1.026393e-01      RMSE=3.203737e-01
  per-joint RMSE: 0.3536 0.4652 0.2804 0.2526 0.2597 0.2540
Combined torque MSE=1.026393e-01     RMSE=3.203737e-01
  per-joint RMSE: 0.3536 0.4652 0.2804 0.2526 0.2597 0.2540
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep300.npz --H 50 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep300.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep300.json
H=50, n_dof=6, feature_dim=6
X_train: (33432, 50, 6)  Y_train: (33432, 6)
X_test : (13667, 50, 6)  Y_test : (13667, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:56:41.022877: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:56:41.046653: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep300.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (33432, 50, 6), Y_train = (33432, 6)
  X_test  = (13667, 50, 6),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:56:42.088228: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:42.092850: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:42.093645: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:42.095166: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:42.095958: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:42.096695: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:42.172461: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:42.173374: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:42.174125: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:42.174856: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:56:43.117939: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.4661 - val_loss: 2.3782
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.2379 - val_loss: 2.5521
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.1809 - val_loss: 2.4876
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1625 - val_loss: 2.3431
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1429 - val_loss: 2.2618
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1395 - val_loss: 2.1463
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1279 - val_loss: 2.0245
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.1261 - val_loss: 2.0852
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.1236 - val_loss: 2.0105
Epoch 10/80
105/105 - 0s - 5ms/step - loss: 0.1141 - val_loss: 2.0713
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.1095 - val_loss: 2.0790
Epoch 12/80
105/105 - 0s - 4ms/step - loss: 0.1083 - val_loss: 2.0602
Epoch 13/80
105/105 - 0s - 4ms/step - loss: 0.1079 - val_loss: 2.0977
Epoch 14/80
105/105 - 0s - 4ms/step - loss: 0.1048 - val_loss: 1.9872
Epoch 15/80
105/105 - 0s - 4ms/step - loss: 0.1070 - val_loss: 1.7467
Epoch 16/80
105/105 - 0s - 4ms/step - loss: 0.1101 - val_loss: 1.8471
Epoch 17/80
105/105 - 0s - 4ms/step - loss: 0.0989 - val_loss: 1.8237
Epoch 18/80
105/105 - 0s - 4ms/step - loss: 0.0996 - val_loss: 1.7677
Epoch 19/80
105/105 - 0s - 4ms/step - loss: 0.0958 - val_loss: 1.8646
Epoch 20/80
105/105 - 0s - 4ms/step - loss: 0.0968 - val_loss: 1.8107
Epoch 21/80
105/105 - 0s - 4ms/step - loss: 0.0932 - val_loss: 1.8160
Epoch 22/80
105/105 - 0s - 4ms/step - loss: 0.0941 - val_loss: 1.7278
Epoch 23/80
105/105 - 0s - 4ms/step - loss: 0.0936 - val_loss: 1.6789
Epoch 24/80
105/105 - 0s - 4ms/step - loss: 0.1046 - val_loss: 2.2481
Epoch 25/80
105/105 - 0s - 4ms/step - loss: 0.0925 - val_loss: 2.2962
Epoch 26/80
105/105 - 0s - 4ms/step - loss: 0.0911 - val_loss: 2.3026
Epoch 27/80
105/105 - 0s - 4ms/step - loss: 0.0885 - val_loss: 2.2967
Epoch 28/80
105/105 - 0s - 4ms/step - loss: 0.0883 - val_loss: 2.3009
Epoch 29/80
105/105 - 0s - 4ms/step - loss: 0.0894 - val_loss: 2.2704
Epoch 30/80
105/105 - 0s - 4ms/step - loss: 0.0869 - val_loss: 2.2646
Epoch 31/80
105/105 - 0s - 4ms/step - loss: 0.0857 - val_loss: 2.2728
Epoch 32/80
105/105 - 0s - 4ms/step - loss: 0.0858 - val_loss: 2.3097
Epoch 33/80
105/105 - 0s - 4ms/step - loss: 0.0853 - val_loss: 2.2168
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.4141
Per-joint RMSE: 0.4472 0.6335 0.3517 0.3291 0.3023 0.3229
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:56:58.691105: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:56:58.715608: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 07:56:59.579271: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:59.583996: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:59.584797: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:59.586730: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:59.587525: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:59.588265: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:59.667165: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:59.668082: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:59.668818: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:56:59.669544: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:56:59.962485: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.140995e-01  RMSE=4.627089e-01
  per-joint RMSE: 0.4965 0.7384 0.4128 0.3260 0.3306 0.3270
Residual LSTM:  MSE=1.714943e-01      RMSE=4.141187e-01
  per-joint RMSE: 0.4472 0.6335 0.3517 0.3291 0.3023 0.3229
Combined torque MSE=1.714943e-01     RMSE=4.141187e-01
  per-joint RMSE: 0.4472 0.6335 0.3517 0.3291 0.3023 0.3229
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep300.npz --H 50 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep300.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep300.json
H=50, n_dof=6, feature_dim=18
X_train: (33432, 50, 18)  Y_train: (33432, 6)
X_test : (13667, 50, 18)  Y_test : (13667, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:57:02.374864: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:57:02.399161: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep300.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (33432, 50, 18), Y_train = (33432, 6)
  X_test  = (13667, 50, 18),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:57:03.587042: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:03.592019: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:03.592913: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:03.594841: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:03.595755: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:03.596616: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:03.685100: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:03.685996: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:03.686793: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:03.687592: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:57:04.680698: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.3131 - val_loss: 0.8051
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.1935 - val_loss: 0.7738
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.1730 - val_loss: 0.8082
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1629 - val_loss: 0.7984
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1569 - val_loss: 0.7985
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1493 - val_loss: 0.7149
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1443 - val_loss: 0.7219
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.1400 - val_loss: 0.7861
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.1337 - val_loss: 0.7077
Epoch 10/80
105/105 - 0s - 5ms/step - loss: 0.1339 - val_loss: 0.7565
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.1369 - val_loss: 0.7411
Epoch 12/80
105/105 - 0s - 4ms/step - loss: 0.1295 - val_loss: 0.7382
Epoch 13/80
105/105 - 0s - 4ms/step - loss: 0.1258 - val_loss: 0.7229
Epoch 14/80
105/105 - 0s - 4ms/step - loss: 0.1218 - val_loss: 0.7216
Epoch 15/80
105/105 - 0s - 4ms/step - loss: 0.1219 - val_loss: 0.7416
Epoch 16/80
105/105 - 0s - 4ms/step - loss: 0.1191 - val_loss: 0.6629
Epoch 17/80
105/105 - 0s - 4ms/step - loss: 0.1192 - val_loss: 0.7295
Epoch 18/80
105/105 - 0s - 4ms/step - loss: 0.1159 - val_loss: 0.7177
Epoch 19/80
105/105 - 0s - 4ms/step - loss: 0.1131 - val_loss: 0.6736
Epoch 20/80
105/105 - 0s - 4ms/step - loss: 0.1224 - val_loss: 0.6567
Epoch 21/80
105/105 - 0s - 4ms/step - loss: 0.1145 - val_loss: 0.6727
Epoch 22/80
105/105 - 0s - 4ms/step - loss: 0.1135 - val_loss: 0.6692
Epoch 23/80
105/105 - 0s - 4ms/step - loss: 0.1112 - val_loss: 0.6947
Epoch 24/80
105/105 - 0s - 4ms/step - loss: 0.1103 - val_loss: 0.6619
Epoch 25/80
105/105 - 0s - 4ms/step - loss: 0.1102 - val_loss: 0.6741
Epoch 26/80
105/105 - 0s - 4ms/step - loss: 0.1080 - val_loss: 0.6396
Epoch 27/80
105/105 - 0s - 4ms/step - loss: 0.1093 - val_loss: 0.6728
Epoch 28/80
105/105 - 0s - 4ms/step - loss: 0.1056 - val_loss: 0.6749
Epoch 29/80
105/105 - 0s - 4ms/step - loss: 0.1084 - val_loss: 0.6813
Epoch 30/80
105/105 - 0s - 4ms/step - loss: 0.1054 - val_loss: 0.6709
Epoch 31/80
105/105 - 0s - 4ms/step - loss: 0.1044 - val_loss: 0.6824
Epoch 32/80
105/105 - 0s - 4ms/step - loss: 0.1035 - val_loss: 0.6664
Epoch 33/80
105/105 - 0s - 4ms/step - loss: 0.1037 - val_loss: 0.6773
Epoch 34/80
105/105 - 0s - 4ms/step - loss: 0.1018 - val_loss: 0.7254
Epoch 35/80
105/105 - 0s - 4ms/step - loss: 0.1028 - val_loss: 0.7120
Epoch 36/80
105/105 - 0s - 4ms/step - loss: 0.1058 - val_loss: 0.6499
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3668
Per-joint RMSE: 0.4241 0.5118 0.3127 0.2886 0.3029 0.3045
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:57:21.809023: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:57:21.833792: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 07:57:22.685900: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:22.690491: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:22.691285: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:22.693075: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:22.693867: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:22.694615: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:22.774073: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:22.774903: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:22.775647: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:22.776976: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:57:23.072953: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.140995e-01  RMSE=4.627089e-01
  per-joint RMSE: 0.4965 0.7384 0.4128 0.3260 0.3306 0.3270
Residual LSTM:  MSE=1.345698e-01      RMSE=3.668376e-01
  per-joint RMSE: 0.4241 0.5118 0.3127 0.2886 0.3029 0.3045
Combined torque MSE=1.345698e-01     RMSE=3.668376e-01
  per-joint RMSE: 0.4241 0.5118 0.3127 0.2886 0.3029 0.3045
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep300.npz --H 50 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep300.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep300.json
H=50, n_dof=6, feature_dim=18
X_train: (33432, 50, 18)  Y_train: (33432, 6)
X_test : (13667, 50, 18)  Y_test : (13667, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:57:25.506357: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:57:25.529977: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep300.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (33432, 50, 18), Y_train = (33432, 6)
  X_test  = (13667, 50, 18),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:57:26.714387: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:26.719275: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:26.720178: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:26.722025: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:26.722929: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:26.723783: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:26.812025: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:26.812914: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:26.813708: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:26.814494: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:57:27.815842: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.2679 - val_loss: 0.8735
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.1473 - val_loss: 0.8673
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.1290 - val_loss: 0.8281
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1194 - val_loss: 0.8156
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1131 - val_loss: 0.8071
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1086 - val_loss: 0.8037
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1039 - val_loss: 0.7826
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.0999 - val_loss: 0.7717
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.0968 - val_loss: 0.7687
Epoch 10/80
105/105 - 1s - 5ms/step - loss: 0.0946 - val_loss: 0.7385
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.0919 - val_loss: 0.7336
Epoch 12/80
105/105 - 0s - 4ms/step - loss: 0.0899 - val_loss: 0.7210
Epoch 13/80
105/105 - 0s - 4ms/step - loss: 0.0878 - val_loss: 0.7164
Epoch 14/80
105/105 - 0s - 4ms/step - loss: 0.0859 - val_loss: 0.7082
Epoch 15/80
105/105 - 0s - 4ms/step - loss: 0.0849 - val_loss: 0.7042
Epoch 16/80
105/105 - 0s - 4ms/step - loss: 0.0829 - val_loss: 0.6965
Epoch 17/80
105/105 - 0s - 4ms/step - loss: 0.0823 - val_loss: 0.6978
Epoch 18/80
105/105 - 0s - 4ms/step - loss: 0.0806 - val_loss: 0.6930
Epoch 19/80
105/105 - 0s - 4ms/step - loss: 0.0797 - val_loss: 0.6978
Epoch 20/80
105/105 - 0s - 4ms/step - loss: 0.0784 - val_loss: 0.6840
Epoch 21/80
105/105 - 0s - 4ms/step - loss: 0.0770 - val_loss: 0.6980
Epoch 22/80
105/105 - 0s - 4ms/step - loss: 0.0774 - val_loss: 0.7052
Epoch 23/80
105/105 - 0s - 4ms/step - loss: 0.0764 - val_loss: 0.6944
Epoch 24/80
105/105 - 0s - 4ms/step - loss: 0.0747 - val_loss: 0.6943
Epoch 25/80
105/105 - 0s - 4ms/step - loss: 0.0748 - val_loss: 0.7047
Epoch 26/80
105/105 - 0s - 4ms/step - loss: 0.0744 - val_loss: 0.7133
Epoch 27/80
105/105 - 0s - 4ms/step - loss: 0.0735 - val_loss: 0.7079
Epoch 28/80
105/105 - 0s - 4ms/step - loss: 0.0721 - val_loss: 0.6975
Epoch 29/80
105/105 - 0s - 4ms/step - loss: 0.0715 - val_loss: 0.7120
Epoch 30/80
105/105 - 0s - 4ms/step - loss: 0.0708 - val_loss: 0.7089
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3355
Per-joint RMSE: 0.3599 0.5075 0.2935 0.2509 0.2642 0.2637
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:57:42.431114: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:57:42.455217: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s1_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 07:57:43.315520: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:43.320200: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:43.321122: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:43.322936: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:43.323856: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:43.324717: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:43.408613: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:43.409595: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:43.410384: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:57:43.411251: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:57:43.705259: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.140995e-01  RMSE=4.627089e-01
  per-joint RMSE: 0.4965 0.7384 0.4128 0.3260 0.3306 0.3270
Residual LSTM:  MSE=1.125840e-01      RMSE=3.355355e-01
  per-joint RMSE: 0.3599 0.5075 0.2935 0.2509 0.2642 0.2637
Combined torque MSE=1.125840e-01     RMSE=3.355355e-01
  per-joint RMSE: 0.3599 0.5075 0.2935 0.2509 0.2642 0.2637
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s1_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=2                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz                                ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz -t structured -s 2 -r 0 --hp_preset fast_debug --epochs 300 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300.jax' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 300, 'lagrangian_type': <function structured_lagrangian_fn at 0x76acee8c41f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz
   dt ≈ 0.025265617146188975
  dof = 6
  Train trajectories = 70
  Test trajectories  = 30
  Train samples = 35298
  Test samples  = 14539
################################################

2026-01-22 07:57:48.312153: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300 | type=structured | dof=6
################################################
2026-01-22 07:57:51.458585: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:57:51.458621: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:57:51.458628: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:57:51.458656: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:57:51.458661: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:57:51.458675: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:57:51.458712: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:57:51.458718: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:57:51.458733: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:57:51.458738: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.0s, Loss=1.27e+01, Inv=1.27e+01, For=9.94e+01, Power=4.16e+00
  [eval] test_mse=1.728e+00  (n=14539)
Epoch 00050: Time=  10.6s, Loss=2.72e+00, Inv=2.72e+00, For=4.91e+01, Power=1.99e+00
Epoch 00100: Time=  14.9s, Loss=2.42e+00, Inv=2.42e+00, For=6.15e+01, Power=1.75e+00
Epoch 00150: Time=  19.7s, Loss=2.27e+00, Inv=2.27e+00, For=7.34e+01, Power=1.64e+00
Epoch 00200: Time=  24.9s, Loss=2.20e+00, Inv=2.20e+00, For=8.28e+01, Power=1.62e+00
  [eval] test_mse=1.080e+00  (n=14539)
Epoch 00250: Time=  29.3s, Loss=2.14e+00, Inv=2.14e+00, For=9.52e+01, Power=1.60e+00
Epoch 00300: Time=  33.5s, Loss=2.10e+00, Inv=2.10e+00, For=1.05e+02, Power=1.57e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300
Torque MSE  = 2.012e-01
Torque RMSE = 4.485e-01
Per-joint MSE : 2.414e-01 4.846e-01 1.526e-01 1.365e-01 1.115e-01 8.052e-02
Per-joint RMSE: 4.913e-01 6.961e-01 3.907e-01 3.694e-01 3.339e-01 2.838e-01
Comp Time per Sample = 2.207e-08s / 45319659.3Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz' ===
===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K100_tf0p3_seed2_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep300.jax
Detected n_dof=6 (seed=2)
2026-01-22 07:58:27.113157: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 70 trajectories
2026-01-22 07:58:28.414533: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:58:28.414545: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:58:30.028040: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:58:30.028054: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:58:31.610858: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 25/70
2026-01-22 07:58:32.818417: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:58:33.996540: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:58:33.996581: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 07:58:33.996587: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 50/70
  done 70/70

Exporting split=test: 30 trajectories
  done 25/30
  done 30/30

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep300.npz --H 25 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep300.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep300.json
H=25, n_dof=6, feature_dim=24
X_train: (34332, 25, 24)  Y_train: (34332, 6)
X_test : (14092, 25, 24)  Y_test : (14092, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:58:36.426730: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:58:36.450743: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep300.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (34332, 25, 24), Y_train = (34332, 6)
  X_test  = (14092, 25, 24),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:58:37.555885: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:37.560796: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:37.561725: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:37.563534: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:37.564450: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:37.565324: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:37.648812: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:37.649867: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:37.650741: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:37.651527: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8827 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:58:38.604157: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.2670 - val_loss: 0.7851
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.1465 - val_loss: 0.7971
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.1274 - val_loss: 0.7846
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1176 - val_loss: 0.7785
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1105 - val_loss: 0.7699
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1051 - val_loss: 0.7791
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.1013 - val_loss: 0.7682
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.0973 - val_loss: 0.7778
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.0956 - val_loss: 0.7719
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.0927 - val_loss: 0.7856
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.0910 - val_loss: 0.7733
Epoch 12/80
108/108 - 0s - 3ms/step - loss: 0.0892 - val_loss: 0.7762
Epoch 13/80
108/108 - 0s - 3ms/step - loss: 0.0870 - val_loss: 0.7639
Epoch 14/80
108/108 - 0s - 3ms/step - loss: 0.0861 - val_loss: 0.7725
Epoch 15/80
108/108 - 0s - 3ms/step - loss: 0.0835 - val_loss: 0.7615
Epoch 16/80
108/108 - 0s - 3ms/step - loss: 0.0825 - val_loss: 0.7530
Epoch 17/80
108/108 - 0s - 3ms/step - loss: 0.0813 - val_loss: 0.7471
Epoch 18/80
108/108 - 0s - 3ms/step - loss: 0.0799 - val_loss: 0.7466
Epoch 19/80
108/108 - 0s - 3ms/step - loss: 0.0794 - val_loss: 0.7391
Epoch 20/80
108/108 - 0s - 3ms/step - loss: 0.0779 - val_loss: 0.7480
Epoch 21/80
108/108 - 0s - 3ms/step - loss: 0.0770 - val_loss: 0.7410
Epoch 22/80
108/108 - 0s - 3ms/step - loss: 0.0760 - val_loss: 0.7407
Epoch 23/80
108/108 - 0s - 3ms/step - loss: 0.0755 - val_loss: 0.7324
Epoch 24/80
108/108 - 0s - 3ms/step - loss: 0.0742 - val_loss: 0.7320
Epoch 25/80
108/108 - 0s - 3ms/step - loss: 0.0734 - val_loss: 0.7478
Epoch 26/80
108/108 - 0s - 3ms/step - loss: 0.0732 - val_loss: 0.7453
Epoch 27/80
108/108 - 0s - 3ms/step - loss: 0.0725 - val_loss: 0.7439
Epoch 28/80
108/108 - 0s - 3ms/step - loss: 0.0713 - val_loss: 0.7363
Epoch 29/80
108/108 - 0s - 3ms/step - loss: 0.0712 - val_loss: 0.7441
Epoch 30/80
108/108 - 0s - 3ms/step - loss: 0.0702 - val_loss: 0.7400
Epoch 31/80
108/108 - 0s - 3ms/step - loss: 0.0705 - val_loss: 0.7414
Epoch 32/80
108/108 - 0s - 3ms/step - loss: 0.0693 - val_loss: 0.7405
Epoch 33/80
108/108 - 0s - 3ms/step - loss: 0.0694 - val_loss: 0.7496
Epoch 34/80
108/108 - 0s - 3ms/step - loss: 0.0687 - val_loss: 0.7297
Epoch 35/80
108/108 - 0s - 3ms/step - loss: 0.0688 - val_loss: 0.7420
Epoch 36/80
108/108 - 0s - 3ms/step - loss: 0.0673 - val_loss: 0.7474
Epoch 37/80
108/108 - 0s - 3ms/step - loss: 0.0673 - val_loss: 0.7267
Epoch 38/80
108/108 - 0s - 3ms/step - loss: 0.0669 - val_loss: 0.7301
Epoch 39/80
108/108 - 0s - 3ms/step - loss: 0.0661 - val_loss: 0.7324
Epoch 40/80
108/108 - 0s - 3ms/step - loss: 0.0663 - val_loss: 0.7450
Epoch 41/80
108/108 - 0s - 3ms/step - loss: 0.0653 - val_loss: 0.7310
Epoch 42/80
108/108 - 0s - 3ms/step - loss: 0.0655 - val_loss: 0.7281
Epoch 43/80
108/108 - 0s - 3ms/step - loss: 0.0650 - val_loss: 0.7226
Epoch 44/80
108/108 - 0s - 3ms/step - loss: 0.0649 - val_loss: 0.7371
Epoch 45/80
108/108 - 0s - 3ms/step - loss: 0.0642 - val_loss: 0.7413
Epoch 46/80
108/108 - 0s - 3ms/step - loss: 0.0641 - val_loss: 0.7338
Epoch 47/80
108/108 - 0s - 3ms/step - loss: 0.0638 - val_loss: 0.7468
Epoch 48/80
108/108 - 0s - 3ms/step - loss: 0.0634 - val_loss: 0.7457
Epoch 49/80
108/108 - 0s - 3ms/step - loss: 0.0636 - val_loss: 0.7444
Epoch 50/80
108/108 - 0s - 3ms/step - loss: 0.0624 - val_loss: 0.7400
Epoch 51/80
108/108 - 0s - 3ms/step - loss: 0.0623 - val_loss: 0.7456
Epoch 52/80
108/108 - 0s - 3ms/step - loss: 0.0622 - val_loss: 0.7476
Epoch 53/80
108/108 - 0s - 3ms/step - loss: 0.0617 - val_loss: 0.7430
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3115
Per-joint RMSE: 0.3269 0.4385 0.2730 0.3008 0.2647 0.2195
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:58:55.812015: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:58:55.836650: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 07:58:56.694504: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:56.699099: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:56.699939: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:56.701610: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:56.702457: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:56.703255: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:56.782586: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:56.783482: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:56.784281: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:58:56.785064: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:58:57.081112: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.028041e-01  RMSE=4.503377e-01
  per-joint RMSE: 0.4929 0.7001 0.3914 0.3687 0.3361 0.2856
Residual LSTM:  MSE=9.705948e-02      RMSE=3.115437e-01
  per-joint RMSE: 0.3269 0.4385 0.2730 0.3008 0.2647 0.2195
Combined torque MSE=9.705947e-02     RMSE=3.115437e-01
  per-joint RMSE: 0.3269 0.4385 0.2730 0.3008 0.2647 0.2195
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep300.npz --H 25 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep300.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep300.json
H=25, n_dof=6, feature_dim=6
X_train: (34332, 25, 6)  Y_train: (34332, 6)
X_test : (14092, 25, 6)  Y_test : (14092, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:58:59.321184: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:58:59.345691: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep300.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (34332, 25, 6), Y_train = (34332, 6)
  X_test  = (14092, 25, 6),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:59:00.339323: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:00.343874: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:00.344675: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:00.346281: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:00.347073: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:00.347812: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:00.429040: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:00.429884: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:00.430669: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:00.431534: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:59:01.316390: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.5310 - val_loss: 1.5931
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.2769 - val_loss: 1.3231
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.2126 - val_loss: 1.3547
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1866 - val_loss: 1.4436
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1666 - val_loss: 1.4277
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1550 - val_loss: 1.4892
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.1456 - val_loss: 1.8212
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.1386 - val_loss: 1.6028
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.1336 - val_loss: 1.5977
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.1243 - val_loss: 1.5249
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.1193 - val_loss: 1.5297
Epoch 12/80
108/108 - 0s - 3ms/step - loss: 0.1173 - val_loss: 1.5922
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3905
Per-joint RMSE: 0.4530 0.5341 0.3458 0.3443 0.3119 0.2986
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:59:06.401455: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:59:06.426362: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 07:59:07.295689: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:07.300375: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:07.301287: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:07.303163: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:07.304080: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:07.304828: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:07.399167: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:07.400057: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:07.400851: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:07.401630: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:59:07.696347: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.028041e-01  RMSE=4.503377e-01
  per-joint RMSE: 0.4929 0.7001 0.3914 0.3687 0.3361 0.2856
Residual LSTM:  MSE=1.525036e-01      RMSE=3.905171e-01
  per-joint RMSE: 0.4530 0.5341 0.3458 0.3443 0.3119 0.2986
Combined torque MSE=1.525036e-01     RMSE=3.905171e-01
  per-joint RMSE: 0.4530 0.5341 0.3458 0.3443 0.3119 0.2986
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep300.npz --H 25 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep300.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep300.json
H=25, n_dof=6, feature_dim=18
X_train: (34332, 25, 18)  Y_train: (34332, 6)
X_test : (14092, 25, 18)  Y_test : (14092, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:59:10.005383: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:59:10.029811: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep300.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (34332, 25, 18), Y_train = (34332, 6)
  X_test  = (14092, 25, 18),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:59:11.080969: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:11.085963: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:11.086765: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:11.088346: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:11.089137: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:11.089884: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:11.167153: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:11.167987: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:11.168816: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:11.169545: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:59:12.114181: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.3173 - val_loss: 0.6387
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.1951 - val_loss: 0.6954
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.1725 - val_loss: 0.7014
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1607 - val_loss: 0.7106
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1514 - val_loss: 0.6653
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1437 - val_loss: 0.7020
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.1394 - val_loss: 0.7071
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.1349 - val_loss: 0.7213
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.1280 - val_loss: 0.7348
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.1285 - val_loss: 0.7562
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.1169 - val_loss: 0.7373
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3565
Per-joint RMSE: 0.4149 0.4643 0.2823 0.3492 0.3086 0.2789
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:59:16.970853: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:59:16.995268: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 07:59:17.842763: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:17.847381: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:17.848181: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:17.849871: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:17.850671: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:17.851413: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:17.931574: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:17.932418: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:17.933164: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:17.933895: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:59:18.225475: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.028041e-01  RMSE=4.503377e-01
  per-joint RMSE: 0.4929 0.7001 0.3914 0.3687 0.3361 0.2856
Residual LSTM:  MSE=1.270688e-01      RMSE=3.564671e-01
  per-joint RMSE: 0.4149 0.4643 0.2823 0.3492 0.3086 0.2789
Combined torque MSE=1.270688e-01     RMSE=3.564671e-01
  per-joint RMSE: 0.4149 0.4643 0.2823 0.3492 0.3086 0.2789
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep300.npz --H 25 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep300.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep300.json
H=25, n_dof=6, feature_dim=18
X_train: (34332, 25, 18)  Y_train: (34332, 6)
X_test : (14092, 25, 18)  Y_test : (14092, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:59:20.540290: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:59:20.564147: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep300.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (34332, 25, 18), Y_train = (34332, 6)
  X_test  = (14092, 25, 18),  Y_test  = (14092, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:59:21.629349: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:21.633855: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:21.634734: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:21.636348: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:21.637149: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:21.637891: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:21.718536: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:21.719462: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:21.720289: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:21.721104: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8822 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:59:22.653291: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
108/108 - 2s - 15ms/step - loss: 0.2629 - val_loss: 0.6848
Epoch 2/80
108/108 - 0s - 3ms/step - loss: 0.1493 - val_loss: 0.6781
Epoch 3/80
108/108 - 0s - 3ms/step - loss: 0.1286 - val_loss: 0.6507
Epoch 4/80
108/108 - 0s - 3ms/step - loss: 0.1178 - val_loss: 0.6420
Epoch 5/80
108/108 - 0s - 3ms/step - loss: 0.1106 - val_loss: 0.6349
Epoch 6/80
108/108 - 0s - 3ms/step - loss: 0.1052 - val_loss: 0.6318
Epoch 7/80
108/108 - 0s - 3ms/step - loss: 0.1010 - val_loss: 0.6409
Epoch 8/80
108/108 - 0s - 3ms/step - loss: 0.0971 - val_loss: 0.6367
Epoch 9/80
108/108 - 0s - 3ms/step - loss: 0.0945 - val_loss: 0.6298
Epoch 10/80
108/108 - 0s - 3ms/step - loss: 0.0920 - val_loss: 0.6251
Epoch 11/80
108/108 - 0s - 3ms/step - loss: 0.0905 - val_loss: 0.6204
Epoch 12/80
108/108 - 0s - 3ms/step - loss: 0.0886 - val_loss: 0.6204
Epoch 13/80
108/108 - 0s - 3ms/step - loss: 0.0866 - val_loss: 0.6134
Epoch 14/80
108/108 - 0s - 3ms/step - loss: 0.0847 - val_loss: 0.6214
Epoch 15/80
108/108 - 0s - 3ms/step - loss: 0.0835 - val_loss: 0.6131
Epoch 16/80
108/108 - 0s - 3ms/step - loss: 0.0824 - val_loss: 0.6162
Epoch 17/80
108/108 - 0s - 3ms/step - loss: 0.0818 - val_loss: 0.6139
Epoch 18/80
108/108 - 0s - 3ms/step - loss: 0.0804 - val_loss: 0.6143
Epoch 19/80
108/108 - 0s - 3ms/step - loss: 0.0785 - val_loss: 0.6181
Epoch 20/80
108/108 - 0s - 3ms/step - loss: 0.0774 - val_loss: 0.6075
Epoch 21/80
108/108 - 0s - 3ms/step - loss: 0.0767 - val_loss: 0.6028
Epoch 22/80
108/108 - 0s - 3ms/step - loss: 0.0759 - val_loss: 0.6147
Epoch 23/80
108/108 - 0s - 3ms/step - loss: 0.0749 - val_loss: 0.6196
Epoch 24/80
108/108 - 0s - 3ms/step - loss: 0.0737 - val_loss: 0.6163
Epoch 25/80
108/108 - 0s - 3ms/step - loss: 0.0735 - val_loss: 0.6117
Epoch 26/80
108/108 - 0s - 3ms/step - loss: 0.0727 - val_loss: 0.6135
Epoch 27/80
108/108 - 0s - 3ms/step - loss: 0.0727 - val_loss: 0.6180
Epoch 28/80
108/108 - 0s - 3ms/step - loss: 0.0718 - val_loss: 0.6167
Epoch 29/80
108/108 - 0s - 3ms/step - loss: 0.0705 - val_loss: 0.6255
Epoch 30/80
108/108 - 0s - 3ms/step - loss: 0.0703 - val_loss: 0.6116
Epoch 31/80
108/108 - 0s - 3ms/step - loss: 0.0698 - val_loss: 0.6266
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3091
Per-joint RMSE: 0.3323 0.4299 0.2704 0.2881 0.2725 0.2188
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:59:33.254359: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:59:33.278512: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 07:59:34.131663: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:34.136327: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:34.137117: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:34.138947: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:34.139842: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:34.140577: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:34.219183: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:34.220174: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:34.220921: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:34.221655: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:59:34.521753: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.028041e-01  RMSE=4.503377e-01
  per-joint RMSE: 0.4929 0.7001 0.3914 0.3687 0.3361 0.2856
Residual LSTM:  MSE=9.557216e-02      RMSE=3.091475e-01
  per-joint RMSE: 0.3323 0.4299 0.2704 0.2881 0.2725 0.2188
Combined torque MSE=9.557216e-02     RMSE=3.091475e-01
  per-joint RMSE: 0.3323 0.4299 0.2704 0.2881 0.2725 0.2188
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H25_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep300.npz --H 50 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep300.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep300.json
H=50, n_dof=6, feature_dim=24
X_train: (33432, 50, 24)  Y_train: (33432, 6)
X_test : (13667, 50, 24)  Y_test : (13667, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:59:36.950158: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:59:36.974192: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep300.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (33432, 50, 24), Y_train = (33432, 6)
  X_test  = (13667, 50, 24),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 07:59:38.231366: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:38.236578: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:38.237494: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:38.239279: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:38.240193: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:38.241046: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:38.330418: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:38.331379: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:38.332171: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:38.332952: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 07:59:39.359635: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.2546 - val_loss: 0.9188
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.1454 - val_loss: 0.9545
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.1292 - val_loss: 0.8848
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1202 - val_loss: 0.8765
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1139 - val_loss: 0.8548
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1078 - val_loss: 0.8544
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1042 - val_loss: 0.8300
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.1001 - val_loss: 0.8093
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.0974 - val_loss: 0.7822
Epoch 10/80
105/105 - 0s - 5ms/step - loss: 0.0942 - val_loss: 0.7691
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.0917 - val_loss: 0.7560
Epoch 12/80
105/105 - 0s - 4ms/step - loss: 0.0904 - val_loss: 0.7501
Epoch 13/80
105/105 - 0s - 4ms/step - loss: 0.0880 - val_loss: 0.7439
Epoch 14/80
105/105 - 0s - 4ms/step - loss: 0.0866 - val_loss: 0.7438
Epoch 15/80
105/105 - 0s - 4ms/step - loss: 0.0847 - val_loss: 0.7397
Epoch 16/80
105/105 - 0s - 4ms/step - loss: 0.0829 - val_loss: 0.7367
Epoch 17/80
105/105 - 0s - 4ms/step - loss: 0.0816 - val_loss: 0.7248
Epoch 18/80
105/105 - 0s - 4ms/step - loss: 0.0804 - val_loss: 0.7166
Epoch 19/80
105/105 - 0s - 4ms/step - loss: 0.0794 - val_loss: 0.7320
Epoch 20/80
105/105 - 0s - 4ms/step - loss: 0.0781 - val_loss: 0.7135
Epoch 21/80
105/105 - 0s - 4ms/step - loss: 0.0766 - val_loss: 0.7187
Epoch 22/80
105/105 - 0s - 4ms/step - loss: 0.0757 - val_loss: 0.7182
Epoch 23/80
105/105 - 0s - 4ms/step - loss: 0.0755 - val_loss: 0.7152
Epoch 24/80
105/105 - 0s - 4ms/step - loss: 0.0745 - val_loss: 0.7047
Epoch 25/80
105/105 - 0s - 4ms/step - loss: 0.0738 - val_loss: 0.7114
Epoch 26/80
105/105 - 0s - 4ms/step - loss: 0.0725 - val_loss: 0.7112
Epoch 27/80
105/105 - 0s - 4ms/step - loss: 0.0725 - val_loss: 0.7006
Epoch 28/80
105/105 - 0s - 4ms/step - loss: 0.0719 - val_loss: 0.7036
Epoch 29/80
105/105 - 0s - 4ms/step - loss: 0.0710 - val_loss: 0.7153
Epoch 30/80
105/105 - 0s - 4ms/step - loss: 0.0704 - val_loss: 0.7149
Epoch 31/80
105/105 - 0s - 4ms/step - loss: 0.0700 - val_loss: 0.7074
Epoch 32/80
105/105 - 0s - 4ms/step - loss: 0.0691 - val_loss: 0.7321
Epoch 33/80
105/105 - 0s - 4ms/step - loss: 0.0691 - val_loss: 0.7138
Epoch 34/80
105/105 - 0s - 4ms/step - loss: 0.0689 - val_loss: 0.7123
Epoch 35/80
105/105 - 0s - 4ms/step - loss: 0.0679 - val_loss: 0.7178
Epoch 36/80
105/105 - 0s - 4ms/step - loss: 0.0673 - val_loss: 0.7225
Epoch 37/80
105/105 - 0s - 4ms/step - loss: 0.0669 - val_loss: 0.7144
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3019
Per-joint RMSE: 0.3153 0.4119 0.2641 0.3011 0.2600 0.2233
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 07:59:56.776200: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 07:59:56.801373: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 07:59:57.659147: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:57.663784: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:57.664628: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:57.666328: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:57.667256: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:57.668039: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:57.751411: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:57.752473: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:57.753268: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 07:59:57.754058: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8959 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 07:59:58.053558: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.052368e-01  RMSE=4.530307e-01
  per-joint RMSE: 0.4949 0.7061 0.3919 0.3720 0.3387 0.2851
Residual LSTM:  MSE=9.115975e-02      RMSE=3.019267e-01
  per-joint RMSE: 0.3153 0.4119 0.2641 0.3011 0.2600 0.2233
Combined torque MSE=9.115975e-02     RMSE=3.019267e-01
  per-joint RMSE: 0.3153 0.4119 0.2641 0.3011 0.2600 0.2233
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_full__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep300.npz --H 50 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep300.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep300.json
H=50, n_dof=6, feature_dim=6
X_train: (33432, 50, 6)  Y_train: (33432, 6)
X_test : (13667, 50, 6)  Y_test : (13667, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:00:00.374015: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:00:00.398029: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep300.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (33432, 50, 6), Y_train = (33432, 6)
  X_test  = (13667, 50, 6),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:00:01.452680: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:01.457248: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:01.458051: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:01.459591: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:01.460380: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:01.461114: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:01.543288: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:01.544130: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:01.544964: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:01.545700: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 08:00:02.497805: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.4662 - val_loss: 1.5971
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.2366 - val_loss: 1.6796
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.1957 - val_loss: 1.6746
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1644 - val_loss: 1.6874
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1514 - val_loss: 1.7167
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1489 - val_loss: 1.8220
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1327 - val_loss: 1.7616
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.1252 - val_loss: 1.7465
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.1212 - val_loss: 1.8004
Epoch 10/80
105/105 - 0s - 5ms/step - loss: 0.1195 - val_loss: 1.7755
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.1151 - val_loss: 1.7894
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.4098
Per-joint RMSE: 0.4834 0.5601 0.3425 0.3534 0.3367 0.3232
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:00:08.708641: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:00:08.732932: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 08:00:09.585599: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:09.590179: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:09.590970: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:09.592642: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:09.593436: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:09.594562: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:09.678422: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:09.679335: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:09.680090: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:09.680827: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:00:09.977999: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.052368e-01  RMSE=4.530307e-01
  per-joint RMSE: 0.4949 0.7061 0.3919 0.3720 0.3387 0.2851
Residual LSTM:  MSE=1.679177e-01      RMSE=4.097776e-01
  per-joint RMSE: 0.4834 0.5601 0.3425 0.3534 0.3367 0.3232
Combined torque MSE=1.679177e-01     RMSE=4.097776e-01
  per-joint RMSE: 0.4834 0.5601 0.3425 0.3534 0.3367 0.3232
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_tau_hat__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep300.npz --H 50 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep300.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep300.json
H=50, n_dof=6, feature_dim=18
X_train: (33432, 50, 18)  Y_train: (33432, 6)
X_test : (13667, 50, 18)  Y_test : (13667, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:00:12.410553: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:00:12.434608: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep300.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (33432, 50, 18), Y_train = (33432, 6)
  X_test  = (13667, 50, 18),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:00:13.613901: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:13.618741: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:13.619614: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:13.621323: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:13.622115: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:13.622858: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:13.718767: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:13.719658: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:13.720446: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:13.721229: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 08:00:14.690868: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.3102 - val_loss: 0.8472
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.1938 - val_loss: 0.8202
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.1731 - val_loss: 0.8132
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1650 - val_loss: 0.8231
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1552 - val_loss: 0.8736
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1481 - val_loss: 0.8527
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1446 - val_loss: 0.8222
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.1374 - val_loss: 0.8592
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.1344 - val_loss: 0.8762
Epoch 10/80
105/105 - 0s - 5ms/step - loss: 0.1300 - val_loss: 0.9164
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.1271 - val_loss: 0.9219
Epoch 12/80
105/105 - 0s - 4ms/step - loss: 0.1237 - val_loss: 0.8494
Epoch 13/80
105/105 - 0s - 4ms/step - loss: 0.1282 - val_loss: 0.9410
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3586
Per-joint RMSE: 0.4073 0.4798 0.2857 0.3457 0.3090 0.2809
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:00:21.876655: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:00:21.901434: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:00:22.760649: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:22.765405: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:22.766210: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:22.767898: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:22.768761: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:22.769552: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:22.846547: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:22.847472: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:22.848219: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:22.849043: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:00:23.145824: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.052368e-01  RMSE=4.530307e-01
  per-joint RMSE: 0.4949 0.7061 0.3919 0.3720 0.3387 0.2851
Residual LSTM:  MSE=1.286114e-01      RMSE=3.586244e-01
  per-joint RMSE: 0.4073 0.4798 0.2857 0.3457 0.3090 0.2809
Combined torque MSE=1.286114e-01     RMSE=3.586244e-01
  per-joint RMSE: 0.4073 0.4798 0.2857 0.3457 0.3090 0.2809
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep300.npz --H 50 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep300.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep300.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep300.json
H=50, n_dof=6, feature_dim=18
X_train: (33432, 50, 18)  Y_train: (33432, 6)
X_test : (13667, 50, 18)  Y_test : (13667, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep300.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 80 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:00:25.931636: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:00:25.955005: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep300.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (33432, 50, 18), Y_train = (33432, 6)
  X_test  = (13667, 50, 18),  Y_test  = (13667, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:00:27.140972: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:27.145803: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:27.146695: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:27.148358: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:27.149260: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:27.149995: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:27.241670: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:27.242551: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:27.243354: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:27.244148: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/80
2026-01-22 08:00:28.230342: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
105/105 - 2s - 17ms/step - loss: 0.2639 - val_loss: 0.8456
Epoch 2/80
105/105 - 0s - 4ms/step - loss: 0.1471 - val_loss: 0.8699
Epoch 3/80
105/105 - 0s - 4ms/step - loss: 0.1303 - val_loss: 0.8806
Epoch 4/80
105/105 - 0s - 4ms/step - loss: 0.1210 - val_loss: 0.8663
Epoch 5/80
105/105 - 0s - 4ms/step - loss: 0.1134 - val_loss: 0.8635
Epoch 6/80
105/105 - 0s - 4ms/step - loss: 0.1091 - val_loss: 0.8527
Epoch 7/80
105/105 - 0s - 4ms/step - loss: 0.1045 - val_loss: 0.8416
Epoch 8/80
105/105 - 0s - 4ms/step - loss: 0.1007 - val_loss: 0.8202
Epoch 9/80
105/105 - 0s - 4ms/step - loss: 0.0972 - val_loss: 0.7992
Epoch 10/80
105/105 - 0s - 5ms/step - loss: 0.0943 - val_loss: 0.7958
Epoch 11/80
105/105 - 0s - 4ms/step - loss: 0.0917 - val_loss: 0.7823
Epoch 12/80
105/105 - 0s - 4ms/step - loss: 0.0899 - val_loss: 0.7729
Epoch 13/80
105/105 - 0s - 4ms/step - loss: 0.0877 - val_loss: 0.7505
Epoch 14/80
105/105 - 0s - 4ms/step - loss: 0.0860 - val_loss: 0.7573
Epoch 15/80
105/105 - 0s - 4ms/step - loss: 0.0846 - val_loss: 0.7424
Epoch 16/80
105/105 - 0s - 4ms/step - loss: 0.0837 - val_loss: 0.7455
Epoch 17/80
105/105 - 0s - 4ms/step - loss: 0.0822 - val_loss: 0.7343
Epoch 18/80
105/105 - 0s - 4ms/step - loss: 0.0810 - val_loss: 0.7297
Epoch 19/80
105/105 - 0s - 4ms/step - loss: 0.0796 - val_loss: 0.7291
Epoch 20/80
105/105 - 0s - 4ms/step - loss: 0.0787 - val_loss: 0.7145
Epoch 21/80
105/105 - 0s - 4ms/step - loss: 0.0778 - val_loss: 0.7135
Epoch 22/80
105/105 - 0s - 4ms/step - loss: 0.0768 - val_loss: 0.7203
Epoch 23/80
105/105 - 0s - 4ms/step - loss: 0.0753 - val_loss: 0.7271
Epoch 24/80
105/105 - 0s - 4ms/step - loss: 0.0747 - val_loss: 0.7083
Epoch 25/80
105/105 - 0s - 4ms/step - loss: 0.0743 - val_loss: 0.7090
Epoch 26/80
105/105 - 0s - 4ms/step - loss: 0.0732 - val_loss: 0.7204
Epoch 27/80
105/105 - 0s - 4ms/step - loss: 0.0729 - val_loss: 0.7074
Epoch 28/80
105/105 - 0s - 4ms/step - loss: 0.0722 - val_loss: 0.7065
Epoch 29/80
105/105 - 0s - 4ms/step - loss: 0.0714 - val_loss: 0.7063
Epoch 30/80
105/105 - 0s - 4ms/step - loss: 0.0706 - val_loss: 0.7187
Epoch 31/80
105/105 - 0s - 4ms/step - loss: 0.0698 - val_loss: 0.7073
Epoch 32/80
105/105 - 0s - 4ms/step - loss: 0.0694 - val_loss: 0.7071
Epoch 33/80
105/105 - 0s - 4ms/step - loss: 0.0692 - val_loss: 0.7058
Epoch 34/80
105/105 - 0s - 4ms/step - loss: 0.0685 - val_loss: 0.6948
Epoch 35/80
105/105 - 0s - 4ms/step - loss: 0.0679 - val_loss: 0.6962
Epoch 36/80
105/105 - 0s - 4ms/step - loss: 0.0676 - val_loss: 0.7061
Epoch 37/80
105/105 - 0s - 4ms/step - loss: 0.0678 - val_loss: 0.7153
Epoch 38/80
105/105 - 0s - 4ms/step - loss: 0.0668 - val_loss: 0.6979
Epoch 39/80
105/105 - 0s - 4ms/step - loss: 0.0662 - val_loss: 0.7055
Epoch 40/80
105/105 - 0s - 4ms/step - loss: 0.0662 - val_loss: 0.6995
Epoch 41/80
105/105 - 0s - 4ms/step - loss: 0.0658 - val_loss: 0.7052
Epoch 42/80
105/105 - 0s - 4ms/step - loss: 0.0656 - val_loss: 0.6960
Epoch 43/80
105/105 - 0s - 4ms/step - loss: 0.0650 - val_loss: 0.6985
Epoch 44/80
105/105 - 0s - 4ms/step - loss: 0.0647 - val_loss: 0.6974
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.3262
Per-joint RMSE: 0.3404 0.4851 0.2728 0.3015 0.2663 0.2259
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:00:48.863603: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:00:48.888863: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300/delan_UR3_Load0_combined_26__A__K100_tf0p3__residual__delan_jax_struct_s2_ep300.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:00:49.750155: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:49.754880: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:49.755679: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:49.757301: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:49.758174: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:49.758920: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:49.836358: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:49.837270: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:49.838013: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:00:49.838746: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:00:50.134321: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.052368e-01  RMSE=4.530307e-01
  per-joint RMSE: 0.4949 0.7061 0.3919 0.3720 0.3387 0.2851
Residual LSTM:  MSE=1.064126e-01      RMSE=3.262095e-01
  per-joint RMSE: 0.3404 0.4851 0.2728 0.3015 0.2663 0.2259
Combined torque MSE=1.064126e-01     RMSE=3.262095e-01
  per-joint RMSE: 0.3404 0.4851 0.2728 0.3015 0.2663 0.2259
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K100_tf0p3__delan_jax_struct_s2_ep300__feat_state_tauhat__lstm_s2_H50_ep80_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

