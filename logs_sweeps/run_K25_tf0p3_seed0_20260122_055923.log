################################################################################################################
### RUN: K=25 test_fraction=0.3 seed=0                                                                       ###
### npz_in=/workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz ###
################################################################################################################

#####################
### 1) PREPROCESS ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_delan_dataset.py --qdd True --col_format wide --trajectory_amount 25 --test_fraction 0.3 --seed 0 --raw_csv /workspace/shared/data/raw/delan_UR3_Load0_combined_26.csv --out_npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Saved: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz
Trajectories: train=17 test=8
Exists: True

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=0                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz -t structured -s 0 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x7259ad9f81f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz
   dt ≈ 0.022376492089782287
  dof = 6
  Train trajectories = 17
  Test trajectories  = 8
  Train samples = 13027
  Test samples  = 4507
################################################

2026-01-22 05:13:50.546302: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150 | type=structured | dof=6
################################################
2026-01-22 05:13:53.706344: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:13:53.706383: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:13:53.706391: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:13:53.706431: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:13:53.706438: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:13:53.706456: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:13:53.706502: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:13:53.706508: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:13:53.706529: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:13:53.706534: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   4.9s, Loss=2.16e+01, Inv=2.16e+01, For=4.86e+02, Power=3.66e+00
  [eval] test_mse=7.433e+00  (n=4507)
Epoch 00050: Time=   8.3s, Loss=1.60e+00, Inv=1.60e+00, For=8.97e+01, Power=6.86e-01
Epoch 00100: Time=  10.0s, Loss=1.25e+00, Inv=1.25e+00, For=9.32e+01, Power=5.00e-01
Epoch 00150: Time=  11.7s, Loss=1.12e+00, Inv=1.12e+00, For=1.17e+02, Power=4.41e-01
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
Torque MSE  = 1.891e+00
Torque RMSE = 1.375e+00
Per-joint MSE : 9.117e-01 5.531e+00 3.818e-01 1.118e+00 8.204e-01 2.584e+00
Per-joint RMSE: 9.548e-01 2.352e+00 6.179e-01 1.057e+00 9.058e-01 1.607e+00
Comp Time per Sample = 7.000e-08s / 14285352.0Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
Detected n_dof=6 (seed=0)
2026-01-22 05:14:07.474019: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 17 trajectories
2026-01-22 05:14:08.752337: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:14:08.752349: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:14:10.300768: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:14:11.416853: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:14:11.416867: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 17/17

Exporting split=test: 8 trajectories
2026-01-22 05:14:12.852599: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 8/8

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (12808, 25, 24)  Y_train: (12808, 6)
X_test : (4378, 25, 24)  Y_test : (4378, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:14:15.036673: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:14:15.060821: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (12808, 25, 24), Y_train = (12808, 6)
  X_test  = (4378, 25, 24),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:14:16.037871: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:16.042563: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:16.043476: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:16.045192: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:16.046006: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:16.046749: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:16.119697: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:16.120565: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:16.121334: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:16.122093: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:14:17.038177: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 36ms/step - loss: 0.5385 - val_loss: 2.1697
Epoch 2/30
41/41 - 0s - 3ms/step - loss: 0.3775 - val_loss: 2.2197
Epoch 3/30
41/41 - 0s - 3ms/step - loss: 0.3137 - val_loss: 2.1852
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.2815 - val_loss: 2.1713
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.2555 - val_loss: 2.1291
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.2428 - val_loss: 2.0567
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.2338 - val_loss: 2.0887
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.2255 - val_loss: 2.0426
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2186 - val_loss: 2.0490
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2131 - val_loss: 2.0583
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2098 - val_loss: 2.0801
Epoch 12/30
41/41 - 0s - 3ms/step - loss: 0.2034 - val_loss: 2.0738
Epoch 13/30
41/41 - 0s - 3ms/step - loss: 0.2033 - val_loss: 2.1163
Epoch 14/30
41/41 - 0s - 3ms/step - loss: 0.1995 - val_loss: 2.0956
Epoch 15/30
41/41 - 0s - 3ms/step - loss: 0.2024 - val_loss: 2.0679
Epoch 16/30
41/41 - 0s - 3ms/step - loss: 0.1931 - val_loss: 2.1069
Epoch 17/30
41/41 - 0s - 3ms/step - loss: 0.1891 - val_loss: 2.0895
Epoch 18/30
41/41 - 0s - 3ms/step - loss: 0.1869 - val_loss: 2.1126
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.3130
Per-joint RMSE: 0.8561 2.1878 0.6049 1.0659 0.9010 1.5846
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:14:20.945231: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:14:20.971245: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:14:21.812535: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:21.817220: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:21.818079: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:21.819734: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:21.820516: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:21.821249: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:21.903871: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:21.904812: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:21.905555: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:21.906288: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:14:22.201454: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.932365e+00  RMSE=1.390095e+00
  per-joint RMSE: 0.9619 2.3775 0.6241 1.0701 0.9153 1.6261
Residual LSTM:  MSE=1.724009e+00      RMSE=1.313015e+00
  per-joint RMSE: 0.8561 2.1878 0.6049 1.0659 0.9010 1.5846
Combined torque MSE=1.724009e+00     RMSE=1.313015e+00
  per-joint RMSE: 0.8561 2.1878 0.6049 1.0659 0.9010 1.5846
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (12808, 25, 6)  Y_train: (12808, 6)
X_test : (4378, 25, 6)  Y_test : (4378, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:14:24.060160: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:14:24.084220: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (12808, 25, 6), Y_train = (12808, 6)
  X_test  = (4378, 25, 6),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:14:25.044621: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:25.049203: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:25.050147: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:25.051707: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:25.052483: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:25.053213: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:25.134148: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:25.134991: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:25.135733: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:25.136462: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:14:26.058785: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 36ms/step - loss: 0.7496 - val_loss: 2.2425
Epoch 2/30
41/41 - 0s - 3ms/step - loss: 0.5128 - val_loss: 2.8153
Epoch 3/30
41/41 - 0s - 3ms/step - loss: 0.4278 - val_loss: 2.5349
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.3831 - val_loss: 2.6352
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.3588 - val_loss: 2.6975
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.3309 - val_loss: 2.6977
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.3136 - val_loss: 2.7335
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.2981 - val_loss: 2.7040
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2890 - val_loss: 2.6897
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2750 - val_loss: 2.7062
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2684 - val_loss: 2.6764
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.3972
Per-joint RMSE: 0.9779 2.3794 0.6976 1.1378 0.9268 1.5668
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:14:29.046198: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:14:29.070970: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:14:29.931097: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:29.936055: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:29.936856: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:29.938484: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:29.939281: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:29.940017: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:30.022918: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:30.023830: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:30.024584: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:30.025307: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:14:30.319771: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.932365e+00  RMSE=1.390095e+00
  per-joint RMSE: 0.9619 2.3775 0.6241 1.0701 0.9153 1.6261
Residual LSTM:  MSE=1.952204e+00      RMSE=1.397213e+00
  per-joint RMSE: 0.9779 2.3794 0.6976 1.1378 0.9268 1.5668
Combined torque MSE=1.952204e+00     RMSE=1.397213e+00
  per-joint RMSE: 0.9779 2.3794 0.6976 1.1378 0.9268 1.5668
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (12808, 25, 18)  Y_train: (12808, 6)
X_test : (4378, 25, 18)  Y_test : (4378, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:14:32.195526: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:14:32.219140: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (12808, 25, 18), Y_train = (12808, 6)
  X_test  = (4378, 25, 18),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:14:33.187021: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:33.191610: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:33.192397: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:33.194105: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:33.194890: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:33.195626: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:33.272914: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:33.273749: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:33.274490: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:33.275223: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:14:34.194143: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 36ms/step - loss: 0.5542 - val_loss: 2.0422
Epoch 2/30
41/41 - 0s - 3ms/step - loss: 0.4003 - val_loss: 2.1351
Epoch 3/30
41/41 - 0s - 3ms/step - loss: 0.3393 - val_loss: 2.1785
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.3053 - val_loss: 2.1956
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.2826 - val_loss: 2.1794
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.2617 - val_loss: 2.1863
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.2498 - val_loss: 2.1722
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.2385 - val_loss: 2.1545
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2271 - val_loss: 2.2027
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2227 - val_loss: 2.1860
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2186 - val_loss: 2.2437
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.3694
Per-joint RMSE: 0.9447 2.3322 0.6004 1.0508 0.9099 1.6210
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:14:37.201512: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:14:37.225793: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:14:38.080972: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:38.085675: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:38.086552: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:38.088283: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:38.089162: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:38.089908: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:38.169401: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:38.170242: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:38.171038: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:38.171854: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:14:38.467226: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.932365e+00  RMSE=1.390095e+00
  per-joint RMSE: 0.9619 2.3775 0.6241 1.0701 0.9153 1.6261
Residual LSTM:  MSE=1.875322e+00      RMSE=1.369424e+00
  per-joint RMSE: 0.9447 2.3322 0.6004 1.0508 0.9099 1.6210
Combined torque MSE=1.875322e+00     RMSE=1.369424e+00
  per-joint RMSE: 0.9447 2.3322 0.6004 1.0508 0.9099 1.6210
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (12808, 25, 18)  Y_train: (12808, 6)
X_test : (4378, 25, 18)  Y_test : (4378, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:14:40.350058: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:14:40.373600: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (12808, 25, 18), Y_train = (12808, 6)
  X_test  = (4378, 25, 18),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:14:41.340824: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:41.345377: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:41.346244: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:41.347886: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:41.348670: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:41.349403: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:41.419290: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:41.420125: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:41.420865: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:41.421591: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:14:42.309193: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 35ms/step - loss: 0.5448 - val_loss: 1.9399
Epoch 2/30
41/41 - 0s - 3ms/step - loss: 0.3840 - val_loss: 1.9790
Epoch 3/30
41/41 - 0s - 4ms/step - loss: 0.3163 - val_loss: 1.9307
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.2794 - val_loss: 1.9158
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.2569 - val_loss: 1.8838
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.2444 - val_loss: 1.9149
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.2362 - val_loss: 1.9552
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.2269 - val_loss: 1.9429
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2142 - val_loss: 1.9123
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2131 - val_loss: 1.9134
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2086 - val_loss: 1.8958
Epoch 12/30
41/41 - 0s - 3ms/step - loss: 0.2043 - val_loss: 1.9036
Epoch 13/30
41/41 - 0s - 3ms/step - loss: 0.2041 - val_loss: 1.9011
Epoch 14/30
41/41 - 0s - 3ms/step - loss: 0.1965 - val_loss: 1.9143
Epoch 15/30
41/41 - 0s - 3ms/step - loss: 0.1943 - val_loss: 1.9248
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.3213
Per-joint RMSE: 0.8690 2.2319 0.5684 1.0623 0.8976 1.5749
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:14:45.886743: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:14:45.911791: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:14:46.770348: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:46.775081: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:46.775996: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:46.777856: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:46.778763: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:46.779614: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:46.862737: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:46.863619: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:46.864399: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:46.865182: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:14:47.165675: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.932365e+00  RMSE=1.390095e+00
  per-joint RMSE: 0.9619 2.3775 0.6241 1.0701 0.9153 1.6261
Residual LSTM:  MSE=1.745718e+00      RMSE=1.321256e+00
  per-joint RMSE: 0.8690 2.2319 0.5684 1.0623 0.8976 1.5749
Combined torque MSE=1.745718e+00     RMSE=1.321256e+00
  per-joint RMSE: 0.8690 2.2319 0.5684 1.0623 0.8976 1.5749
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (12608, 50, 24)  Y_train: (12608, 6)
X_test : (4253, 50, 24)  Y_test : (4253, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:14:49.091982: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:14:49.115336: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (12608, 50, 24), Y_train = (12608, 6)
  X_test  = (4253, 50, 24),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:14:50.168685: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:50.173504: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:50.174462: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:50.176320: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:50.177118: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:50.177937: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:50.250348: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:50.251190: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:50.251929: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:50.252652: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:14:51.181093: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.5439 - val_loss: 1.4655
Epoch 2/30
40/40 - 0s - 5ms/step - loss: 0.3734 - val_loss: 1.4530
Epoch 3/30
40/40 - 0s - 5ms/step - loss: 0.3121 - val_loss: 1.4375
Epoch 4/30
40/40 - 0s - 5ms/step - loss: 0.2781 - val_loss: 1.3893
Epoch 5/30
40/40 - 0s - 4ms/step - loss: 0.2548 - val_loss: 1.3963
Epoch 6/30
40/40 - 0s - 5ms/step - loss: 0.2392 - val_loss: 1.3781
Epoch 7/30
40/40 - 0s - 4ms/step - loss: 0.2288 - val_loss: 1.3848
Epoch 8/30
40/40 - 0s - 5ms/step - loss: 0.2198 - val_loss: 1.3709
Epoch 9/30
40/40 - 0s - 5ms/step - loss: 0.2129 - val_loss: 1.3381
Epoch 10/30
40/40 - 0s - 4ms/step - loss: 0.2083 - val_loss: 1.3656
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2040 - val_loss: 1.3705
Epoch 12/30
40/40 - 0s - 4ms/step - loss: 0.1979 - val_loss: 1.3762
Epoch 13/30
40/40 - 0s - 4ms/step - loss: 0.1950 - val_loss: 1.3685
Epoch 14/30
40/40 - 0s - 4ms/step - loss: 0.1931 - val_loss: 1.3720
Epoch 15/30
40/40 - 0s - 4ms/step - loss: 0.1923 - val_loss: 1.3695
Epoch 16/30
40/40 - 0s - 4ms/step - loss: 0.1900 - val_loss: 1.3627
Epoch 17/30
40/40 - 0s - 4ms/step - loss: 0.1878 - val_loss: 1.3628
Epoch 18/30
40/40 - 0s - 4ms/step - loss: 0.1845 - val_loss: 1.3437
Epoch 19/30
40/40 - 0s - 4ms/step - loss: 0.1827 - val_loss: 1.3525
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2672
Per-joint RMSE: 0.8636 2.0925 0.5745 1.0515 0.8953 1.5077
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:14:56.201657: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:14:56.226087: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:14:57.066336: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:57.070988: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:57.071777: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:57.073509: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:57.074310: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:57.075048: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:57.149600: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:57.150502: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:57.151322: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:14:57.152053: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:14:57.449595: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.807900e+00  RMSE=1.344582e+00
  per-joint RMSE: 0.9549 2.2835 0.6206 1.0490 0.9075 1.5532
Residual LSTM:  MSE=1.605794e+00      RMSE=1.267199e+00
  per-joint RMSE: 0.8636 2.0925 0.5745 1.0515 0.8953 1.5077
Combined torque MSE=1.605794e+00     RMSE=1.267199e+00
  per-joint RMSE: 0.8636 2.0925 0.5745 1.0515 0.8953 1.5077
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (12608, 50, 6)  Y_train: (12608, 6)
X_test : (4253, 50, 6)  Y_test : (4253, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:14:59.327492: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:14:59.351529: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (12608, 50, 6), Y_train = (12608, 6)
  X_test  = (4253, 50, 6),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:15:00.315964: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:00.320459: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:00.321247: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:00.322845: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:00.323636: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:00.324370: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:00.398850: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:00.399754: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:00.400540: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:00.401355: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:15:01.310596: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.7144 - val_loss: 1.5768
Epoch 2/30
40/40 - 0s - 4ms/step - loss: 0.4578 - val_loss: 2.0495
Epoch 3/30
40/40 - 0s - 4ms/step - loss: 0.3959 - val_loss: 1.9596
Epoch 4/30
40/40 - 0s - 4ms/step - loss: 0.3600 - val_loss: 1.9502
Epoch 5/30
40/40 - 0s - 4ms/step - loss: 0.3344 - val_loss: 1.9509
Epoch 6/30
40/40 - 0s - 4ms/step - loss: 0.3130 - val_loss: 1.9056
Epoch 7/30
40/40 - 0s - 4ms/step - loss: 0.2908 - val_loss: 1.8859
Epoch 8/30
40/40 - 0s - 4ms/step - loss: 0.2723 - val_loss: 1.8072
Epoch 9/30
40/40 - 0s - 4ms/step - loss: 0.2613 - val_loss: 1.7574
Epoch 10/30
40/40 - 0s - 4ms/step - loss: 0.2532 - val_loss: 1.7158
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2472 - val_loss: 1.6974
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.3752
Per-joint RMSE: 0.9662 2.2894 0.7058 1.0821 0.9143 1.6331
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:15:04.849024: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:15:04.872986: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:15:05.718823: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:05.723441: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:05.724314: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:05.726078: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:05.726951: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:05.727746: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:05.808823: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:05.809814: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:05.810557: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:05.811292: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:15:06.104634: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.807900e+00  RMSE=1.344582e+00
  per-joint RMSE: 0.9549 2.2835 0.6206 1.0490 0.9075 1.5532
Residual LSTM:  MSE=1.891125e+00      RMSE=1.375182e+00
  per-joint RMSE: 0.9662 2.2894 0.7058 1.0821 0.9143 1.6331
Combined torque MSE=1.891125e+00     RMSE=1.375182e+00
  per-joint RMSE: 0.9662 2.2894 0.7058 1.0821 0.9143 1.6331
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (12608, 50, 18)  Y_train: (12608, 6)
X_test : (4253, 50, 18)  Y_test : (4253, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:15:08.005309: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:15:08.029700: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (12608, 50, 18), Y_train = (12608, 6)
  X_test  = (4253, 50, 18),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:15:09.037896: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:09.042504: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:09.043455: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:09.045143: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:09.045933: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:09.046676: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:09.124795: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:09.125708: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:09.126451: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:09.127272: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:15:10.043275: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.5648 - val_loss: 1.4762
Epoch 2/30
40/40 - 0s - 5ms/step - loss: 0.4002 - val_loss: 1.5056
Epoch 3/30
40/40 - 0s - 4ms/step - loss: 0.3377 - val_loss: 1.5627
Epoch 4/30
40/40 - 0s - 4ms/step - loss: 0.3088 - val_loss: 1.5429
Epoch 5/30
40/40 - 0s - 4ms/step - loss: 0.2837 - val_loss: 1.5572
Epoch 6/30
40/40 - 0s - 4ms/step - loss: 0.2650 - val_loss: 1.4866
Epoch 7/30
40/40 - 0s - 4ms/step - loss: 0.2515 - val_loss: 1.5059
Epoch 8/30
40/40 - 0s - 4ms/step - loss: 0.2374 - val_loss: 1.4834
Epoch 9/30
40/40 - 0s - 4ms/step - loss: 0.2290 - val_loss: 1.4864
Epoch 10/30
40/40 - 0s - 4ms/step - loss: 0.2190 - val_loss: 1.5024
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2143 - val_loss: 1.4800
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.3354
Per-joint RMSE: 0.9439 2.2507 0.6369 1.0511 0.9053 1.5536
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:15:13.600167: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:15:13.625030: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:15:14.479284: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:14.484012: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:14.484878: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:14.486704: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:14.487492: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:14.488229: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:14.562045: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:14.562951: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:14.563772: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:14.564495: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:15:14.862627: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.807900e+00  RMSE=1.344582e+00
  per-joint RMSE: 0.9549 2.2835 0.6206 1.0490 0.9075 1.5532
Residual LSTM:  MSE=1.783390e+00      RMSE=1.335436e+00
  per-joint RMSE: 0.9439 2.2507 0.6369 1.0511 0.9053 1.5536
Combined torque MSE=1.783390e+00     RMSE=1.335436e+00
  per-joint RMSE: 0.9439 2.2507 0.6369 1.0511 0.9053 1.5536
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (12608, 50, 18)  Y_train: (12608, 6)
X_test : (4253, 50, 18)  Y_test : (4253, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:15:16.764066: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:15:16.787865: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (12608, 50, 18), Y_train = (12608, 6)
  X_test  = (4253, 50, 18),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:15:17.803822: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:17.808346: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:17.809140: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:17.810638: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:17.811416: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:17.812155: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:17.885518: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:17.886505: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:17.887241: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:17.887976: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:15:18.824278: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.5418 - val_loss: 1.4512
Epoch 2/30
40/40 - 0s - 4ms/step - loss: 0.3736 - val_loss: 1.4699
Epoch 3/30
40/40 - 0s - 5ms/step - loss: 0.3131 - val_loss: 1.4380
Epoch 4/30
40/40 - 0s - 5ms/step - loss: 0.2820 - val_loss: 1.3927
Epoch 5/30
40/40 - 0s - 5ms/step - loss: 0.2569 - val_loss: 1.3744
Epoch 6/30
40/40 - 0s - 5ms/step - loss: 0.2416 - val_loss: 1.3449
Epoch 7/30
40/40 - 0s - 4ms/step - loss: 0.2294 - val_loss: 1.3573
Epoch 8/30
40/40 - 0s - 4ms/step - loss: 0.2202 - val_loss: 1.3574
Epoch 9/30
40/40 - 0s - 4ms/step - loss: 0.2134 - val_loss: 1.4162
Epoch 10/30
40/40 - 0s - 4ms/step - loss: 0.2091 - val_loss: 1.3690
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2044 - val_loss: 1.4001
Epoch 12/30
40/40 - 0s - 4ms/step - loss: 0.2003 - val_loss: 1.3928
Epoch 13/30
40/40 - 0s - 4ms/step - loss: 0.1966 - val_loss: 1.4308
Epoch 14/30
40/40 - 0s - 4ms/step - loss: 0.1943 - val_loss: 1.4207
Epoch 15/30
40/40 - 0s - 4ms/step - loss: 0.1917 - val_loss: 1.4131
Epoch 16/30
40/40 - 0s - 4ms/step - loss: 0.1889 - val_loss: 1.4226
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2664
Per-joint RMSE: 0.8370 2.1005 0.5669 1.0382 0.9096 1.5112
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:15:23.314841: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:15:23.339200: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:15:24.190603: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:24.195251: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:24.196044: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:24.197772: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:24.198552: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:24.199283: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:24.277067: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:24.277902: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:24.278647: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:24.279378: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:15:24.580144: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.807900e+00  RMSE=1.344582e+00
  per-joint RMSE: 0.9549 2.2835 0.6206 1.0490 0.9075 1.5532
Residual LSTM:  MSE=1.603778e+00      RMSE=1.266404e+00
  per-joint RMSE: 0.8370 2.1005 0.5669 1.0382 0.9096 1.5112
Combined torque MSE=1.603778e+00     RMSE=1.266404e+00
  per-joint RMSE: 0.8370 2.1005 0.5669 1.0382 0.9096 1.5112
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=1                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz -t structured -s 1 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x7433897b01f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz
   dt ≈ 0.022376492089782287
  dof = 6
  Train trajectories = 17
  Test trajectories  = 8
  Train samples = 13027
  Test samples  = 4507
################################################

2026-01-22 05:15:28.823857: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150 | type=structured | dof=6
################################################
2026-01-22 05:15:31.899172: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:31.899208: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:31.899215: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:31.899241: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:31.899247: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:31.899261: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:31.899299: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:31.899304: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:31.899320: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:31.899324: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   4.8s, Loss=2.88e+01, Inv=2.88e+01, For=9.02e+02, Power=4.23e+00
  [eval] test_mse=8.967e+00  (n=4507)
Epoch 00050: Time=   7.9s, Loss=1.74e+00, Inv=1.74e+00, For=8.08e+01, Power=8.02e-01
Epoch 00100: Time=   9.6s, Loss=1.29e+00, Inv=1.29e+00, For=8.96e+01, Power=5.32e-01
Epoch 00150: Time=  11.3s, Loss=1.14e+00, Inv=1.14e+00, For=1.26e+02, Power=4.59e-01
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
Torque MSE  = 3.316e+00
Torque RMSE = 1.821e+00
Per-joint MSE : 1.426e+00 4.146e+00 4.243e-01 4.625e+00 4.718e+00 4.559e+00
Per-joint RMSE: 1.194e+00 2.036e+00 6.514e-01 2.151e+00 2.172e+00 2.135e+00
Comp Time per Sample = 7.511e-08s / 13313128.6Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
Detected n_dof=6 (seed=1)
2026-01-22 05:15:45.280119: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 17 trajectories
2026-01-22 05:15:46.593981: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:46.593994: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:48.140125: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:49.265009: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:15:49.265024: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 17/17

Exporting split=test: 8 trajectories
2026-01-22 05:15:50.719877: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 8/8

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (12808, 25, 24)  Y_train: (12808, 6)
X_test : (4378, 25, 24)  Y_test : (4378, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:15:52.796877: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:15:52.820555: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (12808, 25, 24), Y_train = (12808, 6)
  X_test  = (4378, 25, 24),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:15:53.793934: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:53.798596: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:53.799422: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:53.801094: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:53.801906: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:53.802670: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:53.875025: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:53.875884: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:53.876647: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:53.877414: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:15:54.770251: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 36ms/step - loss: 0.5308 - val_loss: 1.8561
Epoch 2/30
41/41 - 0s - 3ms/step - loss: 0.3709 - val_loss: 1.8566
Epoch 3/30
41/41 - 0s - 3ms/step - loss: 0.3136 - val_loss: 1.8757
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.2815 - val_loss: 1.9135
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.2569 - val_loss: 1.9076
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.2453 - val_loss: 1.8511
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.2343 - val_loss: 1.8205
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.2284 - val_loss: 1.7934
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2175 - val_loss: 1.7768
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2125 - val_loss: 1.8764
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2115 - val_loss: 1.8635
Epoch 12/30
41/41 - 0s - 3ms/step - loss: 0.2063 - val_loss: 1.8432
Epoch 13/30
41/41 - 0s - 3ms/step - loss: 0.2017 - val_loss: 1.9116
Epoch 14/30
41/41 - 0s - 3ms/step - loss: 0.1974 - val_loss: 1.8869
Epoch 15/30
41/41 - 0s - 3ms/step - loss: 0.1953 - val_loss: 1.9067
Epoch 16/30
41/41 - 0s - 3ms/step - loss: 0.1901 - val_loss: 1.9237
Epoch 17/30
41/41 - 0s - 3ms/step - loss: 0.1899 - val_loss: 1.9096
Epoch 18/30
41/41 - 0s - 3ms/step - loss: 0.1883 - val_loss: 1.9509
Epoch 19/30
41/41 - 0s - 3ms/step - loss: 0.1868 - val_loss: 1.8919
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.8206
Per-joint RMSE: 1.1583 2.0444 0.6476 2.1506 2.1958 2.1214
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:15:58.794455: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:15:58.818464: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:15:59.653671: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:59.658405: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:59.659189: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:59.660887: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:59.661733: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:59.662517: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:59.743687: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:59.744551: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:59.745283: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:15:59.746008: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:16:00.042030: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=3.397778e+00  RMSE=1.843306e+00
  per-joint RMSE: 1.2030 2.0594 0.6585 2.1787 2.1996 2.1632
Residual LSTM:  MSE=3.314639e+00      RMSE=1.820615e+00
  per-joint RMSE: 1.1583 2.0444 0.6476 2.1506 2.1958 2.1214
Combined torque MSE=3.314639e+00     RMSE=1.820615e+00
  per-joint RMSE: 1.1583 2.0444 0.6476 2.1506 2.1958 2.1214
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (12808, 25, 6)  Y_train: (12808, 6)
X_test : (4378, 25, 6)  Y_test : (4378, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:01.893005: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:01.916962: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (12808, 25, 6), Y_train = (12808, 6)
  X_test  = (4378, 25, 6),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:16:02.861966: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:02.866789: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:02.867595: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:02.869153: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:02.869945: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:02.870741: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:02.949555: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:02.950393: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:02.951148: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:02.951883: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:16:03.832881: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 35ms/step - loss: 0.7550 - val_loss: 2.0458
Epoch 2/30
41/41 - 0s - 3ms/step - loss: 0.5240 - val_loss: 2.3816
Epoch 3/30
41/41 - 0s - 3ms/step - loss: 0.4319 - val_loss: 2.3463
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.3846 - val_loss: 2.3652
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.3605 - val_loss: 2.2907
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.3348 - val_loss: 2.4397
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.3150 - val_loss: 2.2842
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.2948 - val_loss: 2.3666
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2834 - val_loss: 2.2917
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2724 - val_loss: 2.2759
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2708 - val_loss: 2.3113
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.8354
Per-joint RMSE: 1.2145 1.9715 0.6617 2.2067 2.2180 2.1500
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:06.828222: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:06.852461: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:16:07.690193: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:07.694772: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:07.695632: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:07.697307: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:07.698091: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:07.698830: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:07.779748: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:07.780574: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:07.781306: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:07.782029: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:16:08.077143: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=3.397778e+00  RMSE=1.843306e+00
  per-joint RMSE: 1.2030 2.0594 0.6585 2.1787 2.1996 2.1632
Residual LSTM:  MSE=3.368540e+00      RMSE=1.835358e+00
  per-joint RMSE: 1.2145 1.9715 0.6617 2.2067 2.2180 2.1500
Combined torque MSE=3.368540e+00     RMSE=1.835358e+00
  per-joint RMSE: 1.2145 1.9715 0.6617 2.2067 2.2180 2.1500
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (12808, 25, 18)  Y_train: (12808, 6)
X_test : (4378, 25, 18)  Y_test : (4378, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:09.961509: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:09.985802: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (12808, 25, 18), Y_train = (12808, 6)
  X_test  = (4378, 25, 18),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:16:10.949823: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:10.954341: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:10.955132: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:10.956740: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:10.957528: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:10.958264: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:11.030348: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:11.031185: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:11.031937: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:11.032684: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:16:11.948514: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 35ms/step - loss: 0.5472 - val_loss: 1.9900
Epoch 2/30
41/41 - 0s - 3ms/step - loss: 0.3977 - val_loss: 2.1629
Epoch 3/30
41/41 - 0s - 3ms/step - loss: 0.3366 - val_loss: 2.3563
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.3072 - val_loss: 2.3756
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.2875 - val_loss: 2.5231
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.2703 - val_loss: 2.4797
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.2570 - val_loss: 2.4907
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.2523 - val_loss: 2.4892
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2360 - val_loss: 2.4086
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2329 - val_loss: 2.4340
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2275 - val_loss: 2.4132
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.8339
Per-joint RMSE: 1.1958 2.0527 0.6553 2.1601 2.1990 2.1460
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:14.950605: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:14.975078: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:16:15.825367: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:15.830117: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:15.830900: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:15.832534: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:15.833320: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:15.834043: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:15.908090: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:15.908928: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:15.909675: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:15.910397: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8948 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:16:16.209258: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=3.397778e+00  RMSE=1.843306e+00
  per-joint RMSE: 1.2030 2.0594 0.6585 2.1787 2.1996 2.1632
Residual LSTM:  MSE=3.363304e+00      RMSE=1.833931e+00
  per-joint RMSE: 1.1958 2.0527 0.6553 2.1601 2.1990 2.1460
Combined torque MSE=3.363304e+00     RMSE=1.833931e+00
  per-joint RMSE: 1.1958 2.0527 0.6553 2.1601 2.1990 2.1460
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (12808, 25, 18)  Y_train: (12808, 6)
X_test : (4378, 25, 18)  Y_test : (4378, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:18.114766: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:18.138583: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (12808, 25, 18), Y_train = (12808, 6)
  X_test  = (4378, 25, 18),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:16:19.108792: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:19.113380: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:19.114167: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:19.115695: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:19.116476: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:19.117210: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:19.195141: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:19.195993: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:19.196732: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:19.197460: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:16:20.091373: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 36ms/step - loss: 0.5363 - val_loss: 1.9348
Epoch 2/30
41/41 - 0s - 3ms/step - loss: 0.3730 - val_loss: 1.9261
Epoch 3/30
41/41 - 0s - 3ms/step - loss: 0.3106 - val_loss: 1.8859
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.2768 - val_loss: 1.8543
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.2609 - val_loss: 1.8086
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.2464 - val_loss: 1.7945
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.2370 - val_loss: 1.8105
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.2291 - val_loss: 1.8604
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2228 - val_loss: 1.8306
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2143 - val_loss: 1.8646
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2123 - val_loss: 1.8711
Epoch 12/30
41/41 - 0s - 3ms/step - loss: 0.2090 - val_loss: 1.8647
Epoch 13/30
41/41 - 0s - 3ms/step - loss: 0.2080 - val_loss: 1.8821
Epoch 14/30
41/41 - 0s - 3ms/step - loss: 0.1997 - val_loss: 1.8520
Epoch 15/30
41/41 - 0s - 3ms/step - loss: 0.1968 - val_loss: 1.8488
Epoch 16/30
41/41 - 0s - 3ms/step - loss: 0.1972 - val_loss: 1.8742
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.8206
Per-joint RMSE: 1.1678 2.0399 0.6521 2.1476 2.1907 2.1276
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:23.761744: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:23.785984: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:16:24.636803: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:24.641523: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:24.642330: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:24.646100: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:24.646904: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:24.647638: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:24.724683: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:24.725634: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:24.726508: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:24.727240: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8948 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:16:25.023615: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=3.397778e+00  RMSE=1.843306e+00
  per-joint RMSE: 1.2030 2.0594 0.6585 2.1787 2.1996 2.1632
Residual LSTM:  MSE=3.314730e+00      RMSE=1.820640e+00
  per-joint RMSE: 1.1678 2.0399 0.6521 2.1476 2.1907 2.1276
Combined torque MSE=3.314730e+00     RMSE=1.820640e+00
  per-joint RMSE: 1.1678 2.0399 0.6521 2.1476 2.1907 2.1276
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (12608, 50, 24)  Y_train: (12608, 6)
X_test : (4253, 50, 24)  Y_test : (4253, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:26.944909: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:26.968874: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (12608, 50, 24), Y_train = (12608, 6)
  X_test  = (4253, 50, 24),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:16:28.003667: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:28.008419: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:28.009216: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:28.010780: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:28.011561: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:28.012301: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:28.084627: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:28.085460: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:28.086299: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:28.087026: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:16:29.039891: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.5430 - val_loss: 1.4143
Epoch 2/30
40/40 - 0s - 5ms/step - loss: 0.3736 - val_loss: 1.4030
Epoch 3/30
40/40 - 0s - 5ms/step - loss: 0.3139 - val_loss: 1.3927
Epoch 4/30
40/40 - 0s - 5ms/step - loss: 0.2822 - val_loss: 1.3878
Epoch 5/30
40/40 - 0s - 5ms/step - loss: 0.2583 - val_loss: 1.3411
Epoch 6/30
40/40 - 0s - 5ms/step - loss: 0.2444 - val_loss: 1.3034
Epoch 7/30
40/40 - 0s - 4ms/step - loss: 0.2326 - val_loss: 1.3155
Epoch 8/30
40/40 - 0s - 5ms/step - loss: 0.2229 - val_loss: 1.3012
Epoch 9/30
40/40 - 0s - 5ms/step - loss: 0.2167 - val_loss: 1.2895
Epoch 10/30
40/40 - 0s - 5ms/step - loss: 0.2119 - val_loss: 1.2497
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2057 - val_loss: 1.2654
Epoch 12/30
40/40 - 0s - 4ms/step - loss: 0.2012 - val_loss: 1.2566
Epoch 13/30
40/40 - 0s - 5ms/step - loss: 0.1992 - val_loss: 1.2304
Epoch 14/30
40/40 - 0s - 4ms/step - loss: 0.1953 - val_loss: 1.2570
Epoch 15/30
40/40 - 0s - 4ms/step - loss: 0.1915 - val_loss: 1.2387
Epoch 16/30
40/40 - 0s - 5ms/step - loss: 0.1893 - val_loss: 1.2150
Epoch 17/30
40/40 - 0s - 4ms/step - loss: 0.1879 - val_loss: 1.2196
Epoch 18/30
40/40 - 0s - 4ms/step - loss: 0.1862 - val_loss: 1.2221
Epoch 19/30
40/40 - 0s - 4ms/step - loss: 0.1832 - val_loss: 1.2216
Epoch 20/30
40/40 - 0s - 4ms/step - loss: 0.1815 - val_loss: 1.2164
Epoch 21/30
40/40 - 0s - 5ms/step - loss: 0.1800 - val_loss: 1.2114
Epoch 22/30
40/40 - 0s - 4ms/step - loss: 0.1758 - val_loss: 1.2143
Epoch 23/30
40/40 - 0s - 6ms/step - loss: 0.1753 - val_loss: 1.1881
Epoch 24/30
40/40 - 0s - 4ms/step - loss: 0.1751 - val_loss: 1.1977
Epoch 25/30
40/40 - 0s - 4ms/step - loss: 0.1725 - val_loss: 1.1932
Epoch 26/30
40/40 - 0s - 4ms/step - loss: 0.1722 - val_loss: 1.2066
Epoch 27/30
40/40 - 0s - 5ms/step - loss: 0.1713 - val_loss: 1.1834
Epoch 28/30
40/40 - 0s - 4ms/step - loss: 0.1692 - val_loss: 1.1999
Epoch 29/30
40/40 - 0s - 4ms/step - loss: 0.1692 - val_loss: 1.1851
Epoch 30/30
40/40 - 0s - 4ms/step - loss: 0.1665 - val_loss: 1.1839
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.7721
Per-joint RMSE: 1.1299 1.9646 0.6535 2.0876 2.1466 2.0766
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:36.140755: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:36.165900: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:16:37.021422: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:37.026102: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:37.026902: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:37.028596: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:37.029387: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:37.030205: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:37.109170: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:37.110009: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:37.110849: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:37.111589: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:16:37.408679: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=3.223605e+00  RMSE=1.795440e+00
  per-joint RMSE: 1.1600 1.9846 0.6475 2.1105 2.1542 2.1315
Residual LSTM:  MSE=3.140240e+00      RMSE=1.772072e+00
  per-joint RMSE: 1.1299 1.9646 0.6535 2.0876 2.1466 2.0766
Combined torque MSE=3.140240e+00     RMSE=1.772072e+00
  per-joint RMSE: 1.1299 1.9646 0.6535 2.0876 2.1466 2.0766
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (12608, 50, 6)  Y_train: (12608, 6)
X_test : (4253, 50, 6)  Y_test : (4253, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:39.286656: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:39.310451: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (12608, 50, 6), Y_train = (12608, 6)
  X_test  = (4253, 50, 6),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:16:40.264598: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:40.269398: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:40.270188: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:40.271863: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:40.272643: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:40.273380: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:40.348030: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:40.348868: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:40.349614: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:40.350348: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:16:41.279401: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.7175 - val_loss: 1.5960
Epoch 2/30
40/40 - 0s - 4ms/step - loss: 0.4658 - val_loss: 1.8628
Epoch 3/30
40/40 - 0s - 4ms/step - loss: 0.3988 - val_loss: 1.8357
Epoch 4/30
40/40 - 0s - 4ms/step - loss: 0.3596 - val_loss: 1.8400
Epoch 5/30
40/40 - 0s - 4ms/step - loss: 0.3313 - val_loss: 1.8155
Epoch 6/30
40/40 - 0s - 4ms/step - loss: 0.3066 - val_loss: 1.8051
Epoch 7/30
40/40 - 0s - 4ms/step - loss: 0.2913 - val_loss: 1.7805
Epoch 8/30
40/40 - 0s - 4ms/step - loss: 0.2781 - val_loss: 1.7607
Epoch 9/30
40/40 - 0s - 4ms/step - loss: 0.2656 - val_loss: 1.7244
Epoch 10/30
40/40 - 0s - 4ms/step - loss: 0.2592 - val_loss: 1.6825
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2503 - val_loss: 1.6766
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.8065
Per-joint RMSE: 1.1833 1.9154 0.6589 2.1158 2.1642 2.2174
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:44.789734: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:44.814457: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:16:45.667513: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:45.672244: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:45.673037: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:45.674924: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:45.675724: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:45.676463: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:45.757268: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:45.758106: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:45.758847: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:45.759669: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:16:46.052569: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=3.223605e+00  RMSE=1.795440e+00
  per-joint RMSE: 1.1600 1.9846 0.6475 2.1105 2.1542 2.1315
Residual LSTM:  MSE=3.263318e+00      RMSE=1.806466e+00
  per-joint RMSE: 1.1833 1.9154 0.6589 2.1158 2.1642 2.2174
Combined torque MSE=3.263318e+00     RMSE=1.806466e+00
  per-joint RMSE: 1.1833 1.9154 0.6589 2.1158 2.1642 2.2174
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (12608, 50, 18)  Y_train: (12608, 6)
X_test : (4253, 50, 18)  Y_test : (4253, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:47.934342: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:47.957924: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (12608, 50, 18), Y_train = (12608, 6)
  X_test  = (4253, 50, 18),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:16:48.974434: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:48.979257: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:48.980047: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:48.981679: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:48.982468: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:48.983201: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:49.056279: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:49.057119: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:49.057878: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:49.058612: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:16:49.974375: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.5422 - val_loss: 1.5392
Epoch 2/30
40/40 - 0s - 5ms/step - loss: 0.3920 - val_loss: 1.4787
Epoch 3/30
40/40 - 0s - 4ms/step - loss: 0.3340 - val_loss: 1.5201
Epoch 4/30
40/40 - 0s - 4ms/step - loss: 0.3036 - val_loss: 1.5346
Epoch 5/30
40/40 - 0s - 5ms/step - loss: 0.2806 - val_loss: 1.4495
Epoch 6/30
40/40 - 0s - 4ms/step - loss: 0.2625 - val_loss: 1.4680
Epoch 7/30
40/40 - 0s - 4ms/step - loss: 0.2479 - val_loss: 1.4739
Epoch 8/30
40/40 - 0s - 4ms/step - loss: 0.2387 - val_loss: 1.4505
Epoch 9/30
40/40 - 0s - 4ms/step - loss: 0.2309 - val_loss: 1.4695
Epoch 10/30
40/40 - 0s - 4ms/step - loss: 0.2218 - val_loss: 1.4891
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2147 - val_loss: 1.4431
Epoch 12/30
40/40 - 0s - 5ms/step - loss: 0.2119 - val_loss: 1.3843
Epoch 13/30
40/40 - 0s - 4ms/step - loss: 0.2058 - val_loss: 1.3887
Epoch 14/30
40/40 - 0s - 4ms/step - loss: 0.2039 - val_loss: 1.3883
Epoch 15/30
40/40 - 0s - 4ms/step - loss: 0.2005 - val_loss: 1.3919
Epoch 16/30
40/40 - 0s - 4ms/step - loss: 0.1968 - val_loss: 1.3844
Epoch 17/30
40/40 - 0s - 4ms/step - loss: 0.1951 - val_loss: 1.3892
Epoch 18/30
40/40 - 0s - 4ms/step - loss: 0.1942 - val_loss: 1.4336
Epoch 19/30
40/40 - 0s - 4ms/step - loss: 0.1930 - val_loss: 1.4562
Epoch 20/30
40/40 - 0s - 4ms/step - loss: 0.1929 - val_loss: 1.4387
Epoch 21/30
40/40 - 0s - 4ms/step - loss: 0.1886 - val_loss: 1.4555
Epoch 22/30
40/40 - 0s - 4ms/step - loss: 0.1871 - val_loss: 1.4428
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.7822
Per-joint RMSE: 1.1408 1.9908 0.6524 2.0830 2.1522 2.0970
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:55.474624: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:55.498752: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:16:56.354643: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:56.359277: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:56.360142: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:56.361814: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:56.362603: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:56.363341: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:56.442489: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:56.443328: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:56.444159: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:56.444888: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:16:56.750020: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=3.223605e+00  RMSE=1.795440e+00
  per-joint RMSE: 1.1600 1.9846 0.6475 2.1105 2.1542 2.1315
Residual LSTM:  MSE=3.176378e+00      RMSE=1.782240e+00
  per-joint RMSE: 1.1408 1.9908 0.6524 2.0830 2.1522 2.0970
Combined torque MSE=3.176378e+00     RMSE=1.782240e+00
  per-joint RMSE: 1.1408 1.9908 0.6524 2.0830 2.1522 2.0970
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (12608, 50, 18)  Y_train: (12608, 6)
X_test : (4253, 50, 18)  Y_test : (4253, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:16:58.677187: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:16:58.700860: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (12608, 50, 18), Y_train = (12608, 6)
  X_test  = (4253, 50, 18),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:16:59.713849: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:59.718472: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:59.719280: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:59.720786: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:59.721587: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:59.722404: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:59.796349: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:59.797188: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:59.797926: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:16:59.798653: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:17:00.744034: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.5469 - val_loss: 1.4452
Epoch 2/30
40/40 - 0s - 4ms/step - loss: 0.3700 - val_loss: 1.4557
Epoch 3/30
40/40 - 0s - 5ms/step - loss: 0.3131 - val_loss: 1.3779
Epoch 4/30
40/40 - 0s - 5ms/step - loss: 0.2813 - val_loss: 1.3211
Epoch 5/30
40/40 - 0s - 4ms/step - loss: 0.2610 - val_loss: 1.3279
Epoch 6/30
40/40 - 0s - 4ms/step - loss: 0.2469 - val_loss: 1.3535
Epoch 7/30
40/40 - 0s - 4ms/step - loss: 0.2337 - val_loss: 1.3453
Epoch 8/30
40/40 - 0s - 4ms/step - loss: 0.2241 - val_loss: 1.3429
Epoch 9/30
40/40 - 0s - 4ms/step - loss: 0.2178 - val_loss: 1.3282
Epoch 10/30
40/40 - 0s - 4ms/step - loss: 0.2141 - val_loss: 1.3594
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2101 - val_loss: 1.3223
Epoch 12/30
40/40 - 0s - 4ms/step - loss: 0.2039 - val_loss: 1.3230
Epoch 13/30
40/40 - 0s - 5ms/step - loss: 0.2000 - val_loss: 1.3198
Epoch 14/30
40/40 - 0s - 4ms/step - loss: 0.1970 - val_loss: 1.3217
Epoch 15/30
40/40 - 0s - 4ms/step - loss: 0.1947 - val_loss: 1.3382
Epoch 16/30
40/40 - 0s - 4ms/step - loss: 0.1914 - val_loss: 1.3530
Epoch 17/30
40/40 - 0s - 4ms/step - loss: 0.1887 - val_loss: 1.3776
Epoch 18/30
40/40 - 0s - 4ms/step - loss: 0.1859 - val_loss: 1.3554
Epoch 19/30
40/40 - 0s - 4ms/step - loss: 0.1846 - val_loss: 1.3534
Epoch 20/30
40/40 - 0s - 4ms/step - loss: 0.1812 - val_loss: 1.3713
Epoch 21/30
40/40 - 0s - 4ms/step - loss: 0.1794 - val_loss: 1.3811
Epoch 22/30
40/40 - 0s - 4ms/step - loss: 0.1791 - val_loss: 1.3951
Epoch 23/30
40/40 - 0s - 4ms/step - loss: 0.1763 - val_loss: 1.3748
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.7670
Per-joint RMSE: 1.1284 1.9525 0.6485 2.0871 2.1458 2.0658
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:17:06.418293: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:17:06.442604: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:17:07.296502: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:07.301093: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:07.301887: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:07.303630: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:07.304431: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:07.305180: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:07.384495: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:07.385335: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:07.386087: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:07.386825: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:17:07.686293: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=3.223605e+00  RMSE=1.795440e+00
  per-joint RMSE: 1.1600 1.9846 0.6475 2.1105 2.1542 2.1315
Residual LSTM:  MSE=3.122364e+00      RMSE=1.767021e+00
  per-joint RMSE: 1.1284 1.9525 0.6485 2.0871 2.1458 2.0658
Combined torque MSE=3.122363e+00     RMSE=1.767021e+00
  per-joint RMSE: 1.1284 1.9525 0.6485 2.0871 2.1458 2.0658
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=2                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz -t structured -s 2 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x75e16a0201f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz
   dt ≈ 0.022376492089782287
  dof = 6
  Train trajectories = 17
  Test trajectories  = 8
  Train samples = 13027
  Test samples  = 4507
################################################

2026-01-22 05:17:11.919544: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150 | type=structured | dof=6
################################################
2026-01-22 05:17:15.005548: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:15.005590: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:15.005596: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:15.005624: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:15.005629: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:15.005644: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:15.005680: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:15.005687: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:15.005702: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:15.005707: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   4.9s, Loss=2.10e+01, Inv=2.10e+01, For=3.24e+02, Power=3.43e+00
  [eval] test_mse=6.129e+00  (n=4507)
Epoch 00050: Time=   8.3s, Loss=1.62e+00, Inv=1.62e+00, For=7.56e+01, Power=7.31e-01
Epoch 00100: Time=   9.9s, Loss=1.24e+00, Inv=1.24e+00, For=7.96e+01, Power=5.17e-01
Epoch 00150: Time=  11.5s, Loss=1.11e+00, Inv=1.11e+00, For=9.91e+01, Power=4.43e-01
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
Torque MSE  = 1.053e+00
Torque RMSE = 1.026e+00
Per-joint MSE : 6.882e-01 1.888e+00 4.212e-01 4.526e-01 1.714e+00 1.155e+00
Per-joint RMSE: 8.296e-01 1.374e+00 6.490e-01 6.728e-01 1.309e+00 1.075e+00
Comp Time per Sample = 6.621e-08s / 15103988.6Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed0_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
Detected n_dof=6 (seed=2)
2026-01-22 05:17:28.600199: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 17 trajectories
2026-01-22 05:17:29.922776: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:29.922789: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:31.511924: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:32.755811: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:17:32.755825: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 17/17

Exporting split=test: 8 trajectories
2026-01-22 05:17:34.291600: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 8/8

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (12808, 25, 24)  Y_train: (12808, 6)
X_test : (4378, 25, 24)  Y_test : (4378, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:17:36.399077: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:17:36.423160: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (12808, 25, 24), Y_train = (12808, 6)
  X_test  = (4378, 25, 24),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:17:37.409267: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:37.413944: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:37.414854: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:37.416476: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:37.417299: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:37.418074: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:37.500315: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:37.501205: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:37.501997: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:37.502882: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:17:38.408533: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 35ms/step - loss: 0.5355 - val_loss: 1.8590
Epoch 2/30
41/41 - 0s - 3ms/step - loss: 0.3855 - val_loss: 1.8895
Epoch 3/30
41/41 - 0s - 3ms/step - loss: 0.3243 - val_loss: 1.8520
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.2952 - val_loss: 1.8294
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.2725 - val_loss: 1.8403
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.2632 - val_loss: 1.8047
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.2514 - val_loss: 1.8123
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.2444 - val_loss: 1.7537
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2363 - val_loss: 1.8068
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2261 - val_loss: 1.7650
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2262 - val_loss: 1.7862
Epoch 12/30
41/41 - 0s - 3ms/step - loss: 0.2139 - val_loss: 1.7789
Epoch 13/30
41/41 - 0s - 3ms/step - loss: 0.2122 - val_loss: 1.8317
Epoch 14/30
41/41 - 0s - 3ms/step - loss: 0.2118 - val_loss: 1.8005
Epoch 15/30
41/41 - 0s - 3ms/step - loss: 0.2069 - val_loss: 1.7967
Epoch 16/30
41/41 - 0s - 3ms/step - loss: 0.2031 - val_loss: 1.7604
Epoch 17/30
41/41 - 0s - 3ms/step - loss: 0.2034 - val_loss: 1.8247
Epoch 18/30
41/41 - 0s - 3ms/step - loss: 0.2033 - val_loss: 1.7901
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9783
Per-joint RMSE: 0.7797 1.2375 0.6307 0.6369 1.3249 1.0220
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:17:42.306924: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:17:42.331449: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:17:43.168877: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:43.173619: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:43.174408: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:43.176231: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:43.177017: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:43.177740: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:43.256201: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:43.257127: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:43.257870: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:43.258606: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:17:43.555664: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.068452e+00  RMSE=1.033660e+00
  per-joint RMSE: 0.8317 1.3800 0.6535 0.6797 1.3203 1.0873
Residual LSTM:  MSE=9.571165e-01      RMSE=9.783233e-01
  per-joint RMSE: 0.7797 1.2375 0.6307 0.6369 1.3249 1.0220
Combined torque MSE=9.571165e-01     RMSE=9.783233e-01
  per-joint RMSE: 0.7797 1.2375 0.6307 0.6369 1.3249 1.0220
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (12808, 25, 6)  Y_train: (12808, 6)
X_test : (4378, 25, 6)  Y_test : (4378, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:17:45.373958: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:17:45.397701: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (12808, 25, 6), Y_train = (12808, 6)
  X_test  = (4378, 25, 6),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:17:46.332067: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:46.336587: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:46.337406: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:46.338972: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:46.339784: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:46.340553: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:46.415220: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:46.416086: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:46.416860: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:46.417626: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:17:47.299736: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 36ms/step - loss: 0.7388 - val_loss: 1.8707
Epoch 2/30
41/41 - 0s - 3ms/step - loss: 0.5068 - val_loss: 2.0521
Epoch 3/30
41/41 - 0s - 3ms/step - loss: 0.4311 - val_loss: 2.1926
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.3866 - val_loss: 2.2257
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.3576 - val_loss: 2.0788
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.3358 - val_loss: 2.1739
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.3180 - val_loss: 2.1794
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.3052 - val_loss: 2.1730
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2952 - val_loss: 2.1603
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2811 - val_loss: 2.1517
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2724 - val_loss: 2.1412
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.0404
Per-joint RMSE: 0.8412 1.3787 0.6614 0.7383 1.3453 1.0457
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:17:50.349550: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:17:50.374430: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:17:51.287406: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:51.291976: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:51.292760: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:51.294422: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:51.295277: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:51.296009: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:51.374157: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:51.374993: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:51.375734: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:51.376464: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:17:51.674656: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.068452e+00  RMSE=1.033660e+00
  per-joint RMSE: 0.8317 1.3800 0.6535 0.6797 1.3203 1.0873
Residual LSTM:  MSE=1.082347e+00      RMSE=1.040359e+00
  per-joint RMSE: 0.8412 1.3787 0.6614 0.7383 1.3453 1.0456
Combined torque MSE=1.082347e+00     RMSE=1.040359e+00
  per-joint RMSE: 0.8412 1.3787 0.6614 0.7383 1.3453 1.0456
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (12808, 25, 18)  Y_train: (12808, 6)
X_test : (4378, 25, 18)  Y_test : (4378, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:17:53.635589: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:17:53.659640: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (12808, 25, 18), Y_train = (12808, 6)
  X_test  = (4378, 25, 18),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:17:54.620626: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:54.625212: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:54.626085: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:54.627782: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:54.628566: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:54.629299: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:54.703654: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:54.704492: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:54.705238: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:54.705967: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:17:55.608178: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 36ms/step - loss: 0.5493 - val_loss: 1.7428
Epoch 2/30
41/41 - 0s - 3ms/step - loss: 0.4058 - val_loss: 1.6844
Epoch 3/30
41/41 - 0s - 3ms/step - loss: 0.3466 - val_loss: 1.8166
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.3145 - val_loss: 1.8725
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.2950 - val_loss: 1.8416
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.2790 - val_loss: 1.8204
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.2727 - val_loss: 1.8334
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.2577 - val_loss: 1.8509
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2458 - val_loss: 1.8310
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2370 - val_loss: 1.8244
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2290 - val_loss: 1.8558
Epoch 12/30
41/41 - 0s - 3ms/step - loss: 0.2296 - val_loss: 1.8714
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.0056
Per-joint RMSE: 0.8202 1.2876 0.6588 0.6379 1.3245 1.0684
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:17:58.762709: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:17:58.788075: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:17:59.647897: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:59.652503: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:59.653382: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:59.655116: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:59.659527: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:59.660308: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:59.735912: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:59.736825: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:59.737568: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:17:59.738301: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:18:00.035969: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.068452e+00  RMSE=1.033660e+00
  per-joint RMSE: 0.8317 1.3800 0.6535 0.6797 1.3203 1.0873
Residual LSTM:  MSE=1.011213e+00      RMSE=1.005591e+00
  per-joint RMSE: 0.8202 1.2876 0.6588 0.6379 1.3245 1.0684
Combined torque MSE=1.011213e+00     RMSE=1.005591e+00
  per-joint RMSE: 0.8202 1.2876 0.6588 0.6379 1.3245 1.0684
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (12808, 25, 18)  Y_train: (12808, 6)
X_test : (4378, 25, 18)  Y_test : (4378, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:18:01.939696: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:18:01.963232: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (12808, 25, 18), Y_train = (12808, 6)
  X_test  = (4378, 25, 18),  Y_test  = (4378, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:18:02.914602: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:02.919053: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:02.919916: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:02.921525: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:02.922307: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:02.923049: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:02.994449: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:02.995365: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:02.996107: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:02.996912: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:18:03.915584: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
41/41 - 1s - 35ms/step - loss: 0.5377 - val_loss: 1.6574
Epoch 2/30
41/41 - 0s - 4ms/step - loss: 0.3784 - val_loss: 1.6230
Epoch 3/30
41/41 - 0s - 3ms/step - loss: 0.3203 - val_loss: 1.5498
Epoch 4/30
41/41 - 0s - 3ms/step - loss: 0.2881 - val_loss: 1.5376
Epoch 5/30
41/41 - 0s - 3ms/step - loss: 0.2703 - val_loss: 1.5330
Epoch 6/30
41/41 - 0s - 3ms/step - loss: 0.2579 - val_loss: 1.5421
Epoch 7/30
41/41 - 0s - 3ms/step - loss: 0.2463 - val_loss: 1.5536
Epoch 8/30
41/41 - 0s - 3ms/step - loss: 0.2387 - val_loss: 1.5531
Epoch 9/30
41/41 - 0s - 3ms/step - loss: 0.2245 - val_loss: 1.5871
Epoch 10/30
41/41 - 0s - 3ms/step - loss: 0.2213 - val_loss: 1.6048
Epoch 11/30
41/41 - 0s - 3ms/step - loss: 0.2168 - val_loss: 1.5947
Epoch 12/30
41/41 - 0s - 3ms/step - loss: 0.2137 - val_loss: 1.6227
Epoch 13/30
41/41 - 0s - 3ms/step - loss: 0.2109 - val_loss: 1.6028
Epoch 14/30
41/41 - 0s - 3ms/step - loss: 0.2043 - val_loss: 1.6289
Epoch 15/30
41/41 - 0s - 3ms/step - loss: 0.2008 - val_loss: 1.6419
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.0155
Per-joint RMSE: 0.7643 1.4114 0.5795 0.6599 1.3194 1.0482
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:18:07.468015: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:18:07.492736: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:18:08.320289: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:08.324803: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:08.325597: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:08.327357: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:08.328150: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:08.328884: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:08.406622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:08.407458: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:08.408196: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:08.408927: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8948 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:18:08.703687: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.068452e+00  RMSE=1.033660e+00
  per-joint RMSE: 0.8317 1.3800 0.6535 0.6797 1.3203 1.0873
Residual LSTM:  MSE=1.031146e+00      RMSE=1.015454e+00
  per-joint RMSE: 0.7643 1.4114 0.5795 0.6599 1.3194 1.0482
Combined torque MSE=1.031146e+00     RMSE=1.015454e+00
  per-joint RMSE: 0.7643 1.4114 0.5795 0.6599 1.3194 1.0482
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (12608, 50, 24)  Y_train: (12608, 6)
X_test : (4253, 50, 24)  Y_test : (4253, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:18:10.610292: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:18:10.634385: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (12608, 50, 24), Y_train = (12608, 6)
  X_test  = (4253, 50, 24),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:18:11.667702: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:11.672231: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:11.673025: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:11.674542: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:11.675508: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:11.676366: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:11.749697: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:11.750612: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:11.751411: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:11.752142: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:18:12.695352: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.5457 - val_loss: 1.3271
Epoch 2/30
40/40 - 0s - 4ms/step - loss: 0.3789 - val_loss: 1.3779
Epoch 3/30
40/40 - 0s - 4ms/step - loss: 0.3230 - val_loss: 1.3644
Epoch 4/30
40/40 - 0s - 4ms/step - loss: 0.2923 - val_loss: 1.4163
Epoch 5/30
40/40 - 0s - 4ms/step - loss: 0.2699 - val_loss: 1.3799
Epoch 6/30
40/40 - 0s - 4ms/step - loss: 0.2559 - val_loss: 1.3793
Epoch 7/30
40/40 - 0s - 4ms/step - loss: 0.2439 - val_loss: 1.3623
Epoch 8/30
40/40 - 0s - 4ms/step - loss: 0.2350 - val_loss: 1.3311
Epoch 9/30
40/40 - 0s - 5ms/step - loss: 0.2257 - val_loss: 1.2821
Epoch 10/30
40/40 - 0s - 4ms/step - loss: 0.2187 - val_loss: 1.3014
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2140 - val_loss: 1.3042
Epoch 12/30
40/40 - 0s - 5ms/step - loss: 0.2113 - val_loss: 1.2566
Epoch 13/30
40/40 - 0s - 4ms/step - loss: 0.2055 - val_loss: 1.2888
Epoch 14/30
40/40 - 0s - 4ms/step - loss: 0.2029 - val_loss: 1.2684
Epoch 15/30
40/40 - 0s - 4ms/step - loss: 0.2013 - val_loss: 1.2768
Epoch 16/30
40/40 - 0s - 5ms/step - loss: 0.1990 - val_loss: 1.2531
Epoch 17/30
40/40 - 0s - 5ms/step - loss: 0.1947 - val_loss: 1.2507
Epoch 18/30
40/40 - 0s - 5ms/step - loss: 0.1932 - val_loss: 1.2293
Epoch 19/30
40/40 - 0s - 5ms/step - loss: 0.1918 - val_loss: 1.2231
Epoch 20/30
40/40 - 0s - 5ms/step - loss: 0.1880 - val_loss: 1.2064
Epoch 21/30
40/40 - 0s - 5ms/step - loss: 0.1867 - val_loss: 1.2025
Epoch 22/30
40/40 - 0s - 4ms/step - loss: 0.1841 - val_loss: 1.2083
Epoch 23/30
40/40 - 0s - 6ms/step - loss: 0.1816 - val_loss: 1.2264
Epoch 24/30
40/40 - 0s - 5ms/step - loss: 0.1811 - val_loss: 1.1931
Epoch 25/30
40/40 - 0s - 4ms/step - loss: 0.1798 - val_loss: 1.2024
Epoch 26/30
40/40 - 0s - 4ms/step - loss: 0.1803 - val_loss: 1.2060
Epoch 27/30
40/40 - 0s - 4ms/step - loss: 0.1796 - val_loss: 1.2074
Epoch 28/30
40/40 - 0s - 5ms/step - loss: 0.1771 - val_loss: 1.1814
Epoch 29/30
40/40 - 0s - 4ms/step - loss: 0.1744 - val_loss: 1.2016
Epoch 30/30
40/40 - 0s - 4ms/step - loss: 0.1742 - val_loss: 1.1879
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.0102
Per-joint RMSE: 0.7777 1.3832 0.5856 0.6690 1.2853 1.0784
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:18:19.706158: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:18:19.730276: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:18:20.577263: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:20.582019: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:20.582889: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:20.584558: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:20.585354: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:20.586086: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:20.663811: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:20.664649: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:20.665393: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:20.666211: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:18:20.967909: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.007120e+00  RMSE=1.003554e+00
  per-joint RMSE: 0.8163 1.3271 0.6380 0.6676 1.2749 1.0665
Residual LSTM:  MSE=1.020584e+00      RMSE=1.010239e+00
  per-joint RMSE: 0.7777 1.3832 0.5856 0.6690 1.2853 1.0784
Combined torque MSE=1.020584e+00     RMSE=1.010239e+00
  per-joint RMSE: 0.7777 1.3832 0.5856 0.6690 1.2853 1.0784
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (12608, 50, 6)  Y_train: (12608, 6)
X_test : (4253, 50, 6)  Y_test : (4253, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:18:22.829912: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:18:22.853706: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (12608, 50, 6), Y_train = (12608, 6)
  X_test  = (4253, 50, 6),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:18:23.822635: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:23.827260: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:23.828155: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:23.830030: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:23.830915: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:23.831661: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:23.904978: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:23.905818: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:23.906564: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:23.907302: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:18:24.819793: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.7123 - val_loss: 1.6196
Epoch 2/30
40/40 - 0s - 5ms/step - loss: 0.4800 - val_loss: 1.8256
Epoch 3/30
40/40 - 0s - 4ms/step - loss: 0.4098 - val_loss: 1.8997
Epoch 4/30
40/40 - 0s - 4ms/step - loss: 0.3743 - val_loss: 1.9127
Epoch 5/30
40/40 - 0s - 4ms/step - loss: 0.3476 - val_loss: 1.8787
Epoch 6/30
40/40 - 0s - 4ms/step - loss: 0.3274 - val_loss: 1.8391
Epoch 7/30
40/40 - 0s - 4ms/step - loss: 0.3082 - val_loss: 1.8475
Epoch 8/30
40/40 - 0s - 4ms/step - loss: 0.2966 - val_loss: 1.7223
Epoch 9/30
40/40 - 0s - 4ms/step - loss: 0.2830 - val_loss: 1.7601
Epoch 10/30
40/40 - 0s - 4ms/step - loss: 0.2667 - val_loss: 1.7025
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2616 - val_loss: 1.7454
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.0653
Per-joint RMSE: 0.8297 1.3389 0.6714 0.7289 1.3071 1.2798
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:18:28.360418: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:18:28.385118: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:18:29.234219: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:29.238814: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:29.239605: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:29.241277: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:29.242136: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:29.242872: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:29.325639: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:29.326485: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:29.327240: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:29.328074: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8948 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:18:29.624076: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.007120e+00  RMSE=1.003554e+00
  per-joint RMSE: 0.8163 1.3271 0.6380 0.6676 1.2749 1.0665
Residual LSTM:  MSE=1.134919e+00      RMSE=1.065326e+00
  per-joint RMSE: 0.8297 1.3389 0.6714 0.7289 1.3071 1.2798
Combined torque MSE=1.134919e+00     RMSE=1.065326e+00
  per-joint RMSE: 0.8297 1.3389 0.6714 0.7289 1.3071 1.2798
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (12608, 50, 18)  Y_train: (12608, 6)
X_test : (4253, 50, 18)  Y_test : (4253, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:18:31.536102: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:18:31.559988: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (12608, 50, 18), Y_train = (12608, 6)
  X_test  = (4253, 50, 18),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:18:32.569607: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:32.574532: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:32.575318: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:32.576845: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:32.577632: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:32.578361: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:32.653039: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:32.654025: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:32.654769: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:32.655593: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:18:33.590060: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.5556 - val_loss: 1.3297
Epoch 2/30
40/40 - 0s - 5ms/step - loss: 0.4009 - val_loss: 1.3789
Epoch 3/30
40/40 - 0s - 5ms/step - loss: 0.3388 - val_loss: 1.4482
Epoch 4/30
40/40 - 0s - 4ms/step - loss: 0.3095 - val_loss: 1.4381
Epoch 5/30
40/40 - 0s - 4ms/step - loss: 0.2885 - val_loss: 1.4300
Epoch 6/30
40/40 - 0s - 4ms/step - loss: 0.2750 - val_loss: 1.4685
Epoch 7/30
40/40 - 0s - 4ms/step - loss: 0.2597 - val_loss: 1.4649
Epoch 8/30
40/40 - 0s - 4ms/step - loss: 0.2496 - val_loss: 1.4550
Epoch 9/30
40/40 - 0s - 4ms/step - loss: 0.2397 - val_loss: 1.4328
Epoch 10/30
40/40 - 0s - 4ms/step - loss: 0.2331 - val_loss: 1.4470
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2282 - val_loss: 1.4754
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9904
Per-joint RMSE: 0.8062 1.3121 0.6293 0.6581 1.2748 1.0296
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:18:37.155656: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:18:37.179807: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:18:38.017433: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:38.022133: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:38.023000: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:38.024652: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:38.025441: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:38.026176: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:38.100331: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:38.101164: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:38.101910: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:38.102643: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:18:38.400636: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.007120e+00  RMSE=1.003554e+00
  per-joint RMSE: 0.8163 1.3271 0.6380 0.6676 1.2749 1.0665
Residual LSTM:  MSE=9.809706e-01      RMSE=9.904396e-01
  per-joint RMSE: 0.8062 1.3121 0.6293 0.6581 1.2748 1.0296
Combined torque MSE=9.809706e-01     RMSE=9.904396e-01
  per-joint RMSE: 0.8062 1.3121 0.6293 0.6581 1.2748 1.0296
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (12608, 50, 18)  Y_train: (12608, 6)
X_test : (4253, 50, 18)  Y_test : (4253, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:18:40.336866: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:18:40.360656: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (12608, 50, 18), Y_train = (12608, 6)
  X_test  = (4253, 50, 18),  Y_test  = (4253, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:18:41.382881: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:41.387748: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:41.388526: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:41.390090: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:41.390873: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:41.391612: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:41.463827: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:41.464739: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:41.465478: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:41.466204: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:18:42.392290: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
40/40 - 2s - 38ms/step - loss: 0.5501 - val_loss: 1.3526
Epoch 2/30
40/40 - 0s - 5ms/step - loss: 0.3816 - val_loss: 1.3202
Epoch 3/30
40/40 - 0s - 5ms/step - loss: 0.3217 - val_loss: 1.2792
Epoch 4/30
40/40 - 0s - 5ms/step - loss: 0.2899 - val_loss: 1.2529
Epoch 5/30
40/40 - 0s - 5ms/step - loss: 0.2667 - val_loss: 1.2505
Epoch 6/30
40/40 - 0s - 5ms/step - loss: 0.2532 - val_loss: 1.2492
Epoch 7/30
40/40 - 0s - 5ms/step - loss: 0.2440 - val_loss: 1.2484
Epoch 8/30
40/40 - 0s - 4ms/step - loss: 0.2342 - val_loss: 1.2684
Epoch 9/30
40/40 - 0s - 4ms/step - loss: 0.2246 - val_loss: 1.2626
Epoch 10/30
40/40 - 0s - 4ms/step - loss: 0.2204 - val_loss: 1.2762
Epoch 11/30
40/40 - 0s - 4ms/step - loss: 0.2147 - val_loss: 1.2846
Epoch 12/30
40/40 - 0s - 4ms/step - loss: 0.2114 - val_loss: 1.2906
Epoch 13/30
40/40 - 0s - 4ms/step - loss: 0.2086 - val_loss: 1.3067
Epoch 14/30
40/40 - 0s - 4ms/step - loss: 0.2045 - val_loss: 1.3214
Epoch 15/30
40/40 - 0s - 4ms/step - loss: 0.1997 - val_loss: 1.3441
Epoch 16/30
40/40 - 0s - 4ms/step - loss: 0.1970 - val_loss: 1.3672
Epoch 17/30
40/40 - 0s - 4ms/step - loss: 0.1957 - val_loss: 1.3721
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9684
Per-joint RMSE: 0.7651 1.2859 0.5772 0.6354 1.2706 1.0181
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:18:47.083116: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:18:47.107604: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:18:47.959332: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:47.963929: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:47.964797: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:47.966557: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:47.967343: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:47.968151: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:48.042141: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:48.042970: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:48.043704: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:18:48.044520: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8950 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:18:48.347216: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.007120e+00  RMSE=1.003554e+00
  per-joint RMSE: 0.8163 1.3271 0.6380 0.6676 1.2749 1.0665
Residual LSTM:  MSE=9.377934e-01      RMSE=9.683974e-01
  per-joint RMSE: 0.7651 1.2859 0.5772 0.6354 1.2706 1.0181
Combined torque MSE=9.377934e-01     RMSE=9.683974e-01
  per-joint RMSE: 0.7651 1.2859 0.5772 0.6354 1.2706 1.0181
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

