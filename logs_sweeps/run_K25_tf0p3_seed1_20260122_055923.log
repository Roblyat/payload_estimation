################################################################################################################
### RUN: K=25 test_fraction=0.3 seed=1                                                                       ###
### npz_in=/workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz ###
################################################################################################################

#####################
### 1) PREPROCESS ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_delan_dataset.py --qdd True --col_format wide --trajectory_amount 25 --test_fraction 0.3 --seed 1 --raw_csv /workspace/shared/data/raw/delan_UR3_Load0_combined_26.csv --out_npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Saved: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz
Trajectories: train=17 test=8
Exists: True

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=0                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz -t structured -s 0 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x792aa9f641f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz
   dt ≈ 0.031131595092024848
  dof = 6
  Train trajectories = 17
  Test trajectories  = 8
  Train samples = 2536
  Test samples  = 4009
################################################

2026-01-22 05:18:54.662387: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150 | type=structured | dof=6
################################################
2026-01-22 05:18:57.815529: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:18:57.815565: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:18:57.815576: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:18:57.815604: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:18:57.815609: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:18:57.815623: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:18:57.815660: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:18:57.815666: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:18:57.815681: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:18:57.815686: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   4.9s, Loss=7.71e+01, Inv=7.71e+01, For=1.77e+02, Power=2.57e+01
  [eval] test_mse=1.674e+01  (n=4009)
Epoch 00050: Time=   6.6s, Loss=4.17e+00, Inv=4.17e+00, For=2.13e+01, Power=1.00e+01
Epoch 00100: Time=   6.9s, Loss=3.82e+00, Inv=3.82e+00, For=1.94e+01, Power=9.45e+00
Epoch 00150: Time=   7.3s, Loss=3.85e+00, Inv=3.85e+00, For=2.05e+01, Power=9.79e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
Torque MSE  = 2.513e+00
Torque RMSE = 1.585e+00
Per-joint MSE : 5.074e+00 1.715e+00 1.897e+00 2.911e-01 4.545e+00 1.555e+00
Per-joint RMSE: 2.252e+00 1.309e+00 1.377e+00 5.396e-01 2.132e+00 1.247e+00
Comp Time per Sample = 8.722e-08s / 11464866.1Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
Detected n_dof=6 (seed=0)
2026-01-22 05:19:07.143632: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 17 trajectories
2026-01-22 05:19:08.420792: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:19:08.420804: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:19:10.006284: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:19:10.006298: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 17/17

Exporting split=test: 8 trajectories
2026-01-22 05:19:11.448943: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 8/8

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (2380, 25, 24)  Y_train: (2380, 6)
X_test : (3880, 25, 24)  Y_test : (3880, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:13.655785: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:13.679991: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (2380, 25, 24), Y_train = (2380, 6)
  X_test  = (3880, 25, 24),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:19:14.677979: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:14.683412: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:14.684376: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:14.686106: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:14.687032: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:14.687906: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:14.781251: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:14.782242: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:14.783034: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:14.783822: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8953 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:19:15.715244: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 173ms/step - loss: 0.4487 - val_loss: 0.3496
Epoch 2/30
8/8 - 0s - 5ms/step - loss: 0.2303 - val_loss: 0.3770
Epoch 3/30
8/8 - 0s - 5ms/step - loss: 0.2001 - val_loss: 0.3802
Epoch 4/30
8/8 - 0s - 5ms/step - loss: 0.1861 - val_loss: 0.3986
Epoch 5/30
8/8 - 0s - 5ms/step - loss: 0.1782 - val_loss: 0.4128
Epoch 6/30
8/8 - 0s - 5ms/step - loss: 0.1716 - val_loss: 0.4109
Epoch 7/30
8/8 - 0s - 5ms/step - loss: 0.1681 - val_loss: 0.4289
Epoch 8/30
8/8 - 0s - 5ms/step - loss: 0.1653 - val_loss: 0.4388
Epoch 9/30
8/8 - 0s - 5ms/step - loss: 0.1611 - val_loss: 0.4524
Epoch 10/30
8/8 - 0s - 5ms/step - loss: 0.1546 - val_loss: 0.4593
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1554 - val_loss: 0.4670
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.5871
Per-joint RMSE: 2.3778 1.1732 1.4387 0.5575 2.0627 1.2033
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:17.812079: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:17.836724: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:19:18.694880: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:18.699540: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:18.700326: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:18.702017: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:18.702798: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:18.703535: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:18.783382: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:18.784209: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:18.784953: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:18.785744: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8939 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:19:19.086917: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.523561e+00  RMSE=1.588572e+00
  per-joint RMSE: 2.2664 1.2855 1.3827 0.5414 2.1355 1.2596
Residual LSTM:  MSE=2.518901e+00      RMSE=1.587105e+00
  per-joint RMSE: 2.3778 1.1732 1.4387 0.5575 2.0627 1.2033
Combined torque MSE=2.518901e+00     RMSE=1.587105e+00
  per-joint RMSE: 2.3778 1.1732 1.4387 0.5575 2.0627 1.2033
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (2380, 25, 6)  Y_train: (2380, 6)
X_test : (3880, 25, 6)  Y_test : (3880, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:20.934235: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:20.958642: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (2380, 25, 6), Y_train = (2380, 6)
  X_test  = (3880, 25, 6),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:19:21.881945: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:21.886435: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:21.887308: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:21.888925: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:21.889720: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:21.890458: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:21.966644: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:21.967492: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:21.968323: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:21.969136: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:19:22.870834: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 170ms/step - loss: 0.8670 - val_loss: 0.5750
Epoch 2/30
8/8 - 0s - 7ms/step - loss: 0.6501 - val_loss: 0.4468
Epoch 3/30
8/8 - 0s - 5ms/step - loss: 0.5671 - val_loss: 0.4775
Epoch 4/30
8/8 - 0s - 5ms/step - loss: 0.4443 - val_loss: 0.4482
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.2872 - val_loss: 0.4350
Epoch 6/30
8/8 - 0s - 6ms/step - loss: 0.2365 - val_loss: 0.4335
Epoch 7/30
8/8 - 0s - 7ms/step - loss: 0.2157 - val_loss: 0.4054
Epoch 8/30
8/8 - 0s - 5ms/step - loss: 0.1906 - val_loss: 0.4484
Epoch 9/30
8/8 - 0s - 5ms/step - loss: 0.1867 - val_loss: 0.4468
Epoch 10/30
8/8 - 0s - 6ms/step - loss: 0.1802 - val_loss: 0.4498
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1745 - val_loss: 0.4580
Epoch 12/30
8/8 - 0s - 5ms/step - loss: 0.1706 - val_loss: 0.4600
Epoch 13/30
8/8 - 0s - 5ms/step - loss: 0.1702 - val_loss: 0.4465
Epoch 14/30
8/8 - 0s - 5ms/step - loss: 0.1693 - val_loss: 0.4652
Epoch 15/30
8/8 - 0s - 5ms/step - loss: 0.1641 - val_loss: 0.4631
Epoch 16/30
8/8 - 0s - 5ms/step - loss: 0.1636 - val_loss: 0.4621
Epoch 17/30
8/8 - 0s - 5ms/step - loss: 0.1636 - val_loss: 0.4661
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6232
Per-joint RMSE: 2.4372 1.2287 1.5398 0.5969 2.0471 1.2004
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:25.231933: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:25.257080: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:19:26.107742: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:26.112295: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:26.113161: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:26.114874: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:26.115654: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:26.116384: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:26.194836: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:26.195671: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:26.196494: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:26.197225: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:19:26.494405: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.523561e+00  RMSE=1.588572e+00
  per-joint RMSE: 2.2664 1.2855 1.3827 0.5414 2.1355 1.2596
Residual LSTM:  MSE=2.634758e+00      RMSE=1.623194e+00
  per-joint RMSE: 2.4372 1.2287 1.5398 0.5969 2.0471 1.2004
Combined torque MSE=2.634758e+00     RMSE=1.623194e+00
  per-joint RMSE: 2.4372 1.2287 1.5398 0.5969 2.0471 1.2004
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (2380, 25, 18)  Y_train: (2380, 6)
X_test : (3880, 25, 18)  Y_test : (3880, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:28.347058: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:28.371105: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (2380, 25, 18), Y_train = (2380, 6)
  X_test  = (3880, 25, 18),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:19:29.297501: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:29.302078: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:29.302870: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:29.304512: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:29.305301: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:29.306043: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:29.381802: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:29.382718: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:29.383462: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:29.384196: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:19:30.274105: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 171ms/step - loss: 0.6088 - val_loss: 0.5392
Epoch 2/30
8/8 - 0s - 8ms/step - loss: 0.2529 - val_loss: 0.3550
Epoch 3/30
8/8 - 0s - 5ms/step - loss: 0.2107 - val_loss: 0.4012
Epoch 4/30
8/8 - 0s - 5ms/step - loss: 0.1949 - val_loss: 0.4356
Epoch 5/30
8/8 - 0s - 5ms/step - loss: 0.1857 - val_loss: 0.3867
Epoch 6/30
8/8 - 0s - 5ms/step - loss: 0.1776 - val_loss: 0.4082
Epoch 7/30
8/8 - 0s - 5ms/step - loss: 0.1741 - val_loss: 0.4114
Epoch 8/30
8/8 - 0s - 5ms/step - loss: 0.1701 - val_loss: 0.4199
Epoch 9/30
8/8 - 0s - 5ms/step - loss: 0.1686 - val_loss: 0.4324
Epoch 10/30
8/8 - 0s - 5ms/step - loss: 0.1633 - val_loss: 0.4353
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1622 - val_loss: 0.4442
Epoch 12/30
8/8 - 0s - 5ms/step - loss: 0.1579 - val_loss: 0.4502
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6022
Per-joint RMSE: 2.2616 1.3979 1.3455 0.5347 2.1054 1.3433
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:32.460501: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:32.485185: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:19:33.344429: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:33.349148: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:33.350026: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:33.351632: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:33.352417: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:33.353156: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:33.427138: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:33.428140: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:33.428890: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:33.429620: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8944 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:19:33.732684: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.523561e+00  RMSE=1.588572e+00
  per-joint RMSE: 2.2664 1.2855 1.3827 0.5414 2.1355 1.2596
Residual LSTM:  MSE=2.567042e+00      RMSE=1.602199e+00
  per-joint RMSE: 2.2616 1.3979 1.3455 0.5347 2.1054 1.3433
Combined torque MSE=2.567042e+00     RMSE=1.602199e+00
  per-joint RMSE: 2.2616 1.3979 1.3455 0.5347 2.1054 1.3433
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (2380, 25, 18)  Y_train: (2380, 6)
X_test : (3880, 25, 18)  Y_test : (3880, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:35.586755: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:35.611661: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (2380, 25, 18), Y_train = (2380, 6)
  X_test  = (3880, 25, 18),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:19:36.555241: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:36.559850: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:36.560637: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:36.562362: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:36.563140: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:36.563881: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:36.639341: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:36.640175: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:36.640917: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:36.641650: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:19:37.553098: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 171ms/step - loss: 0.6340 - val_loss: 0.3666
Epoch 2/30
8/8 - 0s - 7ms/step - loss: 0.2746 - val_loss: 0.3064
Epoch 3/30
8/8 - 0s - 7ms/step - loss: 0.2229 - val_loss: 0.3063
Epoch 4/30
8/8 - 0s - 5ms/step - loss: 0.1998 - val_loss: 0.3276
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1893 - val_loss: 0.2962
Epoch 6/30
8/8 - 0s - 7ms/step - loss: 0.1844 - val_loss: 0.2933
Epoch 7/30
8/8 - 0s - 7ms/step - loss: 0.1783 - val_loss: 0.2895
Epoch 8/30
8/8 - 0s - 7ms/step - loss: 0.1774 - val_loss: 0.2826
Epoch 9/30
8/8 - 0s - 5ms/step - loss: 0.1727 - val_loss: 0.2835
Epoch 10/30
8/8 - 0s - 7ms/step - loss: 0.1661 - val_loss: 0.2810
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1630 - val_loss: 0.2813
Epoch 12/30
8/8 - 0s - 5ms/step - loss: 0.1594 - val_loss: 0.2853
Epoch 13/30
8/8 - 0s - 6ms/step - loss: 0.1584 - val_loss: 0.2924
Epoch 14/30
8/8 - 0s - 5ms/step - loss: 0.1539 - val_loss: 0.3014
Epoch 15/30
8/8 - 0s - 5ms/step - loss: 0.1511 - val_loss: 0.3077
Epoch 16/30
8/8 - 0s - 5ms/step - loss: 0.1453 - val_loss: 0.3174
Epoch 17/30
8/8 - 0s - 5ms/step - loss: 0.1440 - val_loss: 0.3347
Epoch 18/30
8/8 - 0s - 5ms/step - loss: 0.1392 - val_loss: 0.3467
Epoch 19/30
8/8 - 0s - 5ms/step - loss: 0.1325 - val_loss: 0.3602
Epoch 20/30
8/8 - 0s - 5ms/step - loss: 0.1310 - val_loss: 0.3735
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6250
Per-joint RMSE: 2.2791 1.4519 1.3703 0.5436 2.1708 1.2866
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:40.137293: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:40.162243: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:19:41.007500: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:41.012073: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:41.012859: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:41.014533: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:41.015314: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:41.016043: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:41.096189: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:41.097026: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:41.097766: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:41.098495: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:19:41.395202: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.523561e+00  RMSE=1.588572e+00
  per-joint RMSE: 2.2664 1.2855 1.3827 0.5414 2.1355 1.2596
Residual LSTM:  MSE=2.640558e+00      RMSE=1.624979e+00
  per-joint RMSE: 2.2791 1.4519 1.3703 0.5436 2.1708 1.2866
Combined torque MSE=2.640558e+00     RMSE=1.624979e+00
  per-joint RMSE: 2.2791 1.4519 1.3703 0.5436 2.1708 1.2866
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (2255, 50, 24)  Y_train: (2255, 6)
X_test : (3755, 50, 24)  Y_test : (3755, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:43.295878: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:43.319994: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (2255, 50, 24), Y_train = (2255, 6)
  X_test  = (3755, 50, 24),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:19:44.282432: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:44.287040: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:44.287887: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:44.289667: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:44.290456: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:44.291200: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:44.361831: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:44.362670: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:44.363409: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:44.364141: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:19:45.240768: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 171ms/step - loss: 0.5451 - val_loss: 0.3101
Epoch 2/30
8/8 - 0s - 7ms/step - loss: 0.2052 - val_loss: 0.3415
Epoch 3/30
8/8 - 0s - 7ms/step - loss: 0.1809 - val_loss: 0.3416
Epoch 4/30
8/8 - 0s - 7ms/step - loss: 0.1600 - val_loss: 0.3433
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1537 - val_loss: 0.3443
Epoch 6/30
8/8 - 0s - 7ms/step - loss: 0.1475 - val_loss: 0.3611
Epoch 7/30
8/8 - 0s - 6ms/step - loss: 0.1429 - val_loss: 0.3567
Epoch 8/30
8/8 - 0s - 6ms/step - loss: 0.1395 - val_loss: 0.3496
Epoch 9/30
8/8 - 0s - 6ms/step - loss: 0.1378 - val_loss: 0.3624
Epoch 10/30
8/8 - 0s - 6ms/step - loss: 0.1342 - val_loss: 0.3607
Epoch 11/30
8/8 - 0s - 6ms/step - loss: 0.1328 - val_loss: 0.3711
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.5621
Per-joint RMSE: 2.0951 1.3393 1.3256 0.5209 2.1486 1.3460
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:47.498234: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:47.523222: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:19:48.390407: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:48.395144: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:48.396011: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:48.397843: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:48.398628: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:48.399366: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:48.476998: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:48.477909: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:48.478647: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:48.479367: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:19:48.788875: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.476075e+00  RMSE=1.573555e+00
  per-joint RMSE: 2.2542 1.2916 1.3664 0.5408 2.1113 1.2206
Residual LSTM:  MSE=2.440034e+00      RMSE=1.562061e+00
  per-joint RMSE: 2.0951 1.3393 1.3256 0.5209 2.1486 1.3460
Combined torque MSE=2.440034e+00     RMSE=1.562061e+00
  per-joint RMSE: 2.0951 1.3393 1.3256 0.5209 2.1486 1.3460
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (2255, 50, 6)  Y_train: (2255, 6)
X_test : (3755, 50, 6)  Y_test : (3755, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:50.612793: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:50.636796: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (2255, 50, 6), Y_train = (2255, 6)
  X_test  = (3755, 50, 6),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:19:51.574730: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:51.579383: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:51.580176: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:51.581900: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:51.582690: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:51.583424: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:51.656951: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:51.657884: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:51.658770: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:51.659497: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:19:52.571832: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 172ms/step - loss: 0.7908 - val_loss: 0.5538
Epoch 2/30
8/8 - 0s - 9ms/step - loss: 0.4170 - val_loss: 0.5048
Epoch 3/30
8/8 - 0s - 8ms/step - loss: 0.2928 - val_loss: 0.4531
Epoch 4/30
8/8 - 0s - 8ms/step - loss: 0.2492 - val_loss: 0.3932
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.2068 - val_loss: 0.4129
Epoch 6/30
8/8 - 0s - 7ms/step - loss: 0.1868 - val_loss: 0.4659
Epoch 7/30
8/8 - 0s - 7ms/step - loss: 0.1712 - val_loss: 0.5323
Epoch 8/30
8/8 - 0s - 7ms/step - loss: 0.1585 - val_loss: 0.4834
Epoch 9/30
8/8 - 0s - 6ms/step - loss: 0.1541 - val_loss: 0.5433
Epoch 10/30
8/8 - 0s - 6ms/step - loss: 0.1507 - val_loss: 0.5626
Epoch 11/30
8/8 - 0s - 6ms/step - loss: 0.1467 - val_loss: 0.5823
Epoch 12/30
8/8 - 0s - 7ms/step - loss: 0.1444 - val_loss: 0.5628
Epoch 13/30
8/8 - 0s - 6ms/step - loss: 0.1395 - val_loss: 0.5252
Epoch 14/30
8/8 - 0s - 6ms/step - loss: 0.1396 - val_loss: 0.5066
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6391
Per-joint RMSE: 2.4701 1.2921 1.4843 0.5537 2.0808 1.2290
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:54.991048: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:55.015435: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:19:55.884717: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:55.889518: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:55.890441: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:55.892259: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:55.893176: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:55.894038: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:55.987388: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:55.988283: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:55.989146: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:55.989969: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:19:56.286871: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.476075e+00  RMSE=1.573555e+00
  per-joint RMSE: 2.2542 1.2916 1.3664 0.5408 2.1113 1.2206
Residual LSTM:  MSE=2.686805e+00      RMSE=1.639148e+00
  per-joint RMSE: 2.4701 1.2921 1.4843 0.5537 2.0808 1.2290
Combined torque MSE=2.686805e+00     RMSE=1.639148e+00
  per-joint RMSE: 2.4701 1.2921 1.4843 0.5537 2.0808 1.2290
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (2255, 50, 18)  Y_train: (2255, 6)
X_test : (3755, 50, 18)  Y_test : (3755, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:19:58.195453: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:19:58.219434: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (2255, 50, 18), Y_train = (2255, 6)
  X_test  = (3755, 50, 18),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:19:59.156874: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:59.161633: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:59.162496: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:59.163999: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:59.164778: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:59.165507: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:59.239472: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:59.240311: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:59.241045: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:19:59.241775: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:20:00.151994: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 172ms/step - loss: 0.4678 - val_loss: 0.4031
Epoch 2/30
8/8 - 0s - 8ms/step - loss: 0.2030 - val_loss: 0.3679
Epoch 3/30
8/8 - 0s - 8ms/step - loss: 0.1723 - val_loss: 0.3672
Epoch 4/30
8/8 - 0s - 8ms/step - loss: 0.1576 - val_loss: 0.3596
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1473 - val_loss: 0.3656
Epoch 6/30
8/8 - 0s - 7ms/step - loss: 0.1470 - val_loss: 0.3601
Epoch 7/30
8/8 - 0s - 7ms/step - loss: 0.1388 - val_loss: 0.3779
Epoch 8/30
8/8 - 0s - 7ms/step - loss: 0.1388 - val_loss: 0.3839
Epoch 9/30
8/8 - 0s - 6ms/step - loss: 0.1354 - val_loss: 0.3904
Epoch 10/30
8/8 - 0s - 6ms/step - loss: 0.1370 - val_loss: 0.3974
Epoch 11/30
8/8 - 0s - 7ms/step - loss: 0.1323 - val_loss: 0.4047
Epoch 12/30
8/8 - 0s - 7ms/step - loss: 0.1311 - val_loss: 0.4129
Epoch 13/30
8/8 - 0s - 6ms/step - loss: 0.1278 - val_loss: 0.4203
Epoch 14/30
8/8 - 0s - 6ms/step - loss: 0.1309 - val_loss: 0.4239
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.6251
Per-joint RMSE: 2.2598 1.5378 1.3164 0.5226 2.1725 1.2837
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:20:02.572295: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:20:02.597355: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:20:03.447138: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:03.451788: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:03.452653: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:03.454470: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:03.455255: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:03.455989: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:03.530639: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:03.531472: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:03.532211: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:03.532936: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:20:03.845918: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.476075e+00  RMSE=1.573555e+00
  per-joint RMSE: 2.2542 1.2916 1.3664 0.5408 2.1113 1.2206
Residual LSTM:  MSE=2.640834e+00      RMSE=1.625064e+00
  per-joint RMSE: 2.2598 1.5378 1.3164 0.5226 2.1725 1.2837
Combined torque MSE=2.640834e+00     RMSE=1.625064e+00
  per-joint RMSE: 2.2598 1.5378 1.3164 0.5226 2.1725 1.2837
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (2255, 50, 18)  Y_train: (2255, 6)
X_test : (3755, 50, 18)  Y_test : (3755, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:20:05.714777: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:20:05.739016: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (2255, 50, 18), Y_train = (2255, 6)
  X_test  = (3755, 50, 18),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:20:06.691743: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:06.696280: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:06.697069: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:06.698824: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:06.699623: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:06.700364: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:06.773968: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:06.774796: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:06.775536: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:06.776264: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8944 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:20:07.692513: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 173ms/step - loss: 0.5111 - val_loss: 0.5002
Epoch 2/30
8/8 - 0s - 8ms/step - loss: 0.2269 - val_loss: 0.3631
Epoch 3/30
8/8 - 0s - 7ms/step - loss: 0.1824 - val_loss: 0.3939
Epoch 4/30
8/8 - 0s - 7ms/step - loss: 0.1645 - val_loss: 0.3809
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1541 - val_loss: 0.3858
Epoch 6/30
8/8 - 0s - 6ms/step - loss: 0.1476 - val_loss: 0.3899
Epoch 7/30
8/8 - 0s - 6ms/step - loss: 0.1464 - val_loss: 0.3891
Epoch 8/30
8/8 - 0s - 6ms/step - loss: 0.1439 - val_loss: 0.3971
Epoch 9/30
8/8 - 0s - 6ms/step - loss: 0.1379 - val_loss: 0.4036
Epoch 10/30
8/8 - 0s - 6ms/step - loss: 0.1371 - val_loss: 0.4069
Epoch 11/30
8/8 - 0s - 6ms/step - loss: 0.1337 - val_loss: 0.4126
Epoch 12/30
8/8 - 0s - 6ms/step - loss: 0.1338 - val_loss: 0.4238
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.5655
Per-joint RMSE: 2.1553 1.3610 1.3063 0.5054 2.1551 1.2655
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:20:09.970750: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:20:09.995413: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:20:10.846844: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:10.851644: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:10.852434: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:10.854103: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:10.854891: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:10.855627: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:10.931401: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:10.932232: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:10.932972: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:10.933698: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:20:11.238863: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=2.476075e+00  RMSE=1.573555e+00
  per-joint RMSE: 2.2542 1.2916 1.3664 0.5408 2.1113 1.2206
Residual LSTM:  MSE=2.450879e+00      RMSE=1.565528e+00
  per-joint RMSE: 2.1553 1.3610 1.3063 0.5054 2.1551 1.2655
Combined torque MSE=2.450879e+00     RMSE=1.565528e+00
  per-joint RMSE: 2.1553 1.3610 1.3063 0.5054 2.1551 1.2655
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=1                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz -t structured -s 1 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x76a2d2dac1f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz
   dt ≈ 0.031131595092024848
  dof = 6
  Train trajectories = 17
  Test trajectories  = 8
  Train samples = 2536
  Test samples  = 4009
################################################

2026-01-22 05:20:15.498779: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150 | type=structured | dof=6
################################################
2026-01-22 05:20:18.636043: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:18.636080: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:18.636086: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:18.636115: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:18.636120: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:18.636135: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:18.636172: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:18.636177: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:18.636193: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:18.636198: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.2s, Loss=2.05e+02, Inv=2.05e+02, For=6.06e+02, Power=1.12e+01
  [eval] test_mse=7.081e+00  (n=4009)
Epoch 00050: Time=   7.0s, Loss=4.23e+00, Inv=4.23e+00, For=2.38e+01, Power=9.97e+00
Epoch 00100: Time=   7.4s, Loss=3.84e+00, Inv=3.84e+00, For=2.52e+01, Power=9.87e+00
Epoch 00150: Time=   7.7s, Loss=3.75e+00, Inv=3.75e+00, For=2.60e+01, Power=9.82e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
Torque MSE  = 9.218e-01
Torque RMSE = 9.601e-01
Per-joint MSE : 5.011e-01 9.461e-01 9.077e-01 1.649e+00 1.110e+00 4.168e-01
Per-joint RMSE: 7.079e-01 9.727e-01 9.527e-01 1.284e+00 1.054e+00 6.456e-01
Comp Time per Sample = 8.310e-08s / 12033004.4Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
Detected n_dof=6 (seed=1)
2026-01-22 05:20:28.460620: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 17 trajectories
2026-01-22 05:20:29.744768: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:29.744781: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:31.362657: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:20:31.362672: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 17/17

Exporting split=test: 8 trajectories
2026-01-22 05:20:32.976575: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 8/8

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (2380, 25, 24)  Y_train: (2380, 6)
X_test : (3880, 25, 24)  Y_test : (3880, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:20:34.948193: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:20:34.972232: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (2380, 25, 24), Y_train = (2380, 6)
  X_test  = (3880, 25, 24),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:20:35.899954: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:35.904564: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:35.905390: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:35.907042: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:35.907935: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:35.908876: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:35.984637: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:35.985587: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:35.986447: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:35.987298: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:20:36.896794: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 172ms/step - loss: 0.5334 - val_loss: 0.4206
Epoch 2/30
8/8 - 0s - 7ms/step - loss: 0.2579 - val_loss: 0.3470
Epoch 3/30
8/8 - 0s - 5ms/step - loss: 0.2106 - val_loss: 0.3848
Epoch 4/30
8/8 - 0s - 5ms/step - loss: 0.1927 - val_loss: 0.3878
Epoch 5/30
8/8 - 0s - 5ms/step - loss: 0.1849 - val_loss: 0.3825
Epoch 6/30
8/8 - 0s - 5ms/step - loss: 0.1809 - val_loss: 0.3991
Epoch 7/30
8/8 - 0s - 5ms/step - loss: 0.1744 - val_loss: 0.3981
Epoch 8/30
8/8 - 0s - 5ms/step - loss: 0.1737 - val_loss: 0.4161
Epoch 9/30
8/8 - 0s - 6ms/step - loss: 0.1711 - val_loss: 0.4231
Epoch 10/30
8/8 - 0s - 5ms/step - loss: 0.1683 - val_loss: 0.4308
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1670 - val_loss: 0.4311
Epoch 12/30
8/8 - 0s - 5ms/step - loss: 0.1627 - val_loss: 0.4494
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9605
Per-joint RMSE: 0.7273 1.0341 0.9103 1.1935 1.0744 0.7277
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:20:39.068933: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:20:39.092782: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:20:39.935305: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:39.940016: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:39.940965: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:39.942661: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:39.943446: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:39.944179: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:40.026491: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:40.027342: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:40.028119: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:40.028956: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8944 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:20:40.330766: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=9.158185e-01  RMSE=9.569840e-01
  per-joint RMSE: 0.7077 0.9650 0.9624 1.2794 1.0439 0.6403
Residual LSTM:  MSE=9.225316e-01      RMSE=9.604851e-01
  per-joint RMSE: 0.7273 1.0341 0.9103 1.1935 1.0744 0.7277
Combined torque MSE=9.225316e-01     RMSE=9.604851e-01
  per-joint RMSE: 0.7273 1.0341 0.9103 1.1935 1.0744 0.7277
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (2380, 25, 6)  Y_train: (2380, 6)
X_test : (3880, 25, 6)  Y_test : (3880, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:20:42.200684: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:20:42.224877: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (2380, 25, 6), Y_train = (2380, 6)
  X_test  = (3880, 25, 6),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:20:43.141712: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:43.146375: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:43.147249: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:43.148810: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:43.149601: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:43.150332: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:43.240532: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:43.241463: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:43.242300: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:43.243035: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:20:44.127739: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 172ms/step - loss: 0.8939 - val_loss: 0.4275
Epoch 2/30
8/8 - 0s - 7ms/step - loss: 0.6620 - val_loss: 0.3655
Epoch 3/30
8/8 - 0s - 5ms/step - loss: 0.5809 - val_loss: 0.3868
Epoch 4/30
8/8 - 0s - 5ms/step - loss: 0.4671 - val_loss: 0.4056
Epoch 5/30
8/8 - 0s - 5ms/step - loss: 0.3132 - val_loss: 0.4201
Epoch 6/30
8/8 - 0s - 5ms/step - loss: 0.2336 - val_loss: 0.4536
Epoch 7/30
8/8 - 0s - 5ms/step - loss: 0.2124 - val_loss: 0.4603
Epoch 8/30
8/8 - 0s - 5ms/step - loss: 0.1930 - val_loss: 0.4885
Epoch 9/30
8/8 - 0s - 5ms/step - loss: 0.1890 - val_loss: 0.5252
Epoch 10/30
8/8 - 0s - 5ms/step - loss: 0.1829 - val_loss: 0.5288
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1816 - val_loss: 0.5331
Epoch 12/30
8/8 - 0s - 5ms/step - loss: 0.1781 - val_loss: 0.5440
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9721
Per-joint RMSE: 0.7175 0.9836 0.9582 1.3111 1.0624 0.6493
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:20:46.300383: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:20:46.325170: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:20:47.170082: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:47.174740: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:47.175525: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:47.177497: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:47.178376: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:47.179108: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:47.258640: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:47.259471: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:47.260299: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:47.261031: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:20:47.556865: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=9.158185e-01  RMSE=9.569840e-01
  per-joint RMSE: 0.7077 0.9650 0.9624 1.2794 1.0439 0.6403
Residual LSTM:  MSE=9.449261e-01      RMSE=9.720731e-01
  per-joint RMSE: 0.7175 0.9836 0.9582 1.3111 1.0624 0.6493
Combined torque MSE=9.449261e-01     RMSE=9.720731e-01
  per-joint RMSE: 0.7175 0.9836 0.9582 1.3111 1.0624 0.6493
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (2380, 25, 18)  Y_train: (2380, 6)
X_test : (3880, 25, 18)  Y_test : (3880, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:20:49.404450: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:20:49.428559: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (2380, 25, 18), Y_train = (2380, 6)
  X_test  = (3880, 25, 18),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:20:50.360088: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:50.364686: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:50.365476: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:50.367127: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:50.367921: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:50.368656: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:50.442201: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:50.443113: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:50.443939: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:50.444666: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8942 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:20:51.348690: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 171ms/step - loss: 0.5177 - val_loss: 0.3835
Epoch 2/30
8/8 - 0s - 8ms/step - loss: 0.2454 - val_loss: 0.3079
Epoch 3/30
8/8 - 0s - 6ms/step - loss: 0.2159 - val_loss: 0.3436
Epoch 4/30
8/8 - 0s - 5ms/step - loss: 0.1989 - val_loss: 0.3408
Epoch 5/30
8/8 - 0s - 5ms/step - loss: 0.1892 - val_loss: 0.3355
Epoch 6/30
8/8 - 0s - 5ms/step - loss: 0.1826 - val_loss: 0.3662
Epoch 7/30
8/8 - 0s - 6ms/step - loss: 0.1803 - val_loss: 0.3610
Epoch 8/30
8/8 - 0s - 5ms/step - loss: 0.1779 - val_loss: 0.3759
Epoch 9/30
8/8 - 0s - 5ms/step - loss: 0.1732 - val_loss: 0.3854
Epoch 10/30
8/8 - 0s - 5ms/step - loss: 0.1718 - val_loss: 0.3961
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1688 - val_loss: 0.4000
Epoch 12/30
8/8 - 0s - 5ms/step - loss: 0.1666 - val_loss: 0.4066
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9824
Per-joint RMSE: 0.6493 0.8844 1.1128 1.4122 0.9982 0.5979
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:20:53.521336: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:20:53.546078: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:20:54.402993: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:54.407677: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:54.408470: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:54.410058: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:54.410920: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:54.411665: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:54.492523: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:54.493439: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:54.494175: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:54.494991: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:20:54.796657: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=9.158185e-01  RMSE=9.569840e-01
  per-joint RMSE: 0.7077 0.9650 0.9624 1.2794 1.0439 0.6403
Residual LSTM:  MSE=9.650350e-01      RMSE=9.823619e-01
  per-joint RMSE: 0.6493 0.8844 1.1128 1.4122 0.9982 0.5979
Combined torque MSE=9.650350e-01     RMSE=9.823619e-01
  per-joint RMSE: 0.6493 0.8844 1.1128 1.4122 0.9982 0.5979
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (2380, 25, 18)  Y_train: (2380, 6)
X_test : (3880, 25, 18)  Y_test : (3880, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:20:56.764250: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:20:56.787887: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (2380, 25, 18), Y_train = (2380, 6)
  X_test  = (3880, 25, 18),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:20:57.722495: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:57.727010: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:57.727802: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:57.729433: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:57.730222: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:57.730961: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:57.811409: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:57.812346: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:57.813084: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:20:57.813820: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8939 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:20:58.717666: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 170ms/step - loss: 0.5128 - val_loss: 0.3603
Epoch 2/30
8/8 - 0s - 8ms/step - loss: 0.2627 - val_loss: 0.2811
Epoch 3/30
8/8 - 0s - 5ms/step - loss: 0.2159 - val_loss: 0.3073
Epoch 4/30
8/8 - 0s - 5ms/step - loss: 0.1976 - val_loss: 0.2914
Epoch 5/30
8/8 - 0s - 6ms/step - loss: 0.1901 - val_loss: 0.2871
Epoch 6/30
8/8 - 0s - 5ms/step - loss: 0.1849 - val_loss: 0.2942
Epoch 7/30
8/8 - 0s - 5ms/step - loss: 0.1798 - val_loss: 0.2909
Epoch 8/30
8/8 - 0s - 5ms/step - loss: 0.1738 - val_loss: 0.2940
Epoch 9/30
8/8 - 0s - 5ms/step - loss: 0.1704 - val_loss: 0.2979
Epoch 10/30
8/8 - 0s - 5ms/step - loss: 0.1687 - val_loss: 0.3001
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1693 - val_loss: 0.3044
Epoch 12/30
8/8 - 0s - 5ms/step - loss: 0.1621 - val_loss: 0.3073
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9543
Per-joint RMSE: 0.7064 1.0077 0.9148 1.2636 1.0591 0.6278
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:21:00.880430: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:21:00.905054: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:21:01.750826: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:01.755421: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:01.756280: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:01.758125: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:01.758992: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:01.759732: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:01.835569: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:01.836406: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:01.837138: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:01.837868: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8944 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:21:02.136198: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=9.158185e-01  RMSE=9.569840e-01
  per-joint RMSE: 0.7077 0.9650 0.9624 1.2794 1.0439 0.6403
Residual LSTM:  MSE=9.106441e-01      RMSE=9.542767e-01
  per-joint RMSE: 0.7064 1.0077 0.9148 1.2636 1.0591 0.6278
Combined torque MSE=9.106441e-01     RMSE=9.542767e-01
  per-joint RMSE: 0.7064 1.0077 0.9148 1.2636 1.0591 0.6278
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (2255, 50, 24)  Y_train: (2255, 6)
X_test : (3755, 50, 24)  Y_test : (3755, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:21:04.027258: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:21:04.051987: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (2255, 50, 24), Y_train = (2255, 6)
  X_test  = (3755, 50, 24),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:21:05.006739: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:05.011325: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:05.012193: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:05.013841: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:05.014631: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:05.015374: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:05.093050: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:05.093895: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:05.094643: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:05.095371: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:21:05.982601: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 173ms/step - loss: 0.5525 - val_loss: 0.3692
Epoch 2/30
8/8 - 0s - 7ms/step - loss: 0.2067 - val_loss: 0.3947
Epoch 3/30
8/8 - 0s - 9ms/step - loss: 0.1734 - val_loss: 0.3656
Epoch 4/30
8/8 - 0s - 7ms/step - loss: 0.1609 - val_loss: 0.3750
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1525 - val_loss: 0.3796
Epoch 6/30
8/8 - 0s - 8ms/step - loss: 0.1481 - val_loss: 0.3652
Epoch 7/30
8/8 - 0s - 7ms/step - loss: 0.1437 - val_loss: 0.3711
Epoch 8/30
8/8 - 0s - 6ms/step - loss: 0.1397 - val_loss: 0.3744
Epoch 9/30
8/8 - 0s - 7ms/step - loss: 0.1383 - val_loss: 0.3696
Epoch 10/30
8/8 - 0s - 7ms/step - loss: 0.1351 - val_loss: 0.3818
Epoch 11/30
8/8 - 0s - 6ms/step - loss: 0.1331 - val_loss: 0.3847
Epoch 12/30
8/8 - 0s - 7ms/step - loss: 0.1304 - val_loss: 0.3962
Epoch 13/30
8/8 - 0s - 7ms/step - loss: 0.1293 - val_loss: 0.4049
Epoch 14/30
8/8 - 0s - 6ms/step - loss: 0.1297 - val_loss: 0.4160
Epoch 15/30
8/8 - 0s - 7ms/step - loss: 0.1259 - val_loss: 0.4305
Epoch 16/30
8/8 - 0s - 6ms/step - loss: 0.1260 - val_loss: 0.4338
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9854
Per-joint RMSE: 0.8968 1.1617 0.8815 1.1687 1.0349 0.6766
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:21:08.526459: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:21:08.551307: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:21:09.398491: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:09.403126: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:09.403915: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:09.405639: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:09.406432: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:09.407175: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:09.486355: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:09.487198: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:09.487939: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:09.488666: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:21:09.799050: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=9.016258e-01  RMSE=9.495398e-01
  per-joint RMSE: 0.6902 0.9721 0.9427 1.2736 1.0367 0.6347
Residual LSTM:  MSE=9.709466e-01      RMSE=9.853662e-01
  per-joint RMSE: 0.8968 1.1617 0.8815 1.1687 1.0349 0.6766
Combined torque MSE=9.709466e-01     RMSE=9.853662e-01
  per-joint RMSE: 0.8968 1.1617 0.8815 1.1687 1.0349 0.6766
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (2255, 50, 6)  Y_train: (2255, 6)
X_test : (3755, 50, 6)  Y_test : (3755, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:21:11.647799: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:21:11.672149: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (2255, 50, 6), Y_train = (2255, 6)
  X_test  = (3755, 50, 6),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:21:12.609408: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:12.613965: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:12.614758: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:12.616442: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:12.617308: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:12.618063: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:12.691367: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:12.692208: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:12.692946: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:12.693741: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:21:13.597394: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 171ms/step - loss: 0.7661 - val_loss: 0.5938
Epoch 2/30
8/8 - 0s - 9ms/step - loss: 0.3936 - val_loss: 0.4697
Epoch 3/30
8/8 - 0s - 7ms/step - loss: 0.2578 - val_loss: 0.6946
Epoch 4/30
8/8 - 0s - 7ms/step - loss: 0.1889 - val_loss: 0.6910
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1825 - val_loss: 0.6023
Epoch 6/30
8/8 - 0s - 7ms/step - loss: 0.1721 - val_loss: 0.6732
Epoch 7/30
8/8 - 0s - 7ms/step - loss: 0.1611 - val_loss: 0.8146
Epoch 8/30
8/8 - 0s - 6ms/step - loss: 0.1590 - val_loss: 0.7965
Epoch 9/30
8/8 - 0s - 6ms/step - loss: 0.1523 - val_loss: 0.8531
Epoch 10/30
8/8 - 0s - 6ms/step - loss: 0.1483 - val_loss: 0.8386
Epoch 11/30
8/8 - 0s - 7ms/step - loss: 0.1452 - val_loss: 0.8917
Epoch 12/30
8/8 - 0s - 7ms/step - loss: 0.1440 - val_loss: 0.9278
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9577
Per-joint RMSE: 0.7329 1.0098 0.8695 1.2074 1.1052 0.7146
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:21:15.887767: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:21:15.912401: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:21:16.768118: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:16.772789: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:16.773582: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:16.775233: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:16.776015: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:16.776853: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:16.854062: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:16.854980: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:16.855723: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:16.856453: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:21:17.155307: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=9.016258e-01  RMSE=9.495398e-01
  per-joint RMSE: 0.6902 0.9721 0.9427 1.2736 1.0367 0.6347
Residual LSTM:  MSE=9.171379e-01      RMSE=9.576732e-01
  per-joint RMSE: 0.7329 1.0098 0.8695 1.2074 1.1052 0.7146
Combined torque MSE=9.171379e-01     RMSE=9.576732e-01
  per-joint RMSE: 0.7329 1.0098 0.8695 1.2074 1.1052 0.7146
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (2255, 50, 18)  Y_train: (2255, 6)
X_test : (3755, 50, 18)  Y_test : (3755, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:21:19.041612: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:21:19.065272: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (2255, 50, 18), Y_train = (2255, 6)
  X_test  = (3755, 50, 18),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:21:20.006914: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:20.011673: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:20.012467: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:20.014096: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:20.014880: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:20.015618: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:20.089013: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:20.089847: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:20.090671: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:20.091396: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:21:21.005620: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 173ms/step - loss: 0.5552 - val_loss: 0.4059
Epoch 2/30
8/8 - 0s - 8ms/step - loss: 0.2099 - val_loss: 0.3146
Epoch 3/30
8/8 - 0s - 7ms/step - loss: 0.1822 - val_loss: 0.3353
Epoch 4/30
8/8 - 0s - 7ms/step - loss: 0.1611 - val_loss: 0.3510
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1546 - val_loss: 0.3406
Epoch 6/30
8/8 - 0s - 6ms/step - loss: 0.1483 - val_loss: 0.3585
Epoch 7/30
8/8 - 0s - 7ms/step - loss: 0.1455 - val_loss: 0.3590
Epoch 8/30
8/8 - 0s - 6ms/step - loss: 0.1423 - val_loss: 0.3798
Epoch 9/30
8/8 - 0s - 6ms/step - loss: 0.1407 - val_loss: 0.3894
Epoch 10/30
8/8 - 0s - 6ms/step - loss: 0.1395 - val_loss: 0.3986
Epoch 11/30
8/8 - 0s - 6ms/step - loss: 0.1384 - val_loss: 0.4211
Epoch 12/30
8/8 - 0s - 6ms/step - loss: 0.1361 - val_loss: 0.4310
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9992
Per-joint RMSE: 0.6901 1.2132 0.9506 1.3183 1.0084 0.6191
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:21:23.270448: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:21:23.295303: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:21:24.136791: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:24.141460: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:24.142242: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:24.143957: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:24.144739: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:24.145562: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:24.229186: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:24.230093: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:24.230826: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:24.231546: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:21:24.538614: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=9.016258e-01  RMSE=9.495398e-01
  per-joint RMSE: 0.6902 0.9721 0.9427 1.2736 1.0367 0.6347
Residual LSTM:  MSE=9.983015e-01      RMSE=9.991504e-01
  per-joint RMSE: 0.6901 1.2132 0.9506 1.3183 1.0084 0.6191
Combined torque MSE=9.983015e-01     RMSE=9.991504e-01
  per-joint RMSE: 0.6901 1.2132 0.9506 1.3183 1.0084 0.6191
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (2255, 50, 18)  Y_train: (2255, 6)
X_test : (3755, 50, 18)  Y_test : (3755, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:21:26.382793: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:21:26.407133: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (2255, 50, 18), Y_train = (2255, 6)
  X_test  = (3755, 50, 18),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:21:27.349752: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:27.354339: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:27.355211: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:27.356793: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:27.357574: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:27.358306: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:27.436741: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:27.437575: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:27.438391: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:27.439212: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:21:28.325796: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 174ms/step - loss: 0.5361 - val_loss: 0.3657
Epoch 2/30
8/8 - 0s - 8ms/step - loss: 0.2141 - val_loss: 0.2994
Epoch 3/30
8/8 - 0s - 8ms/step - loss: 0.1748 - val_loss: 0.2974
Epoch 4/30
8/8 - 0s - 7ms/step - loss: 0.1586 - val_loss: 0.3108
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1533 - val_loss: 0.3043
Epoch 6/30
8/8 - 0s - 7ms/step - loss: 0.1469 - val_loss: 0.3091
Epoch 7/30
8/8 - 0s - 7ms/step - loss: 0.1446 - val_loss: 0.3061
Epoch 8/30
8/8 - 0s - 7ms/step - loss: 0.1435 - val_loss: 0.3011
Epoch 9/30
8/8 - 0s - 6ms/step - loss: 0.1380 - val_loss: 0.3101
Epoch 10/30
8/8 - 0s - 6ms/step - loss: 0.1371 - val_loss: 0.3044
Epoch 11/30
8/8 - 0s - 6ms/step - loss: 0.1357 - val_loss: 0.3095
Epoch 12/30
8/8 - 0s - 7ms/step - loss: 0.1361 - val_loss: 0.3125
Epoch 13/30
8/8 - 0s - 6ms/step - loss: 0.1318 - val_loss: 0.3119
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9267
Per-joint RMSE: 0.6905 0.9585 0.8769 1.1614 1.0895 0.6727
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:21:30.724464: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:21:30.749488: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:21:31.640588: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:31.645290: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:31.646087: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:31.647723: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:31.648512: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:31.649245: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:31.723714: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:31.724624: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:31.725366: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:31.726100: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8944 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:21:32.031394: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=9.016258e-01  RMSE=9.495398e-01
  per-joint RMSE: 0.6902 0.9721 0.9427 1.2736 1.0367 0.6347
Residual LSTM:  MSE=8.587875e-01      RMSE=9.267079e-01
  per-joint RMSE: 0.6905 0.9585 0.8769 1.1614 1.0895 0.6727
Combined torque MSE=8.587875e-01     RMSE=9.267079e-01
  per-joint RMSE: 0.6905 0.9585 0.8769 1.1614 1.0895 0.6727
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=2                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz -t structured -s 2 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x71bc60dc41f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz
   dt ≈ 0.031131595092024848
  dof = 6
  Train trajectories = 17
  Test trajectories  = 8
  Train samples = 2536
  Test samples  = 4009
################################################

2026-01-22 05:21:36.251963: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150 | type=structured | dof=6
################################################
2026-01-22 05:21:39.397185: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:39.397221: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:39.397227: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:39.397254: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:39.397259: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:39.397273: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:39.397310: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:39.397316: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:39.397331: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:39.397336: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   4.9s, Loss=5.65e+01, Inv=5.65e+01, For=1.42e+02, Power=8.01e+01
  [eval] test_mse=6.347e+00  (n=4009)
Epoch 00050: Time=   6.5s, Loss=4.05e+00, Inv=4.05e+00, For=1.66e+01, Power=1.02e+01
Epoch 00100: Time=   6.8s, Loss=3.88e+00, Inv=3.88e+00, For=1.82e+01, Power=1.00e+01
Epoch 00150: Time=   7.1s, Loss=3.84e+00, Inv=3.84e+00, For=1.92e+01, Power=9.90e+00
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
Torque MSE  = 1.030e+00
Torque RMSE = 1.015e+00
Per-joint MSE : 3.676e-01 8.863e-01 3.127e+00 7.458e-01 7.887e-01 2.650e-01
Per-joint RMSE: 6.063e-01 9.414e-01 1.768e+00 8.636e-01 8.881e-01 5.148e-01
Comp Time per Sample = 8.276e-08s / 12083745.2Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p3_seed1_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
Detected n_dof=6 (seed=2)
2026-01-22 05:21:48.612625: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 17 trajectories
2026-01-22 05:21:49.902745: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:49.902757: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:51.503932: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:21:51.503946: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 17/17

Exporting split=test: 8 trajectories
2026-01-22 05:21:52.973749: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 8/8

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (2380, 25, 24)  Y_train: (2380, 6)
X_test : (3880, 25, 24)  Y_test : (3880, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:21:55.014159: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:21:55.038458: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (2380, 25, 24), Y_train = (2380, 6)
  X_test  = (3880, 25, 24),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:21:55.975604: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:55.981305: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:55.982252: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:55.983933: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:55.984750: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:55.985708: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:56.070717: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:56.071621: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:56.072422: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:56.073219: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8947 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:21:56.997769: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 173ms/step - loss: 0.6315 - val_loss: 0.3167
Epoch 2/30
8/8 - 0s - 5ms/step - loss: 0.2661 - val_loss: 0.3627
Epoch 3/30
8/8 - 0s - 5ms/step - loss: 0.2208 - val_loss: 0.3495
Epoch 4/30
8/8 - 0s - 5ms/step - loss: 0.2047 - val_loss: 0.3506
Epoch 5/30
8/8 - 0s - 5ms/step - loss: 0.1977 - val_loss: 0.3833
Epoch 6/30
8/8 - 0s - 5ms/step - loss: 0.1892 - val_loss: 0.3755
Epoch 7/30
8/8 - 0s - 5ms/step - loss: 0.1859 - val_loss: 0.3767
Epoch 8/30
8/8 - 0s - 5ms/step - loss: 0.1844 - val_loss: 0.3879
Epoch 9/30
8/8 - 0s - 5ms/step - loss: 0.1833 - val_loss: 0.3963
Epoch 10/30
8/8 - 0s - 5ms/step - loss: 0.1764 - val_loss: 0.3947
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1741 - val_loss: 0.4062
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.0708
Per-joint RMSE: 0.6473 1.0659 1.8612 0.8610 0.9144 0.5322
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:21:59.099486: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:21:59.124310: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:21:59.964058: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:59.968767: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:59.969645: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:59.971323: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:59.972110: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:21:59.972927: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:00.051676: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:00.052504: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:00.053245: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:00.053975: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8939 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:22:00.354828: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.037665e+00  RMSE=1.018659e+00
  per-joint RMSE: 0.5940 0.9430 1.7821 0.8751 0.8781 0.5206
Residual LSTM:  MSE=1.146671e+00      RMSE=1.070827e+00
  per-joint RMSE: 0.6473 1.0659 1.8612 0.8610 0.9144 0.5322
Combined torque MSE=1.146671e+00     RMSE=1.070827e+00
  per-joint RMSE: 0.6473 1.0659 1.8612 0.8610 0.9144 0.5322
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (2380, 25, 6)  Y_train: (2380, 6)
X_test : (3880, 25, 6)  Y_test : (3880, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:02.197593: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:02.221630: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (2380, 25, 6), Y_train = (2380, 6)
  X_test  = (3880, 25, 6),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:22:03.163915: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:03.168496: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:03.169275: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:03.170907: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:03.171769: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:03.172495: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:03.251123: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:03.252107: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:03.252932: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:03.253662: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:22:04.126155: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 170ms/step - loss: 0.8567 - val_loss: 0.4338
Epoch 2/30
8/8 - 0s - 7ms/step - loss: 0.6638 - val_loss: 0.3791
Epoch 3/30
8/8 - 0s - 5ms/step - loss: 0.5820 - val_loss: 0.3939
Epoch 4/30
8/8 - 0s - 7ms/step - loss: 0.4640 - val_loss: 0.3638
Epoch 5/30
8/8 - 0s - 6ms/step - loss: 0.3081 - val_loss: 0.3745
Epoch 6/30
8/8 - 0s - 5ms/step - loss: 0.2641 - val_loss: 0.3838
Epoch 7/30
8/8 - 0s - 7ms/step - loss: 0.2261 - val_loss: 0.3638
Epoch 8/30
8/8 - 0s - 5ms/step - loss: 0.2066 - val_loss: 0.4067
Epoch 9/30
8/8 - 0s - 5ms/step - loss: 0.2016 - val_loss: 0.4174
Epoch 10/30
8/8 - 0s - 5ms/step - loss: 0.1913 - val_loss: 0.4504
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1907 - val_loss: 0.4582
Epoch 12/30
8/8 - 0s - 5ms/step - loss: 0.1862 - val_loss: 0.4687
Epoch 13/30
8/8 - 0s - 5ms/step - loss: 0.1828 - val_loss: 0.4781
Epoch 14/30
8/8 - 0s - 5ms/step - loss: 0.1756 - val_loss: 0.4857
Epoch 15/30
8/8 - 0s - 6ms/step - loss: 0.1760 - val_loss: 0.4941
Epoch 16/30
8/8 - 0s - 5ms/step - loss: 0.1767 - val_loss: 0.4930
Epoch 17/30
8/8 - 0s - 5ms/step - loss: 0.1711 - val_loss: 0.5019
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.0769
Per-joint RMSE: 0.6265 0.8980 1.9293 0.9861 0.8479 0.5882
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:06.528487: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:06.553263: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:22:07.406516: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:07.411069: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:07.411893: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:07.413593: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:07.414377: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:07.415123: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:07.492509: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:07.493342: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:07.494084: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:07.494824: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:22:07.792564: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.037665e+00  RMSE=1.018659e+00
  per-joint RMSE: 0.5940 0.9430 1.7821 0.8751 0.8781 0.5206
Residual LSTM:  MSE=1.159702e+00      RMSE=1.076895e+00
  per-joint RMSE: 0.6264 0.8980 1.9293 0.9861 0.8479 0.5882
Combined torque MSE=1.159702e+00     RMSE=1.076895e+00
  per-joint RMSE: 0.6264 0.8980 1.9293 0.9861 0.8479 0.5882
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (2380, 25, 18)  Y_train: (2380, 6)
X_test : (3880, 25, 18)  Y_test : (3880, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:09.684855: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:09.709336: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (2380, 25, 18), Y_train = (2380, 6)
  X_test  = (3880, 25, 18),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:22:10.631392: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:10.635912: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:10.636697: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:10.638209: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:10.638981: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:10.639714: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:10.712377: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:10.713215: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:10.714051: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:10.714785: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:22:11.597101: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 170ms/step - loss: 0.5838 - val_loss: 0.4345
Epoch 2/30
8/8 - 0s - 7ms/step - loss: 0.2595 - val_loss: 0.3656
Epoch 3/30
8/8 - 0s - 6ms/step - loss: 0.2228 - val_loss: 0.4376
Epoch 4/30
8/8 - 0s - 5ms/step - loss: 0.2063 - val_loss: 0.4588
Epoch 5/30
8/8 - 0s - 5ms/step - loss: 0.2013 - val_loss: 0.4217
Epoch 6/30
8/8 - 0s - 5ms/step - loss: 0.1954 - val_loss: 0.4439
Epoch 7/30
8/8 - 0s - 5ms/step - loss: 0.1917 - val_loss: 0.4488
Epoch 8/30
8/8 - 0s - 5ms/step - loss: 0.1880 - val_loss: 0.4619
Epoch 9/30
8/8 - 0s - 5ms/step - loss: 0.1844 - val_loss: 0.4907
Epoch 10/30
8/8 - 0s - 5ms/step - loss: 0.1813 - val_loss: 0.5038
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1797 - val_loss: 0.5330
Epoch 12/30
8/8 - 0s - 5ms/step - loss: 0.1775 - val_loss: 0.5408
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9963
Per-joint RMSE: 0.5494 0.9394 1.7280 0.8494 0.8924 0.5173
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:13.776702: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:13.801618: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:22:14.640887: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:14.645484: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:14.646427: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:14.648102: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:14.648887: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:14.649617: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:14.727181: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:14.728018: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:14.728762: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:14.729487: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8939 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:22:15.032008: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.037665e+00  RMSE=1.018659e+00
  per-joint RMSE: 0.5940 0.9430 1.7821 0.8751 0.8781 0.5206
Residual LSTM:  MSE=9.926209e-01      RMSE=9.963036e-01
  per-joint RMSE: 0.5494 0.9394 1.7280 0.8494 0.8924 0.5173
Combined torque MSE=9.926209e-01     RMSE=9.963036e-01
  per-joint RMSE: 0.5494 0.9394 1.7280 0.8494 0.8924 0.5173
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (2380, 25, 18)  Y_train: (2380, 6)
X_test : (3880, 25, 18)  Y_test : (3880, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:16.896576: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:16.921703: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (2380, 25, 18), Y_train = (2380, 6)
  X_test  = (3880, 25, 18),  Y_test  = (3880, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:22:17.847105: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:17.851676: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:17.852540: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:17.854112: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:17.854892: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:17.855628: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:17.930919: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:17.931844: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:17.932594: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:17.933327: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:22:18.848168: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 171ms/step - loss: 0.5826 - val_loss: 0.3808
Epoch 2/30
8/8 - 0s - 8ms/step - loss: 0.2875 - val_loss: 0.2808
Epoch 3/30
8/8 - 0s - 7ms/step - loss: 0.2343 - val_loss: 0.2579
Epoch 4/30
8/8 - 0s - 5ms/step - loss: 0.2101 - val_loss: 0.3169
Epoch 5/30
8/8 - 0s - 6ms/step - loss: 0.2039 - val_loss: 0.2751
Epoch 6/30
8/8 - 0s - 5ms/step - loss: 0.1951 - val_loss: 0.2723
Epoch 7/30
8/8 - 0s - 5ms/step - loss: 0.1912 - val_loss: 0.2822
Epoch 8/30
8/8 - 0s - 5ms/step - loss: 0.1865 - val_loss: 0.2704
Epoch 9/30
8/8 - 0s - 5ms/step - loss: 0.1827 - val_loss: 0.2770
Epoch 10/30
8/8 - 0s - 5ms/step - loss: 0.1774 - val_loss: 0.2848
Epoch 11/30
8/8 - 0s - 5ms/step - loss: 0.1811 - val_loss: 0.2861
Epoch 12/30
8/8 - 0s - 5ms/step - loss: 0.1700 - val_loss: 0.2936
Epoch 13/30
8/8 - 0s - 5ms/step - loss: 0.1715 - val_loss: 0.2997
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.0154
Per-joint RMSE: 0.5683 0.8288 1.8350 0.8821 0.8733 0.5184
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:21.073307: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:21.098470: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:22:21.964057: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:21.968750: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:21.969627: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:21.971307: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:21.972764: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:21.973608: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:22.052500: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:22.053409: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:22.054149: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:22.054877: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:22:22.353035: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.037665e+00  RMSE=1.018659e+00
  per-joint RMSE: 0.5940 0.9430 1.7821 0.8751 0.8781 0.5206
Residual LSTM:  MSE=1.031117e+00      RMSE=1.015440e+00
  per-joint RMSE: 0.5683 0.8288 1.8350 0.8821 0.8733 0.5184
Combined torque MSE=1.031117e+00     RMSE=1.015440e+00
  per-joint RMSE: 0.5683 0.8288 1.8350 0.8821 0.8733 0.5184
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (2255, 50, 24)  Y_train: (2255, 6)
X_test : (3755, 50, 24)  Y_test : (3755, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:24.250847: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:24.274579: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (2255, 50, 24), Y_train = (2255, 6)
  X_test  = (3755, 50, 24),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:22:25.239829: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:25.244370: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:25.245240: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:25.246766: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:25.247547: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:25.248273: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:25.327231: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:25.328061: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:25.328802: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:25.329534: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:22:26.229458: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 172ms/step - loss: 0.5327 - val_loss: 0.3841
Epoch 2/30
8/8 - 0s - 9ms/step - loss: 0.2149 - val_loss: 0.3833
Epoch 3/30
8/8 - 0s - 7ms/step - loss: 0.1869 - val_loss: 0.3852
Epoch 4/30
8/8 - 0s - 7ms/step - loss: 0.1670 - val_loss: 0.4272
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1585 - val_loss: 0.4126
Epoch 6/30
8/8 - 0s - 7ms/step - loss: 0.1561 - val_loss: 0.4123
Epoch 7/30
8/8 - 0s - 6ms/step - loss: 0.1531 - val_loss: 0.4161
Epoch 8/30
8/8 - 0s - 7ms/step - loss: 0.1506 - val_loss: 0.4137
Epoch 9/30
8/8 - 0s - 6ms/step - loss: 0.1488 - val_loss: 0.4194
Epoch 10/30
8/8 - 0s - 6ms/step - loss: 0.1436 - val_loss: 0.4117
Epoch 11/30
8/8 - 0s - 6ms/step - loss: 0.1454 - val_loss: 0.4305
Epoch 12/30
8/8 - 0s - 6ms/step - loss: 0.1428 - val_loss: 0.4294
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9993
Per-joint RMSE: 0.6553 1.0711 1.6319 0.8383 0.8628 0.5517
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:28.519245: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:28.543962: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:22:29.412088: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:29.416865: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:29.417663: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:29.419509: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:29.420920: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:29.421660: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:29.501352: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:29.502262: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:29.503089: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:29.503825: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:22:29.813940: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.019021e+00  RMSE=1.009466e+00
  per-joint RMSE: 0.5871 0.9497 1.7594 0.8723 0.8733 0.4985
Residual LSTM:  MSE=9.985632e-01      RMSE=9.992813e-01
  per-joint RMSE: 0.6553 1.0711 1.6319 0.8383 0.8628 0.5517
Combined torque MSE=9.985632e-01     RMSE=9.992813e-01
  per-joint RMSE: 0.6553 1.0711 1.6319 0.8383 0.8628 0.5517
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_full__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (2255, 50, 6)  Y_train: (2255, 6)
X_test : (3755, 50, 6)  Y_test : (3755, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:31.676666: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:31.700758: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (2255, 50, 6), Y_train = (2255, 6)
  X_test  = (3755, 50, 6),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:22:32.648557: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:32.653151: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:32.653950: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:32.655722: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:32.656515: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:32.657250: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:32.730160: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:32.730998: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:32.731743: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:32.732482: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:22:33.665748: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 176ms/step - loss: 0.7691 - val_loss: 0.8280
Epoch 2/30
8/8 - 0s - 9ms/step - loss: 0.3605 - val_loss: 0.7060
Epoch 3/30
8/8 - 0s - 7ms/step - loss: 0.2635 - val_loss: 0.8476
Epoch 4/30
8/8 - 0s - 7ms/step - loss: 0.1997 - val_loss: 1.0248
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1804 - val_loss: 0.7931
Epoch 6/30
8/8 - 0s - 7ms/step - loss: 0.1753 - val_loss: 0.7712
Epoch 7/30
8/8 - 0s - 7ms/step - loss: 0.1663 - val_loss: 0.9555
Epoch 8/30
8/8 - 0s - 7ms/step - loss: 0.1621 - val_loss: 1.0675
Epoch 9/30
8/8 - 0s - 7ms/step - loss: 0.1585 - val_loss: 1.1096
Epoch 10/30
8/8 - 0s - 6ms/step - loss: 0.1574 - val_loss: 1.0827
Epoch 11/30
8/8 - 0s - 6ms/step - loss: 0.1550 - val_loss: 1.0790
Epoch 12/30
8/8 - 0s - 7ms/step - loss: 0.1529 - val_loss: 1.0744
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.0291
Per-joint RMSE: 0.7476 0.8360 1.7620 0.9203 0.9091 0.5639
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:35.975924: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:36.000475: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:22:36.863660: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:36.868394: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:36.869203: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:36.870791: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:36.871887: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:36.872622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:36.950725: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:36.951565: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:36.952312: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:36.953130: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8939 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:22:37.253133: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.019021e+00  RMSE=1.009466e+00
  per-joint RMSE: 0.5871 0.9497 1.7594 0.8723 0.8733 0.4985
Residual LSTM:  MSE=1.058957e+00      RMSE=1.029056e+00
  per-joint RMSE: 0.7476 0.8360 1.7620 0.9203 0.9091 0.5639
Combined torque MSE=1.058957e+00     RMSE=1.029056e+00
  per-joint RMSE: 0.7476 0.8360 1.7620 0.9203 0.9091 0.5639
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (2255, 50, 18)  Y_train: (2255, 6)
X_test : (3755, 50, 18)  Y_test : (3755, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:39.133661: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:39.158430: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (2255, 50, 18), Y_train = (2255, 6)
  X_test  = (3755, 50, 18),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:22:40.117312: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:40.122012: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:40.122889: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:40.124554: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:40.125355: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:40.126182: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:40.205189: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:40.206181: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:40.206929: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:40.207663: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:22:41.086307: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 173ms/step - loss: 0.5729 - val_loss: 0.2326
Epoch 2/30
8/8 - 0s - 9ms/step - loss: 0.2039 - val_loss: 0.2261
Epoch 3/30
8/8 - 0s - 7ms/step - loss: 0.1821 - val_loss: 0.2285
Epoch 4/30
8/8 - 0s - 7ms/step - loss: 0.1661 - val_loss: 0.2392
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1585 - val_loss: 0.2353
Epoch 6/30
8/8 - 0s - 6ms/step - loss: 0.1531 - val_loss: 0.2551
Epoch 7/30
8/8 - 0s - 6ms/step - loss: 0.1491 - val_loss: 0.2589
Epoch 8/30
8/8 - 0s - 7ms/step - loss: 0.1489 - val_loss: 0.2653
Epoch 9/30
8/8 - 0s - 6ms/step - loss: 0.1455 - val_loss: 0.2682
Epoch 10/30
8/8 - 0s - 6ms/step - loss: 0.1450 - val_loss: 0.2678
Epoch 11/30
8/8 - 0s - 6ms/step - loss: 0.1447 - val_loss: 0.2713
Epoch 12/30
8/8 - 0s - 7ms/step - loss: 0.1414 - val_loss: 0.2842
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9751
Per-joint RMSE: 0.5541 1.0370 1.6077 0.7746 0.9061 0.5632
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:43.408938: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:43.433423: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:22:44.277610: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:44.282276: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:44.283070: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:44.284733: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:44.285527: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:44.286268: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:44.366289: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:44.367135: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:44.367876: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:44.368614: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8940 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:22:44.675555: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.019021e+00  RMSE=1.009466e+00
  per-joint RMSE: 0.5871 0.9497 1.7594 0.8723 0.8733 0.4985
Residual LSTM:  MSE=9.508663e-01      RMSE=9.751237e-01
  per-joint RMSE: 0.5541 1.0370 1.6077 0.7746 0.9061 0.5632
Combined torque MSE=9.508663e-01     RMSE=9.751237e-01
  per-joint RMSE: 0.5541 1.0370 1.6077 0.7746 0.9061 0.5632
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (2255, 50, 18)  Y_train: (2255, 6)
X_test : (3755, 50, 18)  Y_test : (3755, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:46.575385: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:46.599112: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (2255, 50, 18), Y_train = (2255, 6)
  X_test  = (3755, 50, 18),  Y_test  = (3755, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:22:47.536438: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:47.541142: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:47.542237: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:47.543843: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:47.544926: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:47.545698: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:47.618473: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:47.619309: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:47.620057: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:47.620787: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8941 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:22:48.523626: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
8/8 - 1s - 171ms/step - loss: 0.5658 - val_loss: 0.2762
Epoch 2/30
8/8 - 0s - 8ms/step - loss: 0.2356 - val_loss: 0.2499
Epoch 3/30
8/8 - 0s - 8ms/step - loss: 0.1853 - val_loss: 0.2331
Epoch 4/30
8/8 - 0s - 7ms/step - loss: 0.1708 - val_loss: 0.2506
Epoch 5/30
8/8 - 0s - 7ms/step - loss: 0.1594 - val_loss: 0.2365
Epoch 6/30
8/8 - 0s - 7ms/step - loss: 0.1558 - val_loss: 0.2387
Epoch 7/30
8/8 - 0s - 7ms/step - loss: 0.1524 - val_loss: 0.2440
Epoch 8/30
8/8 - 0s - 7ms/step - loss: 0.1482 - val_loss: 0.2417
Epoch 9/30
8/8 - 0s - 6ms/step - loss: 0.1471 - val_loss: 0.2467
Epoch 10/30
8/8 - 0s - 7ms/step - loss: 0.1436 - val_loss: 0.2462
Epoch 11/30
8/8 - 0s - 7ms/step - loss: 0.1455 - val_loss: 0.2460
Epoch 12/30
8/8 - 0s - 7ms/step - loss: 0.1392 - val_loss: 0.2480
Epoch 13/30
8/8 - 0s - 6ms/step - loss: 0.1373 - val_loss: 0.2506
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9861
Per-joint RMSE: 0.5807 0.8720 1.7226 0.8885 0.8583 0.4938
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:22:50.886087: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:22:50.910600: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p3__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 8
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:22:51.765883: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:51.770526: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:51.771397: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:51.773050: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:51.774123: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:51.774854: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:51.855735: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:51.856570: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:51.857381: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:22:51.858109: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8944 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:22:52.161613: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.019021e+00  RMSE=1.009466e+00
  per-joint RMSE: 0.5871 0.9497 1.7594 0.8723 0.8733 0.4985
Residual LSTM:  MSE=9.724557e-01      RMSE=9.861317e-01
  per-joint RMSE: 0.5807 0.8720 1.7226 0.8885 0.8583 0.4938
Combined torque MSE=9.724557e-01     RMSE=9.861317e-01
  per-joint RMSE: 0.5807 0.8720 1.7226 0.8885 0.8583 0.4938
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p3__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s1_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

