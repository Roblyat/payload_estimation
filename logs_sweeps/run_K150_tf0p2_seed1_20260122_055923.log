#################################################################################################################
### RUN: K=150 test_fraction=0.2 seed=1                                                                       ###
### npz_in=/workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz ###
#################################################################################################################

#####################
### 1) PREPROCESS ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_delan_dataset.py --qdd True --col_format wide --trajectory_amount 150 --test_fraction 0.2 --seed 1 --raw_csv /workspace/shared/data/raw/delan_UR3_Load0_combined_26.csv --out_npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Saved: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz
Trajectories: train=120 test=30
Exists: True

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=0                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz                                ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz -t structured -s 0 -r 0 --hp_preset fast_debug --epochs 400 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 400, 'lagrangian_type': <function structured_lagrangian_fn at 0x7fd3ad71c1f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz
   dt ≈ 0.027122289385805493
  dof = 6
  Train trajectories = 120
  Test trajectories  = 30
  Train samples = 58073
  Test samples  = 13048
################################################

2026-01-22 08:22:11.402292: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400 | type=structured | dof=6
################################################
2026-01-22 08:22:14.555506: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:22:14.555542: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:22:14.555548: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:22:14.555577: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:22:14.555587: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:22:14.555601: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:22:14.555639: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:22:14.555645: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:22:14.555661: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:22:14.555666: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.3s, Loss=9.80e+00, Inv=9.80e+00, For=1.57e+02, Power=2.20e+00
  [eval] test_mse=1.107e+00  (n=13048)
Epoch 00050: Time=  14.5s, Loss=2.52e+00, Inv=2.52e+00, For=8.65e+01, Power=1.09e+00
Epoch 00100: Time=  22.0s, Loss=2.26e+00, Inv=2.26e+00, For=1.05e+02, Power=9.75e-01
Epoch 00150: Time=  29.8s, Loss=2.13e+00, Inv=2.13e+00, For=1.27e+02, Power=9.29e-01
Epoch 00200: Time=  38.1s, Loss=2.05e+00, Inv=2.05e+00, For=1.42e+02, Power=9.07e-01
  [eval] test_mse=7.706e-01  (n=13048)
Epoch 00250: Time=  45.4s, Loss=2.01e+00, Inv=2.01e+00, For=1.54e+02, Power=9.03e-01
Epoch 00300: Time=  52.8s, Loss=1.98e+00, Inv=1.98e+00, For=1.61e+02, Power=8.92e-01
Epoch 00350: Time=  60.1s, Loss=1.96e+00, Inv=1.96e+00, For=1.72e+02, Power=8.89e-01
Epoch 00400: Time=  67.8s, Loss=1.94e+00, Inv=1.94e+00, For=1.79e+02, Power=8.83e-01
  [eval] test_mse=8.109e-01  (n=13048)
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400
Torque MSE  = 1.351e-01
Torque RMSE = 3.676e-01
Per-joint MSE : 1.964e-01 3.029e-01 1.103e-01 6.581e-02 6.599e-02 6.947e-02
Per-joint RMSE: 4.431e-01 5.504e-01 3.321e-01 2.565e-01 2.569e-01 2.636e-01
Comp Time per Sample = 2.151e-08s / 46495882.7Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz' ===
===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep400.jax
Detected n_dof=6 (seed=0)
2026-01-22 08:23:24.572512: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 120 trajectories
2026-01-22 08:23:25.902479: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:23:25.902495: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:23:27.493417: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:23:28.790768: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:23:28.790782: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:23:30.261723: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:23:30.261767: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:23:30.261775: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 25/120
  done 50/120
2026-01-22 08:23:31.729196: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 75/120
  done 100/120
2026-01-22 08:23:32.969291: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 120/120

Exporting split=test: 30 trajectories
  done 25/30
  done 30/30

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.npz --H 25 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.json
H=25, n_dof=6, feature_dim=24
X_train: (56455, 25, 24)  Y_train: (56455, 6)
X_test : (12664, 25, 24)  Y_test : (12664, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:23:35.472331: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:23:35.496863: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep400.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (56455, 25, 24), Y_train = (56455, 6)
  X_test  = (12664, 25, 24),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:23:36.720271: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:36.725627: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:36.726558: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:36.728230: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:36.729243: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:36.729997: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:36.815448: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:36.816313: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:36.817193: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:36.818070: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8962 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:23:37.834642: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.2821 - val_loss: 0.4067
Epoch 2/100
177/177 - 0s - 3ms/step - loss: 0.1722 - val_loss: 0.3779
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.1519 - val_loss: 0.3386
Epoch 4/100
177/177 - 0s - 3ms/step - loss: 0.1404 - val_loss: 0.3251
Epoch 5/100
177/177 - 0s - 2ms/step - loss: 0.1312 - val_loss: 0.3297
Epoch 6/100
177/177 - 1s - 3ms/step - loss: 0.1246 - val_loss: 0.3264
Epoch 7/100
177/177 - 0s - 3ms/step - loss: 0.1195 - val_loss: 0.3420
Epoch 8/100
177/177 - 0s - 3ms/step - loss: 0.1161 - val_loss: 0.3685
Epoch 9/100
177/177 - 0s - 2ms/step - loss: 0.1100 - val_loss: 0.3893
Epoch 10/100
177/177 - 0s - 3ms/step - loss: 0.1082 - val_loss: 0.3814
Epoch 11/100
177/177 - 0s - 3ms/step - loss: 0.1038 - val_loss: 0.3801
Epoch 12/100
177/177 - 0s - 2ms/step - loss: 0.1004 - val_loss: 0.4018
Epoch 13/100
177/177 - 0s - 2ms/step - loss: 0.0987 - val_loss: 0.4126
Epoch 14/100
177/177 - 0s - 2ms/step - loss: 0.0970 - val_loss: 0.3890
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2120
Per-joint RMSE: 0.2587 0.2540 0.1979 0.1449 0.1882 0.2064
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:23:45.832705: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:23:45.857802: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 08:23:46.714595: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:46.719249: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:46.720049: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:46.721821: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:46.722635: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:46.723447: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:46.800389: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:46.801227: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:46.801986: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:46.802719: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:23:47.099081: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.349558e-01  RMSE=3.673633e-01
  per-joint RMSE: 0.4437 0.5486 0.3289 0.2572 0.2586 0.2660
Residual LSTM:  MSE=4.493164e-02      RMSE=2.119709e-01
  per-joint RMSE: 0.2587 0.2540 0.1979 0.1449 0.1882 0.2064
Combined torque MSE=4.493164e-02     RMSE=2.119709e-01
  per-joint RMSE: 0.2587 0.2540 0.1979 0.1449 0.1882 0.2064
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.npz --H 25 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.json
H=25, n_dof=6, feature_dim=6
X_train: (56455, 25, 6)  Y_train: (56455, 6)
X_test : (12664, 25, 6)  Y_test : (12664, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:23:49.320033: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:23:49.344255: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep400.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (56455, 25, 6), Y_train = (56455, 6)
  X_test  = (12664, 25, 6),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:23:50.379477: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:50.384169: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:50.384951: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:50.386566: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:50.387364: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:50.388099: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:50.471807: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:50.472773: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:50.473749: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:50.474521: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:23:51.380492: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.6022 - val_loss: 0.9268
Epoch 2/100
177/177 - 0s - 2ms/step - loss: 0.3792 - val_loss: 0.9602
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.3150 - val_loss: 1.0108
Epoch 4/100
177/177 - 0s - 2ms/step - loss: 0.2775 - val_loss: 1.0307
Epoch 5/100
177/177 - 0s - 3ms/step - loss: 0.2495 - val_loss: 1.0805
Epoch 6/100
177/177 - 1s - 3ms/step - loss: 0.2047 - val_loss: 1.0797
Epoch 7/100
177/177 - 0s - 3ms/step - loss: 0.1790 - val_loss: 1.0221
Epoch 8/100
177/177 - 0s - 3ms/step - loss: 0.1826 - val_loss: 0.9841
Epoch 9/100
177/177 - 0s - 2ms/step - loss: 0.1545 - val_loss: 1.0909
Epoch 10/100
177/177 - 0s - 3ms/step - loss: 0.1467 - val_loss: 1.0900
Epoch 11/100
177/177 - 0s - 3ms/step - loss: 0.1397 - val_loss: 1.0272
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2912
Per-joint RMSE: 0.3746 0.3974 0.2649 0.2025 0.2283 0.2172
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:23:57.997658: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:23:58.022924: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 08:23:58.878202: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:58.882971: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:58.883762: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:58.885634: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:58.886430: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:58.887179: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:58.968616: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:58.969456: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:58.970290: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:23:58.971018: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:23:59.263689: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.349558e-01  RMSE=3.673633e-01
  per-joint RMSE: 0.4437 0.5486 0.3289 0.2572 0.2586 0.2660
Residual LSTM:  MSE=8.479323e-02      RMSE=2.911928e-01
  per-joint RMSE: 0.3746 0.3974 0.2649 0.2025 0.2283 0.2172
Combined torque MSE=8.479323e-02     RMSE=2.911928e-01
  per-joint RMSE: 0.3746 0.3974 0.2649 0.2025 0.2283 0.2172
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.npz --H 25 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (56455, 25, 18)  Y_train: (56455, 6)
X_test : (12664, 25, 18)  Y_test : (12664, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:24:01.565994: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:24:01.590598: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (56455, 25, 18), Y_train = (56455, 6)
  X_test  = (12664, 25, 18),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:24:02.720078: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:02.724698: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:02.725482: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:02.727024: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:02.727812: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:02.728543: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:02.808490: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:02.809377: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:02.810152: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:02.810931: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:24:03.769717: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.3170 - val_loss: 0.4592
Epoch 2/100
177/177 - 0s - 3ms/step - loss: 0.2029 - val_loss: 0.4198
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.1748 - val_loss: 0.5135
Epoch 4/100
177/177 - 0s - 2ms/step - loss: 0.1586 - val_loss: 0.4238
Epoch 5/100
177/177 - 0s - 3ms/step - loss: 0.1475 - val_loss: 0.4177
Epoch 6/100
177/177 - 0s - 3ms/step - loss: 0.1410 - val_loss: 0.5434
Epoch 7/100
177/177 - 0s - 2ms/step - loss: 0.1346 - val_loss: 0.5013
Epoch 8/100
177/177 - 0s - 2ms/step - loss: 0.1275 - val_loss: 0.4470
Epoch 9/100
177/177 - 0s - 3ms/step - loss: 0.1234 - val_loss: 0.5305
Epoch 10/100
177/177 - 0s - 2ms/step - loss: 0.1213 - val_loss: 0.5598
Epoch 11/100
177/177 - 0s - 3ms/step - loss: 0.1146 - val_loss: 0.4946
Epoch 12/100
177/177 - 0s - 3ms/step - loss: 0.1129 - val_loss: 0.5851
Epoch 13/100
177/177 - 0s - 3ms/step - loss: 0.1093 - val_loss: 0.4508
Epoch 14/100
177/177 - 0s - 3ms/step - loss: 0.1081 - val_loss: 0.5539
Epoch 15/100
177/177 - 0s - 3ms/step - loss: 0.1051 - val_loss: 0.5808
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2446
Per-joint RMSE: 0.3192 0.2755 0.1870 0.1827 0.2317 0.2431
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:24:12.166844: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:24:12.191596: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:24:13.042315: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:13.047034: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:13.047827: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:13.049461: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:13.050327: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:13.051078: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:13.130153: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:13.130996: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:13.131748: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:13.132478: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:24:13.429499: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.349558e-01  RMSE=3.673633e-01
  per-joint RMSE: 0.4437 0.5486 0.3289 0.2572 0.2586 0.2660
Residual LSTM:  MSE=5.981915e-02      RMSE=2.445795e-01
  per-joint RMSE: 0.3192 0.2755 0.1870 0.1827 0.2317 0.2431
Combined torque MSE=5.981915e-02     RMSE=2.445795e-01
  per-joint RMSE: 0.3192 0.2755 0.1870 0.1827 0.2317 0.2431
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.npz --H 25 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (56455, 25, 18)  Y_train: (56455, 6)
X_test : (12664, 25, 18)  Y_test : (12664, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:24:15.722092: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:24:15.745784: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (56455, 25, 18), Y_train = (56455, 6)
  X_test  = (12664, 25, 18),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:24:16.872537: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:16.877355: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:16.878148: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:16.879756: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:16.880542: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:16.881278: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:16.962731: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:16.963652: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:16.964391: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:16.965129: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8957 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:24:17.918866: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.2815 - val_loss: 0.3678
Epoch 2/100
177/177 - 0s - 3ms/step - loss: 0.1748 - val_loss: 0.3307
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.1531 - val_loss: 0.2970
Epoch 4/100
177/177 - 0s - 3ms/step - loss: 0.1410 - val_loss: 0.2759
Epoch 5/100
177/177 - 0s - 3ms/step - loss: 0.1329 - val_loss: 0.2777
Epoch 6/100
177/177 - 1s - 3ms/step - loss: 0.1241 - val_loss: 0.2877
Epoch 7/100
177/177 - 0s - 3ms/step - loss: 0.1176 - val_loss: 0.2969
Epoch 8/100
177/177 - 0s - 3ms/step - loss: 0.1138 - val_loss: 0.3026
Epoch 9/100
177/177 - 0s - 3ms/step - loss: 0.1111 - val_loss: 0.2805
Epoch 10/100
177/177 - 0s - 3ms/step - loss: 0.1066 - val_loss: 0.2810
Epoch 11/100
177/177 - 0s - 2ms/step - loss: 0.1043 - val_loss: 0.2792
Epoch 12/100
177/177 - 0s - 3ms/step - loss: 0.1019 - val_loss: 0.2815
Epoch 13/100
177/177 - 0s - 3ms/step - loss: 0.1005 - val_loss: 0.2772
Epoch 14/100
177/177 - 1s - 3ms/step - loss: 0.0988 - val_loss: 0.2729
Epoch 15/100
177/177 - 0s - 3ms/step - loss: 0.0959 - val_loss: 0.2682
Epoch 16/100
177/177 - 0s - 3ms/step - loss: 0.0946 - val_loss: 0.2794
Epoch 17/100
177/177 - 0s - 3ms/step - loss: 0.0924 - val_loss: 0.2787
Epoch 18/100
177/177 - 0s - 3ms/step - loss: 0.0917 - val_loss: 0.2682
Epoch 19/100
177/177 - 0s - 3ms/step - loss: 0.0905 - val_loss: 0.2690
Epoch 20/100
177/177 - 0s - 3ms/step - loss: 0.0897 - val_loss: 0.2708
Epoch 21/100
177/177 - 0s - 3ms/step - loss: 0.0877 - val_loss: 0.2616
Epoch 22/100
177/177 - 0s - 3ms/step - loss: 0.0861 - val_loss: 0.2794
Epoch 23/100
177/177 - 0s - 3ms/step - loss: 0.0865 - val_loss: 0.2687
Epoch 24/100
177/177 - 0s - 3ms/step - loss: 0.0848 - val_loss: 0.2666
Epoch 25/100
177/177 - 0s - 2ms/step - loss: 0.0832 - val_loss: 0.2657
Epoch 26/100
177/177 - 0s - 3ms/step - loss: 0.0833 - val_loss: 0.2611
Epoch 27/100
177/177 - 0s - 3ms/step - loss: 0.0819 - val_loss: 0.2588
Epoch 28/100
177/177 - 0s - 3ms/step - loss: 0.0816 - val_loss: 0.2603
Epoch 29/100
177/177 - 0s - 3ms/step - loss: 0.0810 - val_loss: 0.2664
Epoch 30/100
177/177 - 0s - 3ms/step - loss: 0.0803 - val_loss: 0.2661
Epoch 31/100
177/177 - 0s - 3ms/step - loss: 0.0800 - val_loss: 0.2678
Epoch 32/100
177/177 - 0s - 3ms/step - loss: 0.0794 - val_loss: 0.2499
Epoch 33/100
177/177 - 0s - 2ms/step - loss: 0.0784 - val_loss: 0.2601
Epoch 34/100
177/177 - 0s - 3ms/step - loss: 0.0773 - val_loss: 0.2552
Epoch 35/100
177/177 - 0s - 2ms/step - loss: 0.0767 - val_loss: 0.2645
Epoch 36/100
177/177 - 0s - 3ms/step - loss: 0.0764 - val_loss: 0.2480
Epoch 37/100
177/177 - 0s - 3ms/step - loss: 0.0746 - val_loss: 0.2604
Epoch 38/100
177/177 - 0s - 3ms/step - loss: 0.0751 - val_loss: 0.2514
Epoch 39/100
177/177 - 0s - 3ms/step - loss: 0.0747 - val_loss: 0.2505
Epoch 40/100
177/177 - 0s - 3ms/step - loss: 0.0731 - val_loss: 0.2524
Epoch 41/100
177/177 - 0s - 3ms/step - loss: 0.0731 - val_loss: 0.2597
Epoch 42/100
177/177 - 0s - 3ms/step - loss: 0.0730 - val_loss: 0.2531
Epoch 43/100
177/177 - 0s - 2ms/step - loss: 0.0722 - val_loss: 0.2558
Epoch 44/100
177/177 - 0s - 3ms/step - loss: 0.0719 - val_loss: 0.2542
Epoch 45/100
177/177 - 0s - 3ms/step - loss: 0.0708 - val_loss: 0.2522
Epoch 46/100
177/177 - 0s - 2ms/step - loss: 0.0710 - val_loss: 0.2490
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2117
Per-joint RMSE: 0.2539 0.2652 0.1799 0.1574 0.1890 0.2030
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:24:40.397842: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:24:40.422666: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:24:41.285149: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:41.289814: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:41.290760: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:41.292430: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:41.293302: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:41.294037: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:41.381615: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:41.382452: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:41.383279: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:41.384006: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8967 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:24:41.684932: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.349558e-01  RMSE=3.673633e-01
  per-joint RMSE: 0.4437 0.5486 0.3289 0.2572 0.2586 0.2660
Residual LSTM:  MSE=4.481173e-02      RMSE=2.116878e-01
  per-joint RMSE: 0.2539 0.2652 0.1799 0.1574 0.1890 0.2030
Combined torque MSE=4.481173e-02     RMSE=2.116878e-01
  per-joint RMSE: 0.2539 0.2652 0.1799 0.1574 0.1890 0.2030
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.npz --H 50 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.json
H=50, n_dof=6, feature_dim=24
X_train: (54955, 50, 24)  Y_train: (54955, 6)
X_test : (12314, 50, 24)  Y_test : (12314, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:24:44.248072: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:24:44.272159: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep400.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (54955, 50, 24), Y_train = (54955, 6)
  X_test  = (12314, 50, 24),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:24:45.701022: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:45.705930: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:45.706876: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:45.708498: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:45.709437: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:45.710315: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:45.797212: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:45.798105: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:45.798898: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:24:45.799749: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8968 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:24:46.862727: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.2897 - val_loss: 0.3978
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.1751 - val_loss: 0.4120
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.1556 - val_loss: 0.3714
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.1425 - val_loss: 0.3746
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.1334 - val_loss: 0.3590
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1273 - val_loss: 0.3505
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1217 - val_loss: 0.3446
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1179 - val_loss: 0.3367
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1152 - val_loss: 0.3349
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1105 - val_loss: 0.3225
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1081 - val_loss: 0.3515
Epoch 12/100
172/172 - 1s - 4ms/step - loss: 0.1052 - val_loss: 0.3412
Epoch 13/100
172/172 - 1s - 4ms/step - loss: 0.1023 - val_loss: 0.3424
Epoch 14/100
172/172 - 1s - 4ms/step - loss: 0.0993 - val_loss: 0.3483
Epoch 15/100
172/172 - 1s - 4ms/step - loss: 0.0960 - val_loss: 0.3356
Epoch 16/100
172/172 - 1s - 4ms/step - loss: 0.0967 - val_loss: 0.3209
Epoch 17/100
172/172 - 1s - 4ms/step - loss: 0.0936 - val_loss: 0.3289
Epoch 18/100
172/172 - 1s - 4ms/step - loss: 0.0919 - val_loss: 0.3237
Epoch 19/100
172/172 - 1s - 4ms/step - loss: 0.0899 - val_loss: 0.3495
Epoch 20/100
172/172 - 1s - 4ms/step - loss: 0.0889 - val_loss: 0.3513
Epoch 21/100
172/172 - 1s - 4ms/step - loss: 0.0877 - val_loss: 0.3521
Epoch 22/100
172/172 - 1s - 4ms/step - loss: 0.0874 - val_loss: 0.3769
Epoch 23/100
172/172 - 1s - 4ms/step - loss: 0.0861 - val_loss: 0.3507
Epoch 24/100
172/172 - 1s - 4ms/step - loss: 0.0848 - val_loss: 0.3484
Epoch 25/100
172/172 - 1s - 4ms/step - loss: 0.0834 - val_loss: 0.3566
Epoch 26/100
172/172 - 1s - 4ms/step - loss: 0.0832 - val_loss: 0.3731
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2189
Per-joint RMSE: 0.2585 0.2709 0.1808 0.1625 0.2066 0.2133
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:25:06.016649: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:25:06.042970: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 08:25:06.901737: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:06.906456: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:06.907341: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:06.909073: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:06.909976: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:06.910880: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:06.991761: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:06.992611: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:06.993356: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:06.994088: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:25:07.292589: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.347580e-01  RMSE=3.670940e-01
  per-joint RMSE: 0.4414 0.5510 0.3264 0.2548 0.2599 0.2666
Residual LSTM:  MSE=4.791695e-02      RMSE=2.188994e-01
  per-joint RMSE: 0.2585 0.2709 0.1808 0.1625 0.2066 0.2133
Combined torque MSE=4.791695e-02     RMSE=2.188994e-01
  per-joint RMSE: 0.2585 0.2709 0.1808 0.1625 0.2066 0.2133
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.npz --H 50 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.json
H=50, n_dof=6, feature_dim=6
X_train: (54955, 50, 6)  Y_train: (54955, 6)
X_test : (12314, 50, 6)  Y_test : (12314, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:25:09.591150: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:25:09.614878: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep400.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (54955, 50, 6), Y_train = (54955, 6)
  X_test  = (12314, 50, 6),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:25:10.757356: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:10.762018: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:10.762984: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:10.764857: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:10.765797: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:10.766656: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:10.852342: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:10.853232: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:10.854030: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:10.854807: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:25:11.812524: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.5667 - val_loss: 0.9221
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.3350 - val_loss: 1.0316
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.2663 - val_loss: 1.0224
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.2421 - val_loss: 0.9080
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.1881 - val_loss: 1.0075
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1675 - val_loss: 1.1792
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1637 - val_loss: 1.1365
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1555 - val_loss: 1.1064
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1489 - val_loss: 1.0994
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1457 - val_loss: 1.0983
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1398 - val_loss: 1.0862
Epoch 12/100
172/172 - 1s - 4ms/step - loss: 0.1364 - val_loss: 1.1942
Epoch 13/100
172/172 - 1s - 4ms/step - loss: 0.1352 - val_loss: 1.1409
Epoch 14/100
172/172 - 1s - 4ms/step - loss: 0.1339 - val_loss: 1.0900
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2804
Per-joint RMSE: 0.3650 0.3543 0.2383 0.1986 0.2379 0.2457
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:25:22.913193: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:25:22.937491: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 08:25:23.779657: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:23.784231: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:23.785067: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:23.786795: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:23.787638: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:23.788422: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:23.869952: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:23.870838: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:23.871624: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:23.872398: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:25:24.165149: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.347580e-01  RMSE=3.670940e-01
  per-joint RMSE: 0.4414 0.5510 0.3264 0.2548 0.2599 0.2666
Residual LSTM:  MSE=7.864869e-02      RMSE=2.804437e-01
  per-joint RMSE: 0.3650 0.3543 0.2383 0.1986 0.2379 0.2457
Combined torque MSE=7.864869e-02     RMSE=2.804437e-01
  per-joint RMSE: 0.3650 0.3543 0.2383 0.1986 0.2379 0.2457
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.npz --H 50 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (54955, 50, 18)  Y_train: (54955, 6)
X_test : (12314, 50, 18)  Y_test : (12314, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:25:26.668891: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:25:26.692512: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (54955, 50, 18), Y_train = (54955, 6)
  X_test  = (12314, 50, 18),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:25:28.030226: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:28.035033: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:28.036036: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:28.037789: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:28.038691: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:28.039427: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:28.127158: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:28.128050: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:28.128836: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:28.129623: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:25:29.172647: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.3207 - val_loss: 0.4195
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.2019 - val_loss: 0.4408
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.1747 - val_loss: 0.4148
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.1617 - val_loss: 0.4937
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.1519 - val_loss: 0.4701
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1446 - val_loss: 0.4795
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1387 - val_loss: 0.4759
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1321 - val_loss: 0.5136
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1277 - val_loss: 0.4867
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1255 - val_loss: 0.4579
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1191 - val_loss: 0.4879
Epoch 12/100
172/172 - 1s - 4ms/step - loss: 0.1144 - val_loss: 0.5375
Epoch 13/100
172/172 - 1s - 4ms/step - loss: 0.1122 - val_loss: 0.4972
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2451
Per-joint RMSE: 0.3159 0.2830 0.1923 0.1803 0.2297 0.2415
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:25:39.733898: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:25:39.758803: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:25:40.610325: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:40.614955: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:40.615840: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:40.617493: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:40.618284: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:40.619027: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:40.695539: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:40.696375: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:40.697114: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:40.697844: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:25:40.995898: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.347580e-01  RMSE=3.670940e-01
  per-joint RMSE: 0.4414 0.5510 0.3264 0.2548 0.2599 0.2666
Residual LSTM:  MSE=6.006997e-02      RMSE=2.450918e-01
  per-joint RMSE: 0.3159 0.2830 0.1923 0.1803 0.2297 0.2415
Combined torque MSE=6.006997e-02     RMSE=2.450918e-01
  per-joint RMSE: 0.3159 0.2830 0.1923 0.1803 0.2297 0.2415
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.npz --H 50 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (54955, 50, 18)  Y_train: (54955, 6)
X_test : (12314, 50, 18)  Y_test : (12314, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:25:43.472638: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:25:43.496668: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (54955, 50, 18), Y_train = (54955, 6)
  X_test  = (12314, 50, 18),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:25:44.815527: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:44.820264: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:44.821173: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:44.822836: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:44.823740: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:44.824488: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:44.910983: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:44.911875: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:44.912682: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:25:44.913475: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:25:45.964342: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.2918 - val_loss: 0.3936
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.1778 - val_loss: 0.3532
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.1565 - val_loss: 0.3151
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.1468 - val_loss: 0.3327
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.1361 - val_loss: 0.3048
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1276 - val_loss: 0.3406
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1222 - val_loss: 0.3193
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1148 - val_loss: 0.3261
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1119 - val_loss: 0.3349
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1080 - val_loss: 0.2991
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1052 - val_loss: 0.3097
Epoch 12/100
172/172 - 1s - 4ms/step - loss: 0.1038 - val_loss: 0.3287
Epoch 13/100
172/172 - 1s - 4ms/step - loss: 0.1019 - val_loss: 0.3104
Epoch 14/100
172/172 - 1s - 4ms/step - loss: 0.1002 - val_loss: 0.3041
Epoch 15/100
172/172 - 1s - 4ms/step - loss: 0.0965 - val_loss: 0.3039
Epoch 16/100
172/172 - 1s - 4ms/step - loss: 0.0961 - val_loss: 0.3152
Epoch 17/100
172/172 - 1s - 4ms/step - loss: 0.0940 - val_loss: 0.3000
Epoch 18/100
172/172 - 1s - 4ms/step - loss: 0.0925 - val_loss: 0.3048
Epoch 19/100
172/172 - 1s - 4ms/step - loss: 0.0913 - val_loss: 0.3109
Epoch 20/100
172/172 - 1s - 4ms/step - loss: 0.0895 - val_loss: 0.2767
Epoch 21/100
172/172 - 1s - 4ms/step - loss: 0.0891 - val_loss: 0.2946
Epoch 22/100
172/172 - 1s - 4ms/step - loss: 0.0875 - val_loss: 0.3027
Epoch 23/100
172/172 - 1s - 4ms/step - loss: 0.0863 - val_loss: 0.3006
Epoch 24/100
172/172 - 1s - 4ms/step - loss: 0.0860 - val_loss: 0.2766
Epoch 25/100
172/172 - 1s - 4ms/step - loss: 0.0857 - val_loss: 0.3084
Epoch 26/100
172/172 - 1s - 4ms/step - loss: 0.0836 - val_loss: 0.3041
Epoch 27/100
172/172 - 1s - 4ms/step - loss: 0.0834 - val_loss: 0.2877
Epoch 28/100
172/172 - 1s - 4ms/step - loss: 0.0821 - val_loss: 0.2863
Epoch 29/100
172/172 - 1s - 4ms/step - loss: 0.0811 - val_loss: 0.2892
Epoch 30/100
172/172 - 1s - 4ms/step - loss: 0.0804 - val_loss: 0.2902
Epoch 31/100
172/172 - 1s - 4ms/step - loss: 0.0798 - val_loss: 0.2875
Epoch 32/100
172/172 - 1s - 4ms/step - loss: 0.0786 - val_loss: 0.2850
Epoch 33/100
172/172 - 1s - 4ms/step - loss: 0.0785 - val_loss: 0.2822
Epoch 34/100
172/172 - 1s - 4ms/step - loss: 0.0774 - val_loss: 0.2833
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2105
Per-joint RMSE: 0.2689 0.2419 0.1907 0.1426 0.1877 0.2077
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:26:10.834709: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:26:10.858953: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s0_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:26:11.700112: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:26:11.704747: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:26:11.705544: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:26:11.707290: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:26:11.708078: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:26:11.708821: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:26:11.785011: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:26:11.785929: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:26:11.786747: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:26:11.787519: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:26:12.085435: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.347580e-01  RMSE=3.670940e-01
  per-joint RMSE: 0.4414 0.5510 0.3264 0.2548 0.2599 0.2666
Residual LSTM:  MSE=4.431156e-02      RMSE=2.105031e-01
  per-joint RMSE: 0.2689 0.2419 0.1907 0.1426 0.1877 0.2077
Combined torque MSE=4.431156e-02     RMSE=2.105031e-01
  per-joint RMSE: 0.2689 0.2419 0.1907 0.1426 0.1877 0.2077
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s0_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=1                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz                                ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz -t structured -s 1 -r 0 --hp_preset fast_debug --epochs 400 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 400, 'lagrangian_type': <function structured_lagrangian_fn at 0x79beb59901f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz
   dt ≈ 0.027122289385805493
  dof = 6
  Train trajectories = 120
  Test trajectories  = 30
  Train samples = 58073
  Test samples  = 13048
################################################

2026-01-22 08:26:16.611293: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400 | type=structured | dof=6
################################################
2026-01-22 08:26:19.748742: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:26:19.748777: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:26:19.748784: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:26:19.748811: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:26:19.748816: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:26:19.748831: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:26:19.748868: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:26:19.748874: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:26:19.748889: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:26:19.748894: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.1s, Loss=1.07e+01, Inv=1.07e+01, For=1.37e+02, Power=2.16e+00
  [eval] test_mse=1.261e+00  (n=13048)
Epoch 00050: Time=  14.3s, Loss=2.62e+00, Inv=2.62e+00, For=7.86e+01, Power=1.13e+00
Epoch 00100: Time=  21.6s, Loss=2.30e+00, Inv=2.30e+00, For=8.97e+01, Power=9.93e-01
Epoch 00150: Time=  29.3s, Loss=2.14e+00, Inv=2.14e+00, For=1.13e+02, Power=9.26e-01
Epoch 00200: Time=  38.0s, Loss=2.07e+00, Inv=2.07e+00, For=1.41e+02, Power=9.11e-01
  [eval] test_mse=7.199e-01  (n=13048)
Epoch 00250: Time=  45.3s, Loss=2.02e+00, Inv=2.02e+00, For=1.68e+02, Power=9.00e-01
Epoch 00300: Time=  53.1s, Loss=1.98e+00, Inv=1.98e+00, For=1.88e+02, Power=8.92e-01
Epoch 00350: Time=  61.2s, Loss=1.96e+00, Inv=1.96e+00, For=2.01e+02, Power=8.85e-01
Epoch 00400: Time=  68.9s, Loss=1.94e+00, Inv=1.94e+00, For=2.03e+02, Power=8.77e-01
  [eval] test_mse=7.070e-01  (n=13048)
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400
Torque MSE  = 1.178e-01
Torque RMSE = 3.433e-01
Per-joint MSE : 1.503e-01 3.409e-01 9.464e-02 5.931e-02 2.638e-02 3.548e-02
Per-joint RMSE: 3.877e-01 5.838e-01 3.076e-01 2.435e-01 1.624e-01 1.884e-01
Comp Time per Sample = 2.493e-08s / 40105982.3Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz' ===
===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep400.jax
Detected n_dof=6 (seed=1)
2026-01-22 08:27:30.768273: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 120 trajectories
2026-01-22 08:27:32.071261: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:27:32.071273: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:27:33.676303: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:27:34.930801: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:27:34.930815: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:27:36.340623: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:27:36.340657: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:27:36.340663: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 25/120
  done 50/120
2026-01-22 08:27:37.861747: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 75/120
  done 100/120
2026-01-22 08:27:39.079032: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 120/120

Exporting split=test: 30 trajectories
  done 25/30
  done 30/30

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.npz --H 25 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.json
H=25, n_dof=6, feature_dim=24
X_train: (56455, 25, 24)  Y_train: (56455, 6)
X_test : (12664, 25, 24)  Y_test : (12664, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:27:41.520212: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:27:41.544497: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep400.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (56455, 25, 24), Y_train = (56455, 6)
  X_test  = (12664, 25, 24),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:27:42.721362: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:42.726153: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:42.727092: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:42.728852: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:42.729771: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:42.730650: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:42.814916: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:42.815797: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:42.816678: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:42.817468: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8974 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:27:43.828818: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.2824 - val_loss: 0.4286
Epoch 2/100
177/177 - 0s - 3ms/step - loss: 0.1730 - val_loss: 0.4004
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.1510 - val_loss: 0.4020
Epoch 4/100
177/177 - 0s - 3ms/step - loss: 0.1391 - val_loss: 0.4154
Epoch 5/100
177/177 - 0s - 3ms/step - loss: 0.1317 - val_loss: 0.3825
Epoch 6/100
177/177 - 1s - 3ms/step - loss: 0.1261 - val_loss: 0.3932
Epoch 7/100
177/177 - 0s - 3ms/step - loss: 0.1212 - val_loss: 0.3734
Epoch 8/100
177/177 - 0s - 3ms/step - loss: 0.1171 - val_loss: 0.3644
Epoch 9/100
177/177 - 0s - 3ms/step - loss: 0.1110 - val_loss: 0.4119
Epoch 10/100
177/177 - 0s - 3ms/step - loss: 0.1068 - val_loss: 0.4304
Epoch 11/100
177/177 - 0s - 3ms/step - loss: 0.1045 - val_loss: 0.4325
Epoch 12/100
177/177 - 0s - 3ms/step - loss: 0.1022 - val_loss: 0.4462
Epoch 13/100
177/177 - 0s - 3ms/step - loss: 0.0986 - val_loss: 0.4266
Epoch 14/100
177/177 - 0s - 3ms/step - loss: 0.0979 - val_loss: 0.4521
Epoch 15/100
177/177 - 0s - 3ms/step - loss: 0.0961 - val_loss: 0.4294
Epoch 16/100
177/177 - 0s - 3ms/step - loss: 0.0937 - val_loss: 0.4484
Epoch 17/100
177/177 - 0s - 3ms/step - loss: 0.0937 - val_loss: 0.4364
Epoch 18/100
177/177 - 0s - 3ms/step - loss: 0.0921 - val_loss: 0.4185
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1674
Per-joint RMSE: 0.1908 0.2807 0.1389 0.1329 0.0823 0.0954
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:27:53.861156: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:27:53.886460: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 08:27:54.744507: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:54.749231: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:54.750080: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:54.751834: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:54.752682: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:54.753472: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:54.833146: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:54.834037: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:54.834837: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:54.835627: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:27:55.135023: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.170748e-01  RMSE=3.421619e-01
  per-joint RMSE: 0.3866 0.5827 0.3034 0.2438 0.1616 0.1891
Residual LSTM:  MSE=2.800994e-02      RMSE=1.673617e-01
  per-joint RMSE: 0.1908 0.2807 0.1389 0.1329 0.0823 0.0954
Combined torque MSE=2.800994e-02     RMSE=1.673617e-01
  per-joint RMSE: 0.1908 0.2807 0.1389 0.1329 0.0823 0.0954
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.npz --H 25 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.json
H=25, n_dof=6, feature_dim=6
X_train: (56455, 25, 6)  Y_train: (56455, 6)
X_test : (12664, 25, 6)  Y_test : (12664, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:27:57.412002: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:27:57.435935: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep400.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (56455, 25, 6), Y_train = (56455, 6)
  X_test  = (12664, 25, 6),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:27:58.456821: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:58.461361: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:58.462149: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:58.463794: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:58.464576: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:58.465313: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:58.540525: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:58.541360: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:58.542179: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:27:58.542907: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:27:59.472340: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.6014 - val_loss: 0.8827
Epoch 2/100
177/177 - 0s - 3ms/step - loss: 0.3823 - val_loss: 0.8616
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.3388 - val_loss: 0.8420
Epoch 4/100
177/177 - 0s - 3ms/step - loss: 0.2880 - val_loss: 0.8044
Epoch 5/100
177/177 - 0s - 3ms/step - loss: 0.2582 - val_loss: 1.0076
Epoch 6/100
177/177 - 1s - 3ms/step - loss: 0.2359 - val_loss: 0.9115
Epoch 7/100
177/177 - 0s - 3ms/step - loss: 0.2195 - val_loss: 1.0279
Epoch 8/100
177/177 - 0s - 3ms/step - loss: 0.2074 - val_loss: 1.0295
Epoch 9/100
177/177 - 0s - 2ms/step - loss: 0.1977 - val_loss: 1.0206
Epoch 10/100
177/177 - 0s - 3ms/step - loss: 0.2032 - val_loss: 1.0698
Epoch 11/100
177/177 - 0s - 3ms/step - loss: 0.2005 - val_loss: 1.0263
Epoch 12/100
177/177 - 0s - 3ms/step - loss: 0.1701 - val_loss: 1.0310
Epoch 13/100
177/177 - 0s - 3ms/step - loss: 0.1701 - val_loss: 0.9969
Epoch 14/100
177/177 - 0s - 3ms/step - loss: 0.1686 - val_loss: 0.9871
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2538
Per-joint RMSE: 0.3276 0.3870 0.2280 0.1864 0.1346 0.1565
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:28:07.485226: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:28:07.510341: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 08:28:08.361027: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:08.365639: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:08.366442: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:08.368213: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:08.369010: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:08.369749: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:08.449522: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:08.450455: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:08.451196: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:08.451926: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:28:08.745856: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.170748e-01  RMSE=3.421619e-01
  per-joint RMSE: 0.3866 0.5827 0.3034 0.2438 0.1616 0.1891
Residual LSTM:  MSE=6.441217e-02      RMSE=2.537955e-01
  per-joint RMSE: 0.3276 0.3870 0.2280 0.1864 0.1346 0.1565
Combined torque MSE=6.441217e-02     RMSE=2.537955e-01
  per-joint RMSE: 0.3276 0.3870 0.2280 0.1864 0.1346 0.1565
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.npz --H 25 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (56455, 25, 18)  Y_train: (56455, 6)
X_test : (12664, 25, 18)  Y_test : (12664, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:28:11.095213: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:28:11.119316: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (56455, 25, 18), Y_train = (56455, 6)
  X_test  = (12664, 25, 18),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:28:12.254432: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:12.259001: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:12.259791: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:12.261319: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:12.262110: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:12.262921: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:12.346861: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:12.347750: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:12.348546: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:12.349335: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:28:13.340200: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.3219 - val_loss: 0.4716
Epoch 2/100
177/177 - 0s - 3ms/step - loss: 0.2051 - val_loss: 0.4689
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.1777 - val_loss: 0.4802
Epoch 4/100
177/177 - 0s - 3ms/step - loss: 0.1596 - val_loss: 0.4777
Epoch 5/100
177/177 - 0s - 3ms/step - loss: 0.1495 - val_loss: 0.5295
Epoch 6/100
177/177 - 1s - 3ms/step - loss: 0.1386 - val_loss: 0.5322
Epoch 7/100
177/177 - 0s - 3ms/step - loss: 0.1349 - val_loss: 0.5233
Epoch 8/100
177/177 - 0s - 3ms/step - loss: 0.1271 - val_loss: 0.5602
Epoch 9/100
177/177 - 0s - 3ms/step - loss: 0.1222 - val_loss: 0.5575
Epoch 10/100
177/177 - 0s - 3ms/step - loss: 0.1189 - val_loss: 0.5855
Epoch 11/100
177/177 - 0s - 3ms/step - loss: 0.1134 - val_loss: 0.5714
Epoch 12/100
177/177 - 0s - 3ms/step - loss: 0.1142 - val_loss: 0.5791
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2019
Per-joint RMSE: 0.2307 0.3457 0.1620 0.1499 0.0990 0.1153
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:28:20.470043: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:28:20.494853: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:28:21.354747: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:21.359334: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:21.360210: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:21.361829: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:21.362622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:21.363352: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:21.445774: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:21.446682: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:21.447430: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:21.448163: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:28:21.742160: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.170748e-01  RMSE=3.421619e-01
  per-joint RMSE: 0.3866 0.5827 0.3034 0.2438 0.1616 0.1891
Residual LSTM:  MSE=4.075649e-02      RMSE=2.018824e-01
  per-joint RMSE: 0.2307 0.3457 0.1620 0.1499 0.0990 0.1153
Combined torque MSE=4.075649e-02     RMSE=2.018824e-01
  per-joint RMSE: 0.2307 0.3457 0.1620 0.1499 0.0990 0.1153
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.npz --H 25 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (56455, 25, 18)  Y_train: (56455, 6)
X_test : (12664, 25, 18)  Y_test : (12664, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:28:24.041041: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:28:24.064885: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (56455, 25, 18), Y_train = (56455, 6)
  X_test  = (12664, 25, 18),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:28:25.207611: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:25.212068: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:25.212856: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:25.214572: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:25.215362: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:25.216101: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:25.290348: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:25.291179: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:25.291926: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:25.292662: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:28:26.270934: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.2864 - val_loss: 0.3358
Epoch 2/100
177/177 - 0s - 3ms/step - loss: 0.1758 - val_loss: 0.3342
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.1540 - val_loss: 0.3176
Epoch 4/100
177/177 - 0s - 3ms/step - loss: 0.1411 - val_loss: 0.3077
Epoch 5/100
177/177 - 0s - 3ms/step - loss: 0.1337 - val_loss: 0.3100
Epoch 6/100
177/177 - 1s - 3ms/step - loss: 0.1241 - val_loss: 0.3240
Epoch 7/100
177/177 - 0s - 3ms/step - loss: 0.1192 - val_loss: 0.3374
Epoch 8/100
177/177 - 0s - 3ms/step - loss: 0.1136 - val_loss: 0.3329
Epoch 9/100
177/177 - 0s - 3ms/step - loss: 0.1104 - val_loss: 0.3416
Epoch 10/100
177/177 - 0s - 3ms/step - loss: 0.1073 - val_loss: 0.3323
Epoch 11/100
177/177 - 0s - 3ms/step - loss: 0.1043 - val_loss: 0.3133
Epoch 12/100
177/177 - 0s - 3ms/step - loss: 0.1027 - val_loss: 0.3191
Epoch 13/100
177/177 - 0s - 3ms/step - loss: 0.1007 - val_loss: 0.3396
Epoch 14/100
177/177 - 0s - 3ms/step - loss: 0.0990 - val_loss: 0.3321
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1780
Per-joint RMSE: 0.1951 0.3075 0.1472 0.1340 0.0844 0.1032
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:28:34.399839: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:28:34.424834: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:28:35.267737: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:35.272424: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:35.273211: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:35.274868: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:35.275653: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:35.276376: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:35.361714: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:35.362625: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:35.363363: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:35.364090: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8971 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:28:35.661248: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.170748e-01  RMSE=3.421619e-01
  per-joint RMSE: 0.3866 0.5827 0.3034 0.2438 0.1616 0.1891
Residual LSTM:  MSE=3.167436e-02      RMSE=1.779729e-01
  per-joint RMSE: 0.1951 0.3075 0.1472 0.1340 0.0844 0.1032
Combined torque MSE=3.167436e-02     RMSE=1.779729e-01
  per-joint RMSE: 0.1951 0.3075 0.1472 0.1340 0.0844 0.1032
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.npz --H 50 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.json
H=50, n_dof=6, feature_dim=24
X_train: (54955, 50, 24)  Y_train: (54955, 6)
X_test : (12314, 50, 24)  Y_test : (12314, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:28:38.191692: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:28:38.215423: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep400.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (54955, 50, 24), Y_train = (54955, 6)
  X_test  = (12314, 50, 24),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:28:39.630514: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:39.635434: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:39.636367: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:39.638172: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:39.639098: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:39.639976: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:39.740857: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:39.741873: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:39.742666: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:39.743471: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8968 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:28:40.778475: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.2819 - val_loss: 0.3300
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.1769 - val_loss: 0.3237
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.1546 - val_loss: 0.3317
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.1430 - val_loss: 0.3214
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.1354 - val_loss: 0.3260
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1277 - val_loss: 0.3319
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1220 - val_loss: 0.3290
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1187 - val_loss: 0.2985
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1154 - val_loss: 0.2913
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1097 - val_loss: 0.3152
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1068 - val_loss: 0.3450
Epoch 12/100
172/172 - 1s - 4ms/step - loss: 0.1035 - val_loss: 0.3513
Epoch 13/100
172/172 - 1s - 4ms/step - loss: 0.1012 - val_loss: 0.3452
Epoch 14/100
172/172 - 1s - 4ms/step - loss: 0.0977 - val_loss: 0.3429
Epoch 15/100
172/172 - 1s - 4ms/step - loss: 0.0965 - val_loss: 0.3503
Epoch 16/100
172/172 - 1s - 4ms/step - loss: 0.0941 - val_loss: 0.3384
Epoch 17/100
172/172 - 1s - 4ms/step - loss: 0.0931 - val_loss: 0.3553
Epoch 18/100
172/172 - 1s - 4ms/step - loss: 0.0914 - val_loss: 0.3459
Epoch 19/100
172/172 - 1s - 4ms/step - loss: 0.0902 - val_loss: 0.3624
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1687
Per-joint RMSE: 0.1952 0.2819 0.1366 0.1380 0.0818 0.0932
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:28:55.276634: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:28:55.300784: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 08:28:56.165509: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:56.170046: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:56.170842: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:56.172601: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:56.173396: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:56.174143: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:56.253210: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:56.254048: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:56.254799: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:28:56.255528: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:28:56.549135: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.171489e-01  RMSE=3.422702e-01
  per-joint RMSE: 0.3847 0.5863 0.3032 0.2418 0.1601 0.1873
Residual LSTM:  MSE=2.844690e-02      RMSE=1.686621e-01
  per-joint RMSE: 0.1952 0.2819 0.1366 0.1380 0.0818 0.0932
Combined torque MSE=2.844690e-02     RMSE=1.686621e-01
  per-joint RMSE: 0.1952 0.2819 0.1366 0.1380 0.0818 0.0932
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.npz --H 50 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.json
H=50, n_dof=6, feature_dim=6
X_train: (54955, 50, 6)  Y_train: (54955, 6)
X_test : (12314, 50, 6)  Y_test : (12314, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:28:58.894674: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:28:58.919148: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep400.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (54955, 50, 6), Y_train = (54955, 6)
  X_test  = (12314, 50, 6),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:29:00.063050: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:00.067611: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:00.068405: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:00.069914: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:00.072499: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:00.073238: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:00.157522: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:00.158419: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:00.159217: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:00.160012: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:29:01.117661: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.5520 - val_loss: 1.0628
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.3378 - val_loss: 1.0103
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.2851 - val_loss: 1.1326
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.2529 - val_loss: 1.3001
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.2268 - val_loss: 1.1615
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1792 - val_loss: 1.2338
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1645 - val_loss: 1.2281
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1525 - val_loss: 1.3040
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1519 - val_loss: 1.1292
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1504 - val_loss: 1.2367
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1387 - val_loss: 1.3126
Epoch 12/100
172/172 - 1s - 4ms/step - loss: 0.1358 - val_loss: 1.2476
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2711
Per-joint RMSE: 0.3554 0.4234 0.2249 0.2010 0.1310 0.1650
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:29:10.757487: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:29:10.782190: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 08:29:11.658340: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:11.663042: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:11.663934: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:11.665561: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:11.666353: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:11.667093: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:11.749921: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:11.750835: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:11.751664: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:11.752390: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8971 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:29:12.041813: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.171489e-01  RMSE=3.422702e-01
  per-joint RMSE: 0.3847 0.5863 0.3032 0.2418 0.1601 0.1873
Residual LSTM:  MSE=7.349809e-02      RMSE=2.711053e-01
  per-joint RMSE: 0.3554 0.4234 0.2249 0.2010 0.1310 0.1650
Combined torque MSE=7.349809e-02     RMSE=2.711053e-01
  per-joint RMSE: 0.3554 0.4234 0.2249 0.2010 0.1310 0.1650
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.npz --H 50 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (54955, 50, 18)  Y_train: (54955, 6)
X_test : (12314, 50, 18)  Y_test : (12314, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:29:14.513630: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:29:14.537169: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (54955, 50, 18), Y_train = (54955, 6)
  X_test  = (12314, 50, 18),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:29:15.866544: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:15.871335: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:15.872369: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:15.874159: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:15.875066: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:15.875935: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:15.967040: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:15.968021: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:15.968915: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:15.969764: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:29:16.978765: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.3222 - val_loss: 0.4880
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.2064 - val_loss: 0.5040
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.1780 - val_loss: 0.4871
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.1637 - val_loss: 0.5038
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.1535 - val_loss: 0.5315
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1458 - val_loss: 0.4803
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1388 - val_loss: 0.4750
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1323 - val_loss: 0.4730
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1271 - val_loss: 0.5457
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1263 - val_loss: 0.4771
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1225 - val_loss: 0.5441
Epoch 12/100
172/172 - 1s - 4ms/step - loss: 0.1156 - val_loss: 0.5398
Epoch 13/100
172/172 - 1s - 4ms/step - loss: 0.1115 - val_loss: 0.5301
Epoch 14/100
172/172 - 1s - 4ms/step - loss: 0.1105 - val_loss: 0.5342
Epoch 15/100
172/172 - 1s - 4ms/step - loss: 0.1080 - val_loss: 0.5302
Epoch 16/100
172/172 - 1s - 4ms/step - loss: 0.1058 - val_loss: 0.5212
Epoch 17/100
172/172 - 1s - 4ms/step - loss: 0.1046 - val_loss: 0.5308
Epoch 18/100
172/172 - 1s - 4ms/step - loss: 0.1024 - val_loss: 0.5201
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1933
Per-joint RMSE: 0.2204 0.3343 0.1516 0.1435 0.0915 0.1091
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:29:30.816086: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:29:30.841530: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:29:31.690759: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:31.695371: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:31.696215: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:31.697956: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:31.698810: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:31.699607: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:31.782648: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:31.783627: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:31.784412: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:31.785196: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:29:32.078836: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.171489e-01  RMSE=3.422702e-01
  per-joint RMSE: 0.3847 0.5863 0.3032 0.2418 0.1601 0.1873
Residual LSTM:  MSE=3.735908e-02      RMSE=1.932850e-01
  per-joint RMSE: 0.2204 0.3343 0.1516 0.1435 0.0915 0.1091
Combined torque MSE=3.735908e-02     RMSE=1.932850e-01
  per-joint RMSE: 0.2204 0.3343 0.1516 0.1435 0.0915 0.1091
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.npz --H 50 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (54955, 50, 18)  Y_train: (54955, 6)
X_test : (12314, 50, 18)  Y_test : (12314, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:29:34.572065: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:29:34.596236: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (54955, 50, 18), Y_train = (54955, 6)
  X_test  = (12314, 50, 18),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:29:35.927666: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:35.932577: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:35.933498: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:35.935364: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:35.936286: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:35.937235: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:36.020612: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:36.021526: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:36.022545: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:36.023459: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:29:37.014367: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.2912 - val_loss: 0.3388
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.1777 - val_loss: 0.3246
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.1572 - val_loss: 0.3061
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.1447 - val_loss: 0.3174
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.1353 - val_loss: 0.3582
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1280 - val_loss: 0.3252
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1198 - val_loss: 0.3409
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1161 - val_loss: 0.2980
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1116 - val_loss: 0.3153
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1078 - val_loss: 0.3320
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1051 - val_loss: 0.3408
Epoch 12/100
172/172 - 1s - 4ms/step - loss: 0.1028 - val_loss: 0.3296
Epoch 13/100
172/172 - 1s - 4ms/step - loss: 0.1015 - val_loss: 0.3379
Epoch 14/100
172/172 - 1s - 4ms/step - loss: 0.0987 - val_loss: 0.3299
Epoch 15/100
172/172 - 1s - 4ms/step - loss: 0.0967 - val_loss: 0.3338
Epoch 16/100
172/172 - 1s - 4ms/step - loss: 0.0954 - val_loss: 0.3263
Epoch 17/100
172/172 - 1s - 4ms/step - loss: 0.0943 - val_loss: 0.3136
Epoch 18/100
172/172 - 1s - 4ms/step - loss: 0.0919 - val_loss: 0.3273
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1743
Per-joint RMSE: 0.2028 0.2952 0.1420 0.1307 0.0843 0.0985
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:29:50.766731: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:29:50.791323: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s1_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:29:51.640231: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:51.644887: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:51.645847: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:51.647608: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:51.648404: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:51.649154: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:51.726693: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:51.727533: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:51.728280: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:29:51.729010: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:29:52.021707: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.171489e-01  RMSE=3.422702e-01
  per-joint RMSE: 0.3847 0.5863 0.3032 0.2418 0.1601 0.1873
Residual LSTM:  MSE=3.039347e-02      RMSE=1.743372e-01
  per-joint RMSE: 0.2028 0.2952 0.1420 0.1307 0.0843 0.0985
Combined torque MSE=3.039347e-02     RMSE=1.743372e-01
  per-joint RMSE: 0.2028 0.2952 0.1420 0.1307 0.0843 0.0985
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s1_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=2                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz                                ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz -t structured -s 2 -r 0 --hp_preset fast_debug --epochs 400 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 400, 'lagrangian_type': <function structured_lagrangian_fn at 0x7f647e41c1f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz
   dt ≈ 0.027122289385805493
  dof = 6
  Train trajectories = 120
  Test trajectories  = 30
  Train samples = 58073
  Test samples  = 13048
################################################

2026-01-22 08:29:56.570220: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400 | type=structured | dof=6
################################################
2026-01-22 08:29:59.748312: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:29:59.748350: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:29:59.748356: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:29:59.748385: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:29:59.748391: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:29:59.748406: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:29:59.748455: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:29:59.748461: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:29:59.748477: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:29:59.748483: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.1s, Loss=8.77e+00, Inv=8.77e+00, For=1.04e+02, Power=2.18e+00
  [eval] test_mse=1.087e+00  (n=13048)
Epoch 00050: Time=  14.5s, Loss=2.57e+00, Inv=2.57e+00, For=8.16e+01, Power=1.12e+00
Epoch 00100: Time=  22.8s, Loss=2.29e+00, Inv=2.29e+00, For=9.09e+01, Power=9.94e-01
Epoch 00150: Time=  30.6s, Loss=2.15e+00, Inv=2.15e+00, For=1.05e+02, Power=9.36e-01
Epoch 00200: Time=  38.4s, Loss=2.07e+00, Inv=2.07e+00, For=1.23e+02, Power=9.02e-01
  [eval] test_mse=6.787e-01  (n=13048)
Epoch 00250: Time=  46.7s, Loss=2.01e+00, Inv=2.01e+00, For=1.36e+02, Power=8.89e-01
Epoch 00300: Time=  53.9s, Loss=1.98e+00, Inv=1.98e+00, For=1.46e+02, Power=8.89e-01
Epoch 00350: Time=  61.3s, Loss=1.96e+00, Inv=1.96e+00, For=1.61e+02, Power=8.87e-01
Epoch 00400: Time=  69.5s, Loss=1.94e+00, Inv=1.94e+00, For=1.79e+02, Power=8.73e-01
  [eval] test_mse=7.424e-01  (n=13048)
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400
Torque MSE  = 1.237e-01
Torque RMSE = 3.518e-01
Per-joint MSE : 1.786e-01 3.009e-01 1.133e-01 5.733e-02 5.000e-02 4.234e-02
Per-joint RMSE: 4.226e-01 5.485e-01 3.366e-01 2.394e-01 2.236e-01 2.058e-01
Comp Time per Sample = 2.520e-08s / 39679113.0Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz' ===
===================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K150_tf0p2_seed1_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep400.jax
Detected n_dof=6 (seed=2)
2026-01-22 08:31:11.429631: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 120 trajectories
2026-01-22 08:31:12.746871: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:31:12.746882: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:31:14.304966: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:31:15.605484: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:31:15.605505: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:31:17.082103: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:31:17.082137: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 08:31:17.082142: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 25/120
  done 50/120
2026-01-22 08:31:18.608038: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 75/120
  done 100/120
2026-01-22 08:31:19.811080: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 120/120

Exporting split=test: 30 trajectories
  done 25/30
  done 30/30

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.npz --H 25 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.json
H=25, n_dof=6, feature_dim=24
X_train: (56455, 25, 24)  Y_train: (56455, 6)
X_test : (12664, 25, 24)  Y_test : (12664, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:31:22.189725: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:31:22.213929: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep400.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (56455, 25, 24), Y_train = (56455, 6)
  X_test  = (12664, 25, 24),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:31:23.394918: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:23.399774: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:23.400773: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:23.402567: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:23.403501: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:23.404268: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:23.487539: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:23.488501: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:23.489386: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:23.490179: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8974 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:31:24.489918: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.2835 - val_loss: 0.4659
Epoch 2/100
177/177 - 0s - 3ms/step - loss: 0.1733 - val_loss: 0.4003
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.1508 - val_loss: 0.3853
Epoch 4/100
177/177 - 0s - 3ms/step - loss: 0.1395 - val_loss: 0.3692
Epoch 5/100
177/177 - 0s - 3ms/step - loss: 0.1321 - val_loss: 0.3388
Epoch 6/100
177/177 - 1s - 3ms/step - loss: 0.1263 - val_loss: 0.3588
Epoch 7/100
177/177 - 0s - 3ms/step - loss: 0.1210 - val_loss: 0.3397
Epoch 8/100
177/177 - 0s - 3ms/step - loss: 0.1163 - val_loss: 0.3685
Epoch 9/100
177/177 - 0s - 3ms/step - loss: 0.1150 - val_loss: 0.3831
Epoch 10/100
177/177 - 0s - 3ms/step - loss: 0.1093 - val_loss: 0.3388
Epoch 11/100
177/177 - 0s - 3ms/step - loss: 0.1081 - val_loss: 0.3982
Epoch 12/100
177/177 - 0s - 3ms/step - loss: 0.1067 - val_loss: 0.4013
Epoch 13/100
177/177 - 0s - 3ms/step - loss: 0.1013 - val_loss: 0.3818
Epoch 14/100
177/177 - 0s - 3ms/step - loss: 0.0976 - val_loss: 0.3849
Epoch 15/100
177/177 - 0s - 3ms/step - loss: 0.0957 - val_loss: 0.3759
Epoch 16/100
177/177 - 0s - 3ms/step - loss: 0.0941 - val_loss: 0.3667
Epoch 17/100
177/177 - 0s - 3ms/step - loss: 0.0922 - val_loss: 0.3564
Epoch 18/100
177/177 - 0s - 3ms/step - loss: 0.0919 - val_loss: 0.3666
Epoch 19/100
177/177 - 0s - 3ms/step - loss: 0.0908 - val_loss: 0.3468
Epoch 20/100
177/177 - 0s - 3ms/step - loss: 0.0896 - val_loss: 0.3645
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1958
Per-joint RMSE: 0.2551 0.2444 0.2106 0.1294 0.1611 0.1348
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:31:35.412117: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:31:35.437178: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 08:31:36.292591: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:36.297293: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:36.298104: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:36.299798: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:36.300594: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:36.301325: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:36.383704: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:36.384536: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:36.385311: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:36.386161: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:31:36.682959: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.231392e-01  RMSE=3.509119e-01
  per-joint RMSE: 0.4225 0.5462 0.3336 0.2398 0.2242 0.2070
Residual LSTM:  MSE=3.833777e-02      RMSE=1.958003e-01
  per-joint RMSE: 0.2551 0.2444 0.2106 0.1294 0.1611 0.1348
Combined torque MSE=3.833777e-02     RMSE=1.958003e-01
  per-joint RMSE: 0.2551 0.2444 0.2106 0.1294 0.1611 0.1348
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.npz --H 25 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.json
H=25, n_dof=6, feature_dim=6
X_train: (56455, 25, 6)  Y_train: (56455, 6)
X_test : (12664, 25, 6)  Y_test : (12664, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:31:38.898894: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:31:38.923292: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep400.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (56455, 25, 6), Y_train = (56455, 6)
  X_test  = (12664, 25, 6),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:31:39.953497: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:39.957995: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:39.958781: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:39.960409: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:39.961190: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:39.961918: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:40.048774: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:40.049760: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:40.050561: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:40.051363: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:31:40.960271: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.6030 - val_loss: 0.9030
Epoch 2/100
177/177 - 0s - 3ms/step - loss: 0.3862 - val_loss: 0.9006
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.3264 - val_loss: 0.9039
Epoch 4/100
177/177 - 0s - 2ms/step - loss: 0.2882 - val_loss: 0.9352
Epoch 5/100
177/177 - 0s - 2ms/step - loss: 0.2594 - val_loss: 0.9928
Epoch 6/100
177/177 - 1s - 3ms/step - loss: 0.2376 - val_loss: 1.0362
Epoch 7/100
177/177 - 0s - 2ms/step - loss: 0.2060 - val_loss: 1.1624
Epoch 8/100
177/177 - 0s - 2ms/step - loss: 0.1866 - val_loss: 1.1682
Epoch 9/100
177/177 - 0s - 2ms/step - loss: 0.1762 - val_loss: 1.2009
Epoch 10/100
177/177 - 0s - 2ms/step - loss: 0.1646 - val_loss: 1.1030
Epoch 11/100
177/177 - 0s - 3ms/step - loss: 0.1578 - val_loss: 1.1174
Epoch 12/100
177/177 - 0s - 3ms/step - loss: 0.1522 - val_loss: 1.2042
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2610
Per-joint RMSE: 0.3458 0.3452 0.2739 0.1757 0.1783 0.1799
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:31:47.972018: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:31:47.996665: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 08:31:48.845605: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:48.850252: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:48.851042: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:48.852784: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:48.853580: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:48.854307: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:48.937458: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:48.938292: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:48.939115: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:48.939845: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:31:49.235110: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.231392e-01  RMSE=3.509119e-01
  per-joint RMSE: 0.4225 0.5462 0.3336 0.2398 0.2242 0.2070
Residual LSTM:  MSE=6.812703e-02      RMSE=2.610115e-01
  per-joint RMSE: 0.3458 0.3452 0.2739 0.1757 0.1783 0.1799
Combined torque MSE=6.812704e-02     RMSE=2.610116e-01
  per-joint RMSE: 0.3458 0.3452 0.2739 0.1757 0.1783 0.1799
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.npz --H 25 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (56455, 25, 18)  Y_train: (56455, 6)
X_test : (12664, 25, 18)  Y_test : (12664, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:31:51.580515: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:31:51.605056: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (56455, 25, 18), Y_train = (56455, 6)
  X_test  = (12664, 25, 18),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:31:52.736945: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:52.742044: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:52.743045: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:52.744649: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:52.745559: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:52.746299: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:52.827512: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:52.828401: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:52.829198: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:31:52.829983: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:31:53.770440: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.3274 - val_loss: 0.5534
Epoch 2/100
177/177 - 0s - 3ms/step - loss: 0.2118 - val_loss: 0.5233
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.1833 - val_loss: 0.4662
Epoch 4/100
177/177 - 0s - 3ms/step - loss: 0.1648 - val_loss: 0.4741
Epoch 5/100
177/177 - 0s - 3ms/step - loss: 0.1514 - val_loss: 0.5339
Epoch 6/100
177/177 - 1s - 3ms/step - loss: 0.1417 - val_loss: 0.5542
Epoch 7/100
177/177 - 0s - 3ms/step - loss: 0.1357 - val_loss: 0.5119
Epoch 8/100
177/177 - 0s - 3ms/step - loss: 0.1305 - val_loss: 0.5882
Epoch 9/100
177/177 - 0s - 3ms/step - loss: 0.1270 - val_loss: 0.5446
Epoch 10/100
177/177 - 0s - 3ms/step - loss: 0.1213 - val_loss: 0.5494
Epoch 11/100
177/177 - 0s - 3ms/step - loss: 0.1188 - val_loss: 0.5079
Epoch 12/100
177/177 - 0s - 3ms/step - loss: 0.1156 - val_loss: 0.5802
Epoch 13/100
177/177 - 0s - 3ms/step - loss: 0.1099 - val_loss: 0.5352
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2185
Per-joint RMSE: 0.2947 0.2786 0.2192 0.1415 0.1761 0.1514
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:32:01.408125: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:32:01.433546: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:32:02.290536: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:02.295210: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:02.296005: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:02.297843: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:02.298636: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:02.299385: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:02.389576: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:02.390409: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:02.391146: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:02.391875: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:32:02.699984: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.231392e-01  RMSE=3.509119e-01
  per-joint RMSE: 0.4225 0.5462 0.3336 0.2398 0.2242 0.2070
Residual LSTM:  MSE=4.774698e-02      RMSE=2.185108e-01
  per-joint RMSE: 0.2947 0.2786 0.2192 0.1415 0.1761 0.1514
Combined torque MSE=4.774698e-02     RMSE=2.185108e-01
  per-joint RMSE: 0.2947 0.2786 0.2192 0.1415 0.1761 0.1514
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.npz --H 25 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.json
H=25, n_dof=6, feature_dim=18
X_train: (56455, 25, 18)  Y_train: (56455, 6)
X_test : (12664, 25, 18)  Y_test : (12664, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:32:04.989000: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:32:05.012930: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (56455, 25, 18), Y_train = (56455, 6)
  X_test  = (12664, 25, 18),  Y_test  = (12664, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:32:06.136248: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:06.140834: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:06.141619: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:06.143237: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:06.144020: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:06.144807: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:06.219189: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:06.220020: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:06.220764: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:06.221496: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:32:07.176885: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
177/177 - 2s - 10ms/step - loss: 0.2887 - val_loss: 0.3332
Epoch 2/100
177/177 - 0s - 3ms/step - loss: 0.1770 - val_loss: 0.3072
Epoch 3/100
177/177 - 0s - 3ms/step - loss: 0.1537 - val_loss: 0.3330
Epoch 4/100
177/177 - 0s - 3ms/step - loss: 0.1395 - val_loss: 0.4389
Epoch 5/100
177/177 - 0s - 2ms/step - loss: 0.1291 - val_loss: 0.3579
Epoch 6/100
177/177 - 1s - 3ms/step - loss: 0.1219 - val_loss: 0.4550
Epoch 7/100
177/177 - 0s - 2ms/step - loss: 0.1174 - val_loss: 0.4088
Epoch 8/100
177/177 - 0s - 2ms/step - loss: 0.1137 - val_loss: 0.4792
Epoch 9/100
177/177 - 0s - 3ms/step - loss: 0.1110 - val_loss: 0.4829
Epoch 10/100
177/177 - 0s - 3ms/step - loss: 0.1076 - val_loss: 0.4401
Epoch 11/100
177/177 - 0s - 3ms/step - loss: 0.1043 - val_loss: 0.4290
Epoch 12/100
177/177 - 0s - 3ms/step - loss: 0.1025 - val_loss: 0.5130
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2092
Per-joint RMSE: 0.2722 0.2798 0.2127 0.1327 0.1668 0.1400
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:32:14.262531: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:32:14.287246: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:32:15.160180: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:15.164905: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:15.165700: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:15.167289: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:15.168075: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:15.168813: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:15.251064: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:15.251892: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:15.252723: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:15.253455: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:32:15.549508: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.231392e-01  RMSE=3.509119e-01
  per-joint RMSE: 0.4225 0.5462 0.3336 0.2398 0.2242 0.2070
Residual LSTM:  MSE=4.378105e-02      RMSE=2.092392e-01
  per-joint RMSE: 0.2722 0.2798 0.2127 0.1327 0.1668 0.1400
Combined torque MSE=4.378105e-02     RMSE=2.092392e-01
  per-joint RMSE: 0.2722 0.2798 0.2127 0.1327 0.1668 0.1400
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H25_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.npz --H 50 --features full' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.json
H=50, n_dof=6, feature_dim=24
X_train: (54955, 50, 24)  Y_train: (54955, 6)
X_test : (12314, 50, 24)  Y_test : (12314, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:32:18.086160: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:32:18.109852: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep400.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (54955, 50, 24), Y_train = (54955, 6)
  X_test  = (12314, 50, 24),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:32:19.525622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:19.530325: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:19.531227: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:19.532994: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:19.533898: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:19.534763: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:19.634224: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:19.635099: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:19.635905: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:19.636700: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8968 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:32:20.681817: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.2892 - val_loss: 0.3397
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.1752 - val_loss: 0.3169
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.1552 - val_loss: 0.3157
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.1432 - val_loss: 0.3096
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.1340 - val_loss: 0.3116
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1286 - val_loss: 0.2913
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1223 - val_loss: 0.2903
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1200 - val_loss: 0.3079
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1155 - val_loss: 0.3029
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1120 - val_loss: 0.3041
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1089 - val_loss: 0.2821
Epoch 12/100
172/172 - 1s - 4ms/step - loss: 0.1076 - val_loss: 0.3010
Epoch 13/100
172/172 - 1s - 4ms/step - loss: 0.1027 - val_loss: 0.3349
Epoch 14/100
172/172 - 1s - 4ms/step - loss: 0.0988 - val_loss: 0.3102
Epoch 15/100
172/172 - 1s - 4ms/step - loss: 0.0969 - val_loss: 0.3154
Epoch 16/100
172/172 - 1s - 4ms/step - loss: 0.0944 - val_loss: 0.3113
Epoch 17/100
172/172 - 1s - 4ms/step - loss: 0.0930 - val_loss: 0.3123
Epoch 18/100
172/172 - 1s - 4ms/step - loss: 0.0927 - val_loss: 0.3165
Epoch 19/100
172/172 - 1s - 4ms/step - loss: 0.0910 - val_loss: 0.3203
Epoch 20/100
172/172 - 1s - 4ms/step - loss: 0.0891 - val_loss: 0.3245
Epoch 21/100
172/172 - 1s - 4ms/step - loss: 0.0873 - val_loss: 0.3261
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.1996
Per-joint RMSE: 0.2604 0.2557 0.2049 0.1385 0.1593 0.1391
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:32:36.456188: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:32:36.481159: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 08:32:37.337936: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:37.342528: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:37.343328: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:37.345091: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:37.345882: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:37.346617: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:37.430486: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:37.431409: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:37.432156: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:37.432893: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:32:37.732639: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.227301e-01  RMSE=3.503286e-01
  per-joint RMSE: 0.4194 0.5487 0.3327 0.2384 0.2230 0.2054
Residual LSTM:  MSE=3.985205e-02      RMSE=1.996298e-01
  per-joint RMSE: 0.2604 0.2557 0.2049 0.1385 0.1593 0.1391
Combined torque MSE=3.985205e-02     RMSE=1.996298e-01
  per-joint RMSE: 0.2604 0.2557 0.2049 0.1385 0.1593 0.1391
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_full__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.npz --H 50 --features tau_hat' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.json
H=50, n_dof=6, feature_dim=6
X_train: (54955, 50, 6)  Y_train: (54955, 6)
X_test : (12314, 50, 6)  Y_test : (12314, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:32:40.004822: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:32:40.029125: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep400.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (54955, 50, 6), Y_train = (54955, 6)
  X_test  = (12314, 50, 6),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:32:41.155799: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:41.160557: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:41.161406: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:41.163092: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:41.163882: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:41.164631: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:41.247310: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:41.248211: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:41.249016: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:41.249857: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:32:42.204391: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.5572 - val_loss: 0.9195
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.3456 - val_loss: 1.0032
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.2729 - val_loss: 0.9560
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.2423 - val_loss: 1.1006
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.1851 - val_loss: 1.0567
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1662 - val_loss: 1.1112
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1556 - val_loss: 1.0869
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1552 - val_loss: 1.0791
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1671 - val_loss: 1.2631
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1438 - val_loss: 1.1314
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1396 - val_loss: 1.1427
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2667
Per-joint RMSE: 0.3452 0.3851 0.2381 0.1847 0.1942 0.1757
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:32:51.165686: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:32:51.190833: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 08:32:52.050780: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:52.055552: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:52.056372: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:52.058197: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:52.058997: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:52.059739: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:52.139615: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:52.140450: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:52.141285: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:52.142025: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:32:52.440529: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.227301e-01  RMSE=3.503286e-01
  per-joint RMSE: 0.4194 0.5487 0.3327 0.2384 0.2230 0.2054
Residual LSTM:  MSE=7.113972e-02      RMSE=2.667203e-01
  per-joint RMSE: 0.3452 0.3851 0.2381 0.1847 0.1942 0.1757
Combined torque MSE=7.113972e-02     RMSE=2.667203e-01
  per-joint RMSE: 0.3452 0.3851 0.2381 0.1847 0.1942 0.1757
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_tau_hat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.npz --H 50 --features state' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (54955, 50, 18)  Y_train: (54955, 6)
X_test : (12314, 50, 18)  Y_test : (12314, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:32:54.958304: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:32:54.984608: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (54955, 50, 18), Y_train = (54955, 6)
  X_test  = (12314, 50, 18),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:32:56.338556: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:56.343377: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:56.344288: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:56.346070: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:56.346975: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:56.347816: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:56.435023: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:56.436009: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:56.437023: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:32:56.437897: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:32:57.494666: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.3341 - val_loss: 0.5141
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.2087 - val_loss: 0.4601
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.1801 - val_loss: 0.4343
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.1630 - val_loss: 0.4392
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.1540 - val_loss: 0.4566
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1460 - val_loss: 0.4152
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1393 - val_loss: 0.4180
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1337 - val_loss: 0.4637
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1272 - val_loss: 0.4703
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1226 - val_loss: 0.5117
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1209 - val_loss: 0.4676
Epoch 12/100
172/172 - 1s - 4ms/step - loss: 0.1169 - val_loss: 0.5199
Epoch 13/100
172/172 - 1s - 4ms/step - loss: 0.1114 - val_loss: 0.4720
Epoch 14/100
172/172 - 1s - 4ms/step - loss: 0.1108 - val_loss: 0.4921
Epoch 15/100
172/172 - 1s - 4ms/step - loss: 0.1070 - val_loss: 0.4919
Epoch 16/100
172/172 - 1s - 4ms/step - loss: 0.1056 - val_loss: 0.4734
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2111
Per-joint RMSE: 0.2782 0.2670 0.2185 0.1389 0.1701 0.1508
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:33:10.068862: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:33:10.094001: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:33:10.942647: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:10.947388: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:10.948262: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:10.950081: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:10.950877: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:10.951622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:11.033878: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:11.034803: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:11.035553: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:11.036284: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:33:11.332859: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.227301e-01  RMSE=3.503286e-01
  per-joint RMSE: 0.4194 0.5487 0.3327 0.2384 0.2230 0.2054
Residual LSTM:  MSE=4.456209e-02      RMSE=2.110974e-01
  per-joint RMSE: 0.2782 0.2670 0.2185 0.1389 0.1701 0.1508
Combined torque MSE=4.456209e-02     RMSE=2.110974e-01
  per-joint RMSE: 0.2782 0.2670 0.2185 0.1389 0.1701 0.1508
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.npz --H 50 --features state_tauhat' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.json
H=50, n_dof=6, feature_dim=18
X_train: (54955, 50, 18)  Y_train: (54955, 6)
X_test : (12314, 50, 18)  Y_test : (12314, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 100 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:33:13.784349: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:33:13.808894: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep400.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (54955, 50, 18), Y_train = (54955, 6)
  X_test  = (12314, 50, 18),  Y_test  = (12314, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 08:33:15.128377: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:15.133065: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:15.133986: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:15.135515: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:15.136430: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:15.137175: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:15.229478: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:15.230378: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:15.231180: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:15.231974: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/100
2026-01-22 08:33:16.227208: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
172/172 - 2s - 12ms/step - loss: 0.2885 - val_loss: 0.3702
Epoch 2/100
172/172 - 1s - 4ms/step - loss: 0.1768 - val_loss: 0.3393
Epoch 3/100
172/172 - 1s - 4ms/step - loss: 0.1562 - val_loss: 0.3428
Epoch 4/100
172/172 - 1s - 4ms/step - loss: 0.1439 - val_loss: 0.3615
Epoch 5/100
172/172 - 1s - 4ms/step - loss: 0.1343 - val_loss: 0.4108
Epoch 6/100
172/172 - 1s - 4ms/step - loss: 0.1253 - val_loss: 0.3916
Epoch 7/100
172/172 - 1s - 4ms/step - loss: 0.1211 - val_loss: 0.3217
Epoch 8/100
172/172 - 1s - 4ms/step - loss: 0.1148 - val_loss: 0.3687
Epoch 9/100
172/172 - 1s - 4ms/step - loss: 0.1113 - val_loss: 0.3744
Epoch 10/100
172/172 - 1s - 4ms/step - loss: 0.1087 - val_loss: 0.3603
Epoch 11/100
172/172 - 1s - 4ms/step - loss: 0.1047 - val_loss: 0.3480
Epoch 12/100
172/172 - 1s - 4ms/step - loss: 0.1022 - val_loss: 0.3363
Epoch 13/100
172/172 - 1s - 4ms/step - loss: 0.1003 - val_loss: 0.3546
Epoch 14/100
172/172 - 1s - 4ms/step - loss: 0.0988 - val_loss: 0.3540
Epoch 15/100
172/172 - 1s - 4ms/step - loss: 0.0964 - val_loss: 0.3541
Epoch 16/100
172/172 - 1s - 4ms/step - loss: 0.0954 - val_loss: 0.3442
Epoch 17/100
172/172 - 1s - 4ms/step - loss: 0.0949 - val_loss: 0.3544
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.2002
Per-joint RMSE: 0.2574 0.2694 0.2049 0.1291 0.1578 0.1348
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 08:33:29.218065: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 08:33:29.243188: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400/delan_UR3_Load0_combined_26__A__K150_tf0p2__residual__delan_jax_struct_s2_ep400.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 30
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 08:33:30.096319: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:30.100966: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:30.101845: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:30.103711: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:30.104498: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:30.105244: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:30.187751: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:30.188661: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:30.189402: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 08:33:30.190134: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8969 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 08:33:30.484835: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
  done 25/30
  done 30/30

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.227301e-01  RMSE=3.503286e-01
  per-joint RMSE: 0.4194 0.5487 0.3327 0.2384 0.2230 0.2054
Residual LSTM:  MSE=4.009102e-02      RMSE=2.002274e-01
  per-joint RMSE: 0.2574 0.2694 0.2049 0.1291 0.1578 0.1348
Combined torque MSE=4.009102e-02     RMSE=2.002274e-01
  per-joint RMSE: 0.2574 0.2694 0.2049 0.1291 0.1578 0.1348
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K150_tf0p2__delan_jax_struct_s2_ep400__feat_state_tauhat__lstm_s1_H50_ep100_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

