################################################################################################################
### RUN: K=25 test_fraction=0.2 seed=0                                                                       ###
### npz_in=/workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz ###
################################################################################################################

#####################
### 1) PREPROCESS ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_delan_dataset.py --qdd True --col_format wide --trajectory_amount 25 --test_fraction 0.2 --seed 0 --raw_csv /workspace/shared/data/raw/delan_UR3_Load0_combined_26.csv --out_npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Saved: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz
Trajectories: train=20 test=5
Exists: True

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=0                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz -t structured -s 0 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x7173c61c41f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz
   dt ≈ 0.022376492089782287
  dof = 6
  Train trajectories = 20
  Test trajectories  = 5
  Train samples = 15530
  Test samples  = 2004
################################################

2026-01-22 04:59:29.282806: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150 | type=structured | dof=6
################################################
2026-01-22 04:59:32.510713: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:32.510750: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:32.510756: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:32.510783: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:32.510788: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:32.510802: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:32.510839: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:32.510845: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:32.510860: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:32.510864: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.0s, Loss=2.06e+01, Inv=2.06e+01, For=2.81e+02, Power=3.75e+00
2026-01-22 04:59:37.368844: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  [eval] test_mse=6.000e+00  (n=2004)
Epoch 00050: Time=   8.7s, Loss=2.32e+00, Inv=2.32e+00, For=1.21e+02, Power=1.08e+00
Epoch 00100: Time=  10.8s, Loss=1.78e+00, Inv=1.78e+00, For=1.44e+02, Power=9.16e-01
Epoch 00150: Time=  13.1s, Loss=1.57e+00, Inv=1.57e+00, For=1.75e+02, Power=8.59e-01
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150
Torque MSE  = 1.492e+00
Torque RMSE = 1.221e+00
Per-joint MSE : 2.089e+00 1.037e+00 7.958e-01 4.736e-01 3.220e+00 1.337e+00
Per-joint RMSE: 1.445e+00 1.018e+00 8.921e-01 6.882e-01 1.795e+00 1.156e+00
Comp Time per Sample = 1.670e-07s / 5988739.8Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s0_ep150.jax
Detected n_dof=6 (seed=0)
2026-01-22 04:59:47.791818: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 20 trajectories
2026-01-22 04:59:49.121874: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:50.434068: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:50.434083: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:51.985430: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 04:59:51.985442: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 20/20

Exporting split=test: 5 trajectories
2026-01-22 04:59:53.552923: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 5/5

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (15260, 25, 24)  Y_train: (15260, 6)
X_test : (1926, 25, 24)  Y_test : (1926, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 04:59:55.754177: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 04:59:55.779739: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (15260, 25, 24), Y_train = (15260, 6)
  X_test  = (1926, 25, 24),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 04:59:56.813922: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 04:59:56.818480: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 04:59:56.819370: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 04:59:56.821111: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 04:59:56.821915: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 04:59:56.822669: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 04:59:56.908723: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 04:59:56.909611: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 04:59:56.910415: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 04:59:56.911202: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8698 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 04:59:57.869044: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 32ms/step - loss: 0.4308 - val_loss: 0.8098
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.2483 - val_loss: 0.8273
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.2087 - val_loss: 0.8332
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.1877 - val_loss: 0.7938
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.1727 - val_loss: 0.7635
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.1644 - val_loss: 0.7652
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.1544 - val_loss: 0.7582
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.1505 - val_loss: 0.7425
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.1475 - val_loss: 0.7316
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1430 - val_loss: 0.7301
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1398 - val_loss: 0.7363
Epoch 12/30
48/48 - 0s - 3ms/step - loss: 0.1398 - val_loss: 0.7460
Epoch 13/30
48/48 - 0s - 3ms/step - loss: 0.1347 - val_loss: 0.7507
Epoch 14/30
48/48 - 0s - 3ms/step - loss: 0.1358 - val_loss: 0.7622
Epoch 15/30
48/48 - 0s - 3ms/step - loss: 0.1295 - val_loss: 0.7697
Epoch 16/30
48/48 - 0s - 3ms/step - loss: 0.1266 - val_loss: 0.7578
Epoch 17/30
48/48 - 0s - 3ms/step - loss: 0.1267 - val_loss: 0.7754
Epoch 18/30
48/48 - 0s - 3ms/step - loss: 0.1238 - val_loss: 0.7708
Epoch 19/30
48/48 - 0s - 3ms/step - loss: 0.1242 - val_loss: 0.7884
Epoch 20/30
48/48 - 0s - 4ms/step - loss: 0.1203 - val_loss: 0.7904
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2070
Per-joint RMSE: 1.4615 1.0595 0.8541 0.6859 1.7708 1.0709
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:02.501290: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:02.526907: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:00:03.418631: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:03.423442: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:03.424230: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:03.425889: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:03.426739: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:03.427524: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:03.507183: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:03.508103: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:03.508859: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:03.509649: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8692 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:00:03.811770: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.539994e+00  RMSE=1.240965e+00
  per-joint RMSE: 1.4714 1.0265 0.9080 0.6982 1.8237 1.1763
Residual LSTM:  MSE=1.456876e+00      RMSE=1.207011e+00
  per-joint RMSE: 1.4615 1.0595 0.8541 0.6859 1.7708 1.0709
Combined torque MSE=1.456876e+00     RMSE=1.207011e+00
  per-joint RMSE: 1.4615 1.0595 0.8541 0.6859 1.7708 1.0709
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (15260, 25, 6)  Y_train: (15260, 6)
X_test : (1926, 25, 6)  Y_test : (1926, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:05.675564: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:05.700097: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (15260, 25, 6), Y_train = (15260, 6)
  X_test  = (1926, 25, 6),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:00:06.711437: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:06.716298: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:06.717094: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:06.718702: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:06.719483: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:06.720223: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:06.792816: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:06.793720: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:06.794537: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:06.795268: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8666 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:00:07.690872: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 32ms/step - loss: 0.7856 - val_loss: 0.8867
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.5008 - val_loss: 1.0139
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.3654 - val_loss: 1.2094
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.2880 - val_loss: 1.2891
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.2610 - val_loss: 1.3156
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.2407 - val_loss: 1.3063
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.2654 - val_loss: 1.3405
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.2405 - val_loss: 1.2872
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.2056 - val_loss: 1.3305
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1963 - val_loss: 1.3515
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1883 - val_loss: 1.3071
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2577
Per-joint RMSE: 1.5175 1.0555 0.8785 0.7455 1.8419 1.1637
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:10.971794: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:10.997401: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:00:11.912800: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:11.917635: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:11.918448: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:11.920220: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:11.921016: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:11.921842: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:12.000139: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:12.000978: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:12.001722: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:12.002451: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8688 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:00:12.300820: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.539994e+00  RMSE=1.240965e+00
  per-joint RMSE: 1.4714 1.0265 0.9080 0.6982 1.8237 1.1763
Residual LSTM:  MSE=1.581858e+00      RMSE=1.257720e+00
  per-joint RMSE: 1.5175 1.0555 0.8785 0.7455 1.8419 1.1637
Combined torque MSE=1.581858e+00     RMSE=1.257720e+00
  per-joint RMSE: 1.5175 1.0555 0.8785 0.7455 1.8419 1.1637
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (15260, 25, 18)  Y_train: (15260, 6)
X_test : (1926, 25, 18)  Y_test : (1926, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:14.194383: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:14.219028: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (15260, 25, 18), Y_train = (15260, 6)
  X_test  = (1926, 25, 18),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:00:15.231093: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:15.235748: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:15.236557: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:15.238125: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:15.238921: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:15.239656: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:15.309632: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:15.310478: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:15.311282: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:15.312010: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8663 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:00:16.218999: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 31ms/step - loss: 0.4589 - val_loss: 0.8308
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.2753 - val_loss: 0.8308
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.2301 - val_loss: 0.8513
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.2046 - val_loss: 0.8670
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.1873 - val_loss: 0.8893
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.1758 - val_loss: 0.9091
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.1648 - val_loss: 0.9029
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.1585 - val_loss: 0.9023
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.1537 - val_loss: 0.9040
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1483 - val_loss: 0.8955
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1441 - val_loss: 0.9068
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2604
Per-joint RMSE: 1.5233 1.1025 0.9641 0.7508 1.7770 1.1599
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:19.505328: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:19.530990: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:00:20.420993: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:20.425696: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:20.426487: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:20.428209: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:20.429000: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:20.429743: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:20.503546: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:20.504384: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:20.505211: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:20.505945: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8691 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:00:20.804429: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.539994e+00  RMSE=1.240965e+00
  per-joint RMSE: 1.4714 1.0265 0.9080 0.6982 1.8237 1.1763
Residual LSTM:  MSE=1.588728e+00      RMSE=1.260447e+00
  per-joint RMSE: 1.5233 1.1025 0.9641 0.7508 1.7770 1.1599
Combined torque MSE=1.588728e+00     RMSE=1.260447e+00
  per-joint RMSE: 1.5233 1.1025 0.9641 0.7508 1.7770 1.1599
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (15260, 25, 18)  Y_train: (15260, 6)
X_test : (1926, 25, 18)  Y_test : (1926, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:22.685557: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:22.710000: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (15260, 25, 18), Y_train = (15260, 6)
  X_test  = (1926, 25, 18),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:00:23.727270: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:23.731964: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:23.732836: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:23.734605: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:23.735663: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:23.736396: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:23.807645: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:23.808506: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:23.809254: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:23.809996: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8690 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:00:24.758631: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 32ms/step - loss: 0.4546 - val_loss: 0.8938
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.2510 - val_loss: 0.8322
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.2054 - val_loss: 0.7909
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.1839 - val_loss: 0.7711
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.1712 - val_loss: 0.7510
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.1610 - val_loss: 0.7309
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.1555 - val_loss: 0.7466
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.1496 - val_loss: 0.7370
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.1458 - val_loss: 0.7335
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1424 - val_loss: 0.7245
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1382 - val_loss: 0.7417
Epoch 12/30
48/48 - 0s - 3ms/step - loss: 0.1347 - val_loss: 0.7136
Epoch 13/30
48/48 - 0s - 3ms/step - loss: 0.1331 - val_loss: 0.7164
Epoch 14/30
48/48 - 0s - 3ms/step - loss: 0.1301 - val_loss: 0.7066
Epoch 15/30
48/48 - 0s - 3ms/step - loss: 0.1297 - val_loss: 0.7141
Epoch 16/30
48/48 - 0s - 3ms/step - loss: 0.1268 - val_loss: 0.7046
Epoch 17/30
48/48 - 0s - 3ms/step - loss: 0.1246 - val_loss: 0.7028
Epoch 18/30
48/48 - 0s - 3ms/step - loss: 0.1238 - val_loss: 0.6949
Epoch 19/30
48/48 - 0s - 5ms/step - loss: 0.1222 - val_loss: 0.6834
Epoch 20/30
48/48 - 0s - 3ms/step - loss: 0.1209 - val_loss: 0.6880
Epoch 21/30
48/48 - 0s - 3ms/step - loss: 0.1206 - val_loss: 0.6808
Epoch 22/30
48/48 - 0s - 3ms/step - loss: 0.1185 - val_loss: 0.6755
Epoch 23/30
48/48 - 0s - 3ms/step - loss: 0.1189 - val_loss: 0.6774
Epoch 24/30
48/48 - 0s - 3ms/step - loss: 0.1147 - val_loss: 0.6779
Epoch 25/30
48/48 - 0s - 3ms/step - loss: 0.1156 - val_loss: 0.6780
Epoch 26/30
48/48 - 0s - 3ms/step - loss: 0.1168 - val_loss: 0.6808
Epoch 27/30
48/48 - 0s - 3ms/step - loss: 0.1151 - val_loss: 0.6779
Epoch 28/30
48/48 - 0s - 3ms/step - loss: 0.1139 - val_loss: 0.6642
Epoch 29/30
48/48 - 0s - 3ms/step - loss: 0.1119 - val_loss: 0.6591
Epoch 30/30
48/48 - 0s - 3ms/step - loss: 0.1111 - val_loss: 0.6580
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.1861
Per-joint RMSE: 1.3973 1.0179 0.8676 0.6638 1.7612 1.0758
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:31.010843: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:31.035952: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:00:31.927824: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:31.932584: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:31.933436: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:31.935258: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:31.936049: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:31.936790: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:32.023868: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:32.024732: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:32.025472: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:32.026196: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8695 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:00:32.330390: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.539994e+00  RMSE=1.240965e+00
  per-joint RMSE: 1.4714 1.0265 0.9080 0.6982 1.8237 1.1763
Residual LSTM:  MSE=1.406857e+00      RMSE=1.186110e+00
  per-joint RMSE: 1.3973 1.0179 0.8676 0.6638 1.7612 1.0758
Combined torque MSE=1.406857e+00     RMSE=1.186110e+00
  per-joint RMSE: 1.3973 1.0179 0.8676 0.6638 1.7612 1.0758
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (15010, 50, 24)  Y_train: (15010, 6)
X_test : (1851, 50, 24)  Y_test : (1851, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:34.285717: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:34.310075: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (15010, 50, 24), Y_train = (15010, 6)
  X_test  = (1851, 50, 24),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:00:35.411398: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:35.416086: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:35.416885: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:35.418439: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:35.419305: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:35.420040: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:35.498914: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:35.499840: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:35.500674: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:35.501407: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8691 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:00:36.500283: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 34ms/step - loss: 0.4476 - val_loss: 0.8903
Epoch 2/30
47/47 - 0s - 5ms/step - loss: 0.2471 - val_loss: 0.8582
Epoch 3/30
47/47 - 0s - 4ms/step - loss: 0.2064 - val_loss: 0.8589
Epoch 4/30
47/47 - 0s - 5ms/step - loss: 0.1859 - val_loss: 0.8081
Epoch 5/30
47/47 - 0s - 5ms/step - loss: 0.1736 - val_loss: 0.7894
Epoch 6/30
47/47 - 0s - 4ms/step - loss: 0.1654 - val_loss: 0.8111
Epoch 7/30
47/47 - 0s - 5ms/step - loss: 0.1604 - val_loss: 0.7637
Epoch 8/30
47/47 - 0s - 5ms/step - loss: 0.1533 - val_loss: 0.7555
Epoch 9/30
47/47 - 0s - 4ms/step - loss: 0.1496 - val_loss: 0.7566
Epoch 10/30
47/47 - 0s - 5ms/step - loss: 0.1436 - val_loss: 0.7446
Epoch 11/30
47/47 - 0s - 5ms/step - loss: 0.1410 - val_loss: 0.7317
Epoch 12/30
47/47 - 0s - 4ms/step - loss: 0.1380 - val_loss: 0.7345
Epoch 13/30
47/47 - 0s - 4ms/step - loss: 0.1360 - val_loss: 0.7401
Epoch 14/30
47/47 - 0s - 4ms/step - loss: 0.1343 - val_loss: 0.7326
Epoch 15/30
47/47 - 0s - 4ms/step - loss: 0.1310 - val_loss: 0.7400
Epoch 16/30
47/47 - 0s - 5ms/step - loss: 0.1284 - val_loss: 0.7203
Epoch 17/30
47/47 - 0s - 4ms/step - loss: 0.1269 - val_loss: 0.7261
Epoch 18/30
47/47 - 0s - 5ms/step - loss: 0.1261 - val_loss: 0.7163
Epoch 19/30
47/47 - 0s - 4ms/step - loss: 0.1239 - val_loss: 0.7249
Epoch 20/30
47/47 - 0s - 6ms/step - loss: 0.1223 - val_loss: 0.7115
Epoch 21/30
47/47 - 0s - 5ms/step - loss: 0.1207 - val_loss: 0.7171
Epoch 22/30
47/47 - 0s - 4ms/step - loss: 0.1204 - val_loss: 0.7241
Epoch 23/30
47/47 - 0s - 4ms/step - loss: 0.1176 - val_loss: 0.7178
Epoch 24/30
47/47 - 0s - 4ms/step - loss: 0.1155 - val_loss: 0.7170
Epoch 25/30
47/47 - 0s - 5ms/step - loss: 0.1163 - val_loss: 0.7221
Epoch 26/30
47/47 - 0s - 5ms/step - loss: 0.1161 - val_loss: 0.7183
Epoch 27/30
47/47 - 0s - 4ms/step - loss: 0.1139 - val_loss: 0.7152
Epoch 28/30
47/47 - 0s - 5ms/step - loss: 0.1129 - val_loss: 0.7030
Epoch 29/30
47/47 - 0s - 5ms/step - loss: 0.1121 - val_loss: 0.6939
Epoch 30/30
47/47 - 0s - 4ms/step - loss: 0.1112 - val_loss: 0.6967
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2031
Per-joint RMSE: 1.4741 0.9675 0.8727 0.6822 1.7387 1.1514
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:44.588231: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:44.613138: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:00:45.538597: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:45.543328: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:45.544357: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:45.546214: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:45.547020: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:45.547933: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:45.621221: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:45.622144: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:45.622903: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:45.623659: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8831 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:00:45.936043: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.523037e+00  RMSE=1.234114e+00
  per-joint RMSE: 1.4789 1.0035 0.9020 0.6873 1.8092 1.1768
Residual LSTM:  MSE=1.447491e+00      RMSE=1.203117e+00
  per-joint RMSE: 1.4741 0.9675 0.8727 0.6822 1.7387 1.1514
Combined torque MSE=1.447491e+00     RMSE=1.203117e+00
  per-joint RMSE: 1.4741 0.9675 0.8727 0.6822 1.7387 1.1514
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (15010, 50, 6)  Y_train: (15010, 6)
X_test : (1851, 50, 6)  Y_test : (1851, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:47.805470: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:47.829899: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (15010, 50, 6), Y_train = (15010, 6)
  X_test  = (1851, 50, 6),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:00:48.832488: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:48.837188: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:48.837992: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:48.839612: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:48.840414: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:48.841158: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:48.913079: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:48.913958: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:48.914705: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:48.915441: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8863 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:00:49.844986: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 33ms/step - loss: 0.6979 - val_loss: 1.0418
Epoch 2/30
47/47 - 0s - 4ms/step - loss: 0.3570 - val_loss: 1.2492
Epoch 3/30
47/47 - 0s - 4ms/step - loss: 0.2960 - val_loss: 1.3030
Epoch 4/30
47/47 - 0s - 4ms/step - loss: 0.2598 - val_loss: 1.3066
Epoch 5/30
47/47 - 0s - 4ms/step - loss: 0.2343 - val_loss: 1.3065
Epoch 6/30
47/47 - 0s - 4ms/step - loss: 0.2178 - val_loss: 1.2895
Epoch 7/30
47/47 - 0s - 4ms/step - loss: 0.2043 - val_loss: 1.2671
Epoch 8/30
47/47 - 0s - 4ms/step - loss: 0.1943 - val_loss: 1.2777
Epoch 9/30
47/47 - 0s - 4ms/step - loss: 0.1903 - val_loss: 1.2754
Epoch 10/30
47/47 - 0s - 4ms/step - loss: 0.1833 - val_loss: 1.2987
Epoch 11/30
47/47 - 0s - 4ms/step - loss: 0.1768 - val_loss: 1.2820
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.2698
Per-joint RMSE: 1.5504 0.9833 0.9038 0.7709 1.8348 1.2353
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:53.752198: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:53.777242: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:00:54.655297: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:54.660119: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:54.661059: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:54.662743: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:54.663532: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:54.664395: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:54.748831: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:54.749712: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:54.750498: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:54.751279: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8864 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:00:55.048603: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.523037e+00  RMSE=1.234114e+00
  per-joint RMSE: 1.4789 1.0035 0.9020 0.6873 1.8092 1.1768
Residual LSTM:  MSE=1.612360e+00      RMSE=1.269787e+00
  per-joint RMSE: 1.5504 0.9833 0.9038 0.7709 1.8348 1.2353
Combined torque MSE=1.612360e+00     RMSE=1.269787e+00
  per-joint RMSE: 1.5504 0.9833 0.9038 0.7709 1.8348 1.2353
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (15010, 50, 18)  Y_train: (15010, 6)
X_test : (1851, 50, 18)  Y_test : (1851, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:00:56.939660: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:00:56.964121: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (15010, 50, 18), Y_train = (15010, 6)
  X_test  = (1851, 50, 18),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:00:58.038321: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:58.042988: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:58.043782: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:58.045472: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:58.046269: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:58.047039: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:58.127837: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:58.129054: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:58.129800: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:00:58.130536: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8876 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:00:59.066830: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 34ms/step - loss: 0.4541 - val_loss: 0.9834
Epoch 2/30
47/47 - 0s - 4ms/step - loss: 0.2736 - val_loss: 1.0203
Epoch 3/30
47/47 - 0s - 5ms/step - loss: 0.2316 - val_loss: 0.9641
Epoch 4/30
47/47 - 0s - 4ms/step - loss: 0.2073 - val_loss: 0.9840
Epoch 5/30
47/47 - 0s - 4ms/step - loss: 0.1930 - val_loss: 0.9696
Epoch 6/30
47/47 - 0s - 5ms/step - loss: 0.1861 - val_loss: 0.9284
Epoch 7/30
47/47 - 0s - 5ms/step - loss: 0.1757 - val_loss: 0.9147
Epoch 8/30
47/47 - 0s - 4ms/step - loss: 0.1638 - val_loss: 0.9473
Epoch 9/30
47/47 - 0s - 4ms/step - loss: 0.1588 - val_loss: 0.9244
Epoch 10/30
47/47 - 0s - 4ms/step - loss: 0.1533 - val_loss: 0.9359
Epoch 11/30
47/47 - 0s - 4ms/step - loss: 0.1521 - val_loss: 0.9746
Epoch 12/30
47/47 - 0s - 4ms/step - loss: 0.1468 - val_loss: 0.9379
Epoch 13/30
47/47 - 0s - 4ms/step - loss: 0.1431 - val_loss: 0.9366
Epoch 14/30
47/47 - 0s - 4ms/step - loss: 0.1408 - val_loss: 0.9230
Epoch 15/30
47/47 - 0s - 5ms/step - loss: 0.1366 - val_loss: 0.9116
Epoch 16/30
47/47 - 0s - 4ms/step - loss: 0.1339 - val_loss: 0.9455
Epoch 17/30
47/47 - 0s - 4ms/step - loss: 0.1318 - val_loss: 0.9543
Epoch 18/30
47/47 - 0s - 4ms/step - loss: 0.1296 - val_loss: 0.9518
Epoch 19/30
47/47 - 0s - 4ms/step - loss: 0.1274 - val_loss: 0.9470
Epoch 20/30
47/47 - 0s - 4ms/step - loss: 0.1280 - val_loss: 0.9710
Epoch 21/30
47/47 - 0s - 6ms/step - loss: 0.1251 - val_loss: 0.9888
Epoch 22/30
47/47 - 0s - 4ms/step - loss: 0.1236 - val_loss: 0.9953
Epoch 23/30
47/47 - 0s - 4ms/step - loss: 0.1210 - val_loss: 1.0003
Epoch 24/30
47/47 - 0s - 4ms/step - loss: 0.1198 - val_loss: 1.0059
Epoch 25/30
47/47 - 0s - 4ms/step - loss: 0.1193 - val_loss: 1.0192
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.3022
Per-joint RMSE: 1.6575 1.1790 1.0867 0.7436 1.7189 1.1609
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:01:05.964518: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:01:05.989483: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:01:06.886698: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:06.891659: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:06.892561: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:06.894349: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:06.895164: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:06.895943: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:06.971327: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:06.972165: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:06.972911: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:06.973648: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8850 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:01:07.284599: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.523037e+00  RMSE=1.234114e+00
  per-joint RMSE: 1.4789 1.0035 0.9020 0.6873 1.8092 1.1768
Residual LSTM:  MSE=1.695638e+00      RMSE=1.302167e+00
  per-joint RMSE: 1.6575 1.1790 1.0867 0.7436 1.7189 1.1609
Combined torque MSE=1.695638e+00     RMSE=1.302167e+00
  per-joint RMSE: 1.6575 1.1790 1.0867 0.7436 1.7189 1.1609
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (15010, 50, 18)  Y_train: (15010, 6)
X_test : (1851, 50, 18)  Y_test : (1851, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:01:09.198083: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:01:09.222299: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s0_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (15010, 50, 18), Y_train = (15010, 6)
  X_test  = (1851, 50, 18),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:01:10.296092: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:10.300782: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:10.301593: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:10.303223: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:10.304019: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:10.304757: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:10.383084: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:10.383934: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:10.384688: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:10.385427: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8859 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:01:11.371539: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 34ms/step - loss: 0.4388 - val_loss: 0.7951
Epoch 2/30
47/47 - 0s - 5ms/step - loss: 0.2506 - val_loss: 0.7652
Epoch 3/30
47/47 - 0s - 4ms/step - loss: 0.2095 - val_loss: 0.7827
Epoch 4/30
47/47 - 0s - 4ms/step - loss: 0.1903 - val_loss: 0.7748
Epoch 5/30
47/47 - 0s - 5ms/step - loss: 0.1769 - val_loss: 0.7503
Epoch 6/30
47/47 - 0s - 4ms/step - loss: 0.1700 - val_loss: 0.7542
Epoch 7/30
47/47 - 0s - 5ms/step - loss: 0.1615 - val_loss: 0.7356
Epoch 8/30
47/47 - 0s - 5ms/step - loss: 0.1544 - val_loss: 0.7354
Epoch 9/30
47/47 - 0s - 5ms/step - loss: 0.1503 - val_loss: 0.7305
Epoch 10/30
47/47 - 0s - 4ms/step - loss: 0.1459 - val_loss: 0.7308
Epoch 11/30
47/47 - 0s - 5ms/step - loss: 0.1413 - val_loss: 0.7216
Epoch 12/30
47/47 - 0s - 4ms/step - loss: 0.1387 - val_loss: 0.7306
Epoch 13/30
47/47 - 0s - 5ms/step - loss: 0.1361 - val_loss: 0.7161
Epoch 14/30
47/47 - 0s - 4ms/step - loss: 0.1341 - val_loss: 0.7235
Epoch 15/30
47/47 - 0s - 5ms/step - loss: 0.1315 - val_loss: 0.7118
Epoch 16/30
47/47 - 0s - 4ms/step - loss: 0.1286 - val_loss: 0.7207
Epoch 17/30
47/47 - 0s - 5ms/step - loss: 0.1280 - val_loss: 0.7164
Epoch 18/30
47/47 - 0s - 5ms/step - loss: 0.1252 - val_loss: 0.7062
Epoch 19/30
47/47 - 0s - 5ms/step - loss: 0.1225 - val_loss: 0.7048
Epoch 20/30
47/47 - 0s - 6ms/step - loss: 0.1238 - val_loss: 0.7229
Epoch 21/30
47/47 - 0s - 4ms/step - loss: 0.1210 - val_loss: 0.7127
Epoch 22/30
47/47 - 0s - 4ms/step - loss: 0.1201 - val_loss: 0.7201
Epoch 23/30
47/47 - 0s - 4ms/step - loss: 0.1187 - val_loss: 0.7091
Epoch 24/30
47/47 - 0s - 4ms/step - loss: 0.1177 - val_loss: 0.7094
Epoch 25/30
47/47 - 0s - 4ms/step - loss: 0.1155 - val_loss: 0.7103
Epoch 26/30
47/47 - 0s - 4ms/step - loss: 0.1157 - val_loss: 0.7062
Epoch 27/30
47/47 - 0s - 5ms/step - loss: 0.1144 - val_loss: 0.7015
Epoch 28/30
47/47 - 0s - 4ms/step - loss: 0.1133 - val_loss: 0.7047
Epoch 29/30
47/47 - 0s - 5ms/step - loss: 0.1133 - val_loss: 0.6936
Epoch 30/30
47/47 - 0s - 4ms/step - loss: 0.1110 - val_loss: 0.6947
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 1.1801
Per-joint RMSE: 1.3752 1.0549 0.8462 0.6661 1.7656 1.0364
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:01:19.529474: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:01:19.554444: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s0_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:01:20.460970: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:20.466016: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:20.466810: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:20.468457: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:20.469391: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:20.470185: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:20.551231: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:20.552146: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:20.552965: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:20.553716: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8856 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:01:20.863568: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=1.523037e+00  RMSE=1.234114e+00
  per-joint RMSE: 1.4789 1.0035 0.9020 0.6873 1.8092 1.1768
Residual LSTM:  MSE=1.392551e+00      RMSE=1.180064e+00
  per-joint RMSE: 1.3752 1.0549 0.8462 0.6661 1.7656 1.0364
Combined torque MSE=1.392551e+00     RMSE=1.180064e+00
  per-joint RMSE: 1.3752 1.0549 0.8462 0.6661 1.7656 1.0364
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s0_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=1                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz -t structured -s 1 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x7464077bc1f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz
   dt ≈ 0.022376492089782287
  dof = 6
  Train trajectories = 20
  Test trajectories  = 5
  Train samples = 15530
  Test samples  = 2004
################################################

2026-01-22 05:01:25.282763: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150 | type=structured | dof=6
################################################
2026-01-22 05:01:28.593224: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:28.593261: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:28.593267: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:28.593295: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:28.593300: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:28.593315: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:28.593351: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:28.593357: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:28.593372: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:28.593377: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.2s, Loss=3.04e+01, Inv=3.04e+01, For=3.77e+02, Power=4.27e+00
2026-01-22 05:01:33.653896: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  [eval] test_mse=2.975e+00  (n=2004)
Epoch 00050: Time=   8.6s, Loss=2.42e+00, Inv=2.42e+00, For=9.26e+01, Power=1.17e+00
Epoch 00100: Time=  10.6s, Loss=1.78e+00, Inv=1.78e+00, For=1.04e+02, Power=9.46e-01
Epoch 00150: Time=  12.8s, Loss=1.60e+00, Inv=1.60e+00, For=1.40e+02, Power=8.89e-01
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150
Torque MSE  = 7.589e-01
Torque RMSE = 8.711e-01
Per-joint MSE : 6.374e-01 1.768e+00 3.811e-01 4.295e-01 7.485e-01 5.884e-01
Per-joint RMSE: 7.983e-01 1.330e+00 6.173e-01 6.554e-01 8.651e-01 7.671e-01
Comp Time per Sample = 1.846e-07s / 5416553.0Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s1_ep150.jax
Detected n_dof=6 (seed=1)
2026-01-22 05:01:43.632879: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 20 trajectories
2026-01-22 05:01:45.000772: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:46.227918: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:46.227932: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:47.767525: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:01:47.767575: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 20/20

Exporting split=test: 5 trajectories
2026-01-22 05:01:49.384058: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 5/5

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (15260, 25, 24)  Y_train: (15260, 6)
X_test : (1926, 25, 24)  Y_test : (1926, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:01:51.537286: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:01:51.562354: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (15260, 25, 24), Y_train = (15260, 6)
  X_test  = (1926, 25, 24),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:01:52.605083: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:52.611637: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:52.612592: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:52.614445: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:52.615361: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:52.616227: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:52.701871: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:52.702817: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:52.703621: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:01:52.704412: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8877 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:01:53.640861: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 32ms/step - loss: 0.4187 - val_loss: 0.9045
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.2464 - val_loss: 0.8559
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.2060 - val_loss: 0.8472
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.1854 - val_loss: 0.7857
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.1716 - val_loss: 0.7568
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.1624 - val_loss: 0.7370
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.1552 - val_loss: 0.6937
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.1494 - val_loss: 0.6899
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.1453 - val_loss: 0.6830
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1418 - val_loss: 0.6848
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1387 - val_loss: 0.6803
Epoch 12/30
48/48 - 0s - 3ms/step - loss: 0.1356 - val_loss: 0.6814
Epoch 13/30
48/48 - 0s - 3ms/step - loss: 0.1334 - val_loss: 0.6809
Epoch 14/30
48/48 - 0s - 3ms/step - loss: 0.1310 - val_loss: 0.6741
Epoch 15/30
48/48 - 0s - 3ms/step - loss: 0.1279 - val_loss: 0.6795
Epoch 16/30
48/48 - 0s - 3ms/step - loss: 0.1264 - val_loss: 0.6839
Epoch 17/30
48/48 - 0s - 3ms/step - loss: 0.1253 - val_loss: 0.6858
Epoch 18/30
48/48 - 0s - 3ms/step - loss: 0.1238 - val_loss: 0.6800
Epoch 19/30
48/48 - 0s - 3ms/step - loss: 0.1220 - val_loss: 0.6832
Epoch 20/30
48/48 - 0s - 5ms/step - loss: 0.1197 - val_loss: 0.6869
Epoch 21/30
48/48 - 0s - 3ms/step - loss: 0.1187 - val_loss: 0.6785
Epoch 22/30
48/48 - 0s - 3ms/step - loss: 0.1168 - val_loss: 0.6841
Epoch 23/30
48/48 - 0s - 3ms/step - loss: 0.1167 - val_loss: 0.6689
Epoch 24/30
48/48 - 0s - 3ms/step - loss: 0.1147 - val_loss: 0.6711
Epoch 25/30
48/48 - 0s - 3ms/step - loss: 0.1136 - val_loss: 0.6846
Epoch 26/30
48/48 - 0s - 3ms/step - loss: 0.1129 - val_loss: 0.6676
Epoch 27/30
48/48 - 0s - 3ms/step - loss: 0.1111 - val_loss: 0.6833
Epoch 28/30
48/48 - 0s - 3ms/step - loss: 0.1113 - val_loss: 0.6773
Epoch 29/30
48/48 - 0s - 3ms/step - loss: 0.1100 - val_loss: 0.6816
Epoch 30/30
48/48 - 0s - 3ms/step - loss: 0.1091 - val_loss: 0.6812
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.7327
Per-joint RMSE: 0.8092 0.9328 0.5301 0.6297 0.7737 0.6480
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:01:59.981348: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:00.006788: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:02:00.929329: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:00.934176: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:00.935046: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:00.936719: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:00.937533: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:00.938268: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:01.018089: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:01.018988: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:01.019734: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:01.020520: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8858 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:02:01.328351: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.805043e-01  RMSE=8.834615e-01
  per-joint RMSE: 0.8102 1.3506 0.6208 0.6661 0.8737 0.7810
Residual LSTM:  MSE=5.368267e-01      RMSE=7.326846e-01
  per-joint RMSE: 0.8092 0.9328 0.5301 0.6297 0.7737 0.6480
Combined torque MSE=5.368267e-01     RMSE=7.326846e-01
  per-joint RMSE: 0.8092 0.9328 0.5301 0.6297 0.7737 0.6480
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (15260, 25, 6)  Y_train: (15260, 6)
X_test : (1926, 25, 6)  Y_test : (1926, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:02:03.282604: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:03.307672: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (15260, 25, 6), Y_train = (15260, 6)
  X_test  = (1926, 25, 6),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:02:04.320993: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:04.325532: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:04.326327: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:04.328020: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:04.328906: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:04.329654: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:04.409487: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:04.410393: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:04.411334: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:04.412165: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8860 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:02:05.364508: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 32ms/step - loss: 0.7565 - val_loss: 0.8879
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.4909 - val_loss: 1.0488
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.3982 - val_loss: 1.0012
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.3026 - val_loss: 1.1308
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.2605 - val_loss: 1.0362
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.2302 - val_loss: 1.0359
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.2137 - val_loss: 1.0600
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.2029 - val_loss: 1.0552
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.1948 - val_loss: 1.1216
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1872 - val_loss: 1.1784
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1797 - val_loss: 1.1661
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8637
Per-joint RMSE: 0.8428 1.1693 0.6418 0.7350 0.8825 0.8172
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:02:08.724623: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:08.750103: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:02:09.672241: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:09.677115: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:09.677923: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:09.679787: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:09.680598: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:09.681432: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:09.766592: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:09.767522: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:09.768277: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:09.769018: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8869 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:02:10.072007: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.805043e-01  RMSE=8.834615e-01
  per-joint RMSE: 0.8102 1.3506 0.6208 0.6661 0.8737 0.7810
Residual LSTM:  MSE=7.460507e-01      RMSE=8.637422e-01
  per-joint RMSE: 0.8428 1.1693 0.6418 0.7350 0.8825 0.8172
Combined torque MSE=7.460507e-01     RMSE=8.637422e-01
  per-joint RMSE: 0.8428 1.1693 0.6418 0.7350 0.8825 0.8172
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (15260, 25, 18)  Y_train: (15260, 6)
X_test : (1926, 25, 18)  Y_test : (1926, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:02:11.968669: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:11.993405: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (15260, 25, 18), Y_train = (15260, 6)
  X_test  = (1926, 25, 18),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:02:13.049247: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:13.054032: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:13.054840: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:13.056433: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:13.057395: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:13.058279: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:13.129884: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:13.130772: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:13.131581: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:13.132452: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8862 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:02:14.085619: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 32ms/step - loss: 0.4438 - val_loss: 0.8669
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.2748 - val_loss: 0.8219
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.2278 - val_loss: 0.8037
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.2063 - val_loss: 0.7618
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.1879 - val_loss: 0.7919
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.1774 - val_loss: 0.7839
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.1679 - val_loss: 0.8022
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.1642 - val_loss: 0.8018
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.1561 - val_loss: 0.8122
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1523 - val_loss: 0.8055
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1488 - val_loss: 0.8179
Epoch 12/30
48/48 - 0s - 3ms/step - loss: 0.1433 - val_loss: 0.8069
Epoch 13/30
48/48 - 0s - 3ms/step - loss: 0.1408 - val_loss: 0.7986
Epoch 14/30
48/48 - 0s - 3ms/step - loss: 0.1391 - val_loss: 0.8201
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.7999
Per-joint RMSE: 0.7968 1.1383 0.6263 0.6280 0.8069 0.6860
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:02:17.856362: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:17.881510: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:02:18.783059: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:18.787823: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:18.788622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:18.790236: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:18.791030: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:18.791766: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:18.871169: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:18.872199: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:18.872962: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:18.873696: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8879 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:02:19.178578: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.805043e-01  RMSE=8.834615e-01
  per-joint RMSE: 0.8102 1.3506 0.6208 0.6661 0.8737 0.7810
Residual LSTM:  MSE=6.398008e-01      RMSE=7.998755e-01
  per-joint RMSE: 0.7968 1.1383 0.6263 0.6280 0.8069 0.6860
Combined torque MSE=6.398008e-01     RMSE=7.998755e-01
  per-joint RMSE: 0.7968 1.1383 0.6263 0.6280 0.8069 0.6860
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (15260, 25, 18)  Y_train: (15260, 6)
X_test : (1926, 25, 18)  Y_test : (1926, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:02:21.071942: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:21.097303: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (15260, 25, 18), Y_train = (15260, 6)
  X_test  = (1926, 25, 18),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:02:22.108141: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:22.112757: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:22.113563: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:22.115256: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:22.116063: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:22.116815: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:22.188755: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:22.189602: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:22.190359: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:22.191100: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8876 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:02:23.145735: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 32ms/step - loss: 0.4373 - val_loss: 0.7802
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.2537 - val_loss: 0.6873
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.2101 - val_loss: 0.6673
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.1869 - val_loss: 0.6403
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.1719 - val_loss: 0.6197
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.1633 - val_loss: 0.6149
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.1564 - val_loss: 0.6164
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.1495 - val_loss: 0.6152
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.1456 - val_loss: 0.6181
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1409 - val_loss: 0.6269
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1380 - val_loss: 0.6285
Epoch 12/30
48/48 - 0s - 3ms/step - loss: 0.1360 - val_loss: 0.6322
Epoch 13/30
48/48 - 0s - 3ms/step - loss: 0.1330 - val_loss: 0.6214
Epoch 14/30
48/48 - 0s - 3ms/step - loss: 0.1316 - val_loss: 0.6250
Epoch 15/30
48/48 - 0s - 3ms/step - loss: 0.1285 - val_loss: 0.6175
Epoch 16/30
48/48 - 0s - 3ms/step - loss: 0.1258 - val_loss: 0.6260
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.7524
Per-joint RMSE: 0.8078 1.0365 0.5447 0.5966 0.7843 0.6337
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:02:27.219880: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:27.245118: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:02:28.154206: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:28.158866: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:28.159660: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:28.161374: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:28.162176: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:28.162919: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:28.242315: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:28.243249: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:28.243997: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:28.244731: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8879 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:02:28.549440: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.805043e-01  RMSE=8.834615e-01
  per-joint RMSE: 0.8102 1.3506 0.6208 0.6661 0.8737 0.7810
Residual LSTM:  MSE=5.660417e-01      RMSE=7.523574e-01
  per-joint RMSE: 0.8078 1.0365 0.5447 0.5966 0.7843 0.6337
Combined torque MSE=5.660417e-01     RMSE=7.523574e-01
  per-joint RMSE: 0.8078 1.0365 0.5447 0.5966 0.7843 0.6337
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (15010, 50, 24)  Y_train: (15010, 6)
X_test : (1851, 50, 24)  Y_test : (1851, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:02:30.502457: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:30.528203: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (15010, 50, 24), Y_train = (15010, 6)
  X_test  = (1851, 50, 24),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:02:31.640996: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:31.645631: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:31.646511: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:31.648216: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:31.649004: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:31.649837: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:31.727737: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:31.728560: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:31.729301: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:31.730028: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8876 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:02:32.726695: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 34ms/step - loss: 0.4325 - val_loss: 0.8835
Epoch 2/30
47/47 - 0s - 5ms/step - loss: 0.2511 - val_loss: 0.8191
Epoch 3/30
47/47 - 0s - 5ms/step - loss: 0.2080 - val_loss: 0.8149
Epoch 4/30
47/47 - 0s - 4ms/step - loss: 0.1863 - val_loss: 0.8429
Epoch 5/30
47/47 - 0s - 5ms/step - loss: 0.1732 - val_loss: 0.8040
Epoch 6/30
47/47 - 0s - 5ms/step - loss: 0.1655 - val_loss: 0.7802
Epoch 7/30
47/47 - 0s - 5ms/step - loss: 0.1584 - val_loss: 0.7540
Epoch 8/30
47/47 - 0s - 5ms/step - loss: 0.1519 - val_loss: 0.7662
Epoch 9/30
47/47 - 0s - 5ms/step - loss: 0.1473 - val_loss: 0.7486
Epoch 10/30
47/47 - 0s - 5ms/step - loss: 0.1451 - val_loss: 0.7128
Epoch 11/30
47/47 - 0s - 5ms/step - loss: 0.1400 - val_loss: 0.7251
Epoch 12/30
47/47 - 0s - 5ms/step - loss: 0.1367 - val_loss: 0.7107
Epoch 13/30
47/47 - 0s - 5ms/step - loss: 0.1334 - val_loss: 0.7082
Epoch 14/30
47/47 - 0s - 4ms/step - loss: 0.1306 - val_loss: 0.7107
Epoch 15/30
47/47 - 0s - 5ms/step - loss: 0.1294 - val_loss: 0.6961
Epoch 16/30
47/47 - 0s - 5ms/step - loss: 0.1282 - val_loss: 0.6895
Epoch 17/30
47/47 - 0s - 5ms/step - loss: 0.1273 - val_loss: 0.6879
Epoch 18/30
47/47 - 0s - 4ms/step - loss: 0.1257 - val_loss: 0.7006
Epoch 19/30
47/47 - 0s - 5ms/step - loss: 0.1221 - val_loss: 0.6908
Epoch 20/30
47/47 - 0s - 6ms/step - loss: 0.1213 - val_loss: 0.6977
Epoch 21/30
47/47 - 0s - 4ms/step - loss: 0.1202 - val_loss: 0.6949
Epoch 22/30
47/47 - 0s - 5ms/step - loss: 0.1182 - val_loss: 0.6857
Epoch 23/30
47/47 - 0s - 5ms/step - loss: 0.1176 - val_loss: 0.6795
Epoch 24/30
47/47 - 0s - 4ms/step - loss: 0.1165 - val_loss: 0.6802
Epoch 25/30
47/47 - 0s - 5ms/step - loss: 0.1150 - val_loss: 0.6791
Epoch 26/30
47/47 - 0s - 5ms/step - loss: 0.1138 - val_loss: 0.6763
Epoch 27/30
47/47 - 0s - 5ms/step - loss: 0.1135 - val_loss: 0.6725
Epoch 28/30
47/47 - 0s - 4ms/step - loss: 0.1110 - val_loss: 0.6867
Epoch 29/30
47/47 - 0s - 4ms/step - loss: 0.1105 - val_loss: 0.6775
Epoch 30/30
47/47 - 0s - 5ms/step - loss: 0.1104 - val_loss: 0.6706
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.7682
Per-joint RMSE: 0.8386 1.0214 0.5481 0.6440 0.7896 0.6751
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:02:40.934277: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:40.959756: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:02:41.850629: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:41.855362: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:41.856164: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:41.857759: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:41.858549: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:41.859296: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:41.941054: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:41.941893: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:41.942638: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:41.943373: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8876 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:02:42.250602: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.650287e-01  RMSE=8.746592e-01
  per-joint RMSE: 0.8063 1.3271 0.6116 0.6673 0.8590 0.7885
Residual LSTM:  MSE=5.901459e-01      RMSE=7.682096e-01
  per-joint RMSE: 0.8386 1.0214 0.5481 0.6440 0.7896 0.6751
Combined torque MSE=5.901459e-01     RMSE=7.682096e-01
  per-joint RMSE: 0.8386 1.0214 0.5481 0.6440 0.7896 0.6751
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (15010, 50, 6)  Y_train: (15010, 6)
X_test : (1851, 50, 6)  Y_test : (1851, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:02:44.185389: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:44.210347: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (15010, 50, 6), Y_train = (15010, 6)
  X_test  = (1851, 50, 6),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:02:45.228748: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:45.233391: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:45.234189: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:45.235801: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:45.236604: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:45.237446: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:45.315942: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:45.316783: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:45.317532: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:45.318268: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8879 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:02:46.240675: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 34ms/step - loss: 0.6818 - val_loss: 1.0375
Epoch 2/30
47/47 - 0s - 4ms/step - loss: 0.3704 - val_loss: 1.2661
Epoch 3/30
47/47 - 0s - 4ms/step - loss: 0.3005 - val_loss: 1.2743
Epoch 4/30
47/47 - 0s - 4ms/step - loss: 0.2724 - val_loss: 1.2343
Epoch 5/30
47/47 - 0s - 4ms/step - loss: 0.2473 - val_loss: 1.2427
Epoch 6/30
47/47 - 0s - 4ms/step - loss: 0.2333 - val_loss: 1.1833
Epoch 7/30
47/47 - 0s - 4ms/step - loss: 0.2253 - val_loss: 1.2663
Epoch 8/30
47/47 - 0s - 4ms/step - loss: 0.2055 - val_loss: 1.2509
Epoch 9/30
47/47 - 0s - 4ms/step - loss: 0.2026 - val_loss: 1.2588
Epoch 10/30
47/47 - 0s - 4ms/step - loss: 0.1950 - val_loss: 1.2888
Epoch 11/30
47/47 - 0s - 4ms/step - loss: 0.1926 - val_loss: 1.2837
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9200
Per-joint RMSE: 0.8828 1.2146 0.6879 0.7788 0.8964 0.9700
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:02:50.167407: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:50.192645: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:02:51.072286: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:51.077252: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:51.078124: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:51.079792: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:51.080587: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:51.081320: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:51.159441: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:51.160283: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:51.161026: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:51.161756: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8897 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:02:51.459311: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.650287e-01  RMSE=8.746592e-01
  per-joint RMSE: 0.8063 1.3271 0.6116 0.6673 0.8590 0.7885
Residual LSTM:  MSE=8.464310e-01      RMSE=9.200169e-01
  per-joint RMSE: 0.8828 1.2146 0.6879 0.7788 0.8964 0.9700
Combined torque MSE=8.464310e-01     RMSE=9.200169e-01
  per-joint RMSE: 0.8828 1.2146 0.6879 0.7788 0.8964 0.9700
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (15010, 50, 18)  Y_train: (15010, 6)
X_test : (1851, 50, 18)  Y_test : (1851, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:02:53.360933: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:02:53.385875: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (15010, 50, 18), Y_train = (15010, 6)
  X_test  = (1851, 50, 18),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:02:54.461811: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:54.466359: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:54.467160: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:54.468847: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:54.469725: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:54.470459: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:54.543471: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:54.544324: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:54.545137: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:02:54.545951: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8895 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:02:55.504751: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 34ms/step - loss: 0.4417 - val_loss: 1.0274
Epoch 2/30
47/47 - 0s - 4ms/step - loss: 0.2696 - val_loss: 1.0394
Epoch 3/30
47/47 - 0s - 5ms/step - loss: 0.2266 - val_loss: 0.9653
Epoch 4/30
47/47 - 0s - 5ms/step - loss: 0.2083 - val_loss: 0.9038
Epoch 5/30
47/47 - 0s - 4ms/step - loss: 0.1916 - val_loss: 0.9344
Epoch 6/30
47/47 - 0s - 5ms/step - loss: 0.1830 - val_loss: 0.8882
Epoch 7/30
47/47 - 0s - 5ms/step - loss: 0.1752 - val_loss: 0.8867
Epoch 8/30
47/47 - 0s - 5ms/step - loss: 0.1667 - val_loss: 0.8742
Epoch 9/30
47/47 - 0s - 4ms/step - loss: 0.1608 - val_loss: 0.8486
Epoch 10/30
47/47 - 0s - 4ms/step - loss: 0.1558 - val_loss: 0.8598
Epoch 11/30
47/47 - 0s - 4ms/step - loss: 0.1493 - val_loss: 0.8621
Epoch 12/30
47/47 - 0s - 4ms/step - loss: 0.1470 - val_loss: 0.8607
Epoch 13/30
47/47 - 0s - 4ms/step - loss: 0.1438 - val_loss: 0.8602
Epoch 14/30
47/47 - 0s - 4ms/step - loss: 0.1395 - val_loss: 0.8760
Epoch 15/30
47/47 - 0s - 4ms/step - loss: 0.1384 - val_loss: 0.8754
Epoch 16/30
47/47 - 0s - 4ms/step - loss: 0.1354 - val_loss: 0.8934
Epoch 17/30
47/47 - 0s - 4ms/step - loss: 0.1317 - val_loss: 0.8852
Epoch 18/30
47/47 - 0s - 4ms/step - loss: 0.1298 - val_loss: 0.8989
Epoch 19/30
47/47 - 0s - 4ms/step - loss: 0.1284 - val_loss: 0.8976
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.7988
Per-joint RMSE: 0.8035 1.1313 0.6215 0.6169 0.8009 0.7037
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:03:01.187193: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:03:01.212740: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:03:02.111387: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:02.116252: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:02.117062: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:02.118754: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:02.119561: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:02.120312: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:02.194370: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:02.195206: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:02.195960: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:02.196817: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8881 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:03:02.502702: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.650287e-01  RMSE=8.746592e-01
  per-joint RMSE: 0.8063 1.3271 0.6116 0.6673 0.8590 0.7885
Residual LSTM:  MSE=6.381328e-01      RMSE=7.988321e-01
  per-joint RMSE: 0.8035 1.1313 0.6215 0.6169 0.8009 0.7037
Combined torque MSE=6.381327e-01     RMSE=7.988321e-01
  per-joint RMSE: 0.8035 1.1313 0.6215 0.6169 0.8009 0.7037
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (15010, 50, 18)  Y_train: (15010, 6)
X_test : (1851, 50, 18)  Y_test : (1851, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:03:04.459741: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:03:04.484610: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s1_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (15010, 50, 18), Y_train = (15010, 6)
  X_test  = (1851, 50, 18),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:03:05.562503: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:05.567245: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:05.568043: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:05.569538: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:05.570332: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:05.571147: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:05.649102: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:05.649950: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:05.650780: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:05.651518: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8877 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:03:06.633501: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 34ms/step - loss: 0.4386 - val_loss: 0.9006
Epoch 2/30
47/47 - 0s - 5ms/step - loss: 0.2528 - val_loss: 0.7750
Epoch 3/30
47/47 - 0s - 5ms/step - loss: 0.2094 - val_loss: 0.7229
Epoch 4/30
47/47 - 0s - 5ms/step - loss: 0.1879 - val_loss: 0.6991
Epoch 5/30
47/47 - 0s - 5ms/step - loss: 0.1740 - val_loss: 0.6562
Epoch 6/30
47/47 - 0s - 5ms/step - loss: 0.1643 - val_loss: 0.6419
Epoch 7/30
47/47 - 0s - 5ms/step - loss: 0.1577 - val_loss: 0.6372
Epoch 8/30
47/47 - 0s - 5ms/step - loss: 0.1511 - val_loss: 0.6137
Epoch 9/30
47/47 - 0s - 5ms/step - loss: 0.1465 - val_loss: 0.6097
Epoch 10/30
47/47 - 0s - 5ms/step - loss: 0.1426 - val_loss: 0.5926
Epoch 11/30
47/47 - 0s - 4ms/step - loss: 0.1396 - val_loss: 0.5976
Epoch 12/30
47/47 - 0s - 4ms/step - loss: 0.1356 - val_loss: 0.5974
Epoch 13/30
47/47 - 0s - 4ms/step - loss: 0.1327 - val_loss: 0.5994
Epoch 14/30
47/47 - 0s - 4ms/step - loss: 0.1297 - val_loss: 0.5934
Epoch 15/30
47/47 - 0s - 4ms/step - loss: 0.1275 - val_loss: 0.5960
Epoch 16/30
47/47 - 0s - 5ms/step - loss: 0.1262 - val_loss: 0.5863
Epoch 17/30
47/47 - 0s - 5ms/step - loss: 0.1238 - val_loss: 0.5780
Epoch 18/30
47/47 - 0s - 5ms/step - loss: 0.1220 - val_loss: 0.5770
Epoch 19/30
47/47 - 0s - 4ms/step - loss: 0.1213 - val_loss: 0.5826
Epoch 20/30
47/47 - 0s - 6ms/step - loss: 0.1194 - val_loss: 0.5806
Epoch 21/30
47/47 - 0s - 5ms/step - loss: 0.1173 - val_loss: 0.5760
Epoch 22/30
47/47 - 0s - 5ms/step - loss: 0.1168 - val_loss: 0.5618
Epoch 23/30
47/47 - 0s - 4ms/step - loss: 0.1154 - val_loss: 0.5740
Epoch 24/30
47/47 - 0s - 4ms/step - loss: 0.1135 - val_loss: 0.5744
Epoch 25/30
47/47 - 0s - 4ms/step - loss: 0.1137 - val_loss: 0.5766
Epoch 26/30
47/47 - 0s - 4ms/step - loss: 0.1131 - val_loss: 0.5710
Epoch 27/30
47/47 - 0s - 4ms/step - loss: 0.1115 - val_loss: 0.5791
Epoch 28/30
47/47 - 0s - 4ms/step - loss: 0.1094 - val_loss: 0.5717
Epoch 29/30
47/47 - 0s - 4ms/step - loss: 0.1084 - val_loss: 0.5745
Epoch 30/30
47/47 - 0s - 4ms/step - loss: 0.1088 - val_loss: 0.5757
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.7233
Per-joint RMSE: 0.8582 0.8801 0.5064 0.6237 0.7688 0.6254
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:03:14.693036: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:03:14.719112: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s1_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:03:15.608730: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:15.613493: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:15.614321: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:15.616207: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:15.617080: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:15.617973: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:15.695450: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:15.696308: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:15.697089: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:15.697829: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8882 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:03:16.002600: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=7.650287e-01  RMSE=8.746592e-01
  per-joint RMSE: 0.8063 1.3271 0.6116 0.6673 0.8590 0.7885
Residual LSTM:  MSE=5.231223e-01      RMSE=7.232720e-01
  per-joint RMSE: 0.8582 0.8801 0.5064 0.6237 0.7688 0.6254
Combined torque MSE=5.231223e-01     RMSE=7.232720e-01
  per-joint RMSE: 0.8582 0.8801 0.5064 0.6237 0.7688 0.6254
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s1_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

###################################################################################################################################################################
### DELAN VARIANT: delan_seed=2                                                                                                                                 ###
### ckpt=/workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax ###
### res_out=/workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz                                 ###
###################################################################################################################################################################

######################
### 2) DELAN TRAIN ###
######################

===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/rbyt_train_delan_jax.py --npz /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz -t structured -s 2 -r 0 --hp_preset fast_debug --epochs 150 --save_path /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax' ===
===============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Final hyper: {'dataset': 'delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150', 'n_width': 64, 'n_depth': 2, 'n_minibatch': 256, 'diagonal_epsilon': 0.1, 'diagonal_shift': 2.0, 'activation': 'tanh', 'learning_rate': 0.0003, 'weight_decay': 1e-05, 'max_epoch': 150, 'lagrangian_type': <function structured_lagrangian_fn at 0x77877bb681f0>}


################################################
DeLaN run: delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
  model_dir = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
  ckpt_path = /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
  type = structured
  hp_preset = fast_debug
################################################


################################################
Dataset: delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz
  npz = /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz
   dt ≈ 0.022376492089782287
  dof = 6
  Train trajectories = 20
  Test trajectories  = 5
  Train samples = 15530
  Test samples  = 2004
################################################

2026-01-22 05:03:20.340336: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
################################################
Training DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150 | type=structured | dof=6
################################################
2026-01-22 05:03:23.583219: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:23.583261: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:23.583269: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:23.583302: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:23.583308: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:23.583323: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:23.583365: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:23.583371: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:23.583386: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:23.583391: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
Epoch 00001: Time=   5.1s, Loss=1.86e+01, Inv=1.86e+01, For=2.13e+02, Power=5.05e+00
2026-01-22 05:03:28.535246: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  [eval] test_mse=4.598e+00  (n=2004)
Epoch 00050: Time=   8.5s, Loss=2.28e+00, Inv=2.28e+00, For=8.57e+01, Power=1.10e+00
Epoch 00100: Time=  10.6s, Loss=1.73e+00, Inv=1.73e+00, For=1.15e+02, Power=9.31e-01
Epoch 00150: Time=  12.8s, Loss=1.55e+00, Inv=1.55e+00, For=1.44e+02, Power=8.69e-01
Saved DeLaN checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
Saved training history: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150__train_history.csv

################################################
Evaluating DeLaN | run=delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150
Torque MSE  = 7.984e-01
Torque RMSE = 8.935e-01
Per-joint MSE : 3.696e-01 8.716e-01 8.605e-01 3.213e-01 1.550e+00 8.176e-01
Per-joint RMSE: 6.079e-01 9.336e-01 9.276e-01 5.669e-01 1.245e+00 9.042e-01
Comp Time per Sample = 1.630e-07s / 6134105.5Hz
Saved metrics TXT: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/metrics_test.txt
Saved metrics JSON: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/metrics.json


###########################
### 3) EXPORT RESIDUALS ###
###########################

=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T delan_jax bash -lc 'python3 /workspace/delan_jax/scripts/export_delan_residuals_jax.py --npz_in /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz --ckpt /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax --out /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz' ===
=================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Loading dataset: /workspace/shared/data/preprocessed/delan_delan_UR3_Load0_combined_26_K25_tf0p2_seed0_dataset.npz
Loading checkpoint: /workspace/shared/models/delan/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__delan_jax_struct_s2_ep150.jax
Detected n_dof=6 (seed=2)
2026-01-22 05:03:38.502097: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.

Exporting split=train: 20 trajectories
2026-01-22 05:03:39.860055: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:41.121172: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:41.121188: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:42.613234: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
2026-01-22 05:03:42.613246: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 20/20

Exporting split=test: 5 trajectories
2026-01-22 05:03:44.221401: W external/xla/xla/service/gpu/autotuning/dot_search_space.cc:200] All configs were filtered out because none of them sufficiently match the hints. Maybe the hints set does not contain a good representative set of valid configs?Working around this by using the full hints set instead.
  done 5/5

Saved residual trajectory dataset: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
Keys: ['test_labels', 'test_q', 'test_qd', 'test_qdd', 'test_r_tau', 'test_t', 'test_tau', 'test_tau_hat', 'train_labels', 'train_q', 'train_qd', 'train_qdd', 'train_r_tau', 'train_t', 'train_tau', 'train_tau_hat']
Saved export JSON: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.json


#############################
### BLOCK: H=25 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz --H 25 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=24
X_train: (15260, 25, 24)  Y_train: (15260, 6)
X_test : (1926, 25, 24)  Y_test : (1926, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:03:46.449128: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:03:46.474184: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_full__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 24
 dout = 6
  X_train = (15260, 25, 24), Y_train = (15260, 6)
  X_test  = (1926, 25, 24),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:03:47.503428: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:47.508406: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:47.509332: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:47.511036: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:47.512029: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:47.513039: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:47.596526: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:47.597527: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:47.598331: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:47.599127: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8887 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:03:48.586998: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 33ms/step - loss: 0.4429 - val_loss: 0.8004
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.2570 - val_loss: 0.8182
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.2115 - val_loss: 0.8261
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.1899 - val_loss: 0.8159
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.1753 - val_loss: 0.7770
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.1644 - val_loss: 0.7613
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.1564 - val_loss: 0.7217
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.1514 - val_loss: 0.7124
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.1455 - val_loss: 0.7010
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1404 - val_loss: 0.7023
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1392 - val_loss: 0.7135
Epoch 12/30
48/48 - 0s - 3ms/step - loss: 0.1371 - val_loss: 0.7015
Epoch 13/30
48/48 - 0s - 3ms/step - loss: 0.1344 - val_loss: 0.6923
Epoch 14/30
48/48 - 0s - 3ms/step - loss: 0.1309 - val_loss: 0.6961
Epoch 15/30
48/48 - 0s - 3ms/step - loss: 0.1302 - val_loss: 0.6891
Epoch 16/30
48/48 - 0s - 3ms/step - loss: 0.1282 - val_loss: 0.6823
Epoch 17/30
48/48 - 0s - 3ms/step - loss: 0.1266 - val_loss: 0.6866
Epoch 18/30
48/48 - 0s - 3ms/step - loss: 0.1249 - val_loss: 0.6959
Epoch 19/30
48/48 - 0s - 3ms/step - loss: 0.1234 - val_loss: 0.6833
Epoch 20/30
48/48 - 0s - 4ms/step - loss: 0.1219 - val_loss: 0.6872
Epoch 21/30
48/48 - 0s - 3ms/step - loss: 0.1200 - val_loss: 0.6973
Epoch 22/30
48/48 - 0s - 3ms/step - loss: 0.1185 - val_loss: 0.6974
Epoch 23/30
48/48 - 0s - 3ms/step - loss: 0.1177 - val_loss: 0.7022
Epoch 24/30
48/48 - 0s - 3ms/step - loss: 0.1176 - val_loss: 0.7085
Epoch 25/30
48/48 - 0s - 3ms/step - loss: 0.1158 - val_loss: 0.7027
Epoch 26/30
48/48 - 0s - 3ms/step - loss: 0.1159 - val_loss: 0.7060
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8483
Per-joint RMSE: 0.5931 0.9059 0.8567 0.5247 1.1798 0.8625
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:03:54.204790: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:03:54.230272: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:03:55.107055: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:55.111622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:55.112465: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:55.114166: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:55.114960: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:55.115716: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:55.195003: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:55.195861: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:55.196761: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:55.197544: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8312 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:03:55.488341: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=8.132454e-01  RMSE=9.018012e-01
  per-joint RMSE: 0.6179 0.9239 0.9379 0.5756 1.2642 0.9137
Residual LSTM:  MSE=7.195692e-01      RMSE=8.482742e-01
  per-joint RMSE: 0.5931 0.9059 0.8567 0.5247 1.1798 0.8625
Combined torque MSE=7.195692e-01     RMSE=8.482742e-01
  per-joint RMSE: 0.5931 0.9059 0.8567 0.5247 1.1798 0.8625
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


################################
### BLOCK: H=25 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz --H 25 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=6
X_train: (15260, 25, 6)  Y_train: (15260, 6)
X_test : (1926, 25, 6)  Y_test : (1926, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:03:57.325912: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:03:57.350297: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_tau_hat__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 6
 dout = 6
  X_train = (15260, 25, 6), Y_train = (15260, 6)
  X_test  = (1926, 25, 6),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:03:58.343306: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:58.348000: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:58.348799: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:58.350396: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:58.351183: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:58.351929: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:58.422954: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:58.423792: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:58.424597: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:03:58.425369: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8320 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:03:59.336831: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 32ms/step - loss: 0.7857 - val_loss: 0.9272
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.4953 - val_loss: 1.4915
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.3567 - val_loss: 1.3251
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.2848 - val_loss: 1.3051
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.2547 - val_loss: 1.3029
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.2332 - val_loss: 1.2990
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.2231 - val_loss: 1.2197
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.2114 - val_loss: 1.1593
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.2037 - val_loss: 1.2562
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1940 - val_loss: 1.2393
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1873 - val_loss: 1.2370
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9584
Per-joint RMSE: 0.7088 1.0227 1.0621 0.6614 1.2602 0.8998
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:04:02.549525: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:04:02.575241: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:04:03.484995: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:03.489832: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:03.490845: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:03.492549: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:03.493358: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:03.494099: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:03.571235: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:03.572087: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:03.572841: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:03.573587: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8298 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:04:03.868659: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=8.132454e-01  RMSE=9.018012e-01
  per-joint RMSE: 0.6179 0.9239 0.9379 0.5756 1.2642 0.9137
Residual LSTM:  MSE=9.186075e-01      RMSE=9.584401e-01
  per-joint RMSE: 0.7088 1.0227 1.0621 0.6614 1.2602 0.8998
Combined torque MSE=9.186075e-01     RMSE=9.584401e-01
  per-joint RMSE: 0.7088 1.0227 1.0621 0.6614 1.2602 0.8998
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


##############################
### BLOCK: H=25 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz --H 25 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (15260, 25, 18)  Y_train: (15260, 6)
X_test : (1926, 25, 18)  Y_test : (1926, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:04:05.747373: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:04:05.772242: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (15260, 25, 18), Y_train = (15260, 6)
  X_test  = (1926, 25, 18),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:04:06.829694: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:06.834414: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:06.835211: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:06.836763: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:06.837561: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:06.838300: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:06.911709: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:06.912566: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:06.913321: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:06.914055: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8259 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:04:07.825302: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 32ms/step - loss: 0.4618 - val_loss: 0.9105
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.2744 - val_loss: 0.9059
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.2261 - val_loss: 0.9270
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.2062 - val_loss: 0.9347
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.1905 - val_loss: 0.9557
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.1779 - val_loss: 0.9389
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.1698 - val_loss: 0.9367
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.1607 - val_loss: 0.9364
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.1557 - val_loss: 0.9150
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1528 - val_loss: 0.9120
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1480 - val_loss: 0.9066
Epoch 12/30
48/48 - 0s - 3ms/step - loss: 0.1438 - val_loss: 0.8830
Epoch 13/30
48/48 - 0s - 3ms/step - loss: 0.1416 - val_loss: 0.8996
Epoch 14/30
48/48 - 0s - 3ms/step - loss: 0.1390 - val_loss: 0.9070
Epoch 15/30
48/48 - 0s - 3ms/step - loss: 0.1376 - val_loss: 0.8958
Epoch 16/30
48/48 - 0s - 3ms/step - loss: 0.1342 - val_loss: 0.9135
Epoch 17/30
48/48 - 0s - 3ms/step - loss: 0.1338 - val_loss: 0.9192
Epoch 18/30
48/48 - 0s - 3ms/step - loss: 0.1320 - val_loss: 0.9044
Epoch 19/30
48/48 - 0s - 3ms/step - loss: 0.1295 - val_loss: 0.8951
Epoch 20/30
48/48 - 0s - 3ms/step - loss: 0.1285 - val_loss: 0.8977
Epoch 21/30
48/48 - 0s - 5ms/step - loss: 0.1279 - val_loss: 0.8741
Epoch 22/30
48/48 - 0s - 3ms/step - loss: 0.1227 - val_loss: 0.8824
Epoch 23/30
48/48 - 0s - 3ms/step - loss: 0.1240 - val_loss: 0.9029
Epoch 24/30
48/48 - 0s - 3ms/step - loss: 0.1209 - val_loss: 0.9036
Epoch 25/30
48/48 - 0s - 3ms/step - loss: 0.1207 - val_loss: 0.8950
Epoch 26/30
48/48 - 0s - 3ms/step - loss: 0.1202 - val_loss: 0.8998
Epoch 27/30
48/48 - 0s - 3ms/step - loss: 0.1188 - val_loss: 0.9167
Epoch 28/30
48/48 - 0s - 3ms/step - loss: 0.1172 - val_loss: 0.9279
Epoch 29/30
48/48 - 0s - 3ms/step - loss: 0.1160 - val_loss: 0.9217
Epoch 30/30
48/48 - 0s - 3ms/step - loss: 0.1157 - val_loss: 0.9069
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9218
Per-joint RMSE: 0.8857 0.9559 1.0465 0.4230 1.1995 0.8288
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:04:13.861599: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:04:13.887695: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:04:14.794086: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:14.798966: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:14.799936: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:14.801544: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:14.802352: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:14.803103: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:14.886412: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:14.887243: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:14.888073: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:14.888810: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8340 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:04:15.183701: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=8.132454e-01  RMSE=9.018012e-01
  per-joint RMSE: 0.6179 0.9239 0.9379 0.5756 1.2642 0.9137
Residual LSTM:  MSE=8.496563e-01      RMSE=9.217681e-01
  per-joint RMSE: 0.8857 0.9559 1.0465 0.4230 1.1995 0.8288
Combined torque MSE=8.496563e-01     RMSE=9.217681e-01
  per-joint RMSE: 0.8857 0.9559 1.0465 0.4230 1.1995 0.8288
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#####################################
### BLOCK: H=25 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --H 25 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
  H           = 25
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.json
H=25, n_dof=6, feature_dim=18
X_train: (15260, 25, 18)  Y_train: (15260, 6)
X_test : (1926, 25, 18)  Y_test : (1926, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:04:17.041563: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:04:17.066696: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H25__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
   H  = 25
  din = 18
 dout = 6
  X_train = (15260, 25, 18), Y_train = (15260, 6)
  X_test  = (1926, 25, 18),  Y_test  = (1926, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:04:18.087799: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:18.092503: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:18.093306: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:18.095000: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:18.095801: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:18.096551: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:18.170421: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:18.171418: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:18.172173: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:18.172904: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8335 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 25, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 25, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:04:19.073834: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
48/48 - 2s - 31ms/step - loss: 0.4436 - val_loss: 0.7641
Epoch 2/30
48/48 - 0s - 3ms/step - loss: 0.2510 - val_loss: 0.7968
Epoch 3/30
48/48 - 0s - 3ms/step - loss: 0.2084 - val_loss: 0.8152
Epoch 4/30
48/48 - 0s - 3ms/step - loss: 0.1881 - val_loss: 0.8291
Epoch 5/30
48/48 - 0s - 3ms/step - loss: 0.1754 - val_loss: 0.8174
Epoch 6/30
48/48 - 0s - 3ms/step - loss: 0.1645 - val_loss: 0.8262
Epoch 7/30
48/48 - 0s - 3ms/step - loss: 0.1566 - val_loss: 0.8085
Epoch 8/30
48/48 - 0s - 3ms/step - loss: 0.1514 - val_loss: 0.8200
Epoch 9/30
48/48 - 0s - 3ms/step - loss: 0.1464 - val_loss: 0.8159
Epoch 10/30
48/48 - 0s - 3ms/step - loss: 0.1425 - val_loss: 0.8017
Epoch 11/30
48/48 - 0s - 3ms/step - loss: 0.1398 - val_loss: 0.7906
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_train_test_H25.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8900
Per-joint RMSE: 0.7088 0.9869 0.9437 0.4890 1.2251 0.8036
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/scalers_H25.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1 --H 25 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:04:22.376148: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:04:22.402744: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 25
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:04:23.290934: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:23.295733: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:23.296878: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:23.298707: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:23.299504: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:23.300254: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:23.380199: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:23.381042: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:23.381797: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:23.382542: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8314 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:04:23.682502: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=8.132454e-01  RMSE=9.018012e-01
  per-joint RMSE: 0.6179 0.9239 0.9379 0.5756 1.2642 0.9137
Residual LSTM:  MSE=7.921638e-01      RMSE=8.900359e-01
  per-joint RMSE: 0.7088 0.9869 0.9437 0.4890 1.2251 0.8036
Combined torque MSE=7.921638e-01     RMSE=8.900359e-01
  per-joint RMSE: 0.7088 0.9869 0.9437 0.4890 1.2251 0.8036
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/metrics_test_H25.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/combined_predictions_test_H25.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H25.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H25_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H25.png


#############################
### BLOCK: H=50 feat=full ###
#############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz --H 50 --features full' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= full
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=24
X_train: (15010, 50, 24)  Y_train: (15010, 6)
X_test : (1851, 50, 24)  Y_test : (1851, 6)
feature_mode=full


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:04:25.639677: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:04:25.664139: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_full__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 24
 dout = 6
  X_train = (15010, 50, 24), Y_train = (15010, 6)
  X_test  = (1851, 50, 24),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (24,)/(24,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:04:26.751528: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:26.756146: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:26.756938: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:26.758461: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:26.759330: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:26.760074: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:26.841940: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:26.842783: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:26.843527: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:26.844267: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8322 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        78,336 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 210,694 (823.02 KB)
 Trainable params: 210,694 (823.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:04:27.787001: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 34ms/step - loss: 0.4526 - val_loss: 0.8664
Epoch 2/30
47/47 - 0s - 5ms/step - loss: 0.2506 - val_loss: 0.8432
Epoch 3/30
47/47 - 0s - 5ms/step - loss: 0.2075 - val_loss: 0.8233
Epoch 4/30
47/47 - 0s - 4ms/step - loss: 0.1865 - val_loss: 0.8244
Epoch 5/30
47/47 - 0s - 5ms/step - loss: 0.1755 - val_loss: 0.8084
Epoch 6/30
47/47 - 0s - 5ms/step - loss: 0.1676 - val_loss: 0.7999
Epoch 7/30
47/47 - 0s - 5ms/step - loss: 0.1589 - val_loss: 0.7881
Epoch 8/30
47/47 - 0s - 5ms/step - loss: 0.1537 - val_loss: 0.7824
Epoch 9/30
47/47 - 0s - 4ms/step - loss: 0.1477 - val_loss: 0.7914
Epoch 10/30
47/47 - 0s - 5ms/step - loss: 0.1443 - val_loss: 0.7797
Epoch 11/30
47/47 - 0s - 4ms/step - loss: 0.1413 - val_loss: 0.7866
Epoch 12/30
47/47 - 0s - 4ms/step - loss: 0.1388 - val_loss: 0.7983
Epoch 13/30
47/47 - 0s - 4ms/step - loss: 0.1365 - val_loss: 0.7826
Epoch 14/30
47/47 - 0s - 5ms/step - loss: 0.1345 - val_loss: 0.7694
Epoch 15/30
47/47 - 0s - 5ms/step - loss: 0.1320 - val_loss: 0.7642
Epoch 16/30
47/47 - 0s - 4ms/step - loss: 0.1305 - val_loss: 0.7790
Epoch 17/30
47/47 - 0s - 4ms/step - loss: 0.1280 - val_loss: 0.7781
Epoch 18/30
47/47 - 0s - 4ms/step - loss: 0.1258 - val_loss: 0.7693
Epoch 19/30
47/47 - 0s - 4ms/step - loss: 0.1247 - val_loss: 0.7719
Epoch 20/30
47/47 - 0s - 6ms/step - loss: 0.1223 - val_loss: 0.7699
Epoch 21/30
47/47 - 0s - 4ms/step - loss: 0.1218 - val_loss: 0.7673
Epoch 22/30
47/47 - 0s - 5ms/step - loss: 0.1195 - val_loss: 0.7619
Epoch 23/30
47/47 - 0s - 5ms/step - loss: 0.1188 - val_loss: 0.7618
Epoch 24/30
47/47 - 0s - 5ms/step - loss: 0.1171 - val_loss: 0.7570
Epoch 25/30
47/47 - 0s - 4ms/step - loss: 0.1170 - val_loss: 0.7593
Epoch 26/30
47/47 - 0s - 4ms/step - loss: 0.1159 - val_loss: 0.7765
Epoch 27/30
47/47 - 0s - 4ms/step - loss: 0.1142 - val_loss: 0.7760
Epoch 28/30
47/47 - 0s - 4ms/step - loss: 0.1131 - val_loss: 0.7670
Epoch 29/30
47/47 - 0s - 4ms/step - loss: 0.1132 - val_loss: 0.7601
Epoch 30/30
47/47 - 0s - 5ms/step - loss: 0.1131 - val_loss: 0.7465
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8442
Per-joint RMSE: 0.6879 0.7755 0.9348 0.5093 1.1933 0.8025
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features full --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:04:35.769051: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:04:35.794866: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 24
################################################
2026-01-22 05:04:36.713295: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:36.718074: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:36.718953: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:36.720789: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:36.721601: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:36.722350: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:36.805472: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:36.806329: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:36.807137: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:36.807953: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8322 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:04:37.108268: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=8.067895e-01  RMSE=8.982146e-01
  per-joint RMSE: 0.6289 0.8960 0.9443 0.5721 1.2636 0.9091
Residual LSTM:  MSE=7.126850e-01      RMSE=8.442068e-01
  per-joint RMSE: 0.6879 0.7755 0.9348 0.5093 1.1933 0.8025
Combined torque MSE=7.126850e-01     RMSE=8.442068e-01
  per-joint RMSE: 0.6879 0.7755 0.9348 0.5093 1.1933 0.8025
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_full__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


################################
### BLOCK: H=50 feat=tau_hat ###
################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz --H 50 --features tau_hat' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= tau_hat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=6
X_train: (15010, 50, 6)  Y_train: (15010, 6)
X_test : (1851, 50, 6)  Y_test : (1851, 6)
feature_mode=tau_hat


#####################
### 5) TRAIN LSTM ###
#####################

===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
===========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:04:38.978995: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:04:39.005459: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_tau_hat__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 6
 dout = 6
  X_train = (15010, 50, 6), Y_train = (15010, 6)
  X_test  = (1851, 50, 6),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (6,)/(6,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:04:40.032680: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:40.037423: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:40.038297: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:40.039988: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:40.040845: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:40.041622: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:40.120157: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:40.121004: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:40.121758: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:40.122496: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8322 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        69,120 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 201,478 (787.02 KB)
 Trainable params: 201,478 (787.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:04:41.051303: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 34ms/step - loss: 0.6892 - val_loss: 1.3795
Epoch 2/30
47/47 - 0s - 4ms/step - loss: 0.3803 - val_loss: 1.5210
Epoch 3/30
47/47 - 0s - 5ms/step - loss: 0.3063 - val_loss: 1.3438
Epoch 4/30
47/47 - 0s - 5ms/step - loss: 0.2708 - val_loss: 1.2710
Epoch 5/30
47/47 - 0s - 5ms/step - loss: 0.2507 - val_loss: 1.2600
Epoch 6/30
47/47 - 0s - 4ms/step - loss: 0.2355 - val_loss: 1.2025
Epoch 7/30
47/47 - 0s - 5ms/step - loss: 0.2143 - val_loss: 1.1618
Epoch 8/30
47/47 - 0s - 4ms/step - loss: 0.2072 - val_loss: 1.2236
Epoch 9/30
47/47 - 0s - 4ms/step - loss: 0.1986 - val_loss: 1.2686
Epoch 10/30
47/47 - 0s - 4ms/step - loss: 0.2014 - val_loss: 1.2491
Epoch 11/30
47/47 - 0s - 4ms/step - loss: 0.1832 - val_loss: 1.2234
Epoch 12/30
47/47 - 0s - 4ms/step - loss: 0.1802 - val_loss: 1.2667
Epoch 13/30
47/47 - 0s - 4ms/step - loss: 0.1805 - val_loss: 1.2611
Epoch 14/30
47/47 - 0s - 4ms/step - loss: 0.1712 - val_loss: 1.2272
Epoch 15/30
47/47 - 0s - 4ms/step - loss: 0.1707 - val_loss: 1.2232
Epoch 16/30
47/47 - 0s - 4ms/step - loss: 0.1611 - val_loss: 1.2173
Epoch 17/30
47/47 - 0s - 4ms/step - loss: 0.1656 - val_loss: 1.2146
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9649
Per-joint RMSE: 0.6909 0.9189 1.1175 0.6280 1.2706 1.0036
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features tau_hat --save_pred_npz' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:04:46.262912: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:04:46.289050: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 6
################################################
2026-01-22 05:04:47.219070: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:47.223904: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:47.224705: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:47.226510: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:47.227296: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:47.228034: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:47.303479: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:47.304380: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:47.305227: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:47.305956: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8301 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:04:47.606293: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=8.067895e-01  RMSE=8.982146e-01
  per-joint RMSE: 0.6289 0.8960 0.9443 0.5721 1.2636 0.9091
Residual LSTM:  MSE=9.311087e-01      RMSE=9.649398e-01
  per-joint RMSE: 0.6909 0.9189 1.1175 0.6280 1.2706 1.0036
Combined torque MSE=9.311087e-01     RMSE=9.649398e-01
  per-joint RMSE: 0.6909 0.9189 1.1175 0.6280 1.2706 1.0036
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_tau_hat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


##############################
### BLOCK: H=50 feat=state ###
##############################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz --H 50 --features state' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= state
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (15010, 50, 18)  Y_train: (15010, 6)
X_test : (1851, 50, 18)  Y_test : (1851, 6)
feature_mode=state


#####################
### 5) TRAIN LSTM ###
#####################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:04:49.547404: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:04:49.573193: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (15010, 50, 18), Y_train = (15010, 6)
  X_test  = (1851, 50, 18),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:04:50.673496: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:50.678227: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:50.679194: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:50.680740: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:50.681565: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:50.682347: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:50.771849: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:50.772866: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:50.773650: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:50.774419: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8295 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:04:51.780689: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 35ms/step - loss: 0.4618 - val_loss: 0.9620
Epoch 2/30
47/47 - 0s - 5ms/step - loss: 0.2758 - val_loss: 0.9277
Epoch 3/30
47/47 - 0s - 4ms/step - loss: 0.2316 - val_loss: 0.9348
Epoch 4/30
47/47 - 0s - 4ms/step - loss: 0.2103 - val_loss: 0.9461
Epoch 5/30
47/47 - 0s - 4ms/step - loss: 0.1950 - val_loss: 0.9867
Epoch 6/30
47/47 - 0s - 5ms/step - loss: 0.1855 - val_loss: 0.9702
Epoch 7/30
47/47 - 0s - 4ms/step - loss: 0.1772 - val_loss: 0.9464
Epoch 8/30
47/47 - 0s - 5ms/step - loss: 0.1670 - val_loss: 0.9427
Epoch 9/30
47/47 - 0s - 5ms/step - loss: 0.1624 - val_loss: 0.9097
Epoch 10/30
47/47 - 0s - 5ms/step - loss: 0.1566 - val_loss: 0.9071
Epoch 11/30
47/47 - 0s - 5ms/step - loss: 0.1525 - val_loss: 0.8845
Epoch 12/30
47/47 - 0s - 5ms/step - loss: 0.1495 - val_loss: 0.9104
Epoch 13/30
47/47 - 0s - 4ms/step - loss: 0.1450 - val_loss: 0.9020
Epoch 14/30
47/47 - 0s - 4ms/step - loss: 0.1408 - val_loss: 0.9029
Epoch 15/30
47/47 - 0s - 4ms/step - loss: 0.1375 - val_loss: 0.8976
Epoch 16/30
47/47 - 0s - 5ms/step - loss: 0.1360 - val_loss: 0.8806
Epoch 17/30
47/47 - 0s - 5ms/step - loss: 0.1331 - val_loss: 0.8977
Epoch 18/30
47/47 - 0s - 5ms/step - loss: 0.1316 - val_loss: 0.8896
Epoch 19/30
47/47 - 0s - 4ms/step - loss: 0.1296 - val_loss: 0.9003
Epoch 20/30
47/47 - 0s - 4ms/step - loss: 0.1284 - val_loss: 0.8882
Epoch 21/30
47/47 - 0s - 6ms/step - loss: 0.1260 - val_loss: 0.9106
Epoch 22/30
47/47 - 0s - 4ms/step - loss: 0.1240 - val_loss: 0.9270
Epoch 23/30
47/47 - 0s - 4ms/step - loss: 0.1212 - val_loss: 0.9080
Epoch 24/30
47/47 - 0s - 4ms/step - loss: 0.1229 - val_loss: 0.9002
Epoch 25/30
47/47 - 0s - 4ms/step - loss: 0.1202 - val_loss: 0.9003
Epoch 26/30
47/47 - 0s - 4ms/step - loss: 0.1219 - val_loss: 0.9237
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.9054
Per-joint RMSE: 0.8738 0.9054 1.0222 0.5103 1.1937 0.7776
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state --save_pred_npz' ===
=============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:04:58.917119: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:04:58.942178: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:04:59.812684: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:59.817343: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:59.818225: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:59.820137: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:59.820934: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:59.821686: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:59.897642: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:59.898487: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:59.899233: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:04:59.899962: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8317 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:05:00.194611: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=8.067895e-01  RMSE=8.982146e-01
  per-joint RMSE: 0.6289 0.8960 0.9443 0.5721 1.2636 0.9091
Residual LSTM:  MSE=8.197330e-01      RMSE=9.053911e-01
  per-joint RMSE: 0.8738 0.9054 1.0222 0.5103 1.1937 0.7776
Combined torque MSE=8.197330e-01     RMSE=9.053911e-01
  per-joint RMSE: 0.8738 0.9054 1.0222 0.5103 1.1937 0.7776
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png


#####################################
### BLOCK: H=50 feat=state_tauhat ###
#####################################

#############################
### 4) BUILD LSTM WINDOWS ###
#############################

=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T preprocess bash -lc 'python3 scripts/build_lstm_windows.py --in_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --out_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --H 50 --features state_tauhat' ===
=======================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
Building LSTM windows
  in_npz      = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
  out_npz     = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
  H           = 50
  feature_mode= state_tauhat
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
Saved: /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.json
H=50, n_dof=6, feature_dim=18
X_train: (15010, 50, 18)  Y_train: (15010, 6)
X_test : (1851, 50, 18)  Y_test : (1851, 6)
feature_mode=state_tauhat


#####################
### 5) TRAIN LSTM ###
#####################

=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T lstm bash -lc 'python3 -c '"'"'import runpy
import keras.callbacks as cb
_Orig = cb.ModelCheckpoint

class PatchedModelCheckpoint(_Orig):
    def __init__(self, filepath, *args, **kwargs):
        if isinstance(filepath, str) and (not filepath.endswith('"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"')) and (not filepath.endswith('"'"'"'"'"'"'"'"'.h5'"'"'"'"'"'"'"'"')):
            filepath = filepath + '"'"'"'"'"'"'"'"'.keras'"'"'"'"'"'"'"'"'
        super().__init__(filepath, *args, **kwargs)

cb.ModelCheckpoint = PatchedModelCheckpoint
runpy.run_path('"'"'"'"'"'"'"'"'scripts/train_residual_lstm.py'"'"'"'"'"'"'"'"', run_name='"'"'"'"'"'"'"'"'__main__'"'"'"'"'"'"'"'"')
'"'"' --npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz --out_dir /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --model_name residual_lstm.keras --epochs 30 --batch 256 --val_split 0.2 --seed 4 --units 128 --dropout 0.1 --eps 1e-08 --no_plots' ===
=====================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:05:02.083928: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:05:02.108270: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
LSTM Residual Dataset:
  npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__lstm_windows_H50__feat_state_tauhat__delan_jax_struct_s2_ep150.npz
   H  = 50
  din = 18
 dout = 6
  X_train = (15010, 50, 18), Y_train = (15010, 6)
  X_test  = (1851, 50, 18),  Y_test  = (1851, 6)
################################################

Saved scalers: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz
X mean/std shapes: (18,)/(18,)
Y mean/std shapes: (6,)/(6,)
2026-01-22 05:05:03.182459: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:03.187095: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:03.188004: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:03.189595: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:03.190418: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:03.191194: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:03.270474: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:03.271345: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:03.272129: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:03.272980: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8319 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
/usr/local/lib/python3.11/dist-packages/keras/src/layers/rnn/rnn.py:205: UserWarning: Do not pass an `input_shape`/`input_dim` argument to a layer. When using Sequential models, prefer using an `Input(shape)` object as the first layer in the model instead.
  super().__init__(**kwargs)
Model: "sequential"
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━┓
┃ Layer (type)                    ┃ Output Shape           ┃       Param # ┃
┡━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━┩
│ lstm (LSTM)                     │ (None, 50, 128)        │        75,264 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout (Dropout)               │ (None, 50, 128)        │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ lstm_1 (LSTM)                   │ (None, 128)            │       131,584 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dropout_1 (Dropout)             │ (None, 128)            │             0 │
├─────────────────────────────────┼────────────────────────┼───────────────┤
│ dense (Dense)                   │ (None, 6)              │           774 │
└─────────────────────────────────┴────────────────────────┴───────────────┘
 Total params: 207,622 (811.02 KB)
 Trainable params: 207,622 (811.02 KB)
 Non-trainable params: 0 (0.00 B)


Epoch 1/30
2026-01-22 05:05:04.207727: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906
47/47 - 2s - 33ms/step - loss: 0.4342 - val_loss: 0.8153
Epoch 2/30
47/47 - 0s - 5ms/step - loss: 0.2529 - val_loss: 0.8096
Epoch 3/30
47/47 - 0s - 5ms/step - loss: 0.2136 - val_loss: 0.8079
Epoch 4/30
47/47 - 0s - 5ms/step - loss: 0.1926 - val_loss: 0.7682
Epoch 5/30
47/47 - 0s - 4ms/step - loss: 0.1789 - val_loss: 0.7751
Epoch 6/30
47/47 - 0s - 5ms/step - loss: 0.1703 - val_loss: 0.7490
Epoch 7/30
47/47 - 0s - 5ms/step - loss: 0.1621 - val_loss: 0.7133
Epoch 8/30
47/47 - 0s - 5ms/step - loss: 0.1560 - val_loss: 0.7130
Epoch 9/30
47/47 - 0s - 5ms/step - loss: 0.1519 - val_loss: 0.7003
Epoch 10/30
47/47 - 0s - 4ms/step - loss: 0.1477 - val_loss: 0.7060
Epoch 11/30
47/47 - 0s - 5ms/step - loss: 0.1438 - val_loss: 0.6877
Epoch 12/30
47/47 - 0s - 4ms/step - loss: 0.1414 - val_loss: 0.6894
Epoch 13/30
47/47 - 0s - 4ms/step - loss: 0.1379 - val_loss: 0.6911
Epoch 14/30
47/47 - 0s - 4ms/step - loss: 0.1350 - val_loss: 0.6780
Epoch 15/30
47/47 - 0s - 5ms/step - loss: 0.1340 - val_loss: 0.6711
Epoch 16/30
47/47 - 0s - 5ms/step - loss: 0.1316 - val_loss: 0.6691
Epoch 17/30
47/47 - 0s - 4ms/step - loss: 0.1271 - val_loss: 0.6700
Epoch 18/30
47/47 - 0s - 4ms/step - loss: 0.1276 - val_loss: 0.6750
Epoch 19/30
47/47 - 0s - 4ms/step - loss: 0.1261 - val_loss: 0.6654
Epoch 20/30
47/47 - 0s - 6ms/step - loss: 0.1238 - val_loss: 0.6563
Epoch 21/30
47/47 - 0s - 4ms/step - loss: 0.1223 - val_loss: 0.6496
Epoch 22/30
47/47 - 0s - 4ms/step - loss: 0.1221 - val_loss: 0.6494
Epoch 23/30
47/47 - 0s - 4ms/step - loss: 0.1203 - val_loss: 0.6484
Epoch 24/30
47/47 - 0s - 4ms/step - loss: 0.1189 - val_loss: 0.6374
Epoch 25/30
47/47 - 0s - 4ms/step - loss: 0.1185 - val_loss: 0.6395
Epoch 26/30
47/47 - 0s - 4ms/step - loss: 0.1167 - val_loss: 0.6401
Epoch 27/30
47/47 - 0s - 4ms/step - loss: 0.1151 - val_loss: 0.6346
Epoch 28/30
47/47 - 0s - 5ms/step - loss: 0.1145 - val_loss: 0.6332
Epoch 29/30
47/47 - 0s - 4ms/step - loss: 0.1155 - val_loss: 0.6239
Epoch 30/30
47/47 - 0s - 4ms/step - loss: 0.1130 - val_loss: 0.6340
Saved metrics JSON: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_train_test_H50.json

################################################
LSTM Residual Evaluation (test, unscaled units):
Total RMSE: 0.8804
Per-joint RMSE: 0.6275 0.9852 0.9831 0.4794 1.2017 0.8039
################################################

Saved predictions: /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/predictions_test.npz
Saved best model:  /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras


##############################
### 6) COMBINED EVALUATION ###
##############################

=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
=== docker compose -p payload_estimation --project-directory /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation --env-file /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/.env -f /home/robat/.localgit/algorithmic_payload_estimation/payload_estimation/docker-compose.yml exec -T evaluation bash -lc 'python3 scripts/combined_evaluation.py --residual_npz /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz --model /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras --scalers /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/scalers_H50.npz --out_dir /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1 --H 50 --split test --features state_tauhat --save_pred_npz' ===
=========================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================
2026-01-22 05:05:12.160627: I tensorflow/core/util/port.cc:113] oneDNN custom operations are on. You may see slightly different numerical results due to floating-point round-off errors from different computation orders. To turn them off, set the environment variable `TF_ENABLE_ONEDNN_OPTS=0`.
2026-01-22 05:05:12.185734: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 AVX512F AVX512_VNNI AVX512_BF16 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
################################################
Evaluate & Combine
 residual_npz = /workspace/shared/data/processed/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150/delan_UR3_Load0_combined_26__A__K25_tf0p2__residual__delan_jax_struct_s2_ep150.npz
 model        = /workspace/shared/models/lstm/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_lstm.keras
 split        = test
 H            = 50
 n_traj       = 5
 n_dof        = 6
 feature_dim  = 18
################################################
2026-01-22 05:05:13.042635: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:13.047226: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:13.048028: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:13.049626: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:13.050427: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:13.051170: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:13.135199: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:13.136121: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:13.136873: I external/local_xla/xla/stream_executor/cuda/cuda_executor.cc:998] successful NUMA node read from SysFS had negative value (-1), but there must be at least one NUMA node, so returning NUMA node zero. See more at https://github.com/torvalds/linux/blob/v6.0/Documentation/ABI/testing/sysfs-bus-pci#L344-L355
2026-01-22 05:05:13.137616: I tensorflow/core/common_runtime/gpu/gpu_device.cc:1928] Created device /job:localhost/replica:0/task:0/device:GPU:0 with 8322 MB memory:  -> device: 0, name: NVIDIA GeForce RTX 4070 Ti, pci bus id: 0000:01:00.0, compute capability: 8.9
2026-01-22 05:05:13.432118: I external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:465] Loaded cuDNN version 8906

################################################
Stage-2 Evaluation (test, valid k>=H-1):
DeLaN torque:   MSE=8.067895e-01  RMSE=8.982146e-01
  per-joint RMSE: 0.6289 0.8960 0.9443 0.5721 1.2636 0.9091
Residual LSTM:  MSE=7.751801e-01      RMSE=8.804432e-01
  per-joint RMSE: 0.6275 0.9852 0.9831 0.4794 1.2017 0.8039
Combined torque MSE=7.751801e-01     RMSE=8.804432e-01
  per-joint RMSE: 0.6275 0.9852 0.9831 0.4794 1.2017 0.8039
################################################

Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.txt
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/metrics_test_H50.json
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/combined_predictions_test_H50.npz
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/residual_gt_vs_pred_test_H50.png
Saved: /workspace/shared/evaluation/delan_UR3_Load0_combined_26__A__K25_tf0p2__delan_jax_struct_s2_ep150__feat_state_tauhat__lstm_s0_H50_ep30_b256_u128_do0p1/torque_gt_vs_delan_vs_combined_test_H50.png

